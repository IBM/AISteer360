
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ibm.github.io/AISteer360/reference/library_reference/">
      
      
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>API reference - AISteer360</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AISteer360" class="md-header__button md-logo" aria-label="AISteer360" data-md-component="logo">
      
  <img src="../../assets/logo_darkmode.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AISteer360
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/IBM/AISteer360" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    IBM/AISteer360
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../concepts/" class="md-tabs__link">
          
  
  
    
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/" class="md-tabs__link">
          
  
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../notebooks/" class="md-tabs__link">
          
  
  
    
  
  Notebooks

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AISteer360" class="md-nav__button md-logo" aria-label="AISteer360" data-md-component="logo">
      
  <img src="../../assets/logo_darkmode.png" alt="logo">

    </a>
    AISteer360
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/IBM/AISteer360" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    IBM/AISteer360
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../home/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../home/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Concepts
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/controls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Controls
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/steering_pipelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Steering pipelines
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tutorials/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/add_new_steering_method/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add a steering method
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/add_new_metric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add a metric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/add_new_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add a use case
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/add_new_benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Add a benchmark
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../notebooks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Notebooks
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Notebooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Controls
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Controls
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1" >
        
          
          <label class="md-nav__link" for="__nav_4_2_1" id="__nav_4_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Input control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1">
            <span class="md-nav__icon md-icon"></span>
            Input control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/few_shot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FewShot
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2_2" id="__nav_4_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Structural control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            Structural control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/mergekit_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MergeKit wrapper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/trl_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SFT with LoRA
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_3" >
        
          
          <label class="md-nav__link" for="__nav_4_2_3" id="__nav_4_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    State control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_3">
            <span class="md-nav__icon md-icon"></span>
            State control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/cast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CAST: Conditional Activation STeering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/pasta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PASTA
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_4" >
        
          
          <label class="md-nav__link" for="__nav_4_2_4" id="__nav_4_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Output control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_4">
            <span class="md-nav__icon md-icon"></span>
            Output control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/deal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DeAL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/rad/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/sasa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SASA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/controls/thinking_intervention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ThinkingIntervention
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Benchmarks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Benchmarks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/benchmarks/commonsense_mcqa/commonsense_mcqa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commonsense MCQA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../notebooks/benchmarks/instruction_following/instruction_following/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instruction following
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Algorithms
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2_2" id="__nav_5_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Input control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_2">
            <span class="md-nav__icon md-icon"></span>
            Input control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/input_control/base_input_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/input_control/few_shot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FewShot
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_3" >
        
          
          <label class="md-nav__link" for="__nav_5_2_3" id="__nav_5_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Structural control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_3">
            <span class="md-nav__icon md-icon"></span>
            Structural control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/structural_control/base_structural_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/structural_control/mergekit_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MergeKit wrapper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/structural_control/trl_wrapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TRL wrapper
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_4" >
        
          
          <label class="md-nav__link" for="__nav_5_2_4" id="__nav_5_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    State control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_4">
            <span class="md-nav__icon md-icon"></span>
            State control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/state_control/base_state_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/state_control/cast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CAST
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/state_control/pasta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PASTA
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2_5" >
        
          
          <label class="md-nav__link" for="__nav_5_2_5" id="__nav_5_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Output control
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_5">
            <span class="md-nav__icon md-icon"></span>
            Output control
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/output_control/base_output_control/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/output_control/deal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DeAL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/output_control/rad/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/output_control/sasa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SASA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../algorithms/output_control/thinking_intervention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ThinkingIntervention
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Evaluation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Evaluation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_1" >
        
          
          <label class="md-nav__link" for="__nav_5_3_1" id="__nav_5_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Metrics
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_1">
            <span class="md-nav__icon md-icon"></span>
            Metrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/metrics/base_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/metrics/generic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Generic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_1_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3_1_3" id="__nav_5_3_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Custom
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_5_3_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            Custom
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/metrics/custom/commonsense_mcqa_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commonsense MCQA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/metrics/custom/instruction_following_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instruction following
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3_2" >
        
          
          <label class="md-nav__link" for="__nav_5_3_2" id="__nav_5_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Use cases
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3_2">
            <span class="md-nav__icon md-icon"></span>
            Use cases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/use_cases/base_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base class
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/use_cases/commonsense_mcqa_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commonsense MCQA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/use_cases/instruction_following_use_case/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instruction following
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Benchmark
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aisteer360" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;aisteer360
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" aisteer360">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;algorithms
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" algorithms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;core
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core.base_args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base_args
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base_args">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core.base_args.T" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;T
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core.steering_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;steering_pipeline
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" steering_pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core.steering_pipeline.SteeringPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SteeringPipeline
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core.steering_utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;steering_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" steering_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core.steering_utils.ensure_pad_token" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;ensure_pad_token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.core.steering_utils.merge_controls" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;merge_controls
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;input_control
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" input_control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control.base" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control.base.InputControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;InputControl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control.base.NoInputControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NoInputControl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control.few_shot" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;few_shot
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" few_shot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control.few_shot.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control.few_shot.control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.input_control.few_shot.selectors" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;selectors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;output_control
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" output_control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.base" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.base.NoOutputControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NoOutputControl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.base.OutputControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;OutputControl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.deal" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;deal
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" deal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.deal.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.deal.control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.rad" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;rad
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" rad">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.rad.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.rad.control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.sasa" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;sasa
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" sasa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.sasa.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.sasa.control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.thinking_intervention" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;thinking_intervention
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" thinking_intervention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.thinking_intervention.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.output_control.thinking_intervention.control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;state_control
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" state_control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.base" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.base.BackwardHook" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;BackwardHook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.base.ForwardHook" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;ForwardHook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.base.HookSpec" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;HookSpec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.base.PreHook" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;PreHook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.base.NoStateControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NoStateControl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.base.StateControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;StateControl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;cast
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" cast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.cast.control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.pasta" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;pasta
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" pasta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.pasta.args" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.state_control.pasta.control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.structural_control" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;structural_control
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" structural_control">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.structural_control.base" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.structural_control.base.NoStructuralControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NoStructuralControl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.structural_control.base.StructuralControl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;StructuralControl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.structural_control.wrappers" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;wrappers
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" wrappers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.structural_control.wrappers.mergekit" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;mergekit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.algorithms.structural_control.wrappers.trl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;trl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;evaluation
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;benchmark
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" benchmark">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Benchmark
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Benchmark">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.base_model_name_or_path" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;base_model_name_or_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.device_map" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;device_map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.gen_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;gen_kwargs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.hf_model_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;hf_model_kwargs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.runtime_overrides" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;runtime_overrides
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.steering_pipelines" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;steering_pipelines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.use_case" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;use_case
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.export" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;export
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.benchmark.Benchmark.run" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;metrics
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Factuality
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Factuality">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.base_prompt_template" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;base_prompt_template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.batch_size" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;batch_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.device" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.extras" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;extras
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.format_instructions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;format_instructions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.max_retries" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;max_retries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.num_return_sequences" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;num_return_sequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.scale" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.use_chat" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;use_chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Factuality.compute" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LLMJudgeMetric
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" LLMJudgeMetric">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.base_prompt_template" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;base_prompt_template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.batch_size" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;batch_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.device" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.extras" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;extras
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.format_instructions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;format_instructions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.max_retries" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;max_retries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.num_return_sequences" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;num_return_sequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.scale" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.use_chat" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;use_chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.LLMJudgeMetric.compute" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Metric" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Metric
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Metric">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Metric.extras" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;extras
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Metric.name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Metric.compute" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Perplexity
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Perplexity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.add_bos" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;add_bos
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.batch_size" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;batch_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.device" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.extras" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;extras
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.max_length" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;max_length
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Perplexity.compute" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Relevance
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Relevance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.base_prompt_template" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;base_prompt_template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.batch_size" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;batch_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.device" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;device
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.extras" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;extras
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.format_instructions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;format_instructions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.max_retries" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;max_retries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.num_return_sequences" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;num_return_sequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.scale" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;scale
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;tokenizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.use_chat" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;use_chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.Relevance.compute" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.base" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.base.Metric" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Metric
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.base_judge" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base_judge
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base_judge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LLMJudgeMetric
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.base_judge.build_structured_parser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;build_structured_parser
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.custom" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;custom
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" custom">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.custom.commonsense_mcqa" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;commonsense_mcqa
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.custom.instruction_following" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;instruction_following
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.generic" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;generic
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" generic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.generic.factuality" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;factuality
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.generic.perplexity" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;perplexity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.metrics.generic.relevance" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;relevance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.use_cases" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;use_cases
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" use_cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.use_cases.base" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.use_cases.base.UseCase" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;UseCase
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.use_cases.commonsense_mcqa" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;commonsense_mcqa
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" commonsense_mcqa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.use_cases.commonsense_mcqa.use_case" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;use_case
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.use_cases.instruction_following" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;instruction_following
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" instruction_following">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.use_cases.instruction_following.use_case" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;use_case
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.generation_utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;generation_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" generation_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.generation_utils.BATCH_SIZE" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;BATCH_SIZE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.generation_utils.apply_chat_template" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;apply_chat_template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.generation_utils.batch_retry_generate" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;batch_retry_generate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.generation_utils.chat_generate_model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;chat_generate_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.generation_utils.chat_generate_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;chat_generate_pipeline
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.metric_utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;metric_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" metric_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.evaluation.utils.metric_utils.to_1d_array" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;to_1d_array
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.utils.model_utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;model_utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" model_utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aisteer360.utils.model_utils.find_project_root" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;find_project_root
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aisteer360.utils.model_utils.is_valid_model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;is_valid_model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-reference">API reference</h1>


<div class="doc doc-object doc-module">



<h2 id="aisteer360" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>aisteer360</code>


</h2>

    <div class="doc doc-contents first">

        <p>AI Steerability 360 toolkit.</p>
<p>The AI Steerability 360 toolkit (AISteer360) enables systematic control over language model behavior through four model
control surfaces: input, structural, state, and output. Methods can be composed into composite model operations (via
steering pipelines). Benchmarks enable comparison of steering pipelines on common use cases.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h3 id="aisteer360.algorithms" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>algorithms</code>


</h3>

    <div class="doc doc-contents ">

        <p>Contains all steering logic and control implementations across input, structural, state, and output control methods.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="aisteer360.algorithms.core" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>core</code>


</h4>

    <div class="doc doc-contents ">

        <p>Core functionality for steering pipelines, steering utilities, and argument parsing.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.core.base_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base_args</code>


</h5>

    <div class="doc doc-contents ">

        <p>Base argument validation for steering method configuration.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.algorithms.core.base_args.T" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;BaseArgs&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.core.steering_pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>steering_pipeline</code>


</h5>

    <div class="doc doc-contents ">

        <p>Core steering pipeline for composing and applying multiple LLM control methods.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SteeringPipeline</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">


        <p>Main steering pipeline for applying various control methods to Hugging Face causal language models.</p>
<p>Enables application of structural, state, input, and output controls in a coordinated manner.
Controls are applied in a fixed bottom-up order during steering, then used together during generation.</p>
<p>Workflow:</p>
<ol>
<li>Instantiate with a base model checkpoint and/or control objects</li>
<li>Call <code>steer()</code> once to apply all controls in order (structural → state → input → output)</li>
<li>Use <code>generate()</code> or <code>generate_text()</code> for inference with steering applied</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name_or_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HuggingFace model hub name or local directory.
Required when <code>lazy_init=False</code>. Ignored when <code>lazy_init=True</code> and the structural
control returns a model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>controls</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a> | <a class="autorefs autorefs-internal" title="            StateControl (aisteer360.algorithms.state_control.base.StateControl)" href="#aisteer360.algorithms.state_control.base.StateControl">StateControl</a> | <a class="autorefs autorefs-internal" title="            InputControl (aisteer360.algorithms.input_control.base.InputControl)" href="#aisteer360.algorithms.input_control.base.InputControl">InputControl</a> | <a class="autorefs autorefs-internal" title="            OutputControl (aisteer360.algorithms.output_control.base.OutputControl)" href="#aisteer360.algorithms.output_control.base.OutputControl">OutputControl</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controls for the steering pipeline, max one control per category. Omitted categories
fall back to no-op controls (see control base classes).</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer_name_or_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer location. Defaults to <code>model_name_or_path</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device_map</code>
            </td>
            <td>
                  <code><span title="str">str</span> or <span title="dict">dict</span>[<span title="str">str</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device map (passed to
<code>transformers.AutoModelForCausalLM.from_pretrained</code>). Defaults to <code>"auto"</code>.
Cannot be used together with <code>device</code> parameter.</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code>(<span title="torch.device">device</span>, <span title="str">str</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device (passed to model's <code>.to()</code> method).
When specified, <code>device_map</code> must remain at its default value of <code>"auto"</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hf_model_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extra keyword arguments passed to
<code>transformers.AutoModelForCausalLM.from_pretrained</code>.</p>
              </div>
            </td>
            <td>
                  <code><span title="dict">dict</span>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lazy_init</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>True</code>, defers loading the base model until <code>steer()</code> time.
Useful when a <code>StructuralControl</code> will itself load or create the final weights
(e.g., MergeKit). When <code>False</code>, the model is loaded during <code>SteeringPipeline</code>
construction. Defaults to <code>False</code>.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>generate()</code> is called before <code>steer()</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If multiple controls provided for same category or required arguments missing</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>Maximum one control per category; omitted categories use no-op defaults</li>
<li>Controls with a <code>tokenizer</code> attribute will have it auto-injected if not already set</li>
</ul>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/core/steering_pipeline.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SteeringPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main steering pipeline for applying various control methods to Hugging Face causal language models.</span>

<span class="sd">    Enables application of structural, state, input, and output controls in a coordinated manner.</span>
<span class="sd">    Controls are applied in a fixed bottom-up order during steering, then used together during generation.</span>

<span class="sd">    Workflow:</span>

<span class="sd">    1. Instantiate with a base model checkpoint and/or control objects</span>
<span class="sd">    2. Call `steer()` once to apply all controls in order (structural → state → input → output)</span>
<span class="sd">    3. Use `generate()` or `generate_text()` for inference with steering applied</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name_or_path (str or pathlib.Path, optional): HuggingFace model hub name or local directory.</span>
<span class="sd">            Required when `lazy_init=False`. Ignored when `lazy_init=True` and the structural</span>
<span class="sd">            control returns a model.</span>
<span class="sd">        controls (Sequence[StructuralControl | StateControl | InputControl | OutputControl], optional):</span>
<span class="sd">            Controls for the steering pipeline, max one control per category. Omitted categories</span>
<span class="sd">            fall back to no-op controls (see control base classes).</span>
<span class="sd">        tokenizer_name_or_path (str, optional): Tokenizer location. Defaults to `model_name_or_path`.</span>
<span class="sd">        device_map (str or dict[str, int], optional): Device map (passed to</span>
<span class="sd">            `transformers.AutoModelForCausalLM.from_pretrained`). Defaults to `&quot;auto&quot;`.</span>
<span class="sd">            Cannot be used together with `device` parameter.</span>
<span class="sd">        device (torch.device, str, optional): Device (passed to model&#39;s `.to()` method).</span>
<span class="sd">            When specified, `device_map` must remain at its default value of `&quot;auto&quot;`.</span>
<span class="sd">        hf_model_kwargs (dict, optional): Extra keyword arguments passed to</span>
<span class="sd">            `transformers.AutoModelForCausalLM.from_pretrained`.</span>
<span class="sd">        lazy_init (bool, optional): If `True`, defers loading the base model until `steer()` time.</span>
<span class="sd">            Useful when a `StructuralControl` will itself load or create the final weights</span>
<span class="sd">            (e.g., MergeKit). When `False`, the model is loaded during `SteeringPipeline`</span>
<span class="sd">            construction. Defaults to `False`.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If `generate()` is called before `steer()`</span>
<span class="sd">        ValueError: If multiple controls provided for same category or required arguments missing</span>

<span class="sd">    Note:</span>

<span class="sd">    - Maximum one control per category; omitted categories use no-op defaults</span>
<span class="sd">    - Controls with a `tokenizer` attribute will have it auto-injected if not already set</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># construction args</span>
    <span class="n">model_name_or_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">controls</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">StructuralControl</span> <span class="o">|</span> <span class="n">StateControl</span> <span class="o">|</span> <span class="n">InputControl</span> <span class="o">|</span> <span class="n">OutputControl</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">tokenizer_name_or_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">device_map</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">hf_model_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">lazy_init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># lazy‑filled fields</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">AutoTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">structural_control</span><span class="p">:</span> <span class="n">StructuralControl</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">state_control</span><span class="p">:</span> <span class="n">StateControl</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">input_control</span><span class="p">:</span> <span class="n">InputControl</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">output_control</span><span class="p">:</span> <span class="n">OutputControl</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">_is_steered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># sort/validate the supplied steering methods</span>
        <span class="n">controls_merged</span> <span class="o">=</span> <span class="n">merge_controls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structural_control</span> <span class="o">=</span> <span class="n">controls_merged</span><span class="p">[</span><span class="s2">&quot;structural_control&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span> <span class="o">=</span> <span class="n">controls_merged</span><span class="p">[</span><span class="s2">&quot;state_control&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_control</span> <span class="o">=</span> <span class="n">controls_merged</span><span class="p">[</span><span class="s2">&quot;input_control&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_control</span> <span class="o">=</span> <span class="n">controls_merged</span><span class="p">[</span><span class="s2">&quot;output_control&quot;</span><span class="p">]</span>

        <span class="c1"># load HF artifacts</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_init</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name_or_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`model_name_or_path` must be provided when lazy_init=False&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_map</span> <span class="o">!=</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both `device` and `device_map`.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hf_model_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span>
                    <span class="n">device_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_map</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hf_model_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_name_or_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span>
                <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">ensure_pad_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_name_or_path</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_name_or_path</span><span class="p">,</span>
                    <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">ensure_pad_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>

        <span class="c1"># late‑inject tokenizer into controls that accept it</span>
        <span class="n">controls_iter</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_control</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">controls_iter</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">steer_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply all steering controls to the model in place.</span>

<span class="sd">        Executes each control&#39;s steer() method in a fixed bottom-up order: structural -&gt; state -&gt; input -&gt; output.</span>
<span class="sd">        This ensures that higher-level controls always see the final configured model from lower levels.</span>

<span class="sd">        If any control&#39;s steer() method returns a PreTrainedModel instance, it replaces the current model for subsequent</span>
<span class="sd">        controls.</span>

<span class="sd">        Args:</span>
<span class="sd">            **steer_kwargs: Keyword arguments passed to all control steer() methods</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If called more than once or no model available after steering</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_steered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># steer each control (bottom-up order)</span>
        <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_control</span><span class="p">):</span>
            <span class="n">steer_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="s2">&quot;steer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">steer_fn</span><span class="p">):</span>
                <span class="n">maybe_new_model</span> <span class="o">=</span> <span class="n">steer_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="o">**</span><span class="n">steer_kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maybe_new_model</span><span class="p">,</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">maybe_new_model</span>

        <span class="c1"># safety checks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No model is available after steering. Either provide a base model (lazy_init=False) or ensure a &quot;</span>
                <span class="s2">&quot;`StructuralControl` returns one.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;name_or_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="n">repo</span> <span class="ow">or</span> <span class="n">Path</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_control</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;out_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                    <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">ensure_pad_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to resolve tokenizer post‑steer.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exception</span>

        <span class="c1"># for control in (self.input_control, self.structural_control, self.state_control, self.output_control):</span>
        <span class="c1">#     if hasattr(control, &quot;tokenizer&quot;) and getattr(control, &quot;tokenizer&quot;) is None:</span>
        <span class="c1">#         setattr(control, &quot;tokenizer&quot;, self.tokenizer)</span>

        <span class="c1"># return steered steerer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_steered</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">input_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gen_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate text with all steering controls applied.</span>

<span class="sd">        Applies controls in sequence during generation:</span>

<span class="sd">        1. Input control adapts the prompt</span>
<span class="sd">        2. State control registers hooks for state control (e.g., activation steering)</span>
<span class="sd">        3. Output control handles the actual generation</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids: Token IDs as list or tensor (shape: [seq_len] or [batch, seq_len])</span>
<span class="sd">            attention_mask: Optional attention mask matching input_ids shape</span>
<span class="sd">            runtime_kwargs: Per-generation parameters for controls (e.g., {&quot;substrings&quot;: [...]})</span>
<span class="sd">            **gen_kwargs: Generation parameters passed to `model.generate()`</span>

<span class="sd">        Returns:</span>
<span class="sd">            Generated token IDs (shape: [batch, generated_len])</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If steer() has not yet been called</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_steered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Must call `.steer()` before `.generate()`.&quot;</span><span class="p">)</span>

        <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">return_full_sequence</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;return_full_sequence&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="c1"># input control</span>
        <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_control</span><span class="o">.</span><span class="n">get_prompt_adapter</span><span class="p">()(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">steered_input_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">steered_input_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># attention_mask (reshape and move to device)</span>
        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">steered_input_ids</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">steered_input_ids</span><span class="o">.</span><span class="n">device</span>
            <span class="p">)</span>

        <span class="c1"># state control</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">get_hooks</span><span class="p">(</span><span class="n">steered_input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">set_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">_model_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="c1"># output control</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="p">:</span>  <span class="c1"># hooks live only for duration of decoding</span>
            <span class="n">output_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_control</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">input_ids</span><span class="o">=</span><span class="n">steered_input_ids</span><span class="p">,</span>
                <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
                <span class="n">runtime_kwargs</span><span class="o">=</span><span class="n">runtime_kwargs</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="o">**</span><span class="n">gen_kwargs</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_full_sequence</span><span class="p">:</span>
            <span class="n">output_ids</span> <span class="o">=</span> <span class="n">output_ids</span><span class="p">[:,</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">):]</span>

        <span class="k">return</span> <span class="n">output_ids</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate text and decode to string(s).</span>

<span class="sd">        Convenience wrapper that calls generate() and decodes the output tokens.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Arguments passed to generate()</span>
<span class="sd">            **kwargs: Keyword arguments passed to generate()</span>

<span class="sd">        Returns:</span>
<span class="sd">            Decoded text string (single prompt) or list of strings (batch)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ids</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.controls" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">controls</span> <span class="o">=</span> <span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.device_map" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device_map</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.hf_model_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">hf_model_kwargs</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.input_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">input_control</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.lazy_init" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lazy_init</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.model_name_or_path" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model_name_or_path</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.output_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">output_control</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.state_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">state_control</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.structural_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">structural_control</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.tokenizer_name_or_path" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer_name_or_path</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Generate text with all steering controls applied.</p>
<p>Applies controls in sequence during generation:</p>
<ol>
<li>Input control adapts the prompt</li>
<li>State control registers hooks for state control (e.g., activation steering)</li>
<li>Output control handles the actual generation</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>] | <span title="torch.LongTensor">LongTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token IDs as list or tensor (shape: [seq_len] or [batch, seq_len])</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attention_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional attention mask matching input_ids shape</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Per-generation parameters for controls (e.g., {"substrings": [...]})</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**gen_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generation parameters passed to <code>model.generate()</code></p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generated token IDs (shape: [batch, generated_len])</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If steer() has not yet been called</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/core/steering_pipeline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate text with all steering controls applied.</span>

<span class="sd">    Applies controls in sequence during generation:</span>

<span class="sd">    1. Input control adapts the prompt</span>
<span class="sd">    2. State control registers hooks for state control (e.g., activation steering)</span>
<span class="sd">    3. Output control handles the actual generation</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids: Token IDs as list or tensor (shape: [seq_len] or [batch, seq_len])</span>
<span class="sd">        attention_mask: Optional attention mask matching input_ids shape</span>
<span class="sd">        runtime_kwargs: Per-generation parameters for controls (e.g., {&quot;substrings&quot;: [...]})</span>
<span class="sd">        **gen_kwargs: Generation parameters passed to `model.generate()`</span>

<span class="sd">    Returns:</span>
<span class="sd">        Generated token IDs (shape: [batch, generated_len])</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If steer() has not yet been called</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_steered</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Must call `.steer()` before `.generate()`.&quot;</span><span class="p">)</span>

    <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">return_full_sequence</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;return_full_sequence&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

    <span class="c1"># input control</span>
    <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_control</span><span class="o">.</span><span class="n">get_prompt_adapter</span><span class="p">()(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">steered_input_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">steered_input_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">steered_input_ids</span> <span class="o">=</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># attention_mask (reshape and move to device)</span>
    <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">steered_input_ids</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">steered_input_ids</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

    <span class="c1"># state control</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">get_hooks</span><span class="p">(</span><span class="n">steered_input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">set_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">_model_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

    <span class="c1"># output control</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="p">:</span>  <span class="c1"># hooks live only for duration of decoding</span>
        <span class="n">output_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_control</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">steered_input_ids</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
            <span class="n">runtime_kwargs</span><span class="o">=</span><span class="n">runtime_kwargs</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gen_kwargs</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_full_sequence</span><span class="p">:</span>
        <span class="n">output_ids</span> <span class="o">=</span> <span class="n">output_ids</span><span class="p">[:,</span> <span class="n">steered_input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">):]</span>

    <span class="k">return</span> <span class="n">output_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.generate_text" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate_text</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Generate text and decode to string(s).</p>
<p>Convenience wrapper that calls generate() and decodes the output tokens.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments passed to generate()</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments passed to generate()</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Decoded text string (single prompt) or list of strings (batch)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/core/steering_pipeline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate text and decode to string(s).</span>

<span class="sd">    Convenience wrapper that calls generate() and decodes the output tokens.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Arguments passed to generate()</span>
<span class="sd">        **kwargs: Keyword arguments passed to generate()</span>

<span class="sd">    Returns:</span>
<span class="sd">        Decoded text string (single prompt) or list of strings (batch)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ids</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.core.steering_pipeline.SteeringPipeline.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="o">**</span><span class="n">steer_kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Apply all steering controls to the model in place.</p>
<p>Executes each control's steer() method in a fixed bottom-up order: structural -&gt; state -&gt; input -&gt; output.
This ensures that higher-level controls always see the final configured model from lower levels.</p>
<p>If any control's steer() method returns a PreTrainedModel instance, it replaces the current model for subsequent
controls.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>**steer_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keyword arguments passed to all control steer() methods</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If called more than once or no model available after steering</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/core/steering_pipeline.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">steer_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply all steering controls to the model in place.</span>

<span class="sd">    Executes each control&#39;s steer() method in a fixed bottom-up order: structural -&gt; state -&gt; input -&gt; output.</span>
<span class="sd">    This ensures that higher-level controls always see the final configured model from lower levels.</span>

<span class="sd">    If any control&#39;s steer() method returns a PreTrainedModel instance, it replaces the current model for subsequent</span>
<span class="sd">    controls.</span>

<span class="sd">    Args:</span>
<span class="sd">        **steer_kwargs: Keyword arguments passed to all control steer() methods</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If called more than once or no model available after steering</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_steered</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># steer each control (bottom-up order)</span>
    <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_control</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_control</span><span class="p">):</span>
        <span class="n">steer_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="s2">&quot;steer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">steer_fn</span><span class="p">):</span>
            <span class="n">maybe_new_model</span> <span class="o">=</span> <span class="n">steer_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="o">**</span><span class="n">steer_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maybe_new_model</span><span class="p">,</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">maybe_new_model</span>

    <span class="c1"># safety checks</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;No model is available after steering. Either provide a base model (lazy_init=False) or ensure a &quot;</span>
            <span class="s2">&quot;`StructuralControl` returns one.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;name_or_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="n">repo</span> <span class="ow">or</span> <span class="n">Path</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structural_control</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;out_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
                <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">ensure_pad_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to resolve tokenizer post‑steer.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exception</span>

    <span class="c1"># for control in (self.input_control, self.structural_control, self.state_control, self.output_control):</span>
    <span class="c1">#     if hasattr(control, &quot;tokenizer&quot;) and getattr(control, &quot;tokenizer&quot;) is None:</span>
    <span class="c1">#         setattr(control, &quot;tokenizer&quot;, self.tokenizer)</span>

    <span class="c1"># return steered steerer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_is_steered</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.core.steering_utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>steering_utils</code>


</h5>

    <div class="doc doc-contents ">

        <p>Helper functions for steering.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="aisteer360.algorithms.core.steering_utils.ensure_pad_token" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">ensure_pad_token</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Set pad token to eos token if not already defined.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizerBase">PreTrainedTokenizerBase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HuggingFace tokenizer instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="transformers.PreTrainedTokenizerBase">PreTrainedTokenizerBase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The same tokenizer with pad_token configured</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/core/steering_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ensure_pad_token</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedTokenizerBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set pad token to eos token if not already defined.</span>

<span class="sd">    Args:</span>
<span class="sd">       tokenizer: HuggingFace tokenizer instance</span>

<span class="sd">    Returns:</span>
<span class="sd">       The same tokenizer with pad_token configured</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
        <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
    <span class="k">return</span> <span class="n">tokenizer</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="aisteer360.algorithms.core.steering_utils.merge_controls" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">merge_controls</span><span class="p">(</span><span class="n">supplied</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Sort supplied controls by category and ensure at most one per category.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>supplied</code>
            </td>
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a> | <a class="autorefs autorefs-internal" title="            StateControl (aisteer360.algorithms.state_control.base.StateControl)" href="#aisteer360.algorithms.state_control.base.StateControl">StateControl</a> | <a class="autorefs autorefs-internal" title="            InputControl (aisteer360.algorithms.input_control.base.InputControl)" href="#aisteer360.algorithms.input_control.base.InputControl">InputControl</a> | <a class="autorefs autorefs-internal" title="            OutputControl (aisteer360.algorithms.output_control.base.OutputControl)" href="#aisteer360.algorithms.output_control.base.OutputControl">OutputControl</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of control instances to organize</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="object">object</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict mapping field names to control instances (with default no-ops for unspecified categories)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If multiple controls of the same category are supplied</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an unrecognized control type is supplied</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/core/steering_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">merge_controls</span><span class="p">(</span>
        <span class="n">supplied</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">StructuralControl</span> <span class="o">|</span> <span class="n">StateControl</span> <span class="o">|</span> <span class="n">InputControl</span> <span class="o">|</span> <span class="n">OutputControl</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort supplied controls by category and ensure at most one per category.</span>

<span class="sd">    Args:</span>
<span class="sd">       supplied: List of control instances to organize</span>

<span class="sd">    Returns:</span>
<span class="sd">       Dict mapping field names to control instances (with default no-ops for unspecified categories)</span>

<span class="sd">    Raises:</span>
<span class="sd">       ValueError: If multiple controls of the same category are supplied</span>
<span class="sd">       TypeError: If an unrecognized control type is supplied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bucket</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">supplied</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">_CATEGORY_TO_DEFAULT</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
                <span class="n">bucket</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown control type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">control</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># todo (future): allow for user to compose multiple methods of the same category in a specified order;</span>
    <span class="c1">#  will require necessary validation logic to ensure no conflicts.</span>
    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">controls</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">control</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">controls</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple </span><span class="si">{</span><span class="n">category</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">s supplied: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">out</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">default_instance</span> <span class="ow">in</span> <span class="n">_CATEGORY_TO_DEFAULT</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">[</span><span class="n">default_instance</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;input_control&quot;</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="n">InputControl</span>
            <span class="k">else</span> <span class="s2">&quot;structural_control&quot;</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="n">StructuralControl</span>
            <span class="k">else</span> <span class="s2">&quot;state_control&quot;</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">is</span> <span class="n">StateControl</span>
            <span class="k">else</span> <span class="s2">&quot;output_control&quot;</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">out_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="aisteer360.algorithms.input_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>input_control</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.input_control.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base</code>


</h5>

    <div class="doc doc-contents ">

        <p>Input control base classes.</p>
<p>This module provides the abstract base class for methods that modify prompts before they reach the model.</p>
<p>Two base classes are provided:</p>
<ul>
<li><code>InputControl</code>: Base class for all input control methods.</li>
<li><code>NoInputControl</code>: Identity (null) control; used when no input control is defined in steering pipeline.</li>
</ul>
<p>Input controls implement steering through prompt transformation σ(x), enabling behavior modification without altering
model parameters or architecture. These methods transform inputs before they reach the model, resulting in generations
following y ~ p_θ(σ(x)).</p>
<p>Examples of input controls:</p>
<ul>
<li>Few-shot learning (prepending examples)</li>
<li>Prompt templates and formatting</li>
<li>Soft prompts and prompt tuning</li>
<li>Chain-of-thought prompting</li>
<li>Iterative prompt refinement</li>
</ul>
<p>See Also:</p>
<ul>
<li><code>aisteer360.algorithms.input_control</code>: Implementations of input control methods</li>
<li><code>aisteer360.core.steering_pipeline</code>: Integration with steering pipeline</li>
</ul>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.input_control.base.InputControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>InputControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for input control steering methods.</p>
<p>Transforms prompts before model processing through a prompt adapter function that modifies input token sequences.</p>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_prompt_adapter(runtime_kwargs=None)

  
      abstractmethod
   (aisteer360.algorithms.input_control.base.InputControl.get_prompt_adapter)" href="#aisteer360.algorithms.input_control.base.InputControl.get_prompt_adapter">get_prompt_adapter</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Return transformation function (required)</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            steer(model=None, tokenizer=None, **kwargs) (aisteer360.algorithms.input_control.base.InputControl.steer)" href="#aisteer360.algorithms.input_control.base.InputControl.steer">steer</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>One-time preparation (optional)</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/input_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InputControl</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for input control steering methods.</span>

<span class="sd">    Transforms prompts before model processing through a prompt adapter function that modifies input token sequences.</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_prompt_adapter(runtime_kwargs) -&gt; Callable: Return transformation function (required)</span>
<span class="sd">        steer(model, tokenizer, **kwargs) -&gt; None: One-time preparation (optional)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseArgs</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># null control</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> accepts no constructor arguments.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> <span class="n">BaseArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># move fields to attributes</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_prompt_adapter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Receives (input_ids, runtime_kwargs) and returns modified input_ids..&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optional steering/preparation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.input_control.base.InputControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.input_control.base.InputControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.input_control.base.InputControl.get_prompt_adapter" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_prompt_adapter</span><span class="p">(</span><span class="n">runtime_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Receives (input_ids, runtime_kwargs) and returns modified input_ids..</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_prompt_adapter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Receives (input_ids, runtime_kwargs) and returns modified input_ids..&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.input_control.base.InputControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Optional steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
          <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optional steering/preparation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.input_control.base.NoInputControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>NoInputControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            InputControl (aisteer360.algorithms.input_control.base.InputControl)" href="#aisteer360.algorithms.input_control.base.InputControl">InputControl</a></code></p>


        <p>Identity input control.</p>
<p>Used as the default when no input control is needed. Returns input_ids.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/input_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NoInputControl</span><span class="p">(</span><span class="n">InputControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identity input control.</span>

<span class="sd">    Used as the default when no input control is needed. Returns input_ids.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prompt_adapter</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null adapter operation; returns identity map.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">ids</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">ids</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">adapter</span><span class="p">(</span><span class="n">input_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">input_ids</span>

        <span class="k">return</span> <span class="n">adapter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null steer operation; attaches tokenizer.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.input_control.base.NoInputControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.input_control.base.NoInputControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.input_control.base.NoInputControl.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.input_control.base.NoInputControl.get_prompt_adapter" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_prompt_adapter</span><span class="p">(</span><span class="n">runtime_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null adapter operation; returns identity map.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prompt_adapter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null adapter operation; returns identity map.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">ids</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">ids</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">adapter</span><span class="p">(</span><span class="n">input_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">input_ids</span>

    <span class="k">return</span> <span class="n">adapter</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.input_control.base.NoInputControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null steer operation; attaches tokenizer.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null steer operation; attaches tokenizer.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.input_control.few_shot" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>few_shot</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.input_control.few_shot.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.input_control.few_shot.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h6>

    <div class="doc doc-contents ">

        <p>Few-shot learning control for prompt adaptation.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.input_control.few_shot.control.FewShot" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>FewShot</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            InputControl (aisteer360.algorithms.input_control.base.InputControl)" href="#aisteer360.algorithms.input_control.base.InputControl">InputControl</a></code></p>


        <p>Implementation of few-shot learning control for prompt adaptation.</p>
<p>FewShot enables selective behavioral steering by prepending specific examples to user prompts, guiding model
responses through demonstration.</p>
<p>The method operates in two modes:</p>
<ol>
<li>
<p><strong>Pool-based sampling</strong>: Maintains pools of positive and negative examples from which k examples are dynamically
    selected using configurable sampling strategies (random, semantic similarity, etc.).</p>
</li>
<li>
<p><strong>Runtime injection</strong>: Accepts examples directly at inference time through runtime_kwargs, enabling
    context-specific demonstrations without predefined pools. Useful for dynamic or user-provided examples.</p>
</li>
</ol>
<p>The selected examples are formatted into a system prompt with clear positive/negative labels and prepended to the
user query using the model's chat template, allowing the model to learn the desired behavior pattern from the
demonstrations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>directive</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Instruction text that precedes the examples, explaining the task or desired behavior.
Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>positive_example_pool</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pool of positive examples demonstrating desired behavior.
Each dict can contain multiple key-value pairs. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>negative_example_pool</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pool of negative examples showing undesired behavior to avoid.
Each dict can contain multiple key-value pairs. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>k_positive</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of positive examples to sample from the pool per query.
Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>k_negative</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of negative examples to sample from the pool per query.
Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>selector_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the selection strategy ('random', 'semantic', etc.).
Determines how examples are chosen from pools. Defaults to 'random'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Custom template for formatting the system prompt. Should contain
{directive} and {example_blocks} placeholders. Defaults to built-in template.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Runtime keyword arguments:</p>
<ul>
<li><code>positive_examples</code> (<code>list[dict]</code>, <code>optional</code>): Positive examples to use for this specific query (overrides pool-based
selection).</li>
<li><code>negative_examples</code> (<code>list[dict]</code>, <code>optional</code>): Negative examples to use for this specific query (overrides pool-based
selection).</li>
</ul>
<p>Notes:</p>
<ul>
<li>Requires a tokenizer with chat_template support for optimal formatting</li>
<li>Examples are automatically labeled as "### Positive example" or "### Negative example"</li>
<li>When both pools and runtime examples are available, runtime examples take precedence</li>
<li>If no examples are provided, the original input is returned unchanged</li>
</ul>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/input_control/few_shot/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FewShot</span><span class="p">(</span><span class="n">InputControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of few-shot learning control for prompt adaptation.</span>

<span class="sd">    FewShot enables selective behavioral steering by prepending specific examples to user prompts, guiding model</span>
<span class="sd">    responses through demonstration.</span>

<span class="sd">    The method operates in two modes:</span>

<span class="sd">    1. **Pool-based sampling**: Maintains pools of positive and negative examples from which k examples are dynamically</span>
<span class="sd">        selected using configurable sampling strategies (random, semantic similarity, etc.).</span>

<span class="sd">    2. **Runtime injection**: Accepts examples directly at inference time through runtime_kwargs, enabling</span>
<span class="sd">        context-specific demonstrations without predefined pools. Useful for dynamic or user-provided examples.</span>

<span class="sd">    The selected examples are formatted into a system prompt with clear positive/negative labels and prepended to the</span>
<span class="sd">    user query using the model&#39;s chat template, allowing the model to learn the desired behavior pattern from the</span>
<span class="sd">    demonstrations.</span>

<span class="sd">    Args:</span>
<span class="sd">        directive (str, optional): Instruction text that precedes the examples, explaining the task or desired behavior.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        positive_example_pool (Sequence[dict], optional): Pool of positive examples demonstrating desired behavior.</span>
<span class="sd">            Each dict can contain multiple key-value pairs. Defaults to None.</span>
<span class="sd">        negative_example_pool (Sequence[dict], optional): Pool of negative examples showing undesired behavior to avoid.</span>
<span class="sd">            Each dict can contain multiple key-value pairs. Defaults to None.</span>
<span class="sd">        k_positive (int, optional): Number of positive examples to sample from the pool per query.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        k_negative (int, optional): Number of negative examples to sample from the pool per query.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        selector_name (str, optional): Name of the selection strategy (&#39;random&#39;, &#39;semantic&#39;, etc.).</span>
<span class="sd">            Determines how examples are chosen from pools. Defaults to &#39;random&#39;.</span>
<span class="sd">        template (str, optional): Custom template for formatting the system prompt. Should contain</span>
<span class="sd">            {directive} and {example_blocks} placeholders. Defaults to built-in template.</span>

<span class="sd">    Runtime keyword arguments:</span>

<span class="sd">    - `positive_examples` (`list[dict]`, `optional`): Positive examples to use for this specific query (overrides pool-based</span>
<span class="sd">    selection).</span>
<span class="sd">    - `negative_examples` (`list[dict]`, `optional`): Negative examples to use for this specific query (overrides pool-based</span>
<span class="sd">    selection).</span>

<span class="sd">    Notes:</span>

<span class="sd">    - Requires a tokenizer with chat_template support for optimal formatting</span>
<span class="sd">    - Examples are automatically labeled as &quot;### Positive example&quot; or &quot;### Negative example&quot;</span>
<span class="sd">    - When both pools and runtime examples are available, runtime examples take precedence</span>
<span class="sd">    - If no examples are provided, the original input is returned unchanged</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span> <span class="o">=</span> <span class="n">FewShotArgs</span>

    <span class="c1"># default templates</span>
    <span class="n">_SYSTEM_PROMPT_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{directive}</span><span class="s2">: </span><span class="se">\n</span><span class="si">{example_blocks}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="n">_POSITIVE_EXAMPLE_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;### Positive example (behavior to follow)</span><span class="se">\n</span><span class="si">{content}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">_NEGATIVE_EXAMPLE_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;### Negative example (behavior to avoid)</span><span class="se">\n</span><span class="si">{content}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># placeholders</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">selector_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">directive</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">positive_example_pool</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">negative_example_pool</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">k_positive</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">k_negative</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">selector</span><span class="p">:</span> <span class="n">Selector</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>

        <span class="c1"># initialize selector if using pool mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector_name</span><span class="p">:</span>
                <span class="n">selector_cls</span> <span class="o">=</span> <span class="n">SELECTOR_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selector_name</span><span class="p">,</span> <span class="n">RandomSelector</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">selector_cls</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">RandomSelector</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prompt_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a prompt adapter function that adds few-shot examples to the model&#39;s system prompt. Creates and</span>
<span class="sd">        returns a closure that modifies input token sequences by prepending few-shot examples.</span>

<span class="sd">        The returned adapter function performs the following steps:</span>

<span class="sd">        1. Determines operational mode (runtime examples take precedence over pools)</span>
<span class="sd">        2. Decodes input tokens to retrieve the original user message</span>
<span class="sd">        3. Selects or retrieves appropriate examples based on mode</span>
<span class="sd">        4. Formats examples with positive/negative labels</span>
<span class="sd">        5. Constructs a system prompt containing the examples</span>
<span class="sd">        6. Applies the model&#39;s chat template (if available) to combine system prompt and user message</span>
<span class="sd">        7. Re-encodes the adapted text to tokens</span>

<span class="sd">        Returns:</span>
<span class="sd">            A prompt adapter function.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If tokenizer is not set (requires calling `steer()` first)</span>

<span class="sd">        Warnings:</span>
<span class="sd">            UserWarning: Issued when:</span>

<span class="sd">                - No examples available from either pools or runtime_kwargs</span>
<span class="sd">                - No examples remain after selection/sampling</span>
<span class="sd">                - Tokenizer lacks chat_template support (falls back to direct prepending)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;FewShot needs a tokenizer; call .steer() first.&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">adapter</span><span class="p">(</span><span class="n">input_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>

            <span class="c1"># infer mode from arguments</span>
            <span class="n">using_runtime_examples</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime_kwargs</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;positive_examples&quot;</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span>
                                                          <span class="s2">&quot;negative_examples&quot;</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">))</span>
            <span class="n">using_pool_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">using_runtime_examples</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">using_pool_mode</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;FewShot: No examples provided via runtime_kwargs or example pools. &quot;</span>
                    <span class="s2">&quot;Returning original input unchanged.&quot;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">input_ids</span>

            <span class="c1"># decode to retrieve user message</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">input_ids_list</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">input_ids_list</span> <span class="o">=</span> <span class="n">input_ids</span>

            <span class="n">original_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># get examples based on mode</span>
            <span class="k">if</span> <span class="n">using_runtime_examples</span><span class="p">:</span>
                <span class="n">examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_runtime_examples</span><span class="p">(</span><span class="n">runtime_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_from_pools</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">examples</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;FewShot: No examples available after selection. Returning original input unchanged.&quot;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">input_ids</span>

            <span class="n">examples_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_examples</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>

            <span class="c1"># apply chat template</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span><span class="p">:</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">examples_text</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">original_text</span><span class="p">}</span>
                <span class="p">]</span>
                <span class="n">adapted_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                    <span class="n">messages</span><span class="p">,</span>
                    <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;No chat template found for tokenizer. Prepending few-shot examples directly to user query.&quot;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span>
                <span class="p">)</span>
                <span class="n">adapted_text</span> <span class="o">=</span> <span class="n">examples_text</span> <span class="o">+</span> <span class="n">original_text</span>

            <span class="c1"># encode the adapted text</span>
            <span class="n">adapted_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="n">adapted_text</span><span class="p">,</span>
                <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">adapted_tokens</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">adapted_tokens</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">adapted_tokens</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">adapted_tokens</span>

        <span class="k">return</span> <span class="n">adapter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_from_pools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample examples from the pools.&quot;&quot;&quot;</span>
        <span class="n">all_examples</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_example_pool</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_positive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_positive</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">positive_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positive_example_pool</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_positive</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">positive_samples</span><span class="p">:</span>
                <span class="n">all_examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">example</span><span class="p">,</span> <span class="s2">&quot;_label&quot;</span><span class="p">:</span> <span class="s2">&quot;positive&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_example_pool</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_negative</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_negative</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">negative_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">negative_example_pool</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_negative</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">negative_samples</span><span class="p">:</span>
                <span class="n">all_examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">example</span><span class="p">,</span> <span class="s2">&quot;_label&quot;</span><span class="p">:</span> <span class="s2">&quot;negative&quot;</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">all_examples</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_examples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">examples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format examples for system prompt.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">examples</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">example_blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
            <span class="n">is_positive</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_label&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_example_content</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_positive</span><span class="p">:</span>
                <span class="n">example_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_POSITIVE_EXAMPLE_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">example_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NEGATIVE_EXAMPLE_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">))</span>

        <span class="n">template</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEM_PROMPT_TEMPLATE</span>
        <span class="n">formatted_blocks</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">example_blocks</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directive</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">example_blocks</span><span class="o">=</span><span class="n">formatted_blocks</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_gather_runtime_examples</span><span class="p">(</span><span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gather examples from runtime_kwargs.&quot;&quot;&quot;</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;positive_examples&quot;</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">[</span><span class="s2">&quot;positive_examples&quot;</span><span class="p">]:</span>
                <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">example</span><span class="p">,</span> <span class="s2">&quot;_label&quot;</span><span class="p">:</span> <span class="s2">&quot;positive&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="s2">&quot;negative_examples&quot;</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">[</span><span class="s2">&quot;negative_examples&quot;</span><span class="p">]:</span>
                <span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="o">**</span><span class="n">example</span><span class="p">,</span> <span class="s2">&quot;_label&quot;</span><span class="p">:</span> <span class="s2">&quot;negative&quot;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">examples</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_format_example_content</span><span class="p">(</span><span class="n">example</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;_label&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">formatted_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">formatted_key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.directive" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">directive</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.k_negative" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">k_negative</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.k_positive" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">k_positive</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.negative_example_pool" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">negative_example_pool</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.positive_example_pool" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">positive_example_pool</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.selector" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">selector</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.selector_name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">selector_name</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.get_prompt_adapter" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_prompt_adapter</span><span class="p">()</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Return a prompt adapter function that adds few-shot examples to the model's system prompt. Creates and
returns a closure that modifies input token sequences by prepending few-shot examples.</p>
<p>The returned adapter function performs the following steps:</p>
<ol>
<li>Determines operational mode (runtime examples take precedence over pools)</li>
<li>Decodes input tokens to retrieve the original user message</li>
<li>Selects or retrieves appropriate examples based on mode</li>
<li>Formats examples with positive/negative labels</li>
<li>Constructs a system prompt containing the examples</li>
<li>Applies the model's chat template (if available) to combine system prompt and user message</li>
<li>Re-encodes the adapted text to tokens</li>
</ol>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="list">list</span>[<span title="int">int</span>] | <span title="torch.Tensor">Tensor</span>, <span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]], <span title="list">list</span>[<span title="int">int</span>] | <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A prompt adapter function.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If tokenizer is not set (requires calling <code>steer()</code> first)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Warns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>UserWarning</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Issued when:</p>
<ul>
<li>No examples available from either pools or runtime_kwargs</li>
<li>No examples remain after selection/sampling</li>
<li>Tokenizer lacks chat_template support (falls back to direct prepending)</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/few_shot/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_prompt_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a prompt adapter function that adds few-shot examples to the model&#39;s system prompt. Creates and</span>
<span class="sd">    returns a closure that modifies input token sequences by prepending few-shot examples.</span>

<span class="sd">    The returned adapter function performs the following steps:</span>

<span class="sd">    1. Determines operational mode (runtime examples take precedence over pools)</span>
<span class="sd">    2. Decodes input tokens to retrieve the original user message</span>
<span class="sd">    3. Selects or retrieves appropriate examples based on mode</span>
<span class="sd">    4. Formats examples with positive/negative labels</span>
<span class="sd">    5. Constructs a system prompt containing the examples</span>
<span class="sd">    6. Applies the model&#39;s chat template (if available) to combine system prompt and user message</span>
<span class="sd">    7. Re-encodes the adapted text to tokens</span>

<span class="sd">    Returns:</span>
<span class="sd">        A prompt adapter function.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If tokenizer is not set (requires calling `steer()` first)</span>

<span class="sd">    Warnings:</span>
<span class="sd">        UserWarning: Issued when:</span>

<span class="sd">            - No examples available from either pools or runtime_kwargs</span>
<span class="sd">            - No examples remain after selection/sampling</span>
<span class="sd">            - Tokenizer lacks chat_template support (falls back to direct prepending)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;FewShot needs a tokenizer; call .steer() first.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">adapter</span><span class="p">(</span><span class="n">input_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>

        <span class="c1"># infer mode from arguments</span>
        <span class="n">using_runtime_examples</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime_kwargs</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;positive_examples&quot;</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span>
                                                      <span class="s2">&quot;negative_examples&quot;</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">))</span>
        <span class="n">using_pool_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">using_runtime_examples</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">using_pool_mode</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;FewShot: No examples provided via runtime_kwargs or example pools. &quot;</span>
                <span class="s2">&quot;Returning original input unchanged.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">input_ids</span>

        <span class="c1"># decode to retrieve user message</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">input_ids_list</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_ids_list</span> <span class="o">=</span> <span class="n">input_ids</span>

        <span class="n">original_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get examples based on mode</span>
        <span class="k">if</span> <span class="n">using_runtime_examples</span><span class="p">:</span>
            <span class="n">examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gather_runtime_examples</span><span class="p">(</span><span class="n">runtime_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_from_pools</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">examples</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;FewShot: No examples available after selection. Returning original input unchanged.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">input_ids</span>

        <span class="n">examples_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_examples</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>

        <span class="c1"># apply chat template</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">examples_text</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">original_text</span><span class="p">}</span>
            <span class="p">]</span>
            <span class="n">adapted_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;No chat template found for tokenizer. Prepending few-shot examples directly to user query.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span>
            <span class="p">)</span>
            <span class="n">adapted_text</span> <span class="o">=</span> <span class="n">examples_text</span> <span class="o">+</span> <span class="n">original_text</span>

        <span class="c1"># encode the adapted text</span>
        <span class="n">adapted_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">adapted_text</span><span class="p">,</span>
            <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">adapted_tokens</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">adapted_tokens</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">adapted_tokens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">adapted_tokens</span>

    <span class="k">return</span> <span class="n">adapter</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.input_control.few_shot.control.FewShot.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Optional steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/few_shot/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>

    <span class="c1"># initialize selector if using pool mode</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">negative_example_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector_name</span><span class="p">:</span>
            <span class="n">selector_cls</span> <span class="o">=</span> <span class="n">SELECTOR_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selector_name</span><span class="p">,</span> <span class="n">RandomSelector</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">selector_cls</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">RandomSelector</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.input_control.few_shot.selectors" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>selectors</code>


</h6>

    <div class="doc doc-contents ">

        <p>Example selectors for few-shot learning prompt adaptation.</p>
<p>This module provides different strategies for selecting examples from pools during few-shot prompting. Selectors
determine which examples are passed as demonstrations to the model.</p>
<p>Available selectors:</p>
<ul>
<li><code>RandomSelector</code>: Randomly samples examples from the pool</li>
</ul>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.input_control.few_shot.selectors.SELECTOR_REGISTRY" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">SELECTOR_REGISTRY</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;random&#39;</span><span class="p">:</span> <span class="n">RandomSelector</span><span class="p">}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>





<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.input_control.few_shot.selectors.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base</code>


</h7>

    <div class="doc doc-contents ">

        <p>Base interface for few-shot example selection strategies.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.algorithms.input_control.few_shot.selectors.base.Selector" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Selector</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Base class for example selector.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/input_control/few_shot/selectors/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Selector</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for example selector.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return k items chosen from pool.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.input_control.few_shot.selectors.base.Selector.sample" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

        <p>Return k items chosen from pool.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/few_shot/selectors/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pool</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return k items chosen from pool.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.input_control.few_shot.selectors.random_selector" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>random_selector</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.algorithms.input_control.few_shot.selectors.random_selector.RandomSelector" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>RandomSelector</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Selector (aisteer360.algorithms.input_control.few_shot.selectors.base.Selector)" href="#aisteer360.algorithms.input_control.few_shot.selectors.base.Selector">Selector</a></code></p>


        <p>Selects examples uniformly at random from a pool for few-shot prompting.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/input_control/few_shot/selectors/random_selector.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RandomSelector</span><span class="p">(</span><span class="n">Selector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Selects examples uniformly at random from a pool for few-shot prompting.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select k examples uniformly at random from the pool.</span>

<span class="sd">        Args:</span>
<span class="sd">            pool: Available examples to select from</span>
<span class="sd">            k: Number of examples to select</span>
<span class="sd">            **_: Ignored (for compatibility with other selectors)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of randomly selected examples (up to min(k, len(pool)))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.input_control.few_shot.selectors.random_selector.RandomSelector.sample" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Select k examples uniformly at random from the pool.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pool</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Available examples to select from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of examples to select</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**_</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored (for compatibility with other selectors)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of randomly selected examples (up to min(k, len(pool)))</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/input_control/few_shot/selectors/random_selector.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select k examples uniformly at random from the pool.</span>

<span class="sd">    Args:</span>
<span class="sd">        pool: Available examples to select from</span>
<span class="sd">        k: Number of examples to select</span>
<span class="sd">        **_: Ignored (for compatibility with other selectors)</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of randomly selected examples (up to min(k, len(pool)))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="aisteer360.algorithms.output_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>output_control</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.output_control.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base</code>


</h5>

    <div class="doc doc-contents ">

        <p>Output control base classes.</p>
<p>This module provides the abstract base classes for methods that intervene during text generation (e.g., via modifying
logits, constraining the output space, or implementing alternative decoding strategies).</p>
<p>Two base classes are provided:</p>
<ul>
<li><code>OutputControl</code>: Base class for all output control methods.</li>
<li><code>NoOutputControl</code>: Identity (null) control; used when no output control is defined in steering pipeline.</li>
</ul>
<p>Output controls implement steering through decoding algorithms and constraints, modifying the sampling process to
produce generations y ~ᵈ p_θ(x), where ~ᵈ indicates the modified generation process.</p>
<p>Examples of output controls:</p>
<ul>
<li>Constrained beam search</li>
<li>Reward-augmented decoding</li>
<li>Grammar-constrained generation</li>
<li>Token filtering and masking</li>
<li>Classifier-guided generation</li>
<li>Best-of-N sampling</li>
</ul>
<p>See Also:</p>
<ul>
<li><code>aisteer360.algorithms.output_control</code>: Implementations of output control methods</li>
<li><code>aisteer360.core.steering_pipeline</code>: Integration with steering pipeline</li>
</ul>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.output_control.base.NoOutputControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>NoOutputControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            OutputControl (aisteer360.algorithms.output_control.base.OutputControl)" href="#aisteer360.algorithms.output_control.base.OutputControl">OutputControl</a></code></p>


        <p>Identity output control.</p>
<p>Used as the default when no output control is needed. Calls (unsteered) model's generate.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NoOutputControl</span><span class="p">(</span><span class="n">OutputControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identity output control.</span>

<span class="sd">    Used as the default when no output control is needed. Calls (unsteered) model&#39;s generate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># only for API compliance as runtime_kwargs are not used in HF models.</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null generate operation; applies model&#39;s generate.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.output_control.base.NoOutputControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.output_control.base.NoOutputControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.output_control.base.NoOutputControl.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null generate operation; applies model's generate.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># only for API compliance as runtime_kwargs are not used in HF models.</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
    <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null generate operation; applies model&#39;s generate.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.output_control.base.NoOutputControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Optional steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
          <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
          <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optional steering/preparation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.output_control.base.OutputControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>OutputControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for output control steering methods.</p>
<p>Overrides the generation process with custom logic.</p>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            generate(input_ids, attention_mask, runtime_kwargs, model, **gen_kwargs)

  
      abstractmethod
   (aisteer360.algorithms.output_control.base.OutputControl.generate)" href="#aisteer360.algorithms.output_control.base.OutputControl.generate">generate</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Custom generation (required)</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            steer(model, tokenizer=None, **kwargs) (aisteer360.algorithms.output_control.base.OutputControl.steer)" href="#aisteer360.algorithms.output_control.base.OutputControl.steer">steer</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>One-time preparation (optional)</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OutputControl</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for output control steering methods.</span>

<span class="sd">    Overrides the generation process with custom logic.</span>

<span class="sd">    Methods:</span>
<span class="sd">        generate(input_ids, attention_mask, runtime_kwargs, model, **gen_kwargs) -&gt; Tensor: Custom generation (required)</span>
<span class="sd">        steer(model, tokenizer, **kwargs) -&gt; None: One-time preparation (optional)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseArgs</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># null control</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> accepts no constructor arguments.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> <span class="n">BaseArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># move fields to attributes</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom generation logic.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
              <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optional steering/preparation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.output_control.base.OutputControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.output_control.base.OutputControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.output_control.base.OutputControl.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Custom generation logic.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
    <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom generation logic.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.output_control.base.OutputControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Optional steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
          <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
          <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optional steering/preparation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.output_control.deal" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>deal</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.deal.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.deal.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.output_control.deal.control.DeAL" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>DeAL</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            OutputControl (aisteer360.algorithms.output_control.base.OutputControl)" href="#aisteer360.algorithms.output_control.base.OutputControl">OutputControl</a></code></p>


        <p>Implementation of DeAL (Decoding-time Alignment) from Deng et al., 2024.</p>
<p>DeAL performs controlled text generation through iterative lookahead search and reward-guided beam selection. Unlike
training-time alignment methods, DeAL operates purely at inference time to steer language model outputs toward
desired behaviors.</p>
<p>The algorithm works in three phases:</p>
<ol>
<li>
<p><strong>Lookahead Generation</strong>: Generate multiple candidate continuations using beam search from the current context.</p>
</li>
<li>
<p><strong>Reward-based Scoring</strong>: Evaluate each candidate continuation using a provided reward function that measures
alignment with the desired objective (e.g., helpfulness, safety).</p>
</li>
<li>
<p><strong>Iterative Refinement</strong>: Select the top-k highest-scoring beams and repeat the process until termination
conditions are met (EOS token, max length, or max iterations reached).</p>
</li>
</ol>
<p>This approach allows for flexible alignment with various objectives without requiring model retraining or
fine-tuning.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reward_func</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that scores generated continuations. Should accept
(prompt: str, continuations: list[str], reward_params: dict) and return list[float].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lookahead</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tokens to generate in each lookahead step. Defaults to 4.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>init_beams</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of initial beams to generate at each iteration. Defaults to 8.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>topk</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of top-scoring beams to retain for the next iteration. Defaults to 4.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_iterations</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of search iterations before termination. Defaults to 10.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Reference:</p>
<ul>
<li>"DeAL: Decoding-time Alignment for Large Language Models"
James Y. Huang, Sailik Sengupta, Daniele Bonadiman, Yi-an Lai, Arshit Gupta, Nikolaos Pappas, Saab Mansour,
Katrin Kirchhoff, Dan Roth
https://arxiv.org/abs/2402.06147</li>
</ul>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/deal/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DeAL</span><span class="p">(</span><span class="n">OutputControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of DeAL (Decoding-time Alignment) from Deng et al., 2024.</span>

<span class="sd">    DeAL performs controlled text generation through iterative lookahead search and reward-guided beam selection. Unlike</span>
<span class="sd">    training-time alignment methods, DeAL operates purely at inference time to steer language model outputs toward</span>
<span class="sd">    desired behaviors.</span>

<span class="sd">    The algorithm works in three phases:</span>

<span class="sd">    1. **Lookahead Generation**: Generate multiple candidate continuations using beam search from the current context.</span>

<span class="sd">    2. **Reward-based Scoring**: Evaluate each candidate continuation using a provided reward function that measures</span>
<span class="sd">    alignment with the desired objective (e.g., helpfulness, safety).</span>

<span class="sd">    3. **Iterative Refinement**: Select the top-k highest-scoring beams and repeat the process until termination</span>
<span class="sd">    conditions are met (EOS token, max length, or max iterations reached).</span>

<span class="sd">    This approach allows for flexible alignment with various objectives without requiring model retraining or</span>
<span class="sd">    fine-tuning.</span>

<span class="sd">    Args:</span>
<span class="sd">        reward_func (Callable): Function that scores generated continuations. Should accept</span>
<span class="sd">            (prompt: str, continuations: list[str], reward_params: dict) and return list[float].</span>
<span class="sd">        lookahead (int): Number of tokens to generate in each lookahead step. Defaults to 4.</span>
<span class="sd">        init_beams (int): Number of initial beams to generate at each iteration. Defaults to 8.</span>
<span class="sd">        topk (int): Number of top-scoring beams to retain for the next iteration. Defaults to 4.</span>
<span class="sd">        max_iterations (int): Maximum number of search iterations before termination. Defaults to 10.</span>

<span class="sd">    Reference:</span>

<span class="sd">    - &quot;DeAL: Decoding-time Alignment for Large Language Models&quot;</span>
<span class="sd">    James Y. Huang, Sailik Sengupta, Daniele Bonadiman, Yi-an Lai, Arshit Gupta, Nikolaos Pappas, Saab Mansour,</span>
<span class="sd">    Katrin Kirchhoff, Dan Roth</span>
<span class="sd">    https://arxiv.org/abs/2402.06147</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span> <span class="o">=</span> <span class="n">DeALArgs</span>

    <span class="c1"># placeholders</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_generate</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lightweight preparation; attaches model, tokenizer, and generate to instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_lookahead_generation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">reward_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">dict</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">reward_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">base_generate</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">input_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and score candidate continuations for one lookahead iteration.</span>

<span class="sd">        Generates multiple beam candidates using the base model&#39;s generation method, then evaluates each continuation</span>
<span class="sd">        with the reward function to guide selection.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.Tensor): Current context tokens to continue from.</span>
<span class="sd">                Shape can vary based on number of active beams.</span>
<span class="sd">            reward_func (Callable[[str, list[str], dict], list[float]]): Function to score continuations.</span>
<span class="sd">                Receives (original_prompt, continuation_texts, params).</span>
<span class="sd">            reward_params (dict): Parameters passed to reward function, including algorithm</span>
<span class="sd">                settings (lookahead, init_beams, topk, max_iterations).</span>
<span class="sd">            base_generate (Callable): Generation function used to produce candidate continuations.</span>
<span class="sd">            input_length (int): Length of original input prompt, used to extract only the newly generated portion for</span>
<span class="sd">                scoring.</span>
<span class="sd">            **gen_kwargs: Generation parameters forwarded to base_generate (including num_beams, max_new_tokens, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[float], torch.Tensor]: Tuple containing:</span>
<span class="sd">                - Reward scores for each generated beam (list of floats)</span>
<span class="sd">                - Full token sequences including input and continuations (tensor)</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If reward function returns wrong number of scores (must match number of generated beams).</span>

<span class="sd">        Note:</span>

<span class="sd">        - Continuations are decoded to text for reward evaluation</span>
<span class="sd">        - Special tokens are skipped when extracting continuation text</span>
<span class="sd">        - Stores original prompt in self.prompt for reward function access</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lookaheads</span> <span class="o">=</span> <span class="n">base_generate</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
        <span class="n">continuations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
            <span class="n">lookaheads</span><span class="p">[:,</span> <span class="n">input_length</span><span class="p">:],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">reward_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span> <span class="n">continuations</span><span class="p">,</span> <span class="n">reward_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lookaheads</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward function returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="si">}</span><span class="s2"> scores for </span><span class="si">{</span><span class="n">lookaheads</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> beams.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span><span class="p">,</span> <span class="n">lookaheads</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute guided generation with iterative lookahead search and reward-based selection. Returns the</span>
<span class="sd">        highest-scoring generation.</span>

<span class="sd">        The generation process is as follows:</span>

<span class="sd">        1. Generate `init_beams` candidate continuations of `lookahead` tokens each</span>
<span class="sd">        2. Score all candidates using the provided reward function</span>
<span class="sd">        3. Select top-k highest scoring beams</span>
<span class="sd">        4. Check termination conditions (EOS, max length, max iterations)</span>
<span class="sd">        5. If not terminated, continue from the selected beams</span>
<span class="sd">        6. Return the highest-scoring complete generation</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.Tensor): Input token IDs of shape [1, seq_len].</span>
<span class="sd">                Currently only supports single prompts (batch size must be 1).</span>
<span class="sd">            attention_mask (torch.Tensor): Attention mask matching input_ids shape.</span>
<span class="sd">                Automatically recomputed during iteration based on padding tokens.</span>
<span class="sd">            runtime_kwargs (dict | None): Runtime parameters including:</span>

<span class="sd">                - &quot;base_generate&quot; (`Callable`, optional): Override the model&#39;s generate function</span>
<span class="sd">                - &quot;reward_params&quot; (`dict`, optional): Additional parameters passed to reward_func</span>
<span class="sd">            model (PreTrainedModel): The language model used for generation.</span>
<span class="sd">                Must match the model provided during steer().</span>
<span class="sd">            **gen_kwargs: Generation parameters passed to the underlying model.generate().</span>
<span class="sd">                Note: `max_new_tokens` is extracted and used as global limit; `num_beams` and `num_return_sequences` are</span>
<span class="sd">                overridden by DeAL parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Generated token IDs of shape [1, output_len] or [output_len].</span>
<span class="sd">                Contains the highest-scoring complete generation found during search.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If base_generate is not callable</span>
<span class="sd">            NotImplementedError: If input has batch size &gt; 1 (multiple prompts not supported)</span>
<span class="sd">            RuntimeError: If reward function returns incorrect number of scores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">reward_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_func</span>
        <span class="n">base_generate</span> <span class="o">=</span> <span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_generate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">base_generate</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;base_generate&#39; must be callable; supplied or cached from steer().&quot;</span><span class="p">)</span>

        <span class="c1"># assert (</span>
        <span class="c1">#     self.model is not None and self.tokenizer is not None</span>
        <span class="c1"># ), &quot;DeAL.steer() must run before generate().&quot;</span>

        <span class="k">if</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Current DeAL implementation handles one prompt at a time.&quot;</span><span class="p">)</span>

        <span class="c1"># record call‑specific objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">input_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">reward_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reward_params&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="s2">&quot;lookahead&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookahead</span><span class="p">,</span>
            <span class="s2">&quot;init_beams&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_beams</span><span class="p">,</span>
            <span class="s2">&quot;topk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span>
            <span class="s2">&quot;max_iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">original_max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># search loop</span>
        <span class="n">best_beam</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>
        <span class="n">current_input_ids</span> <span class="o">=</span> <span class="n">input_ids</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">:</span>
            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_input_ids</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="n">gen_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="p">)</span>
            <span class="n">gen_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;max_new_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookahead</span><span class="p">,</span>
                    <span class="s2">&quot;num_beams&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_beams</span><span class="p">,</span>
                    <span class="s2">&quot;num_return_sequences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_beams</span><span class="p">,</span>
                    <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># rollout + scoring</span>
            <span class="n">scores</span><span class="p">,</span> <span class="n">beams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookahead_generation</span><span class="p">(</span>
                <span class="n">current_input_ids</span><span class="p">,</span>
                <span class="n">reward_func</span><span class="o">=</span><span class="n">reward_func</span><span class="p">,</span>
                <span class="n">reward_params</span><span class="o">=</span><span class="n">reward_params</span><span class="p">,</span>
                <span class="n">base_generate</span><span class="o">=</span><span class="n">base_generate</span><span class="p">,</span>
                <span class="n">input_length</span><span class="o">=</span><span class="n">input_length</span><span class="p">,</span>
                <span class="o">**</span><span class="n">gen_args</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># select top-k</span>
            <span class="n">score_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">beams</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">topk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span> <span class="n">score_tensor</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
            <span class="n">top_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">score_tensor</span><span class="p">,</span> <span class="n">topk</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span>
            <span class="n">beams</span> <span class="o">=</span> <span class="n">beams</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">score_tensor</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="c1"># termination mask</span>
            <span class="n">finished_flags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
                <span class="n">eos_hit</span> <span class="o">=</span> <span class="n">beam</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
                <span class="n">len_hit</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">original_max_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">beam</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">input_length</span> <span class="o">&gt;=</span> <span class="n">original_max_tokens</span>
                <span class="p">)</span>
                <span class="n">finished_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">eos_hit</span> <span class="ow">or</span> <span class="n">len_hit</span><span class="p">))</span>

            <span class="c1"># update best-so-far</span>
            <span class="n">best_local</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">scores</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="n">best_local</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">best_local</span><span class="p">]</span>
                <span class="n">best_beam</span> <span class="o">=</span> <span class="n">beams</span><span class="p">[</span><span class="n">best_local</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">finished_flags</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># prune unfinished beams for next round</span>
            <span class="n">current_input_ids</span> <span class="o">=</span> <span class="n">beams</span><span class="p">[</span>
                <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">finished_flags</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">]</span>
            <span class="p">]</span>

        <span class="n">final_ids</span> <span class="o">=</span> <span class="n">best_beam</span> <span class="k">if</span> <span class="n">best_beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">final_ids</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.deal.control.DeAL.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.deal.control.DeAL.base_generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_generate</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.deal.control.DeAL.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.deal.control.DeAL.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.deal.control.DeAL.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.deal.control.DeAL.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Execute guided generation with iterative lookahead search and reward-based selection. Returns the
highest-scoring generation.</p>
<p>The generation process is as follows:</p>
<ol>
<li>Generate <code>init_beams</code> candidate continuations of <code>lookahead</code> tokens each</li>
<li>Score all candidates using the provided reward function</li>
<li>Select top-k highest scoring beams</li>
<li>Check termination conditions (EOS, max length, max iterations)</li>
<li>If not terminated, continue from the selected beams</li>
<li>Return the highest-scoring complete generation</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDs of shape [1, seq_len].
Currently only supports single prompts (batch size must be 1).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attention_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Attention mask matching input_ids shape.
Automatically recomputed during iteration based on padding tokens.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runtime parameters including:</p>
<ul>
<li>"base_generate" (<code>Callable</code>, optional): Override the model's generate function</li>
<li>"reward_params" (<code>dict</code>, optional): Additional parameters passed to reward_func</li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The language model used for generation.
Must match the model provided during steer().</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**gen_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generation parameters passed to the underlying model.generate().
Note: <code>max_new_tokens</code> is extracted and used as global limit; <code>num_beams</code> and <code>num_return_sequences</code> are
overridden by DeAL parameters.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: Generated token IDs of shape [1, output_len] or [output_len].
Contains the highest-scoring complete generation found during search.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If base_generate is not callable</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="NotImplementedError">NotImplementedError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If input has batch size &gt; 1 (multiple prompts not supported)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If reward function returns incorrect number of scores</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/deal/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
    <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute guided generation with iterative lookahead search and reward-based selection. Returns the</span>
<span class="sd">    highest-scoring generation.</span>

<span class="sd">    The generation process is as follows:</span>

<span class="sd">    1. Generate `init_beams` candidate continuations of `lookahead` tokens each</span>
<span class="sd">    2. Score all candidates using the provided reward function</span>
<span class="sd">    3. Select top-k highest scoring beams</span>
<span class="sd">    4. Check termination conditions (EOS, max length, max iterations)</span>
<span class="sd">    5. If not terminated, continue from the selected beams</span>
<span class="sd">    6. Return the highest-scoring complete generation</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids (torch.Tensor): Input token IDs of shape [1, seq_len].</span>
<span class="sd">            Currently only supports single prompts (batch size must be 1).</span>
<span class="sd">        attention_mask (torch.Tensor): Attention mask matching input_ids shape.</span>
<span class="sd">            Automatically recomputed during iteration based on padding tokens.</span>
<span class="sd">        runtime_kwargs (dict | None): Runtime parameters including:</span>

<span class="sd">            - &quot;base_generate&quot; (`Callable`, optional): Override the model&#39;s generate function</span>
<span class="sd">            - &quot;reward_params&quot; (`dict`, optional): Additional parameters passed to reward_func</span>
<span class="sd">        model (PreTrainedModel): The language model used for generation.</span>
<span class="sd">            Must match the model provided during steer().</span>
<span class="sd">        **gen_kwargs: Generation parameters passed to the underlying model.generate().</span>
<span class="sd">            Note: `max_new_tokens` is extracted and used as global limit; `num_beams` and `num_return_sequences` are</span>
<span class="sd">            overridden by DeAL parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Generated token IDs of shape [1, output_len] or [output_len].</span>
<span class="sd">            Contains the highest-scoring complete generation found during search.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If base_generate is not callable</span>
<span class="sd">        NotImplementedError: If input has batch size &gt; 1 (multiple prompts not supported)</span>
<span class="sd">        RuntimeError: If reward function returns incorrect number of scores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">reward_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_func</span>
    <span class="n">base_generate</span> <span class="o">=</span> <span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_generate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">base_generate</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;base_generate&#39; must be callable; supplied or cached from steer().&quot;</span><span class="p">)</span>

    <span class="c1"># assert (</span>
    <span class="c1">#     self.model is not None and self.tokenizer is not None</span>
    <span class="c1"># ), &quot;DeAL.steer() must run before generate().&quot;</span>

    <span class="k">if</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Current DeAL implementation handles one prompt at a time.&quot;</span><span class="p">)</span>

    <span class="c1"># record call‑specific objects</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">input_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">reward_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reward_params&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;lookahead&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookahead</span><span class="p">,</span>
        <span class="s2">&quot;init_beams&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_beams</span><span class="p">,</span>
        <span class="s2">&quot;topk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span>
        <span class="s2">&quot;max_iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">original_max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># search loop</span>
    <span class="n">best_beam</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>
    <span class="n">current_input_ids</span> <span class="o">=</span> <span class="n">input_ids</span>
    <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span><span class="p">:</span>
        <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_input_ids</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
        <span class="n">gen_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="p">)</span>
        <span class="n">gen_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;max_new_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookahead</span><span class="p">,</span>
                <span class="s2">&quot;num_beams&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_beams</span><span class="p">,</span>
                <span class="s2">&quot;num_return_sequences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_beams</span><span class="p">,</span>
                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># rollout + scoring</span>
        <span class="n">scores</span><span class="p">,</span> <span class="n">beams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookahead_generation</span><span class="p">(</span>
            <span class="n">current_input_ids</span><span class="p">,</span>
            <span class="n">reward_func</span><span class="o">=</span><span class="n">reward_func</span><span class="p">,</span>
            <span class="n">reward_params</span><span class="o">=</span><span class="n">reward_params</span><span class="p">,</span>
            <span class="n">base_generate</span><span class="o">=</span><span class="n">base_generate</span><span class="p">,</span>
            <span class="n">input_length</span><span class="o">=</span><span class="n">input_length</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gen_args</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># select top-k</span>
        <span class="n">score_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">beams</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">topk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span> <span class="n">score_tensor</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">score_tensor</span><span class="p">,</span> <span class="n">topk</span><span class="p">)</span><span class="o">.</span><span class="n">indices</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="n">beams</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">score_tensor</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># termination mask</span>
        <span class="n">finished_flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="p">:</span>
            <span class="n">eos_hit</span> <span class="o">=</span> <span class="n">beam</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
            <span class="n">len_hit</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">original_max_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">beam</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">input_length</span> <span class="o">&gt;=</span> <span class="n">original_max_tokens</span>
            <span class="p">)</span>
            <span class="n">finished_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">eos_hit</span> <span class="ow">or</span> <span class="n">len_hit</span><span class="p">))</span>

        <span class="c1"># update best-so-far</span>
        <span class="n">best_local</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">scores</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="n">best_local</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">best_local</span><span class="p">]</span>
            <span class="n">best_beam</span> <span class="o">=</span> <span class="n">beams</span><span class="p">[</span><span class="n">best_local</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">finished_flags</span><span class="p">):</span>
            <span class="k">break</span>

        <span class="c1"># prune unfinished beams for next round</span>
        <span class="n">current_input_ids</span> <span class="o">=</span> <span class="n">beams</span><span class="p">[</span>
            <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">finished_flags</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="n">final_ids</span> <span class="o">=</span> <span class="n">best_beam</span> <span class="k">if</span> <span class="n">best_beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">final_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.deal.control.DeAL.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Lightweight preparation; attaches model, tokenizer, and generate to instance.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/deal/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">_</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lightweight preparation; attaches model, tokenizer, and generate to instance.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.output_control.rad" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>rad</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.rad.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.rad.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.output_control.rad.control.GPT2RewardModel" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>GPT2RewardModel</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


        <p>GPT-2 based reward model for scoring text toxicity or other attributes.</p>
<p>Modified GPT-2 architecture where the language modeling head is replaced with a classification head. Used to score
text sequences for desired attributes during RAD-guided generation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>reward_model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base GPT-2 model variant to use. Defaults to "gpt2".</p>
              </div>
            </td>
            <td>
                  <code>&#39;gpt2&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_features</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of output classes/attributes. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GPT2RewardModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GPT-2 based reward model for scoring text toxicity or other attributes.</span>

<span class="sd">    Modified GPT-2 architecture where the language modeling head is replaced with a classification head. Used to score</span>
<span class="sd">    text sequences for desired attributes during RAD-guided generation.</span>

<span class="sd">    Args:</span>
<span class="sd">        reward_model_name (str): Base GPT-2 model variant to use. Defaults to &quot;gpt2&quot;.</span>
<span class="sd">        out_features (int): Number of output classes/attributes. Defaults to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reward_model_name</span><span class="o">=</span><span class="s2">&quot;gpt2&quot;</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GPT2RewardModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">GPT2LMHeadModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">reward_model_name</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">in_features</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="n">out_features</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eos_token_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">past_key_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">token_type_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">head_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass through reward model.</span>

<span class="sd">        Processes input through GPT-2 backbone and returns scores from the classification head at the last valid token</span>
<span class="sd">        position for each sequence.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids: Token IDs of shape [batch_size, seq_len].</span>
<span class="sd">            past_key_values: Cached key-value pairs for efficient generation.</span>
<span class="sd">            attention_mask: Attention mask for padding.</span>
<span class="sd">            token_type_ids: Token type IDs (unused for GPT-2).</span>
<span class="sd">            position_ids: Position embeddings.</span>
<span class="sd">            head_mask: Attention head mask.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Classification scores of shape [batch_size, out_features].</span>
<span class="sd">                Extracted from the last non-padding position of each sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
            <span class="n">past_key_values</span><span class="o">=</span><span class="n">past_key_values</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
            <span class="n">token_type_ids</span><span class="o">=</span><span class="n">token_type_ids</span><span class="p">,</span>
            <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
            <span class="n">head_mask</span><span class="o">=</span><span class="n">head_mask</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">]</span>
        <span class="c1"># find the last valid token&#39;s ids</span>
        <span class="n">sequence_lengths</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># use the last valid token&#39;s representation: (batch, max_length, out_features) =&gt; (batch, out_features)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">sequence_lengths</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">scores</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.GPT2RewardModel.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">model</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.GPT2RewardModel.out_features" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">out_features</span> <span class="o">=</span> <span class="n">out_features</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.GPT2RewardModel.pad_token_id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eos_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.rad.control.GPT2RewardModel.forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">past_key_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">token_type_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">head_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Forward pass through reward model.</p>
<p>Processes input through GPT-2 backbone and returns scores from the classification head at the last valid token
position for each sequence.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token IDs of shape [batch_size, seq_len].</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>past_key_values</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<span title="torch.FloatTensor">FloatTensor</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cached key-value pairs for efficient generation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attention_mask</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Attention mask for padding.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token_type_ids</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token type IDs (unused for GPT-2).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>position_ids</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Position embeddings.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>head_mask</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Attention head mask.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: Classification scores of shape [batch_size, out_features].
Extracted from the last non-padding position of each sequence.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">past_key_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">token_type_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">position_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">head_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward pass through reward model.</span>

<span class="sd">    Processes input through GPT-2 backbone and returns scores from the classification head at the last valid token</span>
<span class="sd">    position for each sequence.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids: Token IDs of shape [batch_size, seq_len].</span>
<span class="sd">        past_key_values: Cached key-value pairs for efficient generation.</span>
<span class="sd">        attention_mask: Attention mask for padding.</span>
<span class="sd">        token_type_ids: Token type IDs (unused for GPT-2).</span>
<span class="sd">        position_ids: Position embeddings.</span>
<span class="sd">        head_mask: Attention head mask.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Classification scores of shape [batch_size, out_features].</span>
<span class="sd">            Extracted from the last non-padding position of each sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
        <span class="n">past_key_values</span><span class="o">=</span><span class="n">past_key_values</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span>
        <span class="n">token_type_ids</span><span class="o">=</span><span class="n">token_type_ids</span><span class="p">,</span>
        <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
        <span class="n">head_mask</span><span class="o">=</span><span class="n">head_mask</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">]</span>
    <span class="c1"># find the last valid token&#39;s ids</span>
    <span class="n">sequence_lengths</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># use the last valid token&#39;s representation: (batch, max_length, out_features) =&gt; (batch, out_features)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">sequence_lengths</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">scores</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.output_control.rad.control.RAD" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>RAD</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            OutputControl (aisteer360.algorithms.output_control.base.OutputControl)" href="#aisteer360.algorithms.output_control.base.OutputControl">OutputControl</a></code></p>


        <p>Implementation of RAD (Reward-Augmented Decoding) from Deng and Raffel, 2023.
Integrated from the official implementation of RAD (<a href="https://github.com/r-three/RAD?tab=readme-ov-file">https://github.com/r-three/RAD?tab=readme-ov-file</a>).</p>
<p>RAD works in two phases:</p>
<ol>
<li>
<p><strong>Reward model training</strong>: Train a reward model with a lebeled dataset containing texts and labels.
For detials about this step, please see <a href="https://github.com/r-three/RAD?tab=readme-ov-file">https://github.com/r-three/RAD?tab=readme-ov-file</a>. We skip this
step in this implementation and re-use the open-source toxicity reward model trained by the authors via
gdown <a href="https://storage.googleapis.com/rad_release/saved_models.zip">https://storage.googleapis.com/rad_release/saved_models.zip</a></p>
</li>
<li>
<p><strong>Controlled decoding</strong>: At every decoding step the candidate-token logits are shifted by <strong>beta * reward</strong>,
where the <em>reward</em> is given by a trained reward model.</p>
</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>beta</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Steering intensity. Defaults to 0.0.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reward_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the trained reward model. See <a href="https://github.com/r-three/RAD">https://github.com/r-three/RAD</a> for details. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Reference:</p>
<ul>
<li>"Reward-Augmented Decoding: Efficient Controlled Text Generation With a Unidirectional Reward Model" Haikang Deng,
 Colin Raffel
 <a href="https://arxiv.org/abs/2310.09520">https://arxiv.org/abs/2310.09520</a></li>
</ul>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RAD</span><span class="p">(</span><span class="n">OutputControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of RAD (Reward-Augmented Decoding) from Deng and Raffel, 2023.</span>
<span class="sd">    Integrated from the official implementation of RAD ([https://github.com/r-three/RAD?tab=readme-ov-file](https://github.com/r-three/RAD?tab=readme-ov-file)).</span>

<span class="sd">    RAD works in two phases:</span>

<span class="sd">    1. **Reward model training**: Train a reward model with a lebeled dataset containing texts and labels.</span>
<span class="sd">    For detials about this step, please see [https://github.com/r-three/RAD?tab=readme-ov-file](https://github.com/r-three/RAD?tab=readme-ov-file). We skip this</span>
<span class="sd">    step in this implementation and re-use the open-source toxicity reward model trained by the authors via</span>
<span class="sd">    gdown [https://storage.googleapis.com/rad_release/saved_models.zip](https://storage.googleapis.com/rad_release/saved_models.zip)</span>

<span class="sd">    2. **Controlled decoding**: At every decoding step the candidate-token logits are shifted by **beta * reward**,</span>
<span class="sd">    where the *reward* is given by a trained reward model.</span>

<span class="sd">    Args:</span>
<span class="sd">        beta (float): Steering intensity. Defaults to 0.0.</span>
<span class="sd">        reward_path (str, optional): Path to the trained reward model. See [https://github.com/r-three/RAD](https://github.com/r-three/RAD) for details. Defaults to None.</span>

<span class="sd">    Reference:</span>

<span class="sd">    - &quot;Reward-Augmented Decoding: Efficient Controlled Text Generation With a Unidirectional Reward Model&quot; Haikang Deng,</span>
<span class="sd">     Colin Raffel</span>
<span class="sd">     [https://arxiv.org/abs/2310.09520](https://arxiv.org/abs/2310.09520)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Args</span> <span class="o">=</span> <span class="n">RADArgs</span>

    <span class="c1"># placeholders (filled by steer)</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_generate</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">__</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize RAD by loading and configuring the reward model.</span>

<span class="sd">        Sets up the toxicity reward model used for steering during generation. Automatically downloads the model</span>
<span class="sd">        from the RAD repository if not found locally.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">            tokenizer (PreTrainedTokenizer | None): Tokenizer for the base model.</span>
<span class="sd">                If None, attempts to retrieve from model attributes.</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            PreTrainedModel: The input model, unchanged.</span>

<span class="sd">        Note:</span>

<span class="sd">        - Downloads ~500MB reward model on first use if not cached</span>
<span class="sd">        - Reward model is GPT2-based with 7 toxicity classification heads</span>
<span class="sd">        - Model weights are loaded onto the same device as the base model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>

        <span class="c1"># load reward model from rad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;gpt2&quot;</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">,</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward model not found in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="si">}</span><span class="s2">. Downloading from https://github.com/r-three/RAD......&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gdown</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;gdown&quot;</span><span class="p">])</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">gdown</span>
            <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;https://storage.googleapis.com/rad_release/saved_models.zip&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;./tmp/rad_saved_models.zip&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&quot;./tmp/rad_saved_models.zip&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;./tmp/rad_saved_models&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reward model downloaded. Please set reward_path=&#39;./tmp/rad_saved_models/saved_models/gpt2_toxicity&#39; in the future.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward model found in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span> <span class="o">=</span> <span class="s1">&#39;./tmp/rad_saved_models/saved_models/gpt2_toxicity&#39;</span>
        <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">,</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">GPT2RewardModel</span><span class="p">(</span><span class="n">reward_model_name</span><span class="o">=</span><span class="s2">&quot;gpt2&quot;</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reward model is loaded.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute RAD-guided generation with reward-augmented logits processing.</span>

<span class="sd">        Performs controlled generation by shifting token logits at each decoding step based on reward model scores.</span>
<span class="sd">        Returns generated text steered toward desired behavior.</span>

<span class="sd">        At each decoding step:</span>

<span class="sd">        1. Generate top-k candidate next tokens</span>
<span class="sd">        2. Score each candidate continuation with the reward model</span>
<span class="sd">        3. Adjust logits by beta * reward_score</span>
<span class="sd">        4. Sample from adjusted distribution</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.Tensor): Input token IDs of shape [batch_size, seq_len].</span>
<span class="sd">            attention_mask (torch.Tensor): Attention mask matching input_ids shape.</span>
<span class="sd">            runtime_kwargs (dict | None): Runtime parameters (currently unused).</span>
<span class="sd">            model (PreTrainedModel): The language model used for generation.</span>
<span class="sd">                Must match the model provided during steer().</span>
<span class="sd">            **gen_kwargs: Generation parameters passed to model.generate():</span>

<span class="sd">                - &quot;temperature&quot; (`float`, optional): Sampling temperature. Defaults to 1.0.</span>
<span class="sd">                - &quot;top_k&quot; (`int`, optional): Top-k filtering. Defaults to 0 (disabled).</span>
<span class="sd">                - &quot;top_p&quot; (`float`, optional): Nucleus sampling threshold. Defaults to 1.0.</span>
<span class="sd">                - &quot;repetition_penalty&quot; (`float`, optional): Penalty for repeated tokens. Defaults to 1.0.</span>
<span class="sd">                - Other standard generation arguments (max_length, pad_token_id, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Generated token IDs with same batch dimension as input.</span>

<span class="sd">        Note:</span>

<span class="sd">        - Requires reward model to be loaded during steer() phase</span>
<span class="sd">        - When both top_k and top_p are specified, top_k takes precedence for RAD processing</span>
<span class="sd">        - Reward scores are clamped to [0, 1] and inverted (1 - score) for toxicity reduction</span>
<span class="sd">        - Non-top-k tokens are set to -inf to ensure selection from reward-adjusted candidates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>

        <span class="n">processors</span> <span class="o">=</span> <span class="n">LogitsProcessorList</span><span class="p">()</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temperature</span> <span class="ow">and</span> <span class="n">temperature</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemperatureLogitsWarper</span><span class="p">(</span><span class="n">temperature</span><span class="p">))</span>

        <span class="n">top_k</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="n">top_k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TopKLogitsWarper</span><span class="p">(</span><span class="n">top_k</span><span class="p">))</span>
            <span class="n">rad_topk</span> <span class="o">=</span> <span class="n">top_k</span>
            <span class="n">rad_topp</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">top_p</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top_p&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top_p</span> <span class="ow">and</span> <span class="n">top_p</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TopPLogitsWarper</span><span class="p">(</span><span class="n">top_p</span><span class="p">))</span>
            <span class="n">rad_topp</span> <span class="o">=</span> <span class="n">top_p</span>
            <span class="n">rad_topk</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">repetition_penalty</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repetition_penalty&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">repetition_penalty</span> <span class="ow">and</span> <span class="n">repetition_penalty</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RepetitionPenaltyLogitsProcessor</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="n">repetition_penalty</span><span class="p">))</span>

        <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RewardAugmentedLogitsProcessorNoPkv</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="p">,</span>
                        <span class="n">topk</span><span class="o">=</span><span class="n">rad_topk</span><span class="p">,</span>
                        <span class="n">topp</span><span class="o">=</span><span class="n">rad_topp</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                        <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                        <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># generate candidates</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">logits_processor</span><span class="o">=</span><span class="n">processors</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.base_generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_generate</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.beta" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">beta</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Execute RAD-guided generation with reward-augmented logits processing.</p>
<p>Performs controlled generation by shifting token logits at each decoding step based on reward model scores.
Returns generated text steered toward desired behavior.</p>
<p>At each decoding step:</p>
<ol>
<li>Generate top-k candidate next tokens</li>
<li>Score each candidate continuation with the reward model</li>
<li>Adjust logits by beta * reward_score</li>
<li>Sample from adjusted distribution</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDs of shape [batch_size, seq_len].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attention_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Attention mask matching input_ids shape.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runtime parameters (currently unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The language model used for generation.
Must match the model provided during steer().</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**gen_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generation parameters passed to model.generate():</p>
<ul>
<li>"temperature" (<code>float</code>, optional): Sampling temperature. Defaults to 1.0.</li>
<li>"top_k" (<code>int</code>, optional): Top-k filtering. Defaults to 0 (disabled).</li>
<li>"top_p" (<code>float</code>, optional): Nucleus sampling threshold. Defaults to 1.0.</li>
<li>"repetition_penalty" (<code>float</code>, optional): Penalty for repeated tokens. Defaults to 1.0.</li>
<li>Other standard generation arguments (max_length, pad_token_id, etc.)</li>
</ul>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: Generated token IDs with same batch dimension as input.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>Requires reward model to be loaded during steer() phase</li>
<li>When both top_k and top_p are specified, top_k takes precedence for RAD processing</li>
<li>Reward scores are clamped to [0, 1] and inverted (1 - score) for toxicity reduction</li>
<li>Non-top-k tokens are set to -inf to ensure selection from reward-adjusted candidates</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute RAD-guided generation with reward-augmented logits processing.</span>

<span class="sd">    Performs controlled generation by shifting token logits at each decoding step based on reward model scores.</span>
<span class="sd">    Returns generated text steered toward desired behavior.</span>

<span class="sd">    At each decoding step:</span>

<span class="sd">    1. Generate top-k candidate next tokens</span>
<span class="sd">    2. Score each candidate continuation with the reward model</span>
<span class="sd">    3. Adjust logits by beta * reward_score</span>
<span class="sd">    4. Sample from adjusted distribution</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids (torch.Tensor): Input token IDs of shape [batch_size, seq_len].</span>
<span class="sd">        attention_mask (torch.Tensor): Attention mask matching input_ids shape.</span>
<span class="sd">        runtime_kwargs (dict | None): Runtime parameters (currently unused).</span>
<span class="sd">        model (PreTrainedModel): The language model used for generation.</span>
<span class="sd">            Must match the model provided during steer().</span>
<span class="sd">        **gen_kwargs: Generation parameters passed to model.generate():</span>

<span class="sd">            - &quot;temperature&quot; (`float`, optional): Sampling temperature. Defaults to 1.0.</span>
<span class="sd">            - &quot;top_k&quot; (`int`, optional): Top-k filtering. Defaults to 0 (disabled).</span>
<span class="sd">            - &quot;top_p&quot; (`float`, optional): Nucleus sampling threshold. Defaults to 1.0.</span>
<span class="sd">            - &quot;repetition_penalty&quot; (`float`, optional): Penalty for repeated tokens. Defaults to 1.0.</span>
<span class="sd">            - Other standard generation arguments (max_length, pad_token_id, etc.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Generated token IDs with same batch dimension as input.</span>

<span class="sd">    Note:</span>

<span class="sd">    - Requires reward model to be loaded during steer() phase</span>
<span class="sd">    - When both top_k and top_p are specified, top_k takes precedence for RAD processing</span>
<span class="sd">    - Reward scores are clamped to [0, 1] and inverted (1 - score) for toxicity reduction</span>
<span class="sd">    - Non-top-k tokens are set to -inf to ensure selection from reward-adjusted candidates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>

    <span class="n">processors</span> <span class="o">=</span> <span class="n">LogitsProcessorList</span><span class="p">()</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">temperature</span> <span class="ow">and</span> <span class="n">temperature</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemperatureLogitsWarper</span><span class="p">(</span><span class="n">temperature</span><span class="p">))</span>

    <span class="n">top_k</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">top_k</span> <span class="ow">and</span> <span class="n">top_k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TopKLogitsWarper</span><span class="p">(</span><span class="n">top_k</span><span class="p">))</span>
        <span class="n">rad_topk</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="n">rad_topp</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">top_p</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top_p&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">top_p</span> <span class="ow">and</span> <span class="n">top_p</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TopPLogitsWarper</span><span class="p">(</span><span class="n">top_p</span><span class="p">))</span>
        <span class="n">rad_topp</span> <span class="o">=</span> <span class="n">top_p</span>
        <span class="n">rad_topk</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">repetition_penalty</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repetition_penalty&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repetition_penalty</span> <span class="ow">and</span> <span class="n">repetition_penalty</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RepetitionPenaltyLogitsProcessor</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="n">repetition_penalty</span><span class="p">))</span>

    <span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">RewardAugmentedLogitsProcessorNoPkv</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="p">,</span>
                    <span class="n">topk</span><span class="o">=</span><span class="n">rad_topk</span><span class="p">,</span>
                    <span class="n">topp</span><span class="o">=</span><span class="n">rad_topp</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
                    <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                    <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># generate candidates</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span><span class="p">(</span><span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">logits_processor</span><span class="o">=</span><span class="n">processors</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.rad.control.RAD.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Initialize RAD by loading and configuring the reward model.</p>
<p>Sets up the toxicity reward model used for steering during generation. Automatically downloads the model
from the RAD repository if not found locally.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base language model to be steered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for the base model.
If None, attempts to retrieve from model attributes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>PreTrainedModel</code></td>            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input model, unchanged.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>Downloads ~500MB reward model on first use if not cached</li>
<li>Reward model is GPT2-based with 7 toxicity classification heads</li>
<li>Model weights are loaded onto the same device as the base model</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">__</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize RAD by loading and configuring the reward model.</span>

<span class="sd">    Sets up the toxicity reward model used for steering during generation. Automatically downloads the model</span>
<span class="sd">    from the RAD repository if not found locally.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">        tokenizer (PreTrainedTokenizer | None): Tokenizer for the base model.</span>
<span class="sd">            If None, attempts to retrieve from model attributes.</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        PreTrainedModel: The input model, unchanged.</span>

<span class="sd">    Note:</span>

<span class="sd">    - Downloads ~500MB reward model on first use if not cached</span>
<span class="sd">    - Reward model is GPT2-based with 7 toxicity classification heads</span>
<span class="sd">    - Model weights are loaded onto the same device as the base model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>

    <span class="c1"># load reward model from rad</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;gpt2&quot;</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm_tokenizer</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">,</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward model not found in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="si">}</span><span class="s2">. Downloading from https://github.com/r-three/RAD......&quot;</span><span class="p">)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gdown</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;gdown&quot;</span><span class="p">])</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gdown</span>
        <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;https://storage.googleapis.com/rad_release/saved_models.zip&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;./tmp/rad_saved_models.zip&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&quot;./tmp/rad_saved_models.zip&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;./tmp/rad_saved_models&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reward model downloaded. Please set reward_path=&#39;./tmp/rad_saved_models/saved_models/gpt2_toxicity&#39; in the future.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward model found in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span> <span class="o">=</span> <span class="s1">&#39;./tmp/rad_saved_models/saved_models/gpt2_toxicity&#39;</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">,</span> <span class="s2">&quot;pytorch_model.bin&quot;</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm</span> <span class="o">=</span> <span class="n">GPT2RewardModel</span><span class="p">(</span><span class="n">reward_model_name</span><span class="o">=</span><span class="s2">&quot;gpt2&quot;</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reward model is loaded.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.output_control.rad.control.RewardAugmentedLogitsProcessorNoPkv" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>RewardAugmentedLogitsProcessorNoPkv</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="transformers.LogitsProcessor">LogitsProcessor</span></code></p>


        <p>Logits processor that adjusts token probabilities based on reward model scores.</p>
<p>Implements the core RAD algorithm by evaluating candidate tokens with a reward model and shifting their logits
proportionally to the reward scores. Designed to work with transformers' generate() method as part of a
<code>LogitsProcessorList</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lm_tokenizer</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for the language model being steered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rm_tokenizer</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for the reward model (typically GPT-2).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reward_model</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trained reward model that scores text for desired attributes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>topk</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of candidate tokens to evaluate. Defaults to 20.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>topp</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nucleus sampling threshold if using top-p instead of top-k. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reward application method. Currently only "linear" supported. Defaults to "linear".</p>
              </div>
            </td>
            <td>
                  <code>&#39;linear&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>beta</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaling factor for reward scores. Higher values = stronger steering. Defaults to 30.</p>
              </div>
            </td>
            <td>
                  <code>30</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inverse</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to invert reward scores (1 - score). Used for toxicity reduction. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RewardAugmentedLogitsProcessorNoPkv</span><span class="p">(</span><span class="n">LogitsProcessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logits processor that adjusts token probabilities based on reward model scores.</span>

<span class="sd">    Implements the core RAD algorithm by evaluating candidate tokens with a reward model and shifting their logits</span>
<span class="sd">    proportionally to the reward scores. Designed to work with transformers&#39; generate() method as part of a</span>
<span class="sd">    `LogitsProcessorList`.</span>

<span class="sd">    Args:</span>
<span class="sd">        lm_tokenizer: Tokenizer for the language model being steered.</span>
<span class="sd">        rm_tokenizer: Tokenizer for the reward model (typically GPT-2).</span>
<span class="sd">        reward_model: Trained reward model that scores text for desired attributes.</span>
<span class="sd">        topk (int): Number of candidate tokens to evaluate. Defaults to 20.</span>
<span class="sd">        topp (float): Nucleus sampling threshold if using top-p instead of top-k. Defaults to 1.</span>
<span class="sd">        method (str): Reward application method. Currently only &quot;linear&quot; supported. Defaults to &quot;linear&quot;.</span>
<span class="sd">        beta (float): Scaling factor for reward scores. Higher values = stronger steering. Defaults to 30.</span>
<span class="sd">        inverse (bool): Whether to invert reward scores (1 - score). Used for toxicity reduction. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lm_tokenizer</span><span class="p">,</span> <span class="n">rm_tokenizer</span><span class="p">,</span> <span class="n">reward_model</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">topp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lm_tokenizer</span> <span class="o">=</span> <span class="n">lm_tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rm_tokenizer</span> <span class="o">=</span> <span class="n">rm_tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reward_model</span> <span class="o">=</span> <span class="n">reward_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reward_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reward_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topk</span> <span class="o">=</span> <span class="n">topk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topp</span> <span class="o">=</span> <span class="n">topp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span> <span class="o">=</span> <span class="n">inverse</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">scores</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply reward-based adjustments to token logits.</span>

<span class="sd">        For each position in the batch, evaluates top-k candidate tokens by constructing full text sequences, scoring</span>
<span class="sd">        them with the reward model, and adjusting logits.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.LongTensor): Current token sequence of shape [batch_size, seq_len].</span>
<span class="sd">            scores (torch.FloatTensor): Raw logits for next token of shape [batch_size, vocab_size].</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: Adjusted logits with reward-based modifications.</span>
<span class="sd">                Non-candidate tokens are set to -inf to ensure sampling from evaluated tokens only.</span>

<span class="sd">        Note:</span>
<span class="sd">            - Dynamically switches between top-k and top-p candidate selection</span>
<span class="sd">            - Constructs full text for each candidate to enable proper reward model evaluation</span>
<span class="sd">            - Memory usage scales with batch_size * topk for candidate evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topp</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">## top p modification, batch=1</span>
            <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cumulative_probs</span> <span class="o">=</span> <span class="n">sorted_logits</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sorted_indices_to_keep</span> <span class="o">=</span> <span class="n">cumulative_probs</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topp</span><span class="p">)</span>
            <span class="n">indices_to_keep</span> <span class="o">=</span> <span class="n">sorted_indices_to_keep</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">sorted_indices_to_keep</span><span class="p">)</span>
            <span class="n">topk_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">indices_to_keep</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_topk</span> <span class="o">=</span> <span class="n">topk_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">cumulative_probs</span><span class="p">,</span> <span class="n">sorted_indices_to_keep</span><span class="p">,</span> <span class="n">indices_to_keep</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>  <span class="c1"># Ensure immediate deallocation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">topk_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topk</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>                                    <span class="c1"># (batch, topk,)</span>
        <span class="n">input_ids_enflated</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topk</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>                <span class="c1"># (batch, topk, seq_len)</span>
        <span class="n">candidate_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">input_ids_enflated</span><span class="p">,</span> <span class="n">topk_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># (batch, topk, seq_len+1)</span>
        <span class="n">candidate_input_ids_unroll</span> <span class="o">=</span> <span class="n">candidate_input_ids</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span>
            <span class="n">candidate_input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">candidate_input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>         <span class="c1"># (batch*topk, seq_len+1)</span>
        <span class="n">candidate_input_texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lm_tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">candidate_input_ids_unroll</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># return reward scores</span>
        <span class="n">reward_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reward</span><span class="p">(</span><span class="n">candidate_input_texts</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># apply function (topk_scores, logits)</span>
        <span class="k">for</span> <span class="n">score</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">rs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">topk_ids</span><span class="p">,</span> <span class="n">reward_scores</span><span class="p">):</span>

            <span class="n">score</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_function</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">rs</span><span class="p">)</span>
            <span class="n">inverse_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())),</span> <span class="nb">id</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
            <span class="n">score</span><span class="p">[</span><span class="n">inverse_id</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;Inf&quot;</span><span class="p">)</span>  <span class="c1"># set all other scores to -inf</span>
        <span class="k">return</span> <span class="n">scores</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidate_texts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Score candidate text sequences with the reward model.</span>

<span class="sd">        Args:</span>
<span class="sd">            candidate_texts: List of text strings to evaluate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Reward scores for each candidate, extracted from first output head.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
            <span class="c1"># tokenizer should be configured in RAD</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rm_tokenizer</span><span class="o">.</span><span class="n">batch_encode_plus</span><span class="p">(</span>
                <span class="n">candidate_texts</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rm_tokenizer</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>

            <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reward_model</span><span class="p">(</span><span class="o">**</span><span class="n">input_ids</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">reward</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_score</span><span class="p">,</span> <span class="n">reward_score</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply reward adjustment to original logits.</span>

<span class="sd">        Args:</span>
<span class="sd">            original_score: Original logit values for candidate tokens.</span>
<span class="sd">            reward_score: Reward model scores for candidates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Adjusted logits computed as original + (beta * reward).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If method is not &quot;linear&quot;.</span>

<span class="sd">        Note:</span>

<span class="sd">        - Reward scores are clamped to [0, 1] before application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reward_score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">reward_score</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span><span class="p">:</span>
            <span class="n">reward_score</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">reward_score</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">original_score</span> <span class="o">+</span> <span class="p">(</span><span class="n">reward_score</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">original_score</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;method </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="si">}</span><span class="s2"> not supported&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.rad.control.RewardAugmentedLogitsProcessorNoPkv.apply_function" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">apply_function</span><span class="p">(</span><span class="n">original_score</span><span class="p">,</span> <span class="n">reward_score</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Apply reward adjustment to original logits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>original_score</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original logit values for candidate tokens.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reward_score</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reward model scores for candidates.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: Adjusted logits computed as original + (beta * reward).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If method is not "linear".</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>Reward scores are clamped to [0, 1] before application.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_score</span><span class="p">,</span> <span class="n">reward_score</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply reward adjustment to original logits.</span>

<span class="sd">    Args:</span>
<span class="sd">        original_score: Original logit values for candidate tokens.</span>
<span class="sd">        reward_score: Reward model scores for candidates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Adjusted logits computed as original + (beta * reward).</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If method is not &quot;linear&quot;.</span>

<span class="sd">    Note:</span>

<span class="sd">    - Reward scores are clamped to [0, 1] before application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reward_score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">reward_score</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span><span class="p">:</span>
        <span class="n">reward_score</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">reward_score</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">original_score</span> <span class="o">+</span> <span class="p">(</span><span class="n">reward_score</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_beta</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">original_score</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;method </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="si">}</span><span class="s2"> not supported&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.rad.control.RewardAugmentedLogitsProcessorNoPkv.get_reward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_reward</span><span class="p">(</span><span class="n">candidate_texts</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Score candidate text sequences with the reward model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>candidate_texts</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of text strings to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: Reward scores for each candidate, extracted from first output head.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/rad/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidate_texts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Score candidate text sequences with the reward model.</span>

<span class="sd">    Args:</span>
<span class="sd">        candidate_texts: List of text strings to evaluate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Reward scores for each candidate, extracted from first output head.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">():</span>
        <span class="c1"># tokenizer should be configured in RAD</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rm_tokenizer</span><span class="o">.</span><span class="n">batch_encode_plus</span><span class="p">(</span>
            <span class="n">candidate_texts</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rm_tokenizer</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>

        <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reward_model</span><span class="p">(</span><span class="o">**</span><span class="n">input_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reward</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.output_control.sasa" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>sasa</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.sasa.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.sasa.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.output_control.sasa.control.SASA" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SASA</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            OutputControl (aisteer360.algorithms.output_control.base.OutputControl)" href="#aisteer360.algorithms.output_control.base.OutputControl">OutputControl</a></code></p>


        <p>Implementation of SASA (Self-disciplined autoregressive sampling) from Ko et al., 2024.</p>
<p>SASA works in two phases:</p>
<ol>
<li>
<p><strong>Subspace learning</strong>: From a labelled toxic / non-toxic corpus, it fits a linear classifier in the model’s
own sentence-embedding space; the weight vector defines a toxicity subspace.</p>
</li>
<li>
<p><strong>Controlled decoding</strong>: At every decoding step the candidate-token logits are shifted by <strong>beta * margin</strong>,
where <em>margin</em> is the classifier distance of the updated context from the toxic side of the subspace.  Sampling
from the soft-max of these adjusted logits (optionally with nucleus sampling) nudges generation away from
toxic regions while staying close to the original distribution.</p>
</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>beta</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaling coefficient for value redistribution. Defaults to 0.0.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wv_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to a saved steering-vector tensor. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_wv_data_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the value dataset, e.g. sentences with labeled toxicity. Defaults to "Jigsaw_data/".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_wv_length</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of samples used for preparing SASA steering if wv_path does not exist. Defaults to -1 (use all).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_wv_batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The batch size used for preparing SASA steering if wv_path does not exist. Defaults to 4.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Reference:</p>
<ul>
<li>"Large Language Models can Become Strong Self-Detoxifiers"
  Ching-Yun Ko, Pin-Yu Chen, Payel Das, Youssef Mroueh, Soham Dan, Georgios Kollias, Subhajit Chaudhury,
  Tejaswini Pedapati, Luca Daniel
  <a href="https://arxiv.org/abs/2410.03818">https://arxiv.org/abs/2410.03818</a></li>
</ul>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/sasa/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SASA</span><span class="p">(</span><span class="n">OutputControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of SASA (Self-disciplined autoregressive sampling) from Ko et al., 2024.</span>

<span class="sd">    SASA works in two phases:</span>

<span class="sd">    1. **Subspace learning**: From a labelled toxic / non-toxic corpus, it fits a linear classifier in the model’s</span>
<span class="sd">    own sentence-embedding space; the weight vector defines a toxicity subspace.</span>

<span class="sd">    2. **Controlled decoding**: At every decoding step the candidate-token logits are shifted by **beta * margin**,</span>
<span class="sd">    where *margin* is the classifier distance of the updated context from the toxic side of the subspace.  Sampling</span>
<span class="sd">    from the soft-max of these adjusted logits (optionally with nucleus sampling) nudges generation away from</span>
<span class="sd">    toxic regions while staying close to the original distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        beta (float): Scaling coefficient for value redistribution. Defaults to 0.0.</span>
<span class="sd">        wv_path (str, optional): Path to a saved steering-vector tensor. Defaults to None.</span>
<span class="sd">        gen_wv_data_path (str, optional): Path to the value dataset, e.g. sentences with labeled toxicity. Defaults to &quot;Jigsaw_data/&quot;.</span>
<span class="sd">        gen_wv_length (int, optional): The maximum number of samples used for preparing SASA steering if wv_path does not exist. Defaults to -1 (use all).</span>
<span class="sd">        gen_wv_batch_size (int, optional): The batch size used for preparing SASA steering if wv_path does not exist. Defaults to 4.</span>

<span class="sd">    Reference:</span>

<span class="sd">    - &quot;Large Language Models can Become Strong Self-Detoxifiers&quot;</span>
<span class="sd">      Ching-Yun Ko, Pin-Yu Chen, Payel Das, Youssef Mroueh, Soham Dan, Georgios Kollias, Subhajit Chaudhury,</span>
<span class="sd">      Tejaswini Pedapati, Luca Daniel</span>
<span class="sd">      [https://arxiv.org/abs/2410.03818](https://arxiv.org/abs/2410.03818)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Args</span> <span class="o">=</span> <span class="n">SASAArgs</span>

    <span class="c1"># placeholders (filled by steer)</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_generate</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">wv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">__</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize SASA by loading or generating the toxicity steering vector.</span>

<span class="sd">        Sets up the linear classifier in the model&#39;s embedding space that defines the toxicity subspace. Either loads a</span>
<span class="sd">        pre-computed steering vector or generates one from labeled data.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">            tokenizer (PreTrainedTokenizer | None): Tokenizer for the base model.</span>
<span class="sd">                If None, attempts to retrieve from model attributes.</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            PreTrainedModel: The input model (unchanged).</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If gen_wv_data_path doesn&#39;t contain required Jigsaw dataset</span>

<span class="sd">        Note:</span>

<span class="sd">        - If wv_path is provided, loads pre-computed steering vector</span>
<span class="sd">        - Otherwise generates steering vector from Jigsaw toxicity dataset</span>
<span class="sd">        - Steering vector generation uses closed-form Bayes optimal classifier</span>
<span class="sd">        - Saves generated steering vector to &#39;steer_wv.pt&#39; for future use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad_token is absent. Setting it to eos_token or &#39;&lt;pad&gt;&#39;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># edge case</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">({</span><span class="s2">&quot;pad_token&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;pad&gt;&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;wv_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading SASA steer (wv)......&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wv_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating SASA steer (wv)......&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_wv</span><span class="p">()</span>
            <span class="c1"># self.wv =  {k: v.cpu() for k, v in self.wv.item().items()}</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wv</span><span class="p">,</span> <span class="s1">&#39;steer_wv.pt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wv</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wv</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_wv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate steering vector from labeled toxicity data.</span>

<span class="sd">        Loads the Jigsaw toxicity dataset and learns a linear classifier in the model&#39;s embedding space using a</span>
<span class="sd">        closed-form Bayes optimal solution. The resulting weight vector defines the toxicity subspace used during</span>
<span class="sd">        generation.</span>

<span class="sd">        Process:</span>
<span class="sd">        1. Load toxic and non-toxic sentences from Jigsaw dataset</span>
<span class="sd">        2. Generate sentence embeddings using the model&#39;s last hidden states</span>
<span class="sd">        3. Compute mean vectors and covariance matrix for both classes</span>
<span class="sd">        4. Apply SVD for dimensionality reduction and numerical stability</span>
<span class="sd">        5. Compute Bayes optimal linear classifier in reduced space</span>
<span class="sd">        6. Project back to original space and normalize</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If Jigsaw dataset not found at gen_wv_data_path</span>

<span class="sd">        Note:</span>

<span class="sd">        - Uses pooled representation from last non-padding token</span>
<span class="sd">        - Handles NaN embeddings by filtering them out</span>
<span class="sd">        - Saves computed steering vector to &#39;steer_wv.pt&#39;</span>
<span class="sd">        - Batch processing to manage memory usage</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">batcher</span><span class="p">(</span><span class="n">sentences</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Generate sentence embeddings using the model&#39;s hidden states.</span>

<span class="sd">            Args:</span>
<span class="sd">                sentences: List of text strings to embed.</span>

<span class="sd">            Returns:</span>
<span class="sd">                torch.Tensor: Pooled embeddings from last hidden layer, shape [batch_size, hidden_dim].</span>
<span class="sd">                    Uses representation from last non-padding token position.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_encode_plus</span><span class="p">(</span>
                <span class="n">sentences</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;token_type_ids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">batch</span><span class="p">,</span> <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">last_hidden</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">pooled_result</span> <span class="o">=</span> <span class="n">last_hidden</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_hidden</span><span class="p">)),</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">pooled_result</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="c1"># Load dataset</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data found in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data</span><span class="p">[</span><span class="s1">&#39;neg&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data_path</span><span class="p">,</span> <span class="s2">&quot;all_data.csv&quot;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset found in: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data_path</span><span class="p">,</span> <span class="s2">&quot;all_data.csv&quot;</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;comment_text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;toxicity&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">neg</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;comment_text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;toxicity&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    Jigsaw dataset not found at: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_data_path</span><span class="si">}</span>
<span class="s2">                    To use jigsaw_unintended_bias you have to download it manually from Kaggle: https://www.kaggle.com/c/jigsaw-unintended-bias-in-toxicity-classification/data</span>
<span class="s2">                    You can manually download the data from it&#39;s homepage or use the Kaggle CLI tool (follow the instructions here: https://www.kaggle.com/docs/api)</span>
<span class="s2">                    Please extract all files in one folder and then load the dataset with:</span>
<span class="s2">                    dataset = pd.read_csv(&#39;/Jigsaw_data/all_data.csv&#39;)</span>
<span class="s2">                    &quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are overall </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="si">}</span><span class="s2"> positive sentences and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span><span class="si">}</span><span class="s2"> negative sentences.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_length</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">:</span>
            <span class="n">num_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_length</span> <span class="o">/</span> <span class="n">num</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
            <span class="n">num_neg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_length</span> <span class="o">-</span> <span class="n">num_pos</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:</span><span class="n">num_pos</span><span class="p">]</span>
            <span class="n">neg</span> <span class="o">=</span> <span class="n">neg</span><span class="p">[:</span><span class="n">num_neg</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating wv via </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="si">}</span><span class="s2"> positive sentences and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span><span class="si">}</span><span class="s2"> negative sentences.&quot;</span><span class="p">)</span>

        <span class="n">sorted_pos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="n">sorted_neg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">neg</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

        <span class="c1"># Gather embeddings</span>
        <span class="n">embeddings_pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">embeddings_neg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_pos</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_batch_size</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Embedding POS&quot;</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">sorted_pos</span><span class="p">[</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_batch_size</span><span class="p">]</span>
            <span class="n">embeddings_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batcher</span><span class="p">(</span><span class="n">batch</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_neg</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_batch_size</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Embedding NEG&quot;</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">sorted_neg</span><span class="p">[</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_wv_batch_size</span><span class="p">]</span>
            <span class="n">embeddings_neg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batcher</span><span class="p">(</span><span class="n">batch</span><span class="p">)))</span>

        <span class="n">X1_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">embeddings_pos</span><span class="p">)</span>
        <span class="n">X2_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">embeddings_neg</span><span class="p">)</span>
        <span class="n">X1_train</span> <span class="o">=</span> <span class="n">X1_train</span><span class="p">[</span><span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X1_train</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">X2_train</span> <span class="o">=</span> <span class="n">X2_train</span><span class="p">[</span><span class="o">~</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X2_train</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># Obtain closed-form Bayes optimal classifier</span>
        <span class="n">mu_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X1_train</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X1_train</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">X1_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mu_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X2_train</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">+=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X2_train</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">X2_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="p">(</span><span class="n">X1_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">X2_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

        <span class="n">F</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">some</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span> <span class="n">D</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">D</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">D_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">D</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">mu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="p">(</span><span class="n">mu_1</span> <span class="o">-</span> <span class="n">mu_2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mu_mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu_1</span> <span class="o">+</span> <span class="n">mu_2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">w_0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">D_inv</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
        <span class="n">wv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">w_0</span><span class="p">)</span>
        <span class="n">wv</span> <span class="o">=</span> <span class="n">wv</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wv</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wv&#39;</span><span class="p">:</span> <span class="n">wv</span><span class="p">,</span> <span class="s1">&#39;mu_mu&#39;</span><span class="p">:</span> <span class="n">mu_mu</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">repeat_kv_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">repeats</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Repeat KV cache entries for parallel candidate evaluation.</span>

<span class="sd">        Duplicates cache entries to enable efficient parallel processing of multiple candidate tokens without</span>
<span class="sd">        recomputing shared context.</span>

<span class="sd">        Args:</span>
<span class="sd">            cache: KV cache in various formats (DynamicCache, tuple, or custom).</span>
<span class="sd">            repeats (int): Number of times to repeat each cache entry.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Repeated cache in same format as input.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If cache type is not supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;batch_repeat_interleave&quot;</span><span class="p">):</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">batch_repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cache</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;to_legacy_cache&quot;</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">to_legacy_cache</span><span class="p">()</span>
            <span class="n">repeated</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">raw</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">DynamicCache</span><span class="o">.</span><span class="n">from_legacy_cache</span><span class="p">(</span><span class="n">repeated</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;key_cache&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;value_cache&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">)):</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cache</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">cache</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported cache type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_kv_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">select_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select specific entries from KV cache based on indices.</span>

<span class="sd">        Extracts cache entries corresponding to selected beam paths, used after evaluating multiple candidates to</span>
<span class="sd">        continue with the chosen token.</span>

<span class="sd">        Args:</span>
<span class="sd">            cache: KV cache in various formats.</span>
<span class="sd">            select_idx (torch.Tensor): 1D tensor of indices to select.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Selected cache entries in same format as input.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If select_idx is not 1D.</span>
<span class="sd">            TypeError: If cache type is not supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">select_idx</span><span class="p">):</span>
            <span class="n">select_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">select_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">:</span>
            <span class="n">select_idx</span> <span class="o">=</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select_idx must be 1D, got shape </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">select_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;batch_select&quot;</span><span class="p">):</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">batch_select</span><span class="p">(</span><span class="n">select_idx</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cache</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;batch_gather&quot;</span><span class="p">):</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">batch_gather</span><span class="p">(</span><span class="n">select_idx</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cache</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;to_legacy_cache&quot;</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">to_legacy_cache</span><span class="p">()</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">select_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">raw</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">DynamicCache</span><span class="o">.</span><span class="n">from_legacy_cache</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s1">&#39;key_cache&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s1">&#39;value_cache&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">select_idx_device</span> <span class="o">=</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">select_idx_device</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">select_idx_device</span> <span class="o">=</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">select_idx_device</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cache</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">select_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">cache</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported cache type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute SASA-guided generation with margin-based logit adjustment.</span>

<span class="sd">        Performs controlled generation by computing the distance from toxic subspace at each decoding step and adjusting</span>
<span class="sd">        token logits based on this margin. Returns text steered away from toxic regions while maintaining coherence.</span>

<span class="sd">        At each decoding step:</span>

<span class="sd">        1. Generate embeddings for all valid candidate tokens</span>
<span class="sd">        2. Compute margin (distance from toxic subspace) for each candidate</span>
<span class="sd">        3. Adjust logits by beta * softmax(margins)</span>
<span class="sd">        4. Sample from adjusted distribution</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.Tensor): Input token IDs of shape [batch_size, seq_len].</span>
<span class="sd">            attention_mask (torch.Tensor): Attention mask matching input_ids shape.</span>
<span class="sd">            runtime_kwargs (dict | None): Runtime parameters (unused).</span>
<span class="sd">            model (PreTrainedModel): The language model used for generation.</span>
<span class="sd">                Must match the model provided during steer().</span>
<span class="sd">            **gen_kwargs: Generation parameters passed to model internals:</span>

<span class="sd">                - &quot;generation_config&quot; (`GenerationConfig`, optional): Generation configuration object</span>
<span class="sd">                - &quot;logits_processor&quot; (`LogitsProcessorList`, optional): Custom logit processors</span>
<span class="sd">                - &quot;stopping_criteria&quot; (`StoppingCriteriaList`, optional): Custom stopping criteria</span>
<span class="sd">                - &quot;max_new_tokens&quot; (`int`, optional): Maximum tokens to generate</span>
<span class="sd">                - Standard generation arguments (temperature, top_p, etc.)</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Generated token IDs including the input prompt.</span>

<span class="sd">        Note:</span>

<span class="sd">        - Computes full forward passes for all valid candidate tokens at each step</span>
<span class="sd">        - Uses custom KV cache manipulation for efficient candidate evaluation</span>
<span class="sd">        - Margins computed relative to learned toxic/non-toxic boundary</span>
<span class="sd">        - SASA is memory intensive; scales with vocabulary size at each generation step</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="n">wv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wv</span>

        <span class="c1"># # If vanilla decoding, allow opt-out</span>
        <span class="c1"># if not runtime_kwargs.get(&quot;sasa_enabled&quot;, True):</span>
        <span class="c1">#     return self.base_generate(input_ids=input_ids, **gen_kwargs)</span>

        <span class="n">inputs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">input_ids</span>

        <span class="n">generation_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenerationConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;generation_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">logits_processor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LogitsProcessorList</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;logits_processor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">stopping_criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StoppingCriteriaList</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;stopping_criteria&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">prefix_allowed_tokens_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
            <span class="s2">&quot;prefix_allowed_tokens_fn&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># priority: `generation_config` argument &gt; `model.generation_config` (the default generation config)</span>
        <span class="k">if</span> <span class="n">generation_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generation_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                        <span class="s2">&quot;generation_config&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">GenerationConfig</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generation_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">generation_config</span><span class="p">)</span>

        <span class="n">generation_config</span><span class="p">,</span> <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_prepare_generation_config</span><span class="p">(</span>
            <span class="n">generation_config</span><span class="p">,</span>
            <span class="n">use_model_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gen_kwargs</span>
        <span class="p">)</span>
        <span class="n">generation_config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c1"># Set generation parameters if not already defined</span>
        <span class="n">logits_processor</span> <span class="o">=</span> <span class="n">logits_processor</span> <span class="k">if</span> <span class="n">logits_processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">LogitsProcessorList</span><span class="p">()</span>
        <span class="n">stopping_criteria</span> <span class="o">=</span> <span class="n">stopping_criteria</span> <span class="k">if</span> <span class="n">stopping_criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">StoppingCriteriaList</span><span class="p">()</span>
        <span class="n">kwargs_has_attention_mask</span> <span class="o">=</span> <span class="n">model_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Define model inputs</span>
        <span class="c1"># input_ids has to be defined</span>
        <span class="c1"># all model-specific keyword inputs are removed from `model_kwargs`</span>
        <span class="n">input_ids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_prepare_model_inputs</span><span class="p">(</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">,</span> <span class="n">model_kwargs</span>
        <span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># todo: unused?</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_prepare_special_tokens</span><span class="p">(</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">kwargs_has_attention_mask</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Prepare `max_length` depending on other stopping criteria.</span>
        <span class="n">input_ids_seq_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">max_new_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generation_config</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">max_new_tokens</span> <span class="o">+</span> <span class="n">input_ids_seq_length</span>

        <span class="c1"># Prepare logits processor, stopping criteria</span>
        <span class="n">logits_processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_logits_processor</span><span class="p">(</span>
            <span class="n">generation_config</span><span class="o">=</span><span class="n">generation_config</span><span class="p">,</span>
            <span class="n">input_ids_seq_length</span><span class="o">=</span><span class="n">input_ids_seq_length</span><span class="p">,</span>
            <span class="n">encoder_input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
            <span class="n">prefix_allowed_tokens_fn</span><span class="o">=</span><span class="n">prefix_allowed_tokens_fn</span><span class="p">,</span>
            <span class="n">logits_processor</span><span class="o">=</span><span class="n">logits_processor</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">stopping_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_stopping_criteria</span><span class="p">(</span>
            <span class="n">generation_config</span><span class="o">=</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">stopping_criteria</span><span class="o">=</span><span class="n">stopping_criteria</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Expand input_ids with `num_return_sequences` additional sequences per batch</span>
        <span class="n">input_ids</span><span class="p">,</span> <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_expand_inputs_for_generation</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
            <span class="n">expand_size</span><span class="o">=</span><span class="n">generation_config</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
            <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Run sample</span>
        <span class="c1"># init values</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">mv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># keep track of which sequences are already finished</span>
        <span class="n">unfinished_sequences</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">this_peer_finished</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># used by synced_gpus only</span>

        <span class="n">model_kwargs</span><span class="p">[</span><span class="s2">&quot;cache_position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">model_kwargs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_mask</span>
        <span class="c1"># model_kwargs = self.model._get_initial_cache_position(input_ids, model_kwargs)</span>

        <span class="c1"># auto-regressive generation</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># when generating the first token</span>
                <span class="c1"># prepare model inputs</span>
                <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prepare_inputs_for_generation</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>

                <span class="c1"># forward pass to get next token</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span>
                    <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">output_attentions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">next_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="n">selected_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">selected_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">))]</span>
                <span class="p">)</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">past_key_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_kv_cache</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">past_key_values</span><span class="p">,</span> <span class="n">selected_index</span><span class="p">)</span>

            <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">next_token_scores</span> <span class="o">=</span> <span class="n">logits_processor</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token_logits</span><span class="p">)</span>

            <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_update_model_kwargs_for_generation</span><span class="p">(</span>
                <span class="n">outputs</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">,</span> <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="c1"># prepare the value margins</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">prev_hidden_states</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;hidden_states&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">next_token_scores</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">input_ids_temp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">indices</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">model_kwargs_temp</span> <span class="o">=</span> <span class="n">model_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">is_gemma</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;gemma&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">is_gemma</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_kwargs</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">],</span> <span class="s1">&#39;get_seq_length&#39;</span><span class="p">):</span>
                        <span class="n">cache_length</span> <span class="o">=</span> <span class="n">model_kwargs</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_seq_length</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># fallback: use cache_position to infer length</span>
                        <span class="n">cache_length</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;cache_position&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="c1"># Trim attention_mask to match cache length for gemma</span>
                    <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">][:,</span> <span class="p">:</span><span class="n">cache_length</span><span class="p">]</span>

                    <span class="n">original_cache_pos</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;cache_position&#39;</span><span class="p">]</span>
                    <span class="n">new_token_position</span> <span class="o">=</span> <span class="n">original_cache_pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;cache_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">new_token_position</span><span class="p">],</span>
                                                                    <span class="n">dtype</span><span class="o">=</span><span class="n">original_cache_pos</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                                    <span class="n">device</span><span class="o">=</span><span class="n">original_cache_pos</span><span class="o">.</span><span class="n">device</span>
                                                                    <span class="p">)</span>
                <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat_kv_cache</span><span class="p">(</span><span class="n">model_kwargs</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">],</span> <span class="n">num</span><span class="p">)</span>

                <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prepare_inputs_for_generation</span><span class="p">(</span><span class="n">input_ids_temp</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs_temp</span><span class="p">)</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_attentions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>

                <span class="k">if</span> <span class="n">wv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wv</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">wv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">mv</span> <span class="o">=</span> <span class="p">(</span><span class="n">wv</span><span class="p">[</span><span class="s1">&#39;wv&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;hidden_states&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">wv</span><span class="p">[</span><span class="s1">&#39;mu_mu&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mv</span> <span class="o">=</span> <span class="p">(</span><span class="n">wv</span> <span class="o">*</span> <span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;hidden_states&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">prev_hidden_states</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># re-distribute weights</span>
            <span class="k">if</span> <span class="n">wv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">redistribute</span> <span class="o">=</span> <span class="n">next_token_scores</span><span class="p">[</span><span class="n">next_token_scores</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">mv</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">next_token_scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">next_token_scores</span><span class="p">[</span><span class="n">next_token_scores</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">redistribute</span>

            <span class="n">probs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">next_token_scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">next_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># store scores</span>
            <span class="n">scores</span> <span class="o">+=</span> <span class="p">(</span><span class="n">next_token_scores</span><span class="p">,)</span>

            <span class="c1"># finished sentences should have their next token be a padding token</span>
            <span class="k">if</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If `eos_token_id` is defined, make sure that `pad_token_id` is defined.&quot;</span><span class="p">)</span>
                <span class="n">next_tokens</span> <span class="o">=</span> <span class="n">next_tokens</span> <span class="o">*</span> <span class="n">unfinished_sequences</span> <span class="o">+</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="n">unfinished_sequences</span><span class="p">)</span>

            <span class="c1"># update generated ids, model inputs, and length for next step</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_tokens</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">unfinished_sequences</span> <span class="o">=</span> <span class="n">unfinished_sequences</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">stopping_criteria</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
            <span class="n">this_peer_finished</span> <span class="o">=</span> <span class="n">unfinished_sequences</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">this_peer_finished</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">input_ids</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.base_generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_generate</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.beta" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">beta</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.wv" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">wv</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Execute SASA-guided generation with margin-based logit adjustment.</p>
<p>Performs controlled generation by computing the distance from toxic subspace at each decoding step and adjusting
token logits based on this margin. Returns text steered away from toxic regions while maintaining coherence.</p>
<p>At each decoding step:</p>
<ol>
<li>Generate embeddings for all valid candidate tokens</li>
<li>Compute margin (distance from toxic subspace) for each candidate</li>
<li>Adjust logits by beta * softmax(margins)</li>
<li>Sample from adjusted distribution</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDs of shape [batch_size, seq_len].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>attention_mask</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Attention mask matching input_ids shape.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runtime parameters (unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The language model used for generation.
Must match the model provided during steer().</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**gen_kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generation parameters passed to model internals:</p>
<ul>
<li>"generation_config" (<code>GenerationConfig</code>, optional): Generation configuration object</li>
<li>"logits_processor" (<code>LogitsProcessorList</code>, optional): Custom logit processors</li>
<li>"stopping_criteria" (<code>StoppingCriteriaList</code>, optional): Custom stopping criteria</li>
<li>"max_new_tokens" (<code>int</code>, optional): Maximum tokens to generate</li>
<li>Standard generation arguments (temperature, top_p, etc.)</li>
</ul>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: Generated token IDs including the input prompt.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>Computes full forward passes for all valid candidate tokens at each step</li>
<li>Uses custom KV cache manipulation for efficient candidate evaluation</li>
<li>Margins computed relative to learned toxic/non-toxic boundary</li>
<li>SASA is memory intensive; scales with vocabulary size at each generation step</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/sasa/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute SASA-guided generation with margin-based logit adjustment.</span>

<span class="sd">    Performs controlled generation by computing the distance from toxic subspace at each decoding step and adjusting</span>
<span class="sd">    token logits based on this margin. Returns text steered away from toxic regions while maintaining coherence.</span>

<span class="sd">    At each decoding step:</span>

<span class="sd">    1. Generate embeddings for all valid candidate tokens</span>
<span class="sd">    2. Compute margin (distance from toxic subspace) for each candidate</span>
<span class="sd">    3. Adjust logits by beta * softmax(margins)</span>
<span class="sd">    4. Sample from adjusted distribution</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids (torch.Tensor): Input token IDs of shape [batch_size, seq_len].</span>
<span class="sd">        attention_mask (torch.Tensor): Attention mask matching input_ids shape.</span>
<span class="sd">        runtime_kwargs (dict | None): Runtime parameters (unused).</span>
<span class="sd">        model (PreTrainedModel): The language model used for generation.</span>
<span class="sd">            Must match the model provided during steer().</span>
<span class="sd">        **gen_kwargs: Generation parameters passed to model internals:</span>

<span class="sd">            - &quot;generation_config&quot; (`GenerationConfig`, optional): Generation configuration object</span>
<span class="sd">            - &quot;logits_processor&quot; (`LogitsProcessorList`, optional): Custom logit processors</span>
<span class="sd">            - &quot;stopping_criteria&quot; (`StoppingCriteriaList`, optional): Custom stopping criteria</span>
<span class="sd">            - &quot;max_new_tokens&quot; (`int`, optional): Maximum tokens to generate</span>
<span class="sd">            - Standard generation arguments (temperature, top_p, etc.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Generated token IDs including the input prompt.</span>

<span class="sd">    Note:</span>

<span class="sd">    - Computes full forward passes for all valid candidate tokens at each step</span>
<span class="sd">    - Uses custom KV cache manipulation for efficient candidate evaluation</span>
<span class="sd">    - Margins computed relative to learned toxic/non-toxic boundary</span>
<span class="sd">    - SASA is memory intensive; scales with vocabulary size at each generation step</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
    <span class="n">wv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wv</span>

    <span class="c1"># # If vanilla decoding, allow opt-out</span>
    <span class="c1"># if not runtime_kwargs.get(&quot;sasa_enabled&quot;, True):</span>
    <span class="c1">#     return self.base_generate(input_ids=input_ids, **gen_kwargs)</span>

    <span class="n">inputs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="n">input_ids</span>

    <span class="n">generation_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GenerationConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;generation_config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">logits_processor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LogitsProcessorList</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;logits_processor&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">stopping_criteria</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StoppingCriteriaList</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;stopping_criteria&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">prefix_allowed_tokens_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
        <span class="s2">&quot;prefix_allowed_tokens_fn&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># priority: `generation_config` argument &gt; `model.generation_config` (the default generation config)</span>
    <span class="k">if</span> <span class="n">generation_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">generation_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                                    <span class="s2">&quot;generation_config&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">GenerationConfig</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">generation_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">generation_config</span><span class="p">)</span>

    <span class="n">generation_config</span><span class="p">,</span> <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_prepare_generation_config</span><span class="p">(</span>
        <span class="n">generation_config</span><span class="p">,</span>
        <span class="n">use_model_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span>
    <span class="p">)</span>
    <span class="n">generation_config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

    <span class="c1"># Set generation parameters if not already defined</span>
    <span class="n">logits_processor</span> <span class="o">=</span> <span class="n">logits_processor</span> <span class="k">if</span> <span class="n">logits_processor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">LogitsProcessorList</span><span class="p">()</span>
    <span class="n">stopping_criteria</span> <span class="o">=</span> <span class="n">stopping_criteria</span> <span class="k">if</span> <span class="n">stopping_criteria</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">StoppingCriteriaList</span><span class="p">()</span>
    <span class="n">kwargs_has_attention_mask</span> <span class="o">=</span> <span class="n">model_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># Define model inputs</span>
    <span class="c1"># input_ids has to be defined</span>
    <span class="c1"># all model-specific keyword inputs are removed from `model_kwargs`</span>
    <span class="n">input_ids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_prepare_model_inputs</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">,</span> <span class="n">model_kwargs</span>
    <span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># todo: unused?</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">device</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_prepare_special_tokens</span><span class="p">(</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">kwargs_has_attention_mask</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Prepare `max_length` depending on other stopping criteria.</span>
    <span class="n">input_ids_seq_length</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">max_new_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">generation_config</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">max_new_tokens</span> <span class="o">+</span> <span class="n">input_ids_seq_length</span>

    <span class="c1"># Prepare logits processor, stopping criteria</span>
    <span class="n">logits_processor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_logits_processor</span><span class="p">(</span>
        <span class="n">generation_config</span><span class="o">=</span><span class="n">generation_config</span><span class="p">,</span>
        <span class="n">input_ids_seq_length</span><span class="o">=</span><span class="n">input_ids_seq_length</span><span class="p">,</span>
        <span class="n">encoder_input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
        <span class="n">prefix_allowed_tokens_fn</span><span class="o">=</span><span class="n">prefix_allowed_tokens_fn</span><span class="p">,</span>
        <span class="n">logits_processor</span><span class="o">=</span><span class="n">logits_processor</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stopping_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_stopping_criteria</span><span class="p">(</span>
        <span class="n">generation_config</span><span class="o">=</span><span class="n">generation_config</span><span class="p">,</span> <span class="n">stopping_criteria</span><span class="o">=</span><span class="n">stopping_criteria</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Expand input_ids with `num_return_sequences` additional sequences per batch</span>
    <span class="n">input_ids</span><span class="p">,</span> <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_expand_inputs_for_generation</span><span class="p">(</span>
        <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
        <span class="n">expand_size</span><span class="o">=</span><span class="n">generation_config</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
        <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Run sample</span>
    <span class="c1"># init values</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">mv</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># keep track of which sequences are already finished</span>
    <span class="n">unfinished_sequences</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">input_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">this_peer_finished</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># used by synced_gpus only</span>

    <span class="n">model_kwargs</span><span class="p">[</span><span class="s2">&quot;cache_position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">model_kwargs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_mask</span>
    <span class="c1"># model_kwargs = self.model._get_initial_cache_position(input_ids, model_kwargs)</span>

    <span class="c1"># auto-regressive generation</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># when generating the first token</span>
            <span class="c1"># prepare model inputs</span>
            <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prepare_inputs_for_generation</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>

            <span class="c1"># forward pass to get next token</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
                <span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span>
                <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output_attentions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">next_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="n">selected_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">[</span><span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">selected_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">hidden_states</span><span class="p">))]</span>
            <span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">past_key_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_kv_cache</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">past_key_values</span><span class="p">,</span> <span class="n">selected_index</span><span class="p">)</span>

        <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">next_token_scores</span> <span class="o">=</span> <span class="n">logits_processor</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token_logits</span><span class="p">)</span>

        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_update_model_kwargs_for_generation</span><span class="p">(</span>
            <span class="n">outputs</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">,</span> <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># prepare the value margins</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">prev_hidden_states</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;hidden_states&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">next_token_scores</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">input_ids_temp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">indices</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">model_kwargs_temp</span> <span class="o">=</span> <span class="n">model_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">is_gemma</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;gemma&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_gemma</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_kwargs</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">],</span> <span class="s1">&#39;get_seq_length&#39;</span><span class="p">):</span>
                    <span class="n">cache_length</span> <span class="o">=</span> <span class="n">model_kwargs</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_seq_length</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># fallback: use cache_position to infer length</span>
                    <span class="n">cache_length</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;cache_position&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="c1"># Trim attention_mask to match cache length for gemma</span>
                <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">][:,</span> <span class="p">:</span><span class="n">cache_length</span><span class="p">]</span>

                <span class="n">original_cache_pos</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;cache_position&#39;</span><span class="p">]</span>
                <span class="n">new_token_position</span> <span class="o">=</span> <span class="n">original_cache_pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;cache_position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">new_token_position</span><span class="p">],</span>
                                                                <span class="n">dtype</span><span class="o">=</span><span class="n">original_cache_pos</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                                <span class="n">device</span><span class="o">=</span><span class="n">original_cache_pos</span><span class="o">.</span><span class="n">device</span>
                                                                <span class="p">)</span>
            <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;attention_mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">model_kwargs_temp</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat_kv_cache</span><span class="p">(</span><span class="n">model_kwargs</span><span class="p">[</span><span class="s1">&#39;past_key_values&#39;</span><span class="p">],</span> <span class="n">num</span><span class="p">)</span>

            <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prepare_inputs_for_generation</span><span class="p">(</span><span class="n">input_ids_temp</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs_temp</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">model_inputs</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_attentions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">output_hidden_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">wv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wv</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">wv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">mv</span> <span class="o">=</span> <span class="p">(</span><span class="n">wv</span><span class="p">[</span><span class="s1">&#39;wv&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;hidden_states&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">wv</span><span class="p">[</span><span class="s1">&#39;mu_mu&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mv</span> <span class="o">=</span> <span class="p">(</span><span class="n">wv</span> <span class="o">*</span> <span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;hidden_states&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">prev_hidden_states</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># re-distribute weights</span>
        <span class="k">if</span> <span class="n">wv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">redistribute</span> <span class="o">=</span> <span class="n">next_token_scores</span><span class="p">[</span><span class="n">next_token_scores</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">mv</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">next_token_scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">next_token_scores</span><span class="p">[</span><span class="n">next_token_scores</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">redistribute</span>

        <span class="n">probs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">next_token_scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">next_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># store scores</span>
        <span class="n">scores</span> <span class="o">+=</span> <span class="p">(</span><span class="n">next_token_scores</span><span class="p">,)</span>

        <span class="c1"># finished sentences should have their next token be a padding token</span>
        <span class="k">if</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If `eos_token_id` is defined, make sure that `pad_token_id` is defined.&quot;</span><span class="p">)</span>
            <span class="n">next_tokens</span> <span class="o">=</span> <span class="n">next_tokens</span> <span class="o">*</span> <span class="n">unfinished_sequences</span> <span class="o">+</span> <span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">unfinished_sequences</span><span class="p">)</span>

        <span class="c1"># update generated ids, model inputs, and length for next step</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_tokens</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">unfinished_sequences</span> <span class="o">=</span> <span class="n">unfinished_sequences</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">stopping_criteria</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
        <span class="n">this_peer_finished</span> <span class="o">=</span> <span class="n">unfinished_sequences</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">this_peer_finished</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">input_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.repeat_kv_cache" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">repeat_kv_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">repeats</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

        <p>Repeat KV cache entries for parallel candidate evaluation.</p>
<p>Duplicates cache entries to enable efficient parallel processing of multiple candidate tokens without
recomputing shared context.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cache</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>KV cache in various formats (DynamicCache, tuple, or custom).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>repeats</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of times to repeat each cache entry.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repeated cache in same format as input.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If cache type is not supported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/sasa/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">repeat_kv_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">repeats</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Repeat KV cache entries for parallel candidate evaluation.</span>

<span class="sd">    Duplicates cache entries to enable efficient parallel processing of multiple candidate tokens without</span>
<span class="sd">    recomputing shared context.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache: KV cache in various formats (DynamicCache, tuple, or custom).</span>
<span class="sd">        repeats (int): Number of times to repeat each cache entry.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Repeated cache in same format as input.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If cache type is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;batch_repeat_interleave&quot;</span><span class="p">):</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">batch_repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;to_legacy_cache&quot;</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">to_legacy_cache</span><span class="p">()</span>
        <span class="n">repeated</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">raw</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">DynamicCache</span><span class="o">.</span><span class="n">from_legacy_cache</span><span class="p">(</span><span class="n">repeated</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;key_cache&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;value_cache&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">)):</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">cache</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported cache type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.select_kv_cache" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">select_kv_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">select_idx</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

        <p>Select specific entries from KV cache based on indices.</p>
<p>Extracts cache entries corresponding to selected beam paths, used after evaluating multiple candidates to
continue with the chosen token.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cache</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>KV cache in various formats.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>select_idx</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>1D tensor of indices to select.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Selected cache entries in same format as input.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If select_idx is not 1D.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If cache type is not supported.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/sasa/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">select_kv_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">select_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select specific entries from KV cache based on indices.</span>

<span class="sd">    Extracts cache entries corresponding to selected beam paths, used after evaluating multiple candidates to</span>
<span class="sd">    continue with the chosen token.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache: KV cache in various formats.</span>
<span class="sd">        select_idx (torch.Tensor): 1D tensor of indices to select.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Selected cache entries in same format as input.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If select_idx is not 1D.</span>
<span class="sd">        TypeError: If cache type is not supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">select_idx</span><span class="p">):</span>
        <span class="n">select_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">select_idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">:</span>
        <span class="n">select_idx</span> <span class="o">=</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select_idx must be 1D, got shape </span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">select_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;batch_select&quot;</span><span class="p">):</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">batch_select</span><span class="p">(</span><span class="n">select_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;batch_gather&quot;</span><span class="p">):</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">batch_gather</span><span class="p">(</span><span class="n">select_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s2">&quot;to_legacy_cache&quot;</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">to_legacy_cache</span><span class="p">()</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">select_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">raw</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">DynamicCache</span><span class="o">.</span><span class="n">from_legacy_cache</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s1">&#39;key_cache&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="s1">&#39;value_cache&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">select_idx_device</span> <span class="o">=</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">key_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">select_idx_device</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">select_idx_device</span> <span class="o">=</span> <span class="n">select_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">value_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">select_idx_device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">select_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">cache</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported cache type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.sasa.control.SASA.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Initialize SASA by loading or generating the toxicity steering vector.</p>
<p>Sets up the linear classifier in the model's embedding space that defines the toxicity subspace. Either loads a
pre-computed steering vector or generates one from labeled data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base language model to be steered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for the base model.
If None, attempts to retrieve from model attributes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>PreTrainedModel</code></td>            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input model (unchanged).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If gen_wv_data_path doesn't contain required Jigsaw dataset</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>If wv_path is provided, loads pre-computed steering vector</li>
<li>Otherwise generates steering vector from Jigsaw toxicity dataset</li>
<li>Steering vector generation uses closed-form Bayes optimal classifier</li>
<li>Saves generated steering vector to 'steer_wv.pt' for future use</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/sasa/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">__</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize SASA by loading or generating the toxicity steering vector.</span>

<span class="sd">    Sets up the linear classifier in the model&#39;s embedding space that defines the toxicity subspace. Either loads a</span>
<span class="sd">    pre-computed steering vector or generates one from labeled data.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">        tokenizer (PreTrainedTokenizer | None): Tokenizer for the base model.</span>
<span class="sd">            If None, attempts to retrieve from model attributes.</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        PreTrainedModel: The input model (unchanged).</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If gen_wv_data_path doesn&#39;t contain required Jigsaw dataset</span>

<span class="sd">    Note:</span>

<span class="sd">    - If wv_path is provided, loads pre-computed steering vector</span>
<span class="sd">    - Otherwise generates steering vector from Jigsaw toxicity dataset</span>
<span class="sd">    - Steering vector generation uses closed-form Bayes optimal classifier</span>
<span class="sd">    - Saves generated steering vector to &#39;steer_wv.pt&#39; for future use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad_token is absent. Setting it to eos_token or &#39;&lt;pad&gt;&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># edge case</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">({</span><span class="s2">&quot;pad_token&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;pad&gt;&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;wv_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading SASA steer (wv)......&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wv_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating SASA steer (wv)......&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_wv</span><span class="p">()</span>
        <span class="c1"># self.wv =  {k: v.cpu() for k, v in self.wv.item().items()}</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wv</span><span class="p">,</span> <span class="s1">&#39;steer_wv.pt&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wv</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wv</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.output_control.thinking_intervention" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>thinking_intervention</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.thinking_intervention.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.output_control.thinking_intervention.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ThinkingIntervention</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            OutputControl (aisteer360.algorithms.output_control.base.OutputControl)" href="#aisteer360.algorithms.output_control.base.OutputControl">OutputControl</a></code></p>


        <p>Implementation of Thinking Intervention from Wu et al., 2025.</p>
<p><code>ThinkingIntervention</code> enables controlled text generation by injecting structured thinking processes into the model's
reasoning chain. The method modifies the input prompt to include explicit thinking steps enclosed in special tags,
allowing the model to engage in guided reasoning before producing the final output.</p>
<p>The algorithm works in three phases:</p>
<ol>
<li>
<p><strong>Prompt Modification</strong>: Transform the original prompt by applying an intervention function that injects thinking
instructions, reasoning templates, or structured prompts to guide the model's internal reasoning process.</p>
</li>
<li>
<p><strong>Guided Generation</strong>: Generate text using the modified prompt, where the model first produces thinking content
within special tags (e.g., <think>...</think>) before generating the actual response.</p>
</li>
<li>
<p><strong>Output Extraction</strong>: Parse the generated text to extract only the content after the thinking tags.</p>
</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>intervention</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="str">str</span>, <span title="dict">dict</span>], <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that modifies the input prompt to include thinking
instructions. Takes the original prompt string and parameter dict, returns the modified prompt string.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="reference" open>
  <summary>Reference</summary>
  <p>"Effectively Controlling Reasoning Models through Thinking Intervention"
Tong Wu, Chong Xiang, Jiachen T. Wang, G. Edward Suh, Prateek Mittal
https://arxiv.org/abs/2503.24370</p>
</details>







              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/output_control/thinking_intervention/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ThinkingIntervention</span><span class="p">(</span><span class="n">OutputControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of Thinking Intervention from Wu et al., 2025.</span>

<span class="sd">    `ThinkingIntervention` enables controlled text generation by injecting structured thinking processes into the model&#39;s</span>
<span class="sd">    reasoning chain. The method modifies the input prompt to include explicit thinking steps enclosed in special tags,</span>
<span class="sd">    allowing the model to engage in guided reasoning before producing the final output.</span>

<span class="sd">    The algorithm works in three phases:</span>

<span class="sd">    1. **Prompt Modification**: Transform the original prompt by applying an intervention function that injects thinking</span>
<span class="sd">    instructions, reasoning templates, or structured prompts to guide the model&#39;s internal reasoning process.</span>

<span class="sd">    2. **Guided Generation**: Generate text using the modified prompt, where the model first produces thinking content</span>
<span class="sd">    within special tags (e.g., &lt;think&gt;...&lt;/think&gt;) before generating the actual response.</span>

<span class="sd">    3. **Output Extraction**: Parse the generated text to extract only the content after the thinking tags.</span>

<span class="sd">    Args:</span>
<span class="sd">        intervention (Callable[[str, dict], str]): Function that modifies the input prompt to include thinking</span>
<span class="sd">            instructions. Takes the original prompt string and parameter dict, returns the modified prompt string.</span>

<span class="sd">    Reference:</span>
<span class="sd">        &quot;Effectively Controlling Reasoning Models through Thinking Intervention&quot;</span>
<span class="sd">        Tong Wu, Chong Xiang, Jiachen T. Wang, G. Edward Suh, Prateek Mittal</span>
<span class="sd">        https://arxiv.org/abs/2503.24370</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span> <span class="o">=</span> <span class="n">ThinkingInterventionArgs</span>

    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_generate</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="s2">&quot;&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">input_ids</span>
        <span class="c1"># Paper says interventions are best at the beginning</span>
        <span class="n">intervention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervention</span>
        <span class="n">input_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">{})}</span>

        <span class="n">base_generate</span> <span class="o">=</span> <span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_generate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span><span class="p">)</span>

        <span class="n">original_prompt_ids</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">original_input_len</span> <span class="o">=</span> <span class="n">original_prompt_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">prompt_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">original_prompt_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">modified_prompt_str</span> <span class="o">=</span> <span class="n">intervention</span><span class="p">(</span><span class="n">prompt_str</span><span class="p">,</span> <span class="n">input_params</span><span class="p">)</span>

        <span class="n">new_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">modified_prompt_str</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">gen_kwargs</span><span class="p">[</span><span class="s2">&quot;return_dict_in_generate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">output_ids</span> <span class="o">=</span> <span class="n">base_generate</span><span class="p">(</span><span class="o">**</span><span class="n">new_input</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">keep_prefix</span> <span class="o">=</span> <span class="n">output_ids</span><span class="p">[:</span> <span class="n">original_input_len</span><span class="p">]</span>

        <span class="n">decoded</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">output_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">remainder_txt</span> <span class="o">=</span> <span class="n">decoded</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

        <span class="n">remainder</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
                <span class="n">remainder_txt</span><span class="p">,</span>
                <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
            <span class="p">)[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">output_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">final_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">keep_prefix</span><span class="p">,</span> <span class="n">remainder</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">final_ids</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention.base_generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_generate</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Custom generation logic.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/thinking_intervention/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">attention_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
    <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tag_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="s2">&quot;&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">input_ids</span>
    <span class="c1"># Paper says interventions are best at the beginning</span>
    <span class="n">intervention</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intervention</span>
    <span class="n">input_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">{})}</span>

    <span class="n">base_generate</span> <span class="o">=</span> <span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_generate&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span><span class="p">)</span>

    <span class="n">original_prompt_ids</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">original_input_len</span> <span class="o">=</span> <span class="n">original_prompt_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">prompt_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
        <span class="n">original_prompt_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">modified_prompt_str</span> <span class="o">=</span> <span class="n">intervention</span><span class="p">(</span><span class="n">prompt_str</span><span class="p">,</span> <span class="n">input_params</span><span class="p">)</span>

    <span class="n">new_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">modified_prompt_str</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">gen_kwargs</span><span class="p">[</span><span class="s2">&quot;return_dict_in_generate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">output_ids</span> <span class="o">=</span> <span class="n">base_generate</span><span class="p">(</span><span class="o">**</span><span class="n">new_input</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">keep_prefix</span> <span class="o">=</span> <span class="n">output_ids</span><span class="p">[:</span> <span class="n">original_input_len</span><span class="p">]</span>

    <span class="n">decoded</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">output_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">remainder_txt</span> <span class="o">=</span> <span class="n">decoded</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="n">remainder</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">remainder_txt</span><span class="p">,</span>
            <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
        <span class="p">)[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">output_ids</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">final_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">keep_prefix</span><span class="p">,</span> <span class="n">remainder</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">final_ids</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">final_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.output_control.thinking_intervention.control.ThinkingIntervention.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Optional steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/output_control/thinking_intervention/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">_</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_generate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="aisteer360.algorithms.state_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>state_control</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.state_control.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base</code>


</h5>

    <div class="doc doc-contents ">

        <p>State control base classes.</p>
<p>This module provides the abstract base class for methods that register hooks into the model (e.g., to modify
intermediate representations during inference); does not change model weights.</p>
<p>Two base classes are provided:</p>
<ul>
<li><code>StateControl</code>: Base class for all state control methods.</li>
<li><code>NoStateControl</code>: Identity (null) control; used when no state control is defined in steering pipeline.</li>
</ul>
<p>State controls implement steering through runtime intervention in the model's forward pass, modifying internal states
(activations, attention patterns) to produce generations following y ~ p_θᵃ(x), where "p_θᵃ" is the model with state
controls.</p>
<p>Examples of state controls:</p>
<ul>
<li>Activation steering (e.g., adding direction vectors)</li>
<li>Attention head manipulation and pruning</li>
<li>Layer-wise activation editing</li>
<li>Dynamic routing between components</li>
<li>Representation engineering techniques</li>
</ul>
<p>The base class provides automatic hook management through context managers (ensures cleanup and avoids memory leaks).</p>
<p>See Also:</p>
<ul>
<li><code>aisteer360.algorithms.state_control</code>: Implementations of state control methods</li>
<li><code>aisteer360.core.steering_pipeline</code>: Integration with steering pipeline</li>
</ul>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.algorithms.state_control.base.BackwardHook" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">BackwardHook</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.algorithms.state_control.base.ForwardHook" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">ForwardHook</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.algorithms.state_control.base.HookSpec" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">HookSpec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">PreHook</span> <span class="o">|</span> <span class="n">ForwardHook</span> <span class="o">|</span> <span class="n">BackwardHook</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.algorithms.state_control.base.PreHook" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PreHook</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>



<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.state_control.base.NoStateControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>NoStateControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StateControl (aisteer360.algorithms.state_control.base.StateControl)" href="#aisteer360.algorithms.state_control.base.StateControl">StateControl</a></code></p>


        <p>Identity state control.</p>
<p>Used as the default when no state control is needed. Returns empty hook dictionaries and skips registration.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NoStateControl</span><span class="p">(</span><span class="n">StateControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identity state control.</span>

<span class="sd">    Used as the default when no state control is needed. Returns empty hook dictionaries and skips registration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return empty hooks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
              <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null steering operation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null registration operation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null removal operation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null set operation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null reset operation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pre&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="p">[]}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.registered" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">registered</span> <span class="o">=</span> <span class="p">[]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.get_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_hooks</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Return empty hooks.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return empty hooks.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.register_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">register_hooks</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null registration operation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null registration operation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.remove_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">remove_hooks</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null removal operation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null removal operation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.reset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">reset</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null reset operation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null reset operation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.set_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">set_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null set operation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null set operation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.NoStateControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null steering operation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
          <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
          <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null steering operation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.state_control.base.StateControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>StateControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for state control steering methods.</p>
<p>Modifies internal model states during forward passes via hooks.</p>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            get_hooks(input_ids, runtime_kwargs, **kwargs)

  
      abstractmethod
   (aisteer360.algorithms.state_control.base.StateControl.get_hooks)" href="#aisteer360.algorithms.state_control.base.StateControl.get_hooks">get_hooks</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Create hook specs (required)</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            steer(model, tokenizer=None, **kwargs) (aisteer360.algorithms.state_control.base.StateControl.steer)" href="#aisteer360.algorithms.state_control.base.StateControl.steer">steer</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>One-time preparation (optional)</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            reset() (aisteer360.algorithms.state_control.base.StateControl.reset)" href="#aisteer360.algorithms.state_control.base.StateControl.reset">reset</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Reset logic (optional)</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            register_hooks(model) (aisteer360.algorithms.state_control.base.StateControl.register_hooks)" href="#aisteer360.algorithms.state_control.base.StateControl.register_hooks">register_hooks</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Attach hooks to model (provided)</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            remove_hooks() (aisteer360.algorithms.state_control.base.StateControl.remove_hooks)" href="#aisteer360.algorithms.state_control.base.StateControl.remove_hooks">remove_hooks</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Remove all registered hooks (provided)</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateControl</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for state control steering methods.</span>

<span class="sd">    Modifies internal model states during forward passes via hooks.</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_hooks(input_ids, runtime_kwargs, **kwargs) -&gt; dict: Create hook specs (required)</span>
<span class="sd">        steer(model, tokenizer, **kwargs) -&gt; None: One-time preparation (optional)</span>
<span class="sd">        reset() -&gt; None: Reset logic (optional)</span>
<span class="sd">        register_hooks(model) -&gt; None: Attach hooks to model (provided)</span>
<span class="sd">        remove_hooks() -&gt; None: Remove all registered hooks (provided)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseArgs</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_model_ref</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># null control</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> accepts no constructor arguments.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> <span class="n">BaseArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># move fields to attributes</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">RemovableHandle</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create hook specifications for the current generation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
              <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optional steering/preparation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attach hooks to model.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;backward&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">phase</span><span class="p">]:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_submodule</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;pre&quot;</span><span class="p">:</span>
                    <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_pre_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
                    <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_full_backward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all registered hooks from the model.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the hook specifications to be registered.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">hooks</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager entry: register hooks to model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If model reference not set by pipeline</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model reference not set before entering context.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ref</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager exit: clean up all hooks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_hooks</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optional reset call for state control.&quot;&quot;&quot;</span>
        <span class="k">pass</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optional reset call for state control&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.StateControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.StateControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.StateControl.hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pre&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="p">[]}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.state_control.base.StateControl.registered" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">registered</span> <span class="o">=</span> <span class="p">[]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.StateControl.get_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_hooks</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Create hook specifications for the current generation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create hook specifications for the current generation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.StateControl.register_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">register_hooks</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Attach hooks to model.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attach hooks to model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;backward&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">phase</span><span class="p">]:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_submodule</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;pre&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_pre_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_full_backward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.StateControl.remove_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">remove_hooks</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Remove all registered hooks from the model.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all registered hooks from the model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.StateControl.reset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">reset</span><span class="p">()</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Optional reset call for state control</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optional reset call for state control&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.StateControl.set_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">set_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Update the hook specifications to be registered.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the hook specifications to be registered.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">hooks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.state_control.base.StateControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Optional steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
          <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
          <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optional steering/preparation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.state_control.cast" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>cast</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.state_control.cast.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.state_control.cast.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.state_control.cast.control.CAST" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>CAST</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StateControl (aisteer360.algorithms.state_control.base.StateControl)" href="#aisteer360.algorithms.state_control.base.StateControl">StateControl</a></code></p>


        <p>Implementation of CAST (Conditional Activation Steering) from Lee et al., 2024.</p>
<p>CAST enables selective control of LLM behavior by conditionally applying activation steering based on input context,
allowing fine-grained control without affecting responses to non-targeted content.</p>
<p>The method operates in two phases:</p>
<ol>
<li>
<p><strong>Condition Detection</strong>: Analyzes hidden state activation patterns at specified layers during inference to detect
    if the input matches target conditions. This is done by projecting hidden states onto a condition subspace and
    computing similarity scores against a threshold.</p>
</li>
<li>
<p><strong>Conditional Behavior Modification</strong>: When conditions are met, applies steering vectors to hidden states at
    designated behavior layers. This selectively modifies the model's internal representations to produce desired
    behavioral changes while preserving normal functionality for non-matching inputs.</p>
</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>condition_vector</code>
            </td>
            <td>
                  <code><span title="aisteer360.algorithms.state_control.cast.utils.steering_vector.SteeringVector">SteeringVector</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Steering vector defining the condition subspace for detecting
target input patterns. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior_vector</code>
            </td>
            <td>
                  <code><span title="aisteer360.algorithms.state_control.cast.utils.steering_vector.SteeringVector">SteeringVector</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Steering vector applied to modify behavior when conditions are met.
Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_layer_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Layer indices where condition detection occurs. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior_layer_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Layer indices where behavior modification is applied. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_vector_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Similarity threshold for condition detection. Higher values
require stronger pattern matches. Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior_vector_strength</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaling factor for the behavior steering vector. Controls the
intensity of behavioral modification. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_comparator_threshold_is</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Comparison mode for threshold ('larger' or 'smaller').
Determines if condition is met when similarity is above or below threshold. Defaults to 'larger'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>condition_threshold_comparison_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to aggregate hidden states for comparison ('mean'
or 'last'). Defaults to 'mean'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_behavior_on_first_call</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to apply behavior steering on the first forward pass.
Defaults to True.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_ooi_preventive_normalization</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Apply out-of-distribution preventive normalization to
maintain hidden state magnitudes. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_explained_variance</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scale steering vectors by their explained variance for adaptive
layer-wise control. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Reference:</p>
<ul>
<li>"Programming Refusal with Conditional Activation Steering"
Bruce W. Lee, Inkit Padhi, Karthikeyan Natesan Ramamurthy, Erik Miehling, Pierre Dognin, Manish Nagireddy, Amit Dhurandhar
<a href="https://arxiv.org/abs/2409.05907">https://arxiv.org/abs/2409.05907</a></li>
</ul>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CAST</span><span class="p">(</span><span class="n">StateControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of CAST (Conditional Activation Steering) from Lee et al., 2024.</span>

<span class="sd">    CAST enables selective control of LLM behavior by conditionally applying activation steering based on input context,</span>
<span class="sd">    allowing fine-grained control without affecting responses to non-targeted content.</span>

<span class="sd">    The method operates in two phases:</span>

<span class="sd">    1. **Condition Detection**: Analyzes hidden state activation patterns at specified layers during inference to detect</span>
<span class="sd">        if the input matches target conditions. This is done by projecting hidden states onto a condition subspace and</span>
<span class="sd">        computing similarity scores against a threshold.</span>

<span class="sd">    2. **Conditional Behavior Modification**: When conditions are met, applies steering vectors to hidden states at</span>
<span class="sd">        designated behavior layers. This selectively modifies the model&#39;s internal representations to produce desired</span>
<span class="sd">        behavioral changes while preserving normal functionality for non-matching inputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        condition_vector (SteeringVector, optional): Steering vector defining the condition subspace for detecting</span>
<span class="sd">            target input patterns. Defaults to None.</span>
<span class="sd">        behavior_vector (SteeringVector, optional): Steering vector applied to modify behavior when conditions are met.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        condition_layer_ids (list[int], optional): Layer indices where condition detection occurs. Defaults to None.</span>
<span class="sd">        behavior_layer_ids (list[int], optional): Layer indices where behavior modification is applied. Defaults to None.</span>
<span class="sd">        condition_vector_threshold (float, optional): Similarity threshold for condition detection. Higher values</span>
<span class="sd">            require stronger pattern matches. Defaults to 0.5.</span>
<span class="sd">        behavior_vector_strength (float, optional): Scaling factor for the behavior steering vector. Controls the</span>
<span class="sd">            intensity of behavioral modification. Defaults to 1.0.</span>
<span class="sd">        condition_comparator_threshold_is (str, optional): Comparison mode for threshold (&#39;larger&#39; or &#39;smaller&#39;).</span>
<span class="sd">            Determines if condition is met when similarity is above or below threshold. Defaults to &#39;larger&#39;.</span>
<span class="sd">        condition_threshold_comparison_mode (str, optional): How to aggregate hidden states for comparison (&#39;mean&#39;</span>
<span class="sd">            or &#39;last&#39;). Defaults to &#39;mean&#39;.</span>
<span class="sd">        apply_behavior_on_first_call (bool, optional): Whether to apply behavior steering on the first forward pass.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        use_ooi_preventive_normalization (bool, optional): Apply out-of-distribution preventive normalization to</span>
<span class="sd">            maintain hidden state magnitudes. Defaults to False.</span>
<span class="sd">        use_explained_variance (bool, optional): Scale steering vectors by their explained variance for adaptive</span>
<span class="sd">            layer-wise control. Defaults to False.</span>

<span class="sd">    Reference:</span>

<span class="sd">    - &quot;Programming Refusal with Conditional Activation Steering&quot;</span>
<span class="sd">    Bruce W. Lee, Inkit Padhi, Karthikeyan Natesan Ramamurthy, Erik Miehling, Pierre Dognin, Manish Nagireddy, Amit Dhurandhar</span>
<span class="sd">    [https://arxiv.org/abs/2409.05907](https://arxiv.org/abs/2409.05907)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span> <span class="o">=</span> <span class="n">CASTArgs</span>

    <span class="c1"># placeholders</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># layers list reference</span>
    <span class="n">_layers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_layers_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_layers_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">LayerArgs</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Boolean lists for condition and behavior layers</span>
    <span class="n">_condition_layers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_behavior_layers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Logic flags</span>
    <span class="n">_condition_met</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">_forward_calls</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># condition similarity record</span>
    <span class="n">_condition_similarities</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset internal state tracking between generation calls.</span>

<span class="sd">        Clears condition detection flags, forward call counters, and similarity scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_similarities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">__</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialization by configuring condition detection and behavior modification layers.</span>

<span class="sd">        Sets up steering vectors, condition projectors, and layer-specific parameters for conditional activation</span>
<span class="sd">        steering. Pre-computes projection matrices and behavior vectors.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">            tokenizer (PreTrainedTokenizer | None): Tokenizer (currently unused but maintained</span>
<span class="sd">                for API consistency). If None, attempts to retrieve from model attributes.</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            PreTrainedModel: The input model, unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">__</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create pre-forward hooks for conditional activation steering.</span>

<span class="sd">        Generates hook specifications for all model layers that will conditionally detect patterns and apply behavior</span>
<span class="sd">        modifications during the forward pass.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.Tensor): Input token IDs (unused but required by interface).</span>
<span class="sd">            runtime_kwargs (dict | None): Runtime parameters (currently unused).</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, list]: Hook specifications with &quot;pre&quot;, &quot;forward&quot;, &quot;backward&quot; keys.</span>
<span class="sd">                Only &quot;pre&quot; hooks are populated with CAST steering logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">layer_id</span><span class="p">,</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_names</span><span class="p">):</span>
            <span class="n">hooks</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">layer_name</span><span class="p">,</span>  <span class="c1"># &quot;model.layers.0&quot;</span>
                    <span class="s2">&quot;hook_func&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cast_pre_hook</span><span class="p">,</span>
                        <span class="n">layer_id</span><span class="o">=</span><span class="n">layer_id</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">hooks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_layer_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract the list of transformer layers from the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): Model to extract layers from.</span>

<span class="sd">        Returns:</span>

<span class="sd">            List of layers for given model</span>
<span class="sd">            List of layers module name prefix for given model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">layers_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">model_layers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>  <span class="c1"># mistral-, llama-, gemma-like models</span>
            <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span>
            <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;model.layers&quot;</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;transformer&quot;</span><span class="p">):</span>  <span class="c1"># gpt2-like models</span>
            <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">h</span>
            <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;transformer.h&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to get layer list from model for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_layers</span><span class="p">):</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
            <span class="n">layers_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_layers_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">layers</span><span class="p">,</span> <span class="n">layers_names</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure all CAST internals for the given model.</span>

<span class="sd">        Pre-computes steering vectors, condition projectors, and layer configurations to minimize runtime overhead during generation.</span>

<span class="sd">        Process:</span>

<span class="sd">        1. Identifies condition and behavior layers from configuration</span>
<span class="sd">        2. Computes condition projection matrices for detection layers</span>
<span class="sd">        3. Prepares scaled behavior vectors for modification layers</span>
<span class="sd">        4. Stores layer-specific parameters in _layer_states</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): Model to configure CAST for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_layer_list</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">num_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">)</span>

        <span class="c1"># Creating dicts for condition and behavior layers</span>
        <span class="n">condition_layers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_layers</span>
        <span class="n">behavior_layers</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_layers</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span><span class="p">:</span>
                <span class="n">condition_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_layer_ids</span><span class="p">:</span>
                <span class="n">behavior_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition_layers</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_behavior_layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">behavior_layers</span><span class="p">)}</span>

        <span class="c1"># Precompute behavior vectors and condition projectors</span>
        <span class="n">condition_layer_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_layer_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">behavior_layer_ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_layer_ids</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
            <span class="c1"># layer = self._layers[layer_id]</span>
            <span class="n">behavior_tensor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="n">behavior_layer_ids_set</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_explained_variance</span><span class="p">:</span>
                        <span class="n">behavior_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">behavior_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

                    <span class="n">behavior_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_vector_strength</span> <span class="o">*</span> <span class="n">behavior_direction</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">condition_projector</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layer_id</span> <span class="ow">in</span> <span class="n">condition_layer_ids_set</span><span class="p">:</span>
                <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_explained_variance</span><span class="p">:</span>
                    <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">condition_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition_vector</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

                <span class="n">condition_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">condition_direction</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">condition_projector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ger</span><span class="p">(</span><span class="n">condition_tensor</span><span class="p">,</span> <span class="n">condition_tensor</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">condition_tensor</span><span class="p">,</span> <span class="n">condition_tensor</span><span class="p">)</span>

            <span class="n">layer_control_params</span> <span class="o">=</span> <span class="n">LayerControlParams</span><span class="p">()</span>

            <span class="n">layer_args</span> <span class="o">=</span> <span class="n">LayerArgs</span><span class="p">(</span>
                <span class="n">behavior_vector</span><span class="o">=</span><span class="n">behavior_tensor</span><span class="p">,</span>
                <span class="n">condition_projector</span><span class="o">=</span><span class="n">condition_projector</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_vector_threshold</span><span class="p">,</span>
                <span class="n">use_ooi_preventive_normalization</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ooi_preventive_normalization</span><span class="p">,</span>
                <span class="n">apply_behavior_on_first_call</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_behavior_on_first_call</span><span class="p">,</span>
                <span class="n">condition_comparator_threshold_is</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="p">,</span>
                <span class="n">condition_threshold_comparison_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">layer_control_params</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_use_explained_variance_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">SteeringVector</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scale steering vector by its explained variance for adaptive control.</span>

<span class="sd">        This method scales the steering vector based on its explained variance,</span>
<span class="sd">        potentially adjusting its impact on different layers of the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            vector (SteeringVector): Steering vector containing directions and variances.</span>
<span class="sd">            layer_id (int): Layer index to retrieve variance scaling for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Direction vector scaled by explained variance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="s1">&#39;explained_variances&#39;</span><span class="p">):</span>
            <span class="n">variance_scale</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">explained_variances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">variance_scale</span>

        <span class="k">return</span> <span class="n">direction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cast_pre_hook</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="p">,</span>
        <span class="n">input_args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
        <span class="n">input_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply conditional activation steering as a pre-forward hook.</span>

<span class="sd">        Detect conditions and applies behavior modifications during the model&#39;s forward pass. Processes each layer</span>
<span class="sd">        independently based on its configuration.</span>

<span class="sd">        Process:</span>

<span class="sd">        1. Extract hidden states from arguments</span>
<span class="sd">        2. If condition layer: detect if input matches target pattern</span>
<span class="sd">        3. If behavior layer and conditions met: apply steering vector</span>
<span class="sd">        4. Optionally apply OOI normalization to prevent distribution shift</span>

<span class="sd">        Args:</span>
<span class="sd">            module: The layer module being hooked.</span>
<span class="sd">            input_args: Positional arguments to the forward pass.</span>
<span class="sd">            input_kwargs: Keyword arguments to the forward pass.</span>
<span class="sd">            layer_id (int): Index of the current layer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of potentially modified (input_args, input_kwargs).</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If hidden states cannot be located.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">input_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">input_args</span> <span class="k">else</span> <span class="n">input_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hidden_states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;CAST: could not locate hidden states&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_length</span><span class="p">,</span> <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># CASE 1 -&gt; no steering</span>
            <span class="n">is_condition_layer</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">is_behavior_layer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># CASE 2 -&gt; steering</span>
            <span class="n">is_condition_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>
            <span class="n">is_behavior_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_behavior_layers</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

        <span class="n">original_norm</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_condition_layer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_single_condition</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">layer_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_behavior_layer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_single_behavior</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ooi_preventive_normalization</span> <span class="ow">and</span> <span class="n">is_behavior_layer</span><span class="p">:</span>
            <span class="n">hidden_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ooi_normalization</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">,</span> <span class="n">original_norm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_args</span><span class="p">:</span>
            <span class="n">input_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
            <span class="n">input_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidden_states</span>
            <span class="n">my_input_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_input_args</span> <span class="o">=</span> <span class="n">input_args</span>
            <span class="n">input_kwargs</span><span class="p">[</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidden_states</span>

        <span class="k">return</span> <span class="n">my_input_args</span><span class="p">,</span> <span class="n">input_kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_single_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_state</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect if input matches target condition pattern.</span>

<span class="sd">        Projects hidden states onto condition subspace and compares similarity against threshold to determine if</span>
<span class="sd">        steering should be activated.</span>

<span class="sd">        Process:</span>

<span class="sd">        1. Aggregate hidden states (mean or last token based on config)</span>
<span class="sd">        2. Project onto condition subspace using precomputed projector</span>
<span class="sd">        3. Compute cosine similarity between original and projected</span>
<span class="sd">        4. Compare against threshold with specified comparator</span>

<span class="sd">        Args:</span>
<span class="sd">            hidden_state: Hidden state tensor to analyze [seq_len, hidden_dim].</span>
<span class="sd">            layer_id (int): Current layer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                <span class="n">hidden_state</span> <span class="o">=</span> <span class="n">hidden_state</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_threshold_comparison_mode</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
                <span class="n">hidden_state</span> <span class="o">=</span> <span class="n">hidden_state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">projected_hidden_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_projector</span><span class="p">,</span> <span class="n">hidden_state</span><span class="p">))</span>
            <span class="n">condition_similarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_similarity</span><span class="p">(</span><span class="n">hidden_state</span><span class="p">,</span> <span class="n">projected_hidden_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_condition_similarities</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_similarity</span>

            <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span> <span class="o">==</span> <span class="s2">&quot;smaller&quot;</span><span class="p">:</span>
                <span class="n">condition_met</span> <span class="o">=</span> <span class="p">(</span><span class="n">condition_similarity</span> <span class="o">&gt;=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span> <span class="o">==</span> <span class="s2">&quot;larger&quot;</span><span class="p">:</span>
                <span class="n">condition_met</span> <span class="o">=</span> <span class="p">(</span><span class="n">condition_similarity</span> <span class="o">&lt;</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_met</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;layer </span><span class="si">{</span><span class="n">layer_id</span><span class="si">}</span><span class="s2">:  similarity: </span><span class="si">{</span><span class="n">condition_similarity</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;threshold: </span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;condition comparator threshold &#39;</span><span class="si">{</span><span class="n">layer_args</span><span class="o">.</span><span class="n">condition_comparator_threshold_is</span><span class="si">}</span><span class="s2">&#39; -- &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;Condition Met: </span><span class="si">{</span><span class="n">condition_met</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_single_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply behavior steering vector when conditions are met.</span>

<span class="sd">        Modifies hidden states by adding scaled steering vectors to shift model behavior toward desired outputs.</span>

<span class="sd">        Args:</span>
<span class="sd">            hidden_states: Hidden states to modify [batch, seq_len, hidden_dim].</span>
<span class="sd">            layer_id (int): Current layer index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer_states</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span>

        <span class="n">should_apply</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_condition_layers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># print(f&quot;Should Apply Behavior: {should_apply}&quot;)</span>

        <span class="k">if</span> <span class="n">should_apply</span><span class="p">:</span>
            <span class="n">control</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">behavior_vector</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">hidden_states</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span><span class="p">[</span><span class="n">layer_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">apply_behavior_on_first_call</span><span class="p">:</span>
                    <span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">control</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;apply_behavior_on_first_call is False, skipping behavior vector application&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_args</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">operator</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">control</span><span class="p">)</span>
                <span class="c1"># print(f&quot;{layer_id=}: Applying behavior vector to all tokens&quot;)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_similarity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the cosine similarity between two tensors.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: First tensor.</span>
<span class="sd">            y: Second tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The cosine similarity as a float.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cossim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">cossim</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_ooi_normalization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="n">original_norm</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply out-of-distribution preventive normalization.</span>

<span class="sd">        Prevents hidden states from drifting too far from original distribution by rescaling to maintain norm magnitudes after steering.</span>

<span class="sd">        Args:</span>
<span class="sd">            hidden_states: Modified hidden states to normalize.</span>
<span class="sd">            original_norm: Original norm before modifications.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor: Normalized hidden states.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If NaN or Inf detected in hidden states.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_norm</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">max_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_norm</span> <span class="o">/</span> <span class="n">original_norm</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">has_nan_inf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">has_nan_inf</span><span class="p">:</span>
            <span class="c1"># NaN propagates, decided to raise instead of just applying norm as in original code.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2"> or Inf: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2"> dectected in hidden_states&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">has_nan_inf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying OOI preventive normalization. Max_ratio was </span><span class="si">{</span><span class="n">max_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span> <span class="o">*</span> <span class="p">(</span><span class="n">original_norm</span> <span class="o">/</span> <span class="n">new_norm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No OOI preventive normalization. Max_ratio was </span><span class="si">{</span><span class="n">max_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hidden_states</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pre&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="p">[]}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.registered" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">registered</span> <span class="o">=</span> <span class="p">[]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.get_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_hooks</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Create pre-forward hooks for conditional activation steering.</p>
<p>Generates hook specifications for all model layers that will conditionally detect patterns and apply behavior
modifications during the forward pass.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDs (unused but required by interface).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runtime parameters (currently unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, list]: Hook specifications with "pre", "forward", "backward" keys.
Only "pre" hooks are populated with CAST steering logic.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">__</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create pre-forward hooks for conditional activation steering.</span>

<span class="sd">    Generates hook specifications for all model layers that will conditionally detect patterns and apply behavior</span>
<span class="sd">    modifications during the forward pass.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids (torch.Tensor): Input token IDs (unused but required by interface).</span>
<span class="sd">        runtime_kwargs (dict | None): Runtime parameters (currently unused).</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, list]: Hook specifications with &quot;pre&quot;, &quot;forward&quot;, &quot;backward&quot; keys.</span>
<span class="sd">            Only &quot;pre&quot; hooks are populated with CAST steering logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">layer_id</span><span class="p">,</span> <span class="n">layer_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_layers_names</span><span class="p">):</span>
        <span class="n">hooks</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">layer_name</span><span class="p">,</span>  <span class="c1"># &quot;model.layers.0&quot;</span>
                <span class="s2">&quot;hook_func&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cast_pre_hook</span><span class="p">,</span>
                    <span class="n">layer_id</span><span class="o">=</span><span class="n">layer_id</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">hooks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.get_model_layer_list" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_model_layer_list</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Extract the list of transformer layers from the model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model to extract layers from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:</p>
<pre><code>List of layers for given model
List of layers module name prefix for given model
</code></pre>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_model_layer_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the list of transformer layers from the model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): Model to extract layers from.</span>

<span class="sd">    Returns:</span>

<span class="sd">        List of layers for given model</span>
<span class="sd">        List of layers module name prefix for given model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">layers_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_layers</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>  <span class="c1"># mistral-, llama-, gemma-like models</span>
        <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span>
        <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;model.layers&quot;</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;transformer&quot;</span><span class="p">):</span>  <span class="c1"># gpt2-like models</span>
        <span class="n">model_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">h</span>
        <span class="n">model_layers_prefix</span> <span class="o">=</span> <span class="s2">&quot;transformer.h&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t know how to get layer list from model for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_layers</span><span class="p">):</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">layers_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_layers_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">layers</span><span class="p">,</span> <span class="n">layers_names</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.register_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">register_hooks</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Attach hooks to model.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attach hooks to model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;backward&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">phase</span><span class="p">]:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_submodule</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;pre&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_pre_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_full_backward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.remove_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">remove_hooks</span><span class="p">()</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Remove all registered hooks from the model.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all registered hooks from the model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.reset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">reset</span><span class="p">()</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Reset internal state tracking between generation calls.</p>
<p>Clears condition detection flags, forward call counters, and similarity scores.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset internal state tracking between generation calls.</span>

<span class="sd">    Clears condition detection flags, forward call counters, and similarity scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_condition_met</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_forward_calls</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_condition_similarities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.set_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">set_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Update the hook specifications to be registered.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the hook specifications to be registered.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">hooks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.cast.control.CAST.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Initialization by configuring condition detection and behavior modification layers.</p>
<p>Sets up steering vectors, condition projectors, and layer-specific parameters for conditional activation
steering. Pre-computes projection matrices and behavior vectors.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base language model to be steered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer (currently unused but maintained
for API consistency). If None, attempts to retrieve from model attributes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>PreTrainedModel</code></td>            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input model, unchanged.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/cast/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">__</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialization by configuring condition detection and behavior modification layers.</span>

<span class="sd">    Sets up steering vectors, condition projectors, and layer-specific parameters for conditional activation</span>
<span class="sd">    steering. Pre-computes projection matrices and behavior vectors.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">        tokenizer (PreTrainedTokenizer | None): Tokenizer (currently unused but maintained</span>
<span class="sd">            for API consistency). If None, attempts to retrieve from model attributes.</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        PreTrainedModel: The input model, unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.state_control.pasta" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>pasta</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.state_control.pasta.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.state_control.pasta.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.algorithms.state_control.pasta.control.PASTA" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>PASTA</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StateControl (aisteer360.algorithms.state_control.base.StateControl)" href="#aisteer360.algorithms.state_control.base.StateControl">StateControl</a></code></p>


        <p>Implementation of PASTA (Post-hoc Attention STeering Approach) from Zhang et al., 2023.</p>
<p>PASTA performs controlled text generation by dynamically modifying attention patterns during inference to amplify or
suppress the influence of specific text spans. This allows for fine-grained steering of model behavior without
requiring model retraining or parameter updates.</p>
<p>The algorithm works by:</p>
<ol>
<li>
<p><strong>Substring Identification</strong>: Locate target substrings within the input prompt using tokenizer offset mapping to
determine precise token ranges.</p>
</li>
<li>
<p><strong>Attention Modification</strong>: Inject scaling factors into the attention mask of specified layers and heads to
increase or decrease attention weights for the identified token ranges.</p>
</li>
<li>
<p><strong>Dynamic Steering</strong>: Apply different scaling strategies (include, exclude, or generation-focused) to control how
the model attends to relevant spans during text generation.</p>
</li>
</ol>
<p>This approach enables real-time control over model focus and can be used for tasks like concept amplification, bias
mitigation, or content filtering without architectural changes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Scaling factor for attention modification. Positive values increase attention, negative values
decrease attention. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>head_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | <span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration specifying which layers/heads to modify. If dict, maps layer indices
to lists of head indices. If list, applies to all heads in specified layers.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale_position</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strategy for applying attention scaling. Options:</p>
<ul>
<li>"include": Scale attention TO the target substrings</li>
<li>"exclude": Scale attention AWAY FROM the target substrings</li>
<li>"generation": Scale attention during generation phase</li>
</ul>
<p>Defaults to "include".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Reference:
- "PASTA: Tell Your Model Where to Attend: Post-hoc Attention Steering for LLMs"
Qingru Zhang, Chandan Singh, Liyuan Liu, Xiaodong Liu, Bin Yu, Jianfeng Gao, Tuo Zhao
<a href="https://arxiv.org/abs/2311.02262">https://arxiv.org/abs/2311.02262</a></p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/state_control/pasta/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PASTA</span><span class="p">(</span><span class="n">StateControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of PASTA (Post-hoc Attention STeering Approach) from Zhang et al., 2023.</span>

<span class="sd">    PASTA performs controlled text generation by dynamically modifying attention patterns during inference to amplify or</span>
<span class="sd">    suppress the influence of specific text spans. This allows for fine-grained steering of model behavior without</span>
<span class="sd">    requiring model retraining or parameter updates.</span>

<span class="sd">    The algorithm works by:</span>

<span class="sd">    1. **Substring Identification**: Locate target substrings within the input prompt using tokenizer offset mapping to</span>
<span class="sd">    determine precise token ranges.</span>

<span class="sd">    2. **Attention Modification**: Inject scaling factors into the attention mask of specified layers and heads to</span>
<span class="sd">    increase or decrease attention weights for the identified token ranges.</span>

<span class="sd">    3. **Dynamic Steering**: Apply different scaling strategies (include, exclude, or generation-focused) to control how</span>
<span class="sd">    the model attends to relevant spans during text generation.</span>

<span class="sd">    This approach enables real-time control over model focus and can be used for tasks like concept amplification, bias</span>
<span class="sd">    mitigation, or content filtering without architectural changes.</span>

<span class="sd">    Args:</span>
<span class="sd">        alpha (float): Scaling factor for attention modification. Positive values increase attention, negative values</span>
<span class="sd">            decrease attention. Defaults to 1.0.</span>
<span class="sd">        head_config (dict | list): Configuration specifying which layers/heads to modify. If dict, maps layer indices</span>
<span class="sd">            to lists of head indices. If list, applies to all heads in specified layers.</span>
<span class="sd">        scale_position (str): Strategy for applying attention scaling. Options:</span>

<span class="sd">            - &quot;include&quot;: Scale attention TO the target substrings</span>
<span class="sd">            - &quot;exclude&quot;: Scale attention AWAY FROM the target substrings</span>
<span class="sd">            - &quot;generation&quot;: Scale attention during generation phase</span>

<span class="sd">            Defaults to &quot;include&quot;.</span>

<span class="sd">    Reference:</span>
<span class="sd">    - &quot;PASTA: Tell Your Model Where to Attend: Post-hoc Attention Steering for LLMs&quot;</span>
<span class="sd">    Qingru Zhang, Chandan Singh, Liyuan Liu, Xiaodong Liu, Bin Yu, Jianfeng Gao, Tuo Zhao</span>
<span class="sd">    [https://arxiv.org/abs/2311.02262](https://arxiv.org/abs/2311.02262)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span> <span class="o">=</span> <span class="n">PASTAArgs</span>

    <span class="c1"># placeholders</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_head_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_layers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_scale_constant</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize PASTA by configuring attention head mappings and model references.</span>

<span class="sd">        Sets up the layer and head configurations that will be modified during generation.</span>
<span class="sd">        Validates head configurations against model architecture.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">            tokenizer (PreTrainedTokenizer | None): Tokenizer for substring identification.</span>
<span class="sd">                If None, attempts to retrieve from model attributes.</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            PreTrainedModel: The input model (unchanged).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_head_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">__</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create attention modification hooks for specified substrings.</span>

<span class="sd">        Identifies token ranges corresponding to target substrings and prepares hooks that will modify attention weights</span>
<span class="sd">        during the forward pass.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_ids (torch.Tensor): Input token IDs of shape [batch_size, seq_len].</span>
<span class="sd">            runtime_kwargs (dict | None): Must contain &quot;substrings&quot; key with target text spans:</span>

<span class="sd">                - str: Single substring applied to all batch items</span>
<span class="sd">                - list[str]: List of substrings applied to all batch items</span>
<span class="sd">                - list[list[str]]: Per-batch substring groups</span>
<span class="sd">            **__: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, list]: Hook specifications with &quot;pre&quot;, &quot;forward&quot;, &quot;backward&quot; keys. Only &quot;pre&quot; hooks are populated for attention modification.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If &quot;substrings&quot; not in runtime_kwargs or batch size mismatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="s2">&quot;substrings&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PASTA requires &#39;substrings&#39; inside runtime_kwargs&quot;</span><span class="p">)</span>

        <span class="n">substrings</span> <span class="o">=</span> <span class="n">runtime_kwargs</span><span class="p">[</span><span class="s2">&quot;substrings&quot;</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># normalize substrings to shape (batch, group, str)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substrings</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">substrings</span> <span class="o">=</span> <span class="p">[[</span><span class="n">substrings</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="k">elif</span> <span class="n">substrings</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substrings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">substrings</span> <span class="o">=</span> <span class="p">[</span><span class="n">substrings</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">substrings</span><span class="p">)</span> <span class="o">!=</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Need </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> substring groups (one per prompt); got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">substrings</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># decode and get offsets</span>
        <span class="n">prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Have to encode &amp; decode substrings along with prompts, since we observed prompts getting changed due to</span>
        <span class="c1"># tokenization (e.g. spaces removed); and we need to replicate the same effect in the substrings to ensure they</span>
        <span class="c1"># actually match</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">substring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">substrings</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">substrings</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span>
                    <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">breakpoint</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">!=</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span>

        <span class="n">tokenized</span><span class="p">:</span> <span class="n">BatchEncoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="n">return_offsets_mapping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">offset_mapping</span> <span class="o">=</span> <span class="n">tokenized</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;offset_mapping&quot;</span><span class="p">)</span>
        <span class="n">input_len</span> <span class="o">=</span> <span class="n">tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">token_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_ranges_from_batch</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span> <span class="n">substrings</span><span class="p">,</span> <span class="n">offset_mapping</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">],</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">tokenized</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

        <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">:</span>
            <span class="n">hooks</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;model.layers.</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">.self_attn&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;hook_func&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_attention_pre_hook</span><span class="p">,</span>
                        <span class="n">head_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_head_map</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span>
                        <span class="n">token_ranges</span><span class="o">=</span><span class="n">token_ranges</span><span class="p">,</span>
                        <span class="n">input_len</span><span class="o">=</span><span class="n">input_len</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">hooks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_head_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">head_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse and validate attention head configuration.</span>

<span class="sd">        Converts various configuration formats into internal layer-head mappings and validates against model architecture.</span>

<span class="sd">        Args:</span>
<span class="sd">            head_config: Configuration specifying which layers/heads to modify:</span>

<span class="sd">                - dict: Maps layer indices to lists of head indices</span>
<span class="sd">                - list: Layer indices (applies to all heads in those layers)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If configuration format invalid or heads out of range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">head_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_head_map</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">):</span> <span class="nb">list</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">head_config</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_head_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">head_config</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">head_config</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_head_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_attention_heads</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid head configuration: </span><span class="si">{</span><span class="n">head_config</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">num_heads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_attention_heads</span>
        <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">heads</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_head_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">heads</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">head</span> <span class="o">&lt;</span> <span class="n">num_heads</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s2"> out of range for layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> (0–</span><span class="si">{</span><span class="n">num_heads</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_token_range</span><span class="p">(</span>
        <span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">substring</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">offset_mapping</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
        <span class="n">occurrence</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map a substring to its token index range using offset mapping.</span>

<span class="sd">        Locates the character positions of a substring and converts them to token indices using the tokenizer&#39;s offset mapping.</span>

<span class="sd">        Args:</span>
<span class="sd">            string: Full text to search within.</span>
<span class="sd">            substring: Target substring to locate.</span>
<span class="sd">            offset_mapping: List of (start_char, end_char) tuples for each token.</span>
<span class="sd">            occurrence: Which occurrence to find if substring appears multiple times.</span>
<span class="sd">                Defaults to 0 (first occurrence).</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[int, int]: Start (inclusive) and end (exclusive) token indices.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If substring cannot be mapped to token range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">substring</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">substring</span><span class="si">}</span><span class="s2">&#39; not found in input </span><span class="si">{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="n">char_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">occurrence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">char_index</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">char_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">char_start</span> <span class="o">=</span> <span class="n">char_index</span>
        <span class="n">char_end</span> <span class="o">=</span> <span class="n">char_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>

        <span class="n">token_start</span> <span class="o">=</span> <span class="n">token_end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">token_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">start_char</span><span class="p">,</span> <span class="n">end_char</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">offset_mapping</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token_start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start_char</span> <span class="o">&lt;=</span> <span class="n">char_start</span> <span class="o">&lt;</span> <span class="n">end_char</span><span class="p">:</span>
                <span class="n">token_start</span> <span class="o">=</span> <span class="n">token_idx</span>
            <span class="k">if</span> <span class="n">token_end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start_char</span> <span class="o">&lt;</span> <span class="n">char_end</span> <span class="o">&lt;=</span> <span class="n">end_char</span><span class="p">:</span>
                <span class="n">token_end</span> <span class="o">=</span> <span class="n">token_idx</span>

        <span class="k">if</span> <span class="n">token_start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">token_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not map substring to token range&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">token_start</span><span class="p">,</span> <span class="n">token_end</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_token_ranges_from_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">groups</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">offsets_mapping</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
        <span class="n">occurrence</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert batch of substring groups to token ranges.</span>

<span class="sd">        Maps multiple substrings across batch items to their corresponding token index ranges for attention modification.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: Decoded text for each batch item.</span>
<span class="sd">            groups: Groups of substrings for each batch item.</span>
<span class="sd">            offsets_mapping: Token offset mappings for each batch item.</span>
<span class="sd">            occurrence: Which occurrence to find for repeated substrings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[torch.Tensor]: Token range tensors for each batch item.</span>
<span class="sd">                Each tensor has shape [num_substrings, 2] with [start, end] pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token_ranges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">substrings</span><span class="p">,</span> <span class="n">offsets</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">offsets_mapping</span><span class="p">):</span>
            <span class="n">substring_ranges</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_find_token_range</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">substring</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="n">substrings</span>
            <span class="p">]</span>
            <span class="n">token_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">substring_ranges</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">token_ranges</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_attention_pre_hook</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">module</span><span class="p">,</span>
        <span class="n">input_args</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
        <span class="n">input_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">head_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">token_ranges</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
        <span class="n">input_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify attention mask to steer focus toward/away from target tokens.</span>

<span class="sd">        Pre-forward hook that adjusts attention weights by adding scaling factors to the attention mask for specified token ranges and attention heads.</span>

<span class="sd">        Args:</span>
<span class="sd">            module: The attention module being hooked.</span>
<span class="sd">            input_args: Positional arguments to the forward pass.</span>
<span class="sd">            input_kwargs: Keyword arguments to the forward pass.</span>
<span class="sd">            head_idx: List of attention head indices to modify.</span>
<span class="sd">            token_ranges: Token index ranges to apply scaling to.</span>
<span class="sd">            input_len: Length of input sequence (for generation positioning).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of potentially modified (input_args, input_kwargs).</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If hidden states cannot be located.</span>
<span class="sd">            ValueError: If scale_position is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">input_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">input_args</span> <span class="k">else</span> <span class="n">input_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden_states&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">hidden_states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;PASTA: could not locate hidden states&quot;</span><span class="p">)</span>

        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">input_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attention_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># build it</span>
            <span class="n">batch_size</span><span class="p">,</span> <span class="n">sequence_len</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">num_heads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_attention_heads</span>
            <span class="n">causal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span>
                <span class="n">hidden_states</span><span class="o">.</span><span class="n">new_full</span><span class="p">((</span><span class="n">sequence_len</span><span class="p">,</span> <span class="n">sequence_len</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)),</span>
                <span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">causal</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (1,1,q,k)</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
            <span class="n">input_kwargs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_mask</span>

        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hidden_states</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_attention_heads</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="ow">in</span> <span class="n">token_ranges</span><span class="p">[</span><span class="n">batch_index</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">start_idx</span> <span class="o">==</span> <span class="n">end_idx</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_position</span> <span class="o">==</span> <span class="s2">&quot;include&quot;</span><span class="p">:</span>
                    <span class="n">attention_mask</span><span class="p">[</span>
                        <span class="n">batch_index</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span>
                    <span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_position</span> <span class="o">==</span> <span class="s2">&quot;exclude&quot;</span><span class="p">:</span>
                    <span class="n">attention_mask</span><span class="p">[</span>
                        <span class="n">batch_index</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">start_idx</span>
                    <span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span>
                    <span class="n">attention_mask</span><span class="p">[</span>
                        <span class="n">batch_index</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">end_idx</span><span class="p">:</span><span class="n">input_len</span>
                    <span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_position</span> <span class="o">==</span> <span class="s2">&quot;generation&quot;</span><span class="p">:</span>
                    <span class="n">attention_mask</span><span class="p">[</span>
                        <span class="n">batch_index</span><span class="p">,</span> <span class="n">head_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">input_len</span>
                    <span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown scale_position &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_position</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_position</span> <span class="o">==</span> <span class="s2">&quot;include&quot;</span><span class="p">:</span>
            <span class="n">attention_mask</span><span class="p">[:,</span> <span class="n">head_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">input_len</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span>

        <span class="n">input_kwargs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_mask</span>
        <span class="k">return</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">input_kwargs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pre&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span> <span class="p">[]}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.registered" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">registered</span> <span class="o">=</span> <span class="p">[]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.get_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_hooks</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">runtime_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Create attention modification hooks for specified substrings.</p>
<p>Identifies token ranges corresponding to target substrings and prepares hooks that will modify attention weights
during the forward pass.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>input_ids</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token IDs of shape [batch_size, seq_len].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Must contain "substrings" key with target text spans:</p>
<ul>
<li>str: Single substring applied to all batch items</li>
<li>list[str]: List of substrings applied to all batch items</li>
<li>list[list[str]]: Per-batch substring groups</li>
</ul>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, list]: Hook specifications with "pre", "forward", "backward" keys. Only "pre" hooks are populated for attention modification.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If "substrings" not in runtime_kwargs or batch size mismatch.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/pasta/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_hooks</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">runtime_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">__</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create attention modification hooks for specified substrings.</span>

<span class="sd">    Identifies token ranges corresponding to target substrings and prepares hooks that will modify attention weights</span>
<span class="sd">    during the forward pass.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_ids (torch.Tensor): Input token IDs of shape [batch_size, seq_len].</span>
<span class="sd">        runtime_kwargs (dict | None): Must contain &quot;substrings&quot; key with target text spans:</span>

<span class="sd">            - str: Single substring applied to all batch items</span>
<span class="sd">            - list[str]: List of substrings applied to all batch items</span>
<span class="sd">            - list[list[str]]: Per-batch substring groups</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, list]: Hook specifications with &quot;pre&quot;, &quot;forward&quot;, &quot;backward&quot; keys. Only &quot;pre&quot; hooks are populated for attention modification.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If &quot;substrings&quot; not in runtime_kwargs or batch size mismatch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">runtime_kwargs</span> <span class="ow">or</span> <span class="s2">&quot;substrings&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;PASTA requires &#39;substrings&#39; inside runtime_kwargs&quot;</span><span class="p">)</span>

    <span class="n">substrings</span> <span class="o">=</span> <span class="n">runtime_kwargs</span><span class="p">[</span><span class="s2">&quot;substrings&quot;</span><span class="p">]</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># normalize substrings to shape (batch, group, str)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substrings</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">substrings</span> <span class="o">=</span> <span class="p">[[</span><span class="n">substrings</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span>
    <span class="k">elif</span> <span class="n">substrings</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substrings</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">substrings</span> <span class="o">=</span> <span class="p">[</span><span class="n">substrings</span><span class="p">]</span> <span class="o">*</span> <span class="n">batch_size</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">substrings</span><span class="p">)</span> <span class="o">!=</span> <span class="n">batch_size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Need </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> substring groups (one per prompt); got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">substrings</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># decode and get offsets</span>
    <span class="n">prompts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Have to encode &amp; decode substrings along with prompts, since we observed prompts getting changed due to</span>
    <span class="c1"># tokenization (e.g. spaces removed); and we need to replicate the same effect in the substrings to ensure they</span>
    <span class="c1"># actually match</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">substring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">substrings</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">substrings</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span>
                <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">breakpoint</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">!=</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">padding_side</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span>

    <span class="n">tokenized</span><span class="p">:</span> <span class="n">BatchEncoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
        <span class="n">prompts</span><span class="p">,</span>
        <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
        <span class="n">return_offsets_mapping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">offset_mapping</span> <span class="o">=</span> <span class="n">tokenized</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;offset_mapping&quot;</span><span class="p">)</span>
    <span class="n">input_len</span> <span class="o">=</span> <span class="n">tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">token_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_ranges_from_batch</span><span class="p">(</span>
        <span class="n">prompts</span><span class="p">,</span> <span class="n">substrings</span><span class="p">,</span> <span class="n">offset_mapping</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_constant</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">tokenized</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>

    <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;backward&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layers</span><span class="p">:</span>
        <span class="n">hooks</span><span class="p">[</span><span class="s2">&quot;pre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;model.layers.</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">.self_attn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hook_func&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_attention_pre_hook</span><span class="p">,</span>
                    <span class="n">head_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_head_map</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span>
                    <span class="n">token_ranges</span><span class="o">=</span><span class="n">token_ranges</span><span class="p">,</span>
                    <span class="n">input_len</span><span class="o">=</span><span class="n">input_len</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">hooks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.register_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">register_hooks</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Attach hooks to model.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attach hooks to model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="s2">&quot;backward&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">phase</span><span class="p">]:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_submodule</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;pre&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_pre_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">],</span> <span class="n">with_kwargs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">register_full_backward_hook</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;hook_func&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.remove_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">remove_hooks</span><span class="p">()</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Remove all registered hooks from the model.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all registered hooks from the model.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registered</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.reset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">reset</span><span class="p">()</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Optional reset call for state control</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optional reset call for state control&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.set_hooks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">set_hooks</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Update the hook specifications to be registered.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hooks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">HookSpec</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the hook specifications to be registered.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">hooks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.algorithms.state_control.pasta.control.PASTA.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Initialize PASTA by configuring attention head mappings and model references.</p>
<p>Sets up the layer and head configurations that will be modified during generation.
Validates head configurations against model architecture.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base language model to be steered.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for substring identification.
If None, attempts to retrieve from model attributes.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**__</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>PreTrainedModel</code></td>            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input model (unchanged).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/state_control/pasta/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize PASTA by configuring attention head mappings and model references.</span>

<span class="sd">    Sets up the layer and head configurations that will be modified during generation.</span>
<span class="sd">    Validates head configurations against model architecture.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): The base language model to be steered.</span>
<span class="sd">        tokenizer (PreTrainedTokenizer | None): Tokenizer for substring identification.</span>
<span class="sd">            If None, attempts to retrieve from model attributes.</span>
<span class="sd">        **__: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        PreTrainedModel: The input model (unchanged).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_head_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">head_config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="aisteer360.algorithms.structural_control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>structural_control</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.structural_control.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base</code>


</h5>

    <div class="doc doc-contents ">

        <p>Structural control base classes.</p>
<p>This module provides the abstract base class for methods that create persistent changes to the model, either through
weight updates or architectural changes.</p>
<p>Two base classes are provided:</p>
<ul>
<li><code>StructuralControl</code>: Base class for all structural control methods.</li>
<li><code>NoStructuralControl</code>: Identity (null) control; used when no structural control is defined in steering pipeline.</li>
</ul>
<p>Structural controls implement steering through model weight or architecture modifications, transforming base parameters
θ to θ', resulting in generations following y ~ p_θ'(x).</p>
<p>Examples of structural controls:</p>
<ul>
<li>Fine-tuning (full or parameter-efficient like LoRA)</li>
<li>Model merging (e.g., via MergeKit)</li>
<li>Direct Preference Optimization (DPO)</li>
<li>Adapter layers and modules</li>
<li>Weight interpolation and averaging</li>
</ul>
<p>See Also:</p>
<ul>
<li><code>aisteer360.algorithms.structural_control</code>: Implementations of structural control methods</li>
<li><code>aisteer360.core.steering_pipeline</code>: Integration with steering pipeline</li>
</ul>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.structural_control.base.NoStructuralControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>NoStructuralControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a></code></p>


        <p>Identity structural control.</p>
<p>Used as the default when no structural control is needed. Passes the model through unchanged.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NoStructuralControl</span><span class="p">(</span><span class="n">StructuralControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identity structural control.</span>

<span class="sd">    Used as the default when no structural control is needed. Passes the model through unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Null steer operation; returns model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.structural_control.base.NoStructuralControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.structural_control.base.NoStructuralControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.structural_control.base.NoStructuralControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Null steer operation; returns model.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Null steer operation; returns model.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h6 id="aisteer360.algorithms.structural_control.base.StructuralControl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>StructuralControl</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for structural control steering methods.</p>
<p>Modifies model parameters or architecture persistently, returning a new model instance with transformed weights.</p>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="            steer(model, tokenizer=None, **kwargs)

  
      abstractmethod
   (aisteer360.algorithms.structural_control.base.StructuralControl.steer)" href="#aisteer360.algorithms.structural_control.base.StructuralControl.steer">steer</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Training logic (required)</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StructuralControl</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for structural control steering methods.</span>

<span class="sd">    Modifies model parameters or architecture persistently, returning a new model instance with transformed weights.</span>

<span class="sd">    Methods:</span>
<span class="sd">        steer(model, tokenizer, **kwargs) -&gt; PreTrainedModel: Training logic (required)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseArgs</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># null control</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> accepts no constructor arguments.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> <span class="n">BaseArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># move fields to attributes</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Required steering/preparation.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.structural_control.base.StructuralControl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.algorithms.structural_control.base.StructuralControl.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.algorithms.structural_control.base.StructuralControl.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Required steering/preparation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.algorithms.structural_control.wrappers" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>wrappers</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.structural_control.wrappers.mergekit" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>mergekit</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.mergekit.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.mergekit.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.algorithms.structural_control.wrappers.mergekit.control.MergeKit" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>MergeKit</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a></code></p>


        <p>Wrapper for merging models via MergeKit <a href="https://github.com/arcee-ai/mergekit">https://github.com/arcee-ai/mergekit</a>.</p>
<p>MergeKit combines multiple language models using various merge strategies like linear interpolation, SLERP, and
TIES. This wrapper integrates MergeKit's functionality to enable structural control through model composition.</p>
<p>The process involves loading a merge configuration (from YAML or dict), executing the merge operation, and
optionally loading the resulting merged model. Supports caching to avoid redundant operations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to YAML merge configuration file. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary merge configuration. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>out_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output directory for merged model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>load_merged</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to load merged model after merging. Defaults to True.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>force_remerge</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Force remerge even if output exists. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_cuda</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Use CUDA acceleration if available. Defaults to True.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device_map</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device mapping for model loading. Defaults to None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trust_remote_code</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Trust remote code when loading. Defaults to False.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dtype</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyTorch dtype for loading. Defaults to "float16".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Reference:</p>
<ul>
<li>"Arcee's MergeKit: A Toolkit for Merging Large Language Models"
  Charles Goddard, Shamane Siriwardhana, Malikeh Ehghaghi, Luke Meyers, Vladimir Karpukhin, Brian Benedict,
  Mark McQuade, Jacob Solawetz
  <a href="https://aclanthology.org/2024.emnlp-industry.36">https://aclanthology.org/2024.emnlp-industry.36</a></li>
</ul>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/mergekit/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MergeKit</span><span class="p">(</span><span class="n">StructuralControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for merging models via MergeKit [https://github.com/arcee-ai/mergekit](https://github.com/arcee-ai/mergekit).</span>

<span class="sd">    MergeKit combines multiple language models using various merge strategies like linear interpolation, SLERP, and</span>
<span class="sd">    TIES. This wrapper integrates MergeKit&#39;s functionality to enable structural control through model composition.</span>

<span class="sd">    The process involves loading a merge configuration (from YAML or dict), executing the merge operation, and</span>
<span class="sd">    optionally loading the resulting merged model. Supports caching to avoid redundant operations.</span>

<span class="sd">    Args:</span>
<span class="sd">        config_path (str, optional): Path to YAML merge configuration file. Defaults to None.</span>
<span class="sd">        config_dict (dict, optional): Dictionary merge configuration. Defaults to None.</span>
<span class="sd">        out_path (str): Output directory for merged model.</span>
<span class="sd">        load_merged (bool): Whether to load merged model after merging. Defaults to True.</span>
<span class="sd">        force_remerge (bool): Force remerge even if output exists. Defaults to False.</span>
<span class="sd">        allow_cuda (bool): Use CUDA acceleration if available. Defaults to True.</span>
<span class="sd">        device_map (str | dict, optional): Device mapping for model loading. Defaults to None.</span>
<span class="sd">        trust_remote_code (bool): Trust remote code when loading. Defaults to False.</span>
<span class="sd">        dtype (str): PyTorch dtype for loading. Defaults to &quot;float16&quot;.</span>

<span class="sd">    Reference:</span>

<span class="sd">    - &quot;Arcee&#39;s MergeKit: A Toolkit for Merging Large Language Models&quot;</span>
<span class="sd">      Charles Goddard, Shamane Siriwardhana, Malikeh Ehghaghi, Luke Meyers, Vladimir Karpukhin, Brian Benedict,</span>
<span class="sd">      Mark McQuade, Jacob Solawetz</span>
<span class="sd">      [https://aclanthology.org/2024.emnlp-industry.36](https://aclanthology.org/2024.emnlp-industry.36)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Args</span> <span class="o">=</span> <span class="n">MergeKitArgs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">_</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute model merging via MergeKit and optionally return the merged model.</span>

<span class="sd">        Performs structural steering by merging multiple models according to a configuration file or dictionary.</span>
<span class="sd">        Supports caching to avoid redundant merge operations and can either return the merged model or the original</span>
<span class="sd">        model based on configuration.</span>

<span class="sd">        The method follows this logic:</span>

<span class="sd">        1. Load merge configuration from YAML file or dictionary</span>
<span class="sd">        2. Check if merged model already exists (skip if `force_remerge=False`)</span>
<span class="sd">        3. Execute merge if needed using MergeKit</span>
<span class="sd">        4. Optionally load and return the merged model</span>

<span class="sd">        Args:</span>
<span class="sd">            model (PreTrainedModel): The base model (potentially unused depending on the method).</span>
<span class="sd">            tokenizer (PreTrainedTokenizer, optional): Base tokenizer (currently unused).</span>
<span class="sd">            **_: Additional arguments (ignored).</span>

<span class="sd">        Returns:</span>
<span class="sd">            PreTrainedModel: Either the merged model (if `load_merged=True`) or the original model. When returning</span>
<span class="sd">            merged model, attempts to attach a new tokenizer if one was created during merging.</span>

<span class="sd">        Note:</span>

<span class="sd">        - If out_path exists and `force_remerge=False`, skips merging and loads cached result</span>
<span class="sd">        - Merged model saved to `out_path` directory with full weights and config</span>
<span class="sd">        - If `load_merged=False`, performs merge but returns original model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">MergeKitArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">config_path</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">mk_config</span><span class="o">.</span><span class="n">MergeConfiguration</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">mk_config</span><span class="o">.</span><span class="n">MergeConfiguration</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="n">config_dict</span><span class="p">)</span>

        <span class="c1"># find merged weights</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">out_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">force_remerge</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load_merged</span><span class="p">:</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="n">pretrained_model_name_or_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span>
                    <span class="n">device_map</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device_map</span><span class="p">,</span>
                    <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
                    <span class="n">torch_dtype</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">merged</span>
            <span class="k">return</span> <span class="n">model</span>

        <span class="c1"># merge</span>
        <span class="c1"># with FileLock(str(out_path) + &quot;.lock&quot;):</span>
        <span class="n">mk_merge</span><span class="o">.</span><span class="n">run_merge</span><span class="p">(</span>
            <span class="n">merge_config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">out_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span>
            <span class="n">options</span><span class="o">=</span><span class="n">mk_merge</span><span class="o">.</span><span class="n">MergeOptions</span><span class="p">(</span>
                <span class="n">use_cuda</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">allow_cuda</span><span class="p">,</span>
                <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># load merged checkpoint (and check if merge returned new tokenizer)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load_merged</span><span class="p">:</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="n">out_path</span><span class="p">,</span>
                <span class="n">torch_dtype</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                <span class="n">device_map</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device_map</span><span class="p">,</span>
                <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="n">out_path</span><span class="p">,</span>
                    <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">merged</span>

        <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.algorithms.structural_control.wrappers.mergekit.control.MergeKit.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.algorithms.structural_control.wrappers.mergekit.control.MergeKit.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.mergekit.control.MergeKit.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Execute model merging via MergeKit and optionally return the merged model.</p>
<p>Performs structural steering by merging multiple models according to a configuration file or dictionary.
Supports caching to avoid redundant merge operations and can either return the merged model or the original
model based on configuration.</p>
<p>The method follows this logic:</p>
<ol>
<li>Load merge configuration from YAML file or dictionary</li>
<li>Check if merged model already exists (skip if <code>force_remerge=False</code>)</li>
<li>Execute merge if needed using MergeKit</li>
<li>Optionally load and return the merged model</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base model (potentially unused depending on the method).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base tokenizer (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**_</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (ignored).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>PreTrainedModel</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either the merged model (if <code>load_merged=True</code>) or the original model. When returning</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>merged model, attempts to attach a new tokenizer if one was created during merging.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>If out_path exists and <code>force_remerge=False</code>, skips merging and loads cached result</li>
<li>Merged model saved to <code>out_path</code> directory with full weights and config</li>
<li>If <code>load_merged=False</code>, performs merge but returns original model</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/mergekit/control.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">_</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute model merging via MergeKit and optionally return the merged model.</span>

<span class="sd">    Performs structural steering by merging multiple models according to a configuration file or dictionary.</span>
<span class="sd">    Supports caching to avoid redundant merge operations and can either return the merged model or the original</span>
<span class="sd">    model based on configuration.</span>

<span class="sd">    The method follows this logic:</span>

<span class="sd">    1. Load merge configuration from YAML file or dictionary</span>
<span class="sd">    2. Check if merged model already exists (skip if `force_remerge=False`)</span>
<span class="sd">    3. Execute merge if needed using MergeKit</span>
<span class="sd">    4. Optionally load and return the merged model</span>

<span class="sd">    Args:</span>
<span class="sd">        model (PreTrainedModel): The base model (potentially unused depending on the method).</span>
<span class="sd">        tokenizer (PreTrainedTokenizer, optional): Base tokenizer (currently unused).</span>
<span class="sd">        **_: Additional arguments (ignored).</span>

<span class="sd">    Returns:</span>
<span class="sd">        PreTrainedModel: Either the merged model (if `load_merged=True`) or the original model. When returning</span>
<span class="sd">        merged model, attempts to attach a new tokenizer if one was created during merging.</span>

<span class="sd">    Note:</span>

<span class="sd">    - If out_path exists and `force_remerge=False`, skips merging and loads cached result</span>
<span class="sd">    - Merged model saved to `out_path` directory with full weights and config</span>
<span class="sd">    - If `load_merged=False`, performs merge but returns original model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">MergeKitArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">config_path</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">mk_config</span><span class="o">.</span><span class="n">MergeConfiguration</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">mk_config</span><span class="o">.</span><span class="n">MergeConfiguration</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="n">config_dict</span><span class="p">)</span>

    <span class="c1"># find merged weights</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">out_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">force_remerge</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load_merged</span><span class="p">:</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="n">pretrained_model_name_or_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span>
                <span class="n">device_map</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device_map</span><span class="p">,</span>
                <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
                <span class="n">torch_dtype</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">merged</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="c1"># merge</span>
    <span class="c1"># with FileLock(str(out_path) + &quot;.lock&quot;):</span>
    <span class="n">mk_merge</span><span class="o">.</span><span class="n">run_merge</span><span class="p">(</span>
        <span class="n">merge_config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
        <span class="n">out_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span>
        <span class="n">options</span><span class="o">=</span><span class="n">mk_merge</span><span class="o">.</span><span class="n">MergeOptions</span><span class="p">(</span>
            <span class="n">use_cuda</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">allow_cuda</span><span class="p">,</span>
            <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># load merged checkpoint (and check if merge returned new tokenizer)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load_merged</span><span class="p">:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">out_path</span><span class="p">,</span>
            <span class="n">torch_dtype</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="n">device_map</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device_map</span><span class="p">,</span>
            <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="n">out_path</span><span class="p">,</span>
                <span class="n">trust_remote_code</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trust_remote_code</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.algorithms.structural_control.wrappers.trl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>trl</code>


</h6>

    <div class="doc doc-contents ">

        <p>The TRL wrapper implements a variety of methods from Hugging Face's <a href="https://huggingface.co/docs/trl/index">TRL library</a>.</p>
<p>The current functionality spans the following methods:</p>
<ul>
<li><strong>SFT (Supervised Fine-Tuning)</strong>: Standard supervised learning to fine-tune language models on demonstration data</li>
<li><strong>DPO (Direct Preference Optimization)</strong>: Trains models directly on preference data without requiring a separate reward model</li>
<li><strong>APO (Anchored Preference Optimization)</strong>: A variant of DPO that uses an anchor model to improve training stability and performance</li>
<li><strong>SPPO (Self-Play Preference Optimization)</strong>: Iterative preference optimization using self-generated synthetic data to reduce dependency on external preference datasets</li>
</ul>
<p>For documentation information, please refer to the <a href="https://huggingface.co/docs/trl/index">TRL page</a> and the <a href="https://github.com/uclaml/SPPO">SPPO repository</a>.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>apotrainer</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>APO</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            DPOTrainerMixin (aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin)" href="#aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin">DPOTrainerMixin</a></code></p>


        








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/apotrainer/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">APO</span><span class="p">(</span><span class="n">DPOTrainerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Args</span> <span class="o">=</span> <span class="n">APOArgs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.Config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">Config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.eval_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.lora_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lora_kwargs</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.peft_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.ref_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.train_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.training_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.use_peft" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_peft</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.apotrainer.control.APO.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/dpotrainer/base_mixin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">DPOConfig</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
            <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">DPOTrainer</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">ref_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">peft_config</span><span class="o">=</span><span class="n">peft_config</span>
        <span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.trl.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.trl.base_mixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base_mixin</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.base_mixin.TRLMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>TRLMixin</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a></code></p>


        








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/base_mixin.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TRLMixin</span><span class="p">(</span><span class="n">StructuralControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.base_mixin.TRLMixin.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.base_mixin.TRLMixin.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.base_mixin.TRLMixin.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Required steering/preparation.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>dpotrainer</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base_mixin</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>DPOTrainerMixin</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a></code></p>


        








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/dpotrainer/base_mixin.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DPOTrainerMixin</span><span class="p">(</span><span class="n">StructuralControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Config</span><span class="p">:</span> <span class="n">Type</span>  <span class="c1"># set by subclass</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ref_model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">training_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_peft</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lora_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">training_args</span> <span class="o">=</span> <span class="n">DPOConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
                <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">trainer</span> <span class="o">=</span> <span class="n">DPOTrainer</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">ref_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
                <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
                <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">peft_config</span><span class="o">=</span><span class="n">peft_config</span>
            <span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

            <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.Config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">Config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.eval_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.lora_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lora_kwargs</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.peft_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.ref_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.train_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.training_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.use_peft" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_peft</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/dpotrainer/base_mixin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">DPOConfig</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
            <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">DPOTrainer</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">ref_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">peft_config</span><span class="o">=</span><span class="n">peft_config</span>
        <span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>DPO</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            DPOTrainerMixin (aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin)" href="#aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.base_mixin.DPOTrainerMixin">DPOTrainerMixin</a></code></p>


        








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/dpotrainer/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DPO</span><span class="p">(</span><span class="n">DPOTrainerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Args</span> <span class="o">=</span> <span class="n">DPOArgs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.Config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">Config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.eval_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.lora_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lora_kwargs</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.peft_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.ref_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.train_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.training_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.use_peft" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_peft</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.dpotrainer.control.DPO.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/dpotrainer/base_mixin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">DPOConfig</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
            <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">DPOTrainer</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">ref_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">peft_config</span><span class="o">=</span><span class="n">peft_config</span>
        <span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>sfttrainer</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base_mixin</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SFTTrainerMixin</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a></code></p>


        








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sfttrainer/base_mixin.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SFTTrainerMixin</span><span class="p">(</span><span class="n">StructuralControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Config</span><span class="p">:</span> <span class="n">Type</span>  <span class="c1"># set by subclass</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_collator</span><span class="p">:</span>  <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">training_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_peft</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lora_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data_collator is &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">)</span>
            <span class="n">training_args</span> <span class="o">=</span> <span class="n">SFTConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
                <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="n">trainer</span> <span class="o">=</span> <span class="n">SFTTrainer</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
                <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
                <span class="n">data_collator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
                <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">peft_config</span><span class="o">=</span><span class="n">peft_config</span>
            <span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

            <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.Config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">Config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.data_collator" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">data_collator</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.eval_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.lora_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lora_kwargs</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.peft_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.train_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.training_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.use_peft" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_peft</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sfttrainer/base_mixin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data_collator is &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">)</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">SFTConfig</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
            <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">SFTTrainer</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">data_collator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
            <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">peft_config</span><span class="o">=</span><span class="n">peft_config</span>
        <span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SFT</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            SFTTrainerMixin (aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin)" href="#aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.base_mixin.SFTTrainerMixin">SFTTrainerMixin</a></code></p>


        <p>Structural control that applies a LoRA adapter.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sfttrainer/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SFT</span><span class="p">(</span><span class="n">SFTTrainerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structural control that applies a LoRA adapter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Args</span> <span class="o">=</span> <span class="n">SFTArgs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.Config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">Config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.data_collator" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">data_collator</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.eval_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.lora_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lora_kwargs</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.peft_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.train_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.training_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.use_peft" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_peft</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sfttrainer.control.SFT.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sfttrainer/base_mixin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;data_collator is &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">)</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">SFTConfig</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
            <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">trainer</span> <span class="o">=</span> <span class="n">SFTTrainer</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">data_collator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
            <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">peft_config</span><span class="o">=</span><span class="n">peft_config</span>
        <span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>sppotrainer</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>args</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base_mixin</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SPPOTrainerMixin</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            StructuralControl (aisteer360.algorithms.structural_control.base.StructuralControl)" href="#aisteer360.algorithms.structural_control.base.StructuralControl">StructuralControl</a></code></p>


        








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/base_mixin.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SPPOTrainerMixin</span><span class="p">(</span><span class="n">StructuralControl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Config</span><span class="p">:</span> <span class="n">Type</span>  <span class="c1"># set by subclass</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">refModel</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">training_args</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_peft</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lora_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refModel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">maxlen</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">num_prompts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">additional_train_datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="s2">&quot;sppo_temp_dir&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refModel</span> <span class="o">=</span> <span class="n">refModel</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">training_args</span> <span class="o">=</span> <span class="n">DPOConfig</span><span class="p">(</span>      <span class="c1">#TrainingArguments(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
                <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refModel</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">checkpoints_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">steerer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_iter_num</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

                <span class="n">checkpoints_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/checkpoints/SPPO-Iter</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># steered model stored at each iteration</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">start_iter_num</span> <span class="ow">or</span> <span class="n">additional_train_datasets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">additional_train_datasets</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">start_iter_num</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">processed_train</span> <span class="o">=</span> <span class="n">prepare_dataset_from_prompts</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="p">,</span>
                    <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="n">sppo_temp_dir</span><span class="p">,</span>
                    <span class="n">iter_num</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span><span class="p">,</span>
                    <span class="n">num_prompts</span><span class="o">=</span><span class="n">num_prompts</span>
                <span class="p">)</span>
                <span class="n">trainer</span> <span class="o">=</span> <span class="n">SPPOTrainer</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">ref_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refModel</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
                    <span class="n">train_dataset</span><span class="o">=</span><span class="n">processed_train</span><span class="p">,</span>
                    <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
                    <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                    <span class="n">peft_config</span> <span class="o">=</span> <span class="n">peft_config</span><span class="p">,</span>
                    <span class="n">beta</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                    <span class="n">max_length</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                    <span class="n">max_prompt_length</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">,</span>
                    <span class="n">loss_type</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">loss_type</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

                <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">checkpoints_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">end_iter_num</span><span class="p">:</span>
                        <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>  <span class="c1">### this also needs to be changed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.Config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">Config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.eval_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.lora_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lora_kwargs</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.peft_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.refModel" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">refModel</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.train_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.training_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.use_peft" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_peft</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refModel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">num_prompts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">additional_train_datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="s1">&#39;sppo_temp_dir&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/base_mixin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refModel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">maxlen</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">num_prompts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">additional_train_datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="s2">&quot;sppo_temp_dir&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">refModel</span> <span class="o">=</span> <span class="n">refModel</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">DPOConfig</span><span class="p">(</span>      <span class="c1">#TrainingArguments(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
            <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refModel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">checkpoints_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">steerer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_iter_num</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">checkpoints_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/checkpoints/SPPO-Iter</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># steered model stored at each iteration</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">start_iter_num</span> <span class="ow">or</span> <span class="n">additional_train_datasets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">additional_train_datasets</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">start_iter_num</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">processed_train</span> <span class="o">=</span> <span class="n">prepare_dataset_from_prompts</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="n">sppo_temp_dir</span><span class="p">,</span>
                <span class="n">iter_num</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span><span class="p">,</span>
                <span class="n">num_prompts</span><span class="o">=</span><span class="n">num_prompts</span>
            <span class="p">)</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="n">SPPOTrainer</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">ref_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refModel</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
                <span class="n">train_dataset</span><span class="o">=</span><span class="n">processed_train</span><span class="p">,</span>
                <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
                <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">peft_config</span> <span class="o">=</span> <span class="n">peft_config</span><span class="p">,</span>
                <span class="n">beta</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                <span class="n">max_prompt_length</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">,</span>
                <span class="n">loss_type</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">loss_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

            <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">checkpoints_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">end_iter_num</span><span class="p">:</span>
                    <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>  <span class="c1">### this also needs to be changed</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SPPO</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            SPPOTrainerMixin (aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin)" href="#aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.base_mixin.SPPOTrainerMixin">SPPOTrainerMixin</a></code></p>


        








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/control.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SPPO</span><span class="p">(</span><span class="n">SPPOTrainerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Args</span> <span class="o">=</span> <span class="n">SPPOArgs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.Config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">Config</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Args</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.enabled" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.eval_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">eval_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.lora_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">lora_kwargs</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.peft_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">peft_type</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.refModel" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">refModel</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.train_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">train_dataset</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.training_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">training_args</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.use_peft" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_peft</span> <span class="o">=</span> <span class="kc">False</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.control.SPPO.steer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">steer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refModel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">num_prompts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">additional_train_datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="s1">&#39;sppo_temp_dir&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Required steering/preparation.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/base_mixin.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">steer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refModel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">maxlen</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">num_prompts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">start_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">additional_train_datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="s2">&quot;sppo_temp_dir&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PreTrainedModel</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">refModel</span> <span class="o">=</span> <span class="n">refModel</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">training_args</span> <span class="o">=</span> <span class="n">DPOConfig</span><span class="p">(</span>      <span class="c1">#TrainingArguments(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">training_args</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">peft_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_peft</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">peft_type</span> <span class="o">==</span> <span class="n">PeftType</span><span class="o">.</span><span class="n">LORA</span><span class="p">:</span>
            <span class="n">peft_config</span> <span class="o">=</span> <span class="n">LoraConfig</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">lora_kwargs</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refModel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">checkpoints_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">steerer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_iter_num</span><span class="p">,</span> <span class="n">end_iter_num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">checkpoints_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/checkpoints/SPPO-Iter</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># steered model stored at each iteration</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">start_iter_num</span> <span class="ow">or</span> <span class="n">additional_train_datasets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">additional_train_datasets</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">start_iter_num</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">processed_train</span> <span class="o">=</span> <span class="n">prepare_dataset_from_prompts</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">sppo_temp_dir</span><span class="o">=</span><span class="n">sppo_temp_dir</span><span class="p">,</span>
                <span class="n">iter_num</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span><span class="p">,</span>
                <span class="n">num_prompts</span><span class="o">=</span><span class="n">num_prompts</span>
            <span class="p">)</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="n">SPPOTrainer</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">ref_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refModel</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
                <span class="n">train_dataset</span><span class="o">=</span><span class="n">processed_train</span><span class="p">,</span>
                <span class="n">eval_dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span><span class="p">,</span>
                <span class="n">processing_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">peft_config</span> <span class="o">=</span> <span class="n">peft_config</span><span class="p">,</span>
                <span class="n">beta</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                <span class="n">max_prompt_length</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">,</span>
                <span class="n">loss_type</span><span class="o">=</span><span class="n">training_args</span><span class="o">.</span><span class="n">loss_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">model</span>

            <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">checkpoints_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">end_iter_num</span><span class="p">:</span>
                    <span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">training_args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>  <span class="c1">### this also needs to be changed</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">p</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>trainer</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SPPOTrainer</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="transformers.Trainer">Trainer</span></code></p>


        <p>Initialize SPPOTrainer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code>`transformers.PreTrainedModel`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model to train, preferably an <code>AutoModelForSequenceClassification</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ref_model</code>
            </td>
            <td>
                  <code>`PreTrainedModelWrapper`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face transformer model with a casual language modelling head. Used for implicit reward computation and loss. If no
reference model is provided, the trainer will create a reference model with the same architecture as the model to be optimized.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>beta</code>
            </td>
            <td>
                  <code>`float`, defaults to 0.1</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The beta factor in DPO loss. In SPPO, eta=1/beta. Higher beta means less divergence from the initial policy. For the IPO loss, beta is the regularization parameter denoted by tau in the paper.</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_smoothing</code>
            </td>
            <td>
                  <code>`float`, defaults to 0</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The robust DPO label smoothing parameter from the <a href="https://ericmitchell.ai/cdpo.pdf">cDPO</a> report that should be between 0 and 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>loss_type</code>
            </td>
            <td>
                  <code>`str`, defaults to `&#34;sigmoid&#34;`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of loss to use. 'sppo' reproduces the SPPO algorithms. Other choices are explained as follows: <code>"sigmoid"</code> represents the default DPO loss,<code>"hinge"</code> loss from <a href="https://arxiv.org/abs/2305.10425">SLiC</a> paper, <code>"ipo"</code> from <a href="https://arxiv.org/abs/2310.12036">IPO</a> paper, or <code>"kto"</code> from the HALOs <a href="https://github.com/ContextualAI/HALOs/blob/main/assets/report.pdf">report</a>.</p>
              </div>
            </td>
            <td>
                  <code>&#39;sigmoid&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code>`transformers.TrainingArguments`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arguments to use for training.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_collator</code>
            </td>
            <td>
                  <code>`transformers.DataCollator`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data collator to use for training. If None is specified, the default data collator (<code>DPODataCollatorWithPadding</code>) will be used
which will pad the sequences to the maximum length of the sequences in the batch, given a dataset of paired sequences.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_pad_token_id</code>
            </td>
            <td>
                  <code>`int`, defaults to `-100`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The label pad token id. This argument is required if you want to use the default data collator.</p>
              </div>
            </td>
            <td>
                  <code>-100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>padding_value</code>
            </td>
            <td>
                  <code>`int`, defaults to `0`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The padding value if it is different to the tokenizer's pad_token_id.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>truncation_mode</code>
            </td>
            <td>
                  <code>`str`, defaults to `keep_end`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The truncation mode to use, either <code>keep_end</code> or <code>keep_start</code>. This argument is required if you want to use the default data collator.</p>
              </div>
            </td>
            <td>
                  <code>&#39;keep_end&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_dataset</code>
            </td>
            <td>
                  <code>`datasets.Dataset`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to use for training.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eval_dataset</code>
            </td>
            <td>
                  <code>`datasets.Dataset`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to use for evaluation.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>processing_class</code>
            </td>
            <td>
                  <code>`transformers.PreTrainedTokenizerBase`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tokenizer to use for training. This argument is required if you want to use the default data collator.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_init</code>
            </td>
            <td>
                  <code>`Callable[[], transformers.PreTrainedModel]`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model initializer to use for training. If None is specified, the default model initializer will be used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callbacks</code>
            </td>
            <td>
                  <code>`List[transformers.TrainerCallback]`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The callbacks to use for training.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>optimizers</code>
            </td>
            <td>
                  <code>`Tuple[torch.optim.Optimizer, torch.optim.lr_scheduler.LambdaLR]`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The optimizer and scheduler to use for training.</p>
              </div>
            </td>
            <td>
                  <code>(None, None)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preprocess_logits_for_metrics</code>
            </td>
            <td>
                  <code>`Callable[[torch.Tensor, torch.Tensor], torch.Tensor]`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to use to preprocess the logits before computing the metrics.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code>`int`, defaults to `None`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum length of the sequences in the batch. This argument is required if you want to use the default data collator.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_prompt_length</code>
            </td>
            <td>
                  <code>`int`, defaults to `None`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum length of the prompt. This argument is required if you want to use the default data collator.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_target_length</code>
            </td>
            <td>
                  <code>`int`, defaults to `None`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum length of the target. This argument is required if you want to use the default data collator and your model is an encoder-decoder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>peft_config</code>
            </td>
            <td>
                  <code>`Dict`, defaults to `None`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The PEFT configuration to use for training. If you pass a PEFT configuration, the model will be wrapped in a PEFT model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_encoder_decoder</code>
            </td>
            <td>
                  <code>`Optional[bool]`, `optional`, defaults to `None`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no model is provided, we need to know if the model_init returns an encoder-decoder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>disable_dropout</code>
            </td>
            <td>
                  <code>`bool`, defaults to `True`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether or not to disable dropouts in <code>model</code> and <code>ref_model</code>.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>generate_during_eval</code>
            </td>
            <td>
                  <code>`bool`, defaults to `False`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to sample and log generations during evaluation step.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>compute_metrics</code>
            </td>
            <td>
                  <code>`Callable[[EvalPrediction], Dict]`, *optional*</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The function to use to compute the metrics. Must take a <code>EvalPrediction</code> and return
a dictionary string to metric values.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>precompute_ref_log_probs</code>
            </td>
            <td>
                  <code>`bool`, defaults to `False`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Flag to precompute reference model log probabilities and evaluation datasets. This is useful if you want to train
without the reference model and reduce the total GPU memory needed.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_init_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(<code>Optional[Dict]</code>, <em>optional</em>):
Dict of Optional kwargs to pass when instantiating the model from a string</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ref_model_init_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(<code>Optional[Dict]</code>, <em>optional</em>):
Dict of Optional kwargs to pass when instantiating the ref model from a string</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_adapter_name</code>
            </td>
            <td>
                  <code>`str`, defaults to `None`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the train target PEFT adapter, when using LoRA with multiple adapters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ref_adapter_name</code>
            </td>
            <td>
                  <code>`str`, defaults to `None`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the reference PEFT adapter, when using LoRA with multiple adapters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SPPOTrainer</span><span class="p">(</span><span class="n">Trainer</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize SPPOTrainer.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (`transformers.PreTrainedModel`):</span>
<span class="sd">            The model to train, preferably an `AutoModelForSequenceClassification`.</span>
<span class="sd">        ref_model (`PreTrainedModelWrapper`):</span>
<span class="sd">            Hugging Face transformer model with a casual language modelling head. Used for implicit reward computation and loss. If no</span>
<span class="sd">            reference model is provided, the trainer will create a reference model with the same architecture as the model to be optimized.</span>
<span class="sd">        beta (`float`, defaults to 0.1):</span>
<span class="sd">            The beta factor in DPO loss. In SPPO, eta=1/beta. Higher beta means less divergence from the initial policy. For the IPO loss, beta is the regularization parameter denoted by tau in the paper.</span>
<span class="sd">        label_smoothing (`float`, defaults to 0):</span>
<span class="sd">            The robust DPO label smoothing parameter from the [cDPO](https://ericmitchell.ai/cdpo.pdf) report that should be between 0 and 0.5.</span>
<span class="sd">        loss_type (`str`, defaults to `&quot;sigmoid&quot;`):</span>
<span class="sd">            The type of loss to use. &#39;sppo&#39; reproduces the SPPO algorithms. Other choices are explained as follows: `&quot;sigmoid&quot;` represents the default DPO loss,`&quot;hinge&quot;` loss from [SLiC](https://arxiv.org/abs/2305.10425) paper, `&quot;ipo&quot;` from [IPO](https://arxiv.org/abs/2310.12036) paper, or `&quot;kto&quot;` from the HALOs [report](https://github.com/ContextualAI/HALOs/blob/main/assets/report.pdf).</span>
<span class="sd">        args (`transformers.TrainingArguments`):</span>
<span class="sd">            The arguments to use for training.</span>
<span class="sd">        data_collator (`transformers.DataCollator`):</span>
<span class="sd">            The data collator to use for training. If None is specified, the default data collator (`DPODataCollatorWithPadding`) will be used</span>
<span class="sd">            which will pad the sequences to the maximum length of the sequences in the batch, given a dataset of paired sequences.</span>
<span class="sd">        label_pad_token_id (`int`, defaults to `-100`):</span>
<span class="sd">            The label pad token id. This argument is required if you want to use the default data collator.</span>
<span class="sd">        padding_value (`int`, defaults to `0`):</span>
<span class="sd">            The padding value if it is different to the tokenizer&#39;s pad_token_id.</span>
<span class="sd">        truncation_mode (`str`, defaults to `keep_end`):</span>
<span class="sd">            The truncation mode to use, either `keep_end` or `keep_start`. This argument is required if you want to use the default data collator.</span>
<span class="sd">        train_dataset (`datasets.Dataset`):</span>
<span class="sd">            The dataset to use for training.</span>
<span class="sd">        eval_dataset (`datasets.Dataset`):</span>
<span class="sd">            The dataset to use for evaluation.</span>
<span class="sd">        processing_class (`transformers.PreTrainedTokenizerBase`):</span>
<span class="sd">            The tokenizer to use for training. This argument is required if you want to use the default data collator.</span>
<span class="sd">        model_init (`Callable[[], transformers.PreTrainedModel]`):</span>
<span class="sd">            The model initializer to use for training. If None is specified, the default model initializer will be used.</span>
<span class="sd">        callbacks (`List[transformers.TrainerCallback]`):</span>
<span class="sd">            The callbacks to use for training.</span>
<span class="sd">        optimizers (`Tuple[torch.optim.Optimizer, torch.optim.lr_scheduler.LambdaLR]`):</span>
<span class="sd">            The optimizer and scheduler to use for training.</span>
<span class="sd">        preprocess_logits_for_metrics (`Callable[[torch.Tensor, torch.Tensor], torch.Tensor]`):</span>
<span class="sd">            The function to use to preprocess the logits before computing the metrics.</span>
<span class="sd">        max_length (`int`, defaults to `None`):</span>
<span class="sd">            The maximum length of the sequences in the batch. This argument is required if you want to use the default data collator.</span>
<span class="sd">        max_prompt_length (`int`, defaults to `None`):</span>
<span class="sd">            The maximum length of the prompt. This argument is required if you want to use the default data collator.</span>
<span class="sd">        max_target_length (`int`, defaults to `None`):</span>
<span class="sd">            The maximum length of the target. This argument is required if you want to use the default data collator and your model is an encoder-decoder.</span>
<span class="sd">        peft_config (`Dict`, defaults to `None`):</span>
<span class="sd">            The PEFT configuration to use for training. If you pass a PEFT configuration, the model will be wrapped in a PEFT model.</span>
<span class="sd">        is_encoder_decoder (`Optional[bool]`, `optional`, defaults to `None`):</span>
<span class="sd">            If no model is provided, we need to know if the model_init returns an encoder-decoder.</span>
<span class="sd">        disable_dropout (`bool`, defaults to `True`):</span>
<span class="sd">            Whether or not to disable dropouts in `model` and `ref_model`.</span>
<span class="sd">        generate_during_eval (`bool`, defaults to `False`):</span>
<span class="sd">            Whether to sample and log generations during evaluation step.</span>
<span class="sd">        compute_metrics (`Callable[[EvalPrediction], Dict]`, *optional*):</span>
<span class="sd">            The function to use to compute the metrics. Must take a `EvalPrediction` and return</span>
<span class="sd">            a dictionary string to metric values.</span>
<span class="sd">        precompute_ref_log_probs (`bool`, defaults to `False`):</span>
<span class="sd">            Flag to precompute reference model log probabilities and evaluation datasets. This is useful if you want to train</span>
<span class="sd">            without the reference model and reduce the total GPU memory needed.</span>
<span class="sd">        model_init_kwargs: (`Optional[Dict]`, *optional*):</span>
<span class="sd">            Dict of Optional kwargs to pass when instantiating the model from a string</span>
<span class="sd">        ref_model_init_kwargs: (`Optional[Dict]`, *optional*):</span>
<span class="sd">            Dict of Optional kwargs to pass when instantiating the ref model from a string</span>
<span class="sd">        model_adapter_name (`str`, defaults to `None`):</span>
<span class="sd">            Name of the train target PEFT adapter, when using LoRA with multiple adapters.</span>
<span class="sd">        ref_adapter_name (`str`, defaults to `None`):</span>
<span class="sd">            Name of the reference PEFT adapter, when using LoRA with multiple adapters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_tag_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;trl&quot;</span><span class="p">,</span> <span class="s2">&quot;sppo&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ref_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">label_smoothing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">loss_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span> <span class="s2">&quot;hinge&quot;</span><span class="p">,</span> <span class="s2">&quot;ipo&quot;</span><span class="p">,</span> <span class="s2">&quot;kto_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">args</span><span class="p">:</span> <span class="n">TrainingArguments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_collator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataCollator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">truncation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;keep_end&quot;</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">processing_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PreTrainedTokenizerBase</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_init</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">PreTrainedModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">TrainerCallback</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimizers</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">preprocess_logits_for_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_prompt_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_target_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">peft_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_encoder_decoder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">disable_dropout</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">generate_during_eval</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">EvalLoopOutput</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">precompute_ref_log_probs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">model_init_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ref_model_init_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_adapter_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ref_adapter_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">model_init_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_init_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You passed model_kwargs to the SPPOTrainer. But your model is already instantiated.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref_model_init_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_model_init_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You passed ref_model_kwargs to the SPPOTrainer. But your ref_model is already instantiated.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;You passed a model_id to the SPPOTrainer. This will automatically create an &quot;</span>
                <span class="s2">&quot;`AutoModelForCausalLM` or a `PeftModel` (if you passed a `peft_config`) for you.&quot;</span>
            <span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">model_init_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;You passed a ref model_id to the SPPOTrainer. This will automatically create an &quot;</span>
                <span class="s2">&quot;`AutoModelForCausalLM`&quot;</span>
            <span class="p">)</span>
            <span class="n">ref_model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">ref_model</span><span class="p">,</span> <span class="o">**</span><span class="n">ref_model_init_kwargs</span><span class="p">)</span>

        <span class="c1"># Initialize this variable to False. This helps tracking the case when `peft_module_casting_to_bf16`</span>
        <span class="c1"># has been called in order to properly call autocast if needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_peft_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">peft_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;PEFT is not installed and you passed a `peft_config` in the trainer&#39;s kwargs, please install it to use the PEFT models&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_peft_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">peft_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="c1"># # if model is a peft model and we have a peft_config, we merge and unload it first</span>
            <span class="c1"># if isinstance(model, PeftModel):</span>
            <span class="c1">#     model = model.merge_and_unload()</span>

            <span class="c1"># if getattr(model, &quot;is_loaded_in_8bit&quot;, False) or getattr(model, &quot;is_loaded_in_4bit&quot;, False):</span>
            <span class="c1">#     _support_gc_kwargs = hasattr(</span>
            <span class="c1">#         args, &quot;gradient_checkpointing_kwargs&quot;</span>
            <span class="c1">#     ) and &quot;gradient_checkpointing_kwargs&quot; in list(</span>
            <span class="c1">#         inspect.signature(prepare_model_for_kbit_training).parameters</span>
            <span class="c1">#     )</span>

            <span class="c1">#     preprare_model_kwargs = {&quot;use_gradient_checkpointing&quot;: args.gradient_checkpointing}</span>

            <span class="c1">#     if _support_gc_kwargs:</span>
            <span class="c1">#         preprare_model_kwargs[&quot;gradient_checkpointing_kwargs&quot;] = args.gradient_checkpointing_kwargs</span>

            <span class="c1">#     model = prepare_model_for_kbit_training(model, **preprare_model_kwargs)</span>
            <span class="c1"># elif getattr(args, &quot;gradient_checkpointing&quot;, False):</span>
            <span class="c1">#     # For backward compatibility with older versions of transformers</span>
            <span class="c1">#     if hasattr(model, &quot;enable_input_require_grads&quot;):</span>
            <span class="c1">#         model.enable_input_require_grads()</span>
            <span class="c1">#     else:</span>

            <span class="c1">#         def make_inputs_require_grad(module, input, output):</span>
            <span class="c1">#             output.requires_grad_(True)</span>

            <span class="c1">#         model.get_input_embeddings().register_forward_hook(make_inputs_require_grad)</span>

            <span class="c1"># # get peft model with the given config</span>
            <span class="c1"># model = get_peft_model(model, peft_config)</span>
            <span class="c1"># if args.bf16 and getattr(model, &quot;is_loaded_in_4bit&quot;, False):</span>
            <span class="c1">#     peft_module_casting_to_bf16(model)</span>
            <span class="c1">#     # If args.bf16 we need to explicitly call `generate` with torch amp autocast context manager</span>
            <span class="c1">#     self._peft_has_been_casted_to_bf16 = True</span>

        <span class="c1"># For models that use gradient_checkpoiting, we need to attach a hook that enables input</span>
        <span class="c1"># to explicitly have `requires_grad=True`, otherwise training will either silently</span>
        <span class="c1"># fail or completely fail.</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;gradient_checkpointing&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># For backward compatibility with older versions of transformers</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;enable_input_require_grads&quot;</span><span class="p">):</span>
                <span class="n">model</span><span class="o">.</span><span class="n">enable_input_require_grads</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">make_inputs_require_grad</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">model</span><span class="o">.</span><span class="n">get_input_embeddings</span><span class="p">()</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="n">make_inputs_require_grad</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">generate_during_eval</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_wandb_available</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;`generate_during_eval=True` requires Weights and Biases to be installed.&quot;</span>
                <span class="s2">&quot; Please install `wandb` to resolve.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_encoder_decoder</span>
        <span class="k">elif</span> <span class="n">is_encoder_decoder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When no model is provided, you need to pass the parameter is_encoder_decoder.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span> <span class="o">=</span> <span class="n">is_encoder_decoder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_peft_model</span> <span class="o">=</span> <span class="n">is_peft_available</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PeftModel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_adapter_name</span> <span class="o">=</span> <span class="n">model_adapter_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span> <span class="o">=</span> <span class="n">ref_adapter_name</span>

        <span class="k">if</span> <span class="n">ref_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_peft_model</span> <span class="ow">or</span> <span class="n">precompute_ref_log_probs</span><span class="p">:</span>
            <span class="c1"># The `model` with adapters turned off will be used as the reference model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="n">create_reference_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">processing_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;processing_class must be specified to tokenize a SPPO dataset.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;`max_length` is not set in the SPPOTrainer&#39;s init&quot;</span>
                <span class="s2">&quot; it will default to `512` by default, but you should do it yourself in the future.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="mi">512</span>
        <span class="k">if</span> <span class="n">max_prompt_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;`max_prompt_length` is not set in the SPPOTrainer&#39;s init&quot;</span>
                <span class="s2">&quot; it will default to `128` by default, but you should do it yourself in the future.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">max_prompt_length</span> <span class="o">=</span> <span class="mi">128</span>

        <span class="k">if</span> <span class="n">max_target_length</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;When using an encoder decoder architecture, you should set `max_target_length` in the SPPOTrainer&#39;s init&quot;</span>
                <span class="s2">&quot; it will default to `128` by default, but you should do it yourself in the future.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">max_target_length</span> <span class="o">=</span> <span class="mi">128</span>

        <span class="k">if</span> <span class="n">data_collator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_collator</span> <span class="o">=</span> <span class="n">DPODataCollatorWithPadding</span><span class="p">(</span>
                <span class="n">pad_token_id</span><span class="o">=</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
                <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">label_pad_token_id</span><span class="p">,</span>
                <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">remove_unused_columns</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">remove_unused_columns</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># warn users</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;When using DPODataCollatorWithPadding, you should set `remove_unused_columns=False` in your TrainingArguments&quot;</span>
                    <span class="s2">&quot; we have set it for you, but you should do it yourself in the future.&quot;</span><span class="p">,</span>
                    <span class="ne">UserWarning</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">use_dpo_data_collator</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_dpo_data_collator</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">disable_dropout</span><span class="p">:</span>
            <span class="n">disable_dropout_in_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">disable_dropout_in_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_during_eval</span> <span class="o">=</span> <span class="n">generate_during_eval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding_value</span> <span class="o">=</span> <span class="n">padding_value</span> <span class="k">if</span> <span class="n">padding_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span> <span class="o">=</span> <span class="n">max_prompt_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">=</span> <span class="n">truncation_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_target_length</span> <span class="o">=</span> <span class="n">max_target_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span> <span class="o">=</span> <span class="n">processing_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="o">=</span> <span class="n">precompute_ref_log_probs</span>

        <span class="c1"># Since ref_logs are precomputed on the first call to get_train/eval_dataloader</span>
        <span class="c1"># keep track of first called to avoid computation of future calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_eval_ref_log_probs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">loss_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hinge&quot;</span><span class="p">,</span> <span class="s2">&quot;ipo&quot;</span><span class="p">,</span> <span class="s2">&quot;kto_pair&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">label_smoothing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;You are using a loss type that does not support label smoothing. Ignoring label_smoothing parameter.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span> <span class="o">=</span> <span class="n">label_smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">=</span> <span class="n">loss_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>

        <span class="c1"># tokenize the dataset</span>
        <span class="c1"># print(&#39;=== before map&#39;, train_dataset.features)</span>
        <span class="c1"># chosen_probs = train_dataset[&#39;chosen_probs&#39;]</span>
        <span class="c1"># chosen_probs_win = train_dataset[&#39;chosen_probs_win&#39;]</span>
        <span class="c1"># chosen_probs_lose = train_dataset[&#39;chosen_probs_lose&#39;]</span>
        <span class="c1"># old_train_dataset = train_dataset</span>
        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenize_row</span><span class="p">)</span>
        <span class="c1"># print(&#39;=== before add&#39;, train_dataset.features)</span>
        <span class="c1"># import pandas as pd</span>
        <span class="c1"># mid_dataset = pd.DataFrame(train_dataset)</span>
        <span class="c1"># mid_dataset[&#39;chosen_probs&#39;] = chosen_probs</span>
        <span class="c1"># mid_dataset[&#39;chosen_probs_win&#39;] = chosen_probs_win</span>
        <span class="c1"># mid_dataset[&#39;chosen_probs_lose&#39;] = chosen_probs_lose</span>
        <span class="c1"># train_dataset = Dataset.from_pandas(mid_dataset)</span>
        <span class="c1"># print(&#39;=== after add&#39;, train_dataset.features)</span>
        <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenize_row</span><span class="p">)</span>
        <span class="c1">#print(&#39;=========&#39;)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">data_collator</span><span class="o">=</span><span class="n">data_collator</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">,</span>
            <span class="n">processing_class</span><span class="o">=</span><span class="n">processing_class</span><span class="p">,</span>
            <span class="n">model_init</span><span class="o">=</span><span class="n">model_init</span><span class="p">,</span>
            <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
            <span class="n">optimizers</span><span class="o">=</span><span class="n">optimizers</span><span class="p">,</span>
            <span class="n">preprocess_logits_for_metrics</span><span class="o">=</span><span class="n">preprocess_logits_for_metrics</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;accelerator&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;Your `Trainer` does not have an `accelerator` object. Consider upgrading `transformers`.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Deepspeed Zero-3 does not support precompute_ref_log_probs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_deepspeed_enabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">deepspeed_plugin</span><span class="o">.</span><span class="n">zero_stage</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;You cannot use `precompute_ref_log_probs=True` with Deepspeed ZeRO-3. Please set `precompute_ref_log_probs=False`.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_peft_model</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No reference model and model is not a Peft model. Try setting `precompute_ref_log_probs=True`&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_deepspeed_enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_deepspeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">prepare_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span> <span class="n">evaluation_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_deepspeed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">PreTrainedModelWrapper</span><span class="p">):</span>
        <span class="c1"># Adapted from accelerate: https://github.com/huggingface/accelerate/blob/739b135f8367becb67ffaada12fe76e3aa60fefd/src/accelerate/accelerator.py#L1473</span>
        <span class="n">deepspeed_plugin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">deepspeed_plugin</span>
        <span class="n">config_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">deepspeed_plugin</span><span class="o">.</span><span class="n">deepspeed_config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">):</span>
                <span class="n">hidden_size</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_sizes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;hidden_sizes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;hidden_size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">hidden_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;zero_optimization&quot;</span><span class="p">][</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># Note that `stage3_prefetch_bucket_size` can produce DeepSpeed messages like: `Invalidate trace cache @ step 0: expected module 1, but got module 0`</span>
                    <span class="c1"># This is expected and is not an error, see: https://github.com/microsoft/DeepSpeed/discussions/4081</span>
                    <span class="n">config_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;zero_optimization.reduce_bucket_size&quot;</span><span class="p">:</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="n">hidden_size</span><span class="p">,</span>
                            <span class="s2">&quot;zero_optimization.stage3_param_persistence_threshold&quot;</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">hidden_size</span><span class="p">,</span>
                            <span class="s2">&quot;zero_optimization.stage3_prefetch_bucket_size&quot;</span><span class="p">:</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">hidden_size</span> <span class="o">*</span> <span class="n">hidden_size</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="c1"># If ZeRO-3 is used, we shard both the active and reference model.</span>
        <span class="c1"># Otherwise, we assume the reference model fits in memory and is initialized on each device with ZeRO disabled (stage 0)</span>
        <span class="k">if</span> <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;zero_optimization&quot;</span><span class="p">][</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">config_kwargs</span><span class="p">[</span><span class="s2">&quot;zero_optimization&quot;</span><span class="p">][</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">deepspeed</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config_kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the training [`~torch.utils.data.DataLoader`].</span>

<span class="sd">        Subclass of transformers.src.transformers.trainer.get_train_dataloader to precompute `ref_log_probs`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span><span class="p">:</span>
            <span class="n">dataloader_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">per_device_train_batch_size</span><span class="p">,</span>
                <span class="s2">&quot;collate_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
                <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
                <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_pin_memory</span><span class="p">,</span>
                <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># prepare dataloader</span>
            <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">dataloader_params</span><span class="p">))</span>

            <span class="n">reference_chosen_logps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reference_rejected_logps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">padded_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Train dataset reference log probs&quot;</span><span class="p">):</span>
                <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reference_log_probs</span><span class="p">(</span><span class="n">padded_batch</span><span class="p">)</span>
                <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">gather_for_metrics</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">reference_chosen_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_chosen_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
                <span class="n">reference_rejected_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_rejected_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

            <span class="n">all_reference_chosen_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_chosen_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">all_reference_rejected_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_rejected_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_chosen_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_chosen_logps</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_rejected_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_rejected_logps</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_train_dataloader</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_eval_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the evaluation [`~torch.utils.data.DataLoader`].</span>

<span class="sd">        Subclass of transformers.src.transformers.trainer.get_eval_dataloader to precompute `ref_log_probs`.</span>

<span class="sd">        Args:</span>
<span class="sd">            eval_dataset (`torch.utils.data.Dataset`, *optional*):</span>
<span class="sd">                If provided, will override `self.eval_dataset`. If it is a [`~datasets.Dataset`], columns not accepted</span>
<span class="sd">                by the `model.forward()` method are automatically removed. It must implement `__len__`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trainer: evaluation requires an eval_dataset.&quot;</span><span class="p">)</span>
        <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span> <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_eval_ref_log_probs</span><span class="p">:</span>
            <span class="n">dataloader_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">per_device_eval_batch_size</span><span class="p">,</span>
                <span class="s2">&quot;collate_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
                <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
                <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_pin_memory</span><span class="p">,</span>
                <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># prepare dataloader</span>
            <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">dataloader_params</span><span class="p">))</span>

            <span class="n">reference_chosen_logps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reference_rejected_logps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">padded_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Eval dataset reference log probs&quot;</span><span class="p">):</span>
                <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reference_log_probs</span><span class="p">(</span><span class="n">padded_batch</span><span class="p">)</span>
                <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">gather_for_metrics</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">reference_chosen_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_chosen_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
                <span class="n">reference_rejected_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_rejected_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

            <span class="n">all_reference_chosen_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_chosen_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">all_reference_rejected_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_rejected_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_chosen_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_chosen_logps</span><span class="p">)</span>
            <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_rejected_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_rejected_logps</span>
            <span class="p">)</span>

            <span class="c1"># Save calculated reference_chosen_logps and reference_rejected_logps to the eval_dataset for subsequent runs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_eval_ref_log_probs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_eval_dataloader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_tokenized_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Llama tokenizer does satisfy `enc(a + b) = enc(a) + enc(b)`.</span>
<span class="sd">        It does ensure `enc(a + b) = enc(a) + enc(a + b)[len(enc(a)):]`.</span>
<span class="sd">        Reference:</span>
<span class="sd">            https://github.com/EleutherAI/lm-evaluation-harness/pull/531#issuecomment-1595586257</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">full_tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">answer</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

        <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="p">:]</span>
        <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="p">:]</span>

        <span class="c1"># Concat tokens to form `enc(a) + enc(a + b)[len(enc(a)):]`</span>
        <span class="n">full_concat_input_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">prompt_input_ids</span><span class="p">,</span> <span class="n">answer_input_ids</span><span class="p">])</span>

        <span class="c1"># Prepare input tokens for token by token comparison</span>
        <span class="n">full_input_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_concat_input_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and answer input ids should have the same length.&quot;</span><span class="p">)</span>

        <span class="c1"># On some tokenizers, like Llama-2 tokenizer, there are occasions where tokens</span>
        <span class="c1"># can be merged together when tokenizing prompt+answer. This could result</span>
        <span class="c1"># on the last token from the prompt being different when tokenized on its own</span>
        <span class="c1"># vs when done as prompt+answer.</span>
        <span class="n">response_token_ids_start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span>

        <span class="c1"># If tokenized prompt is different than both prompt+answer, then it means the</span>
        <span class="c1"># last token has changed due to merging.</span>
        <span class="k">if</span> <span class="n">prompt_input_ids</span> <span class="o">!=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]:</span>
            <span class="n">response_token_ids_start_idx</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>
        <span class="n">prompt_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_attention_mask</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and attention mask should have the same length.&quot;</span><span class="p">)</span>

        <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>
        <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">prompt_input_ids</span><span class="o">=</span><span class="n">prompt_input_ids</span><span class="p">,</span>
            <span class="n">prompt_attention_mask</span><span class="o">=</span><span class="n">prompt_attention_mask</span><span class="p">,</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">answer_input_ids</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">answer_attention_mask</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize a single row from a SPPO specific dataset.</span>

<span class="sd">        At this stage, we don&#39;t convert to PyTorch tensors yet; we just handle the truncation</span>
<span class="sd">        in case the prompt + chosen or prompt + rejected responses is/are too long. First</span>
<span class="sd">            we truncate the prompt; if we&#39;re still too long, we truncate the chosen/rejected.</span>

<span class="sd">        We also create the labels for the chosen/rejected responses, which are of length equal to</span>
<span class="sd">            the sum of the length of the prompt and the chosen/rejected response, with</span>
<span class="sd">            label_pad_token_id  for the prompt tokens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span>
        <span class="n">rejected</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">:</span>
            <span class="c1"># Check issues below for more details</span>
            <span class="c1">#  1. https://github.com/huggingface/trl/issues/907</span>
            <span class="c1">#  2. https://github.com/EleutherAI/lm-evaluation-harness/pull/531#issuecomment-1595586257</span>
            <span class="c1">#  3. https://github.com/LianjiaTech/BELLE/issues/337</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prompt should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chosen should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">chosen_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rejected should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rejected</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rejected_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

            <span class="c1"># Last prompt token might get merged by tokenizer and</span>
            <span class="c1"># it should not be included for generation if that happens</span>
            <span class="n">prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>

            <span class="n">chosen_prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>
            <span class="n">rejected_prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>
            <span class="n">prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chosen_prompt_len_input_ids</span><span class="p">,</span> <span class="n">rejected_prompt_len_input_ids</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">prompt_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:</span><span class="n">prompt_len_input_ids</span><span class="p">]</span>

            <span class="c1"># Make sure prompts only have one different token at most an</span>
            <span class="c1"># and length only differs by 1 at most</span>
            <span class="n">num_diff_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span>
            <span class="p">)</span>
            <span class="n">num_diff_len</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">chosen_prompt_len_input_ids</span> <span class="o">-</span> <span class="n">rejected_prompt_len_input_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_diff_tokens</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">num_diff_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Chosen and rejected prompt_input_ids might only differ on the &quot;</span>
                    <span class="s2">&quot;last token due to tokenizer merge ops.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># add BOS token to head of prompt</span>
            <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
            <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
            <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>

            <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
            <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
            <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>

            <span class="c1"># add EOS token to end of answer</span>
            <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
            <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
            <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">longer_response_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]))</span>

            <span class="c1"># if combined sequence is too long, truncate the prompt</span>
            <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_start&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                            <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_end&quot;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                            <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span> <span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown truncation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># if that&#39;s still too long, truncate the response</span>
            <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]:</span>
                        <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>

            <span class="c1"># Create labels</span>
            <span class="n">chosen_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">rejected_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
            <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
            <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>
            <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
            <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
            <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">toks</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="s2">&quot;chosen_&quot;</span><span class="p">:</span> <span class="n">chosen_sequence_tokens</span><span class="p">,</span>
                <span class="s2">&quot;rejected_&quot;</span><span class="p">:</span> <span class="n">rejected_sequence_tokens</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">prompt_tokens</span><span class="p">,</span>
            <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">type_key</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">toks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">type_key</span> <span class="o">==</span> <span class="s2">&quot;token_type_ids&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">type_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">chosen_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span>
                <span class="n">chosen</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_target_length</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">rejected_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span>
                <span class="n">rejected</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_target_length</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span>
                <span class="n">prompt</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;prepare_decoder_input_ids_from_labels&quot;</span><span class="p">):</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_decoder_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">prepare_decoder_input_ids_from_labels</span><span class="p">(</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_labels&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_decoder_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">prepare_decoder_input_ids_from_labels</span><span class="p">(</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="c1">#print(&#39;batch=======&#39;, batch.keys())</span>
        <span class="k">return</span> <span class="n">batch</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">null_ref_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager for handling null reference model (that is, peft adapter manipulation).&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">unwrap_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="p">)</span><span class="o">.</span><span class="n">disable_adapter</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_peft_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span> <span class="k">else</span> <span class="n">nullcontext</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_adapter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_adapter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_adapter_name</span> <span class="ow">or</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_reference_log_probs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">padded_batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes log probabilities of the reference model for a single padded batch of a DPO specific dataset.&quot;&quot;&quot;</span>
        <span class="n">compte_ref_context_manager</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">nullcontext</span>

        <span class="c1"># compute reference logps</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">compte_ref_context_manager</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_ref_context</span><span class="p">():</span>
                    <span class="p">(</span>
                        <span class="n">reference_chosen_logps</span><span class="p">,</span>
                        <span class="n">reference_rejected_logps</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">padded_batch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">reference_chosen_logps</span><span class="p">,</span>
                    <span class="n">reference_rejected_logps</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span> <span class="n">padded_batch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">reference_chosen_logps</span><span class="p">,</span> <span class="n">reference_rejected_logps</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">concatenated_inputs</span><span class="p">(</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]],</span>
        <span class="n">is_encoder_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concatenate the chosen and rejected inputs into a single tensor.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch: A batch of data. Must contain the keys &#39;chosen_input_ids&#39; and &#39;rejected_input_ids&#39;, which are tensors of shape (batch_size, sequence_length).</span>
<span class="sd">            is_encoder_decoder: Whether the model is an encoder-decoder model.</span>
<span class="sd">            label_pad_token_id: The label pad token id.</span>
<span class="sd">            padding_value: The padding value to use for the concatenated inputs_ids.</span>
<span class="sd">            device: The device for the concatenated inputs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary containing the concatenated inputs under the key &#39;concatenated_input_ids&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">concatenated_batch</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;chosen&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
                    <span class="n">pad_value</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
                <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_input_ids&quot;</span><span class="p">):</span>
                    <span class="n">pad_value</span> <span class="o">=</span> <span class="n">padding_value</span>
                <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_attention_mask&quot;</span><span class="p">):</span>
                    <span class="n">pad_value</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">concatenated_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;concatenated&quot;</span><span class="p">)</span>
                <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pad_to_length</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_value</span><span class="o">=</span><span class="n">pad_value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rejected&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
                    <span class="n">pad_value</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
                <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_input_ids&quot;</span><span class="p">):</span>
                    <span class="n">pad_value</span> <span class="o">=</span> <span class="n">padding_value</span>
                <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_attention_mask&quot;</span><span class="p">):</span>
                    <span class="n">pad_value</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">concatenated_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;concatenated&quot;</span><span class="p">)</span>
                <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">],</span>
                        <span class="n">pad_to_length</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_value</span><span class="o">=</span><span class="n">pad_value</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">concatenated_batch</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sppo_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">policy_chosen_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
        <span class="n">policy_rejected_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
        <span class="n">reference_chosen_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
        <span class="n">reference_rejected_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
        <span class="n">chosen_probs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chosen_probs_win</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chosen_probs_lose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reference_free</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SPPO loss for a batch of policy and reference model log probabilities.</span>

<span class="sd">        Args:</span>
<span class="sd">            policy_chosen_logps: Log probabilities of the policy model for the chosen responses. Shape: (batch_size,)</span>
<span class="sd">            policy_rejected_logps: Log probabilities of the policy model for the rejected responses. Shape: (batch_size,)</span>
<span class="sd">            reference_chosen_logps: Log probabilities of the reference model for the chosen responses. Shape: (batch_size,)</span>
<span class="sd">            reference_rejected_logps: Log probabilities of the reference model for the rejected responses. Shape: (batch_size,)</span>
<span class="sd">            reference_free: If True, we ignore the _provided_ reference model and implicitly use a reference model that assigns equal probability to all responses.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of three tensors: (losses, chosen_rewards, rejected_rewards).</span>
<span class="sd">            The losses tensor contains the SPPO loss for each example in the batch.</span>
<span class="sd">            The chosen_rewards and rejected_rewards tensors contain the rewards for the chosen and rejected responses, respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pi_logratios</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">policy_rejected_logps</span>
        <span class="k">if</span> <span class="n">reference_free</span><span class="p">:</span>
            <span class="n">ref_logratios</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_logratios</span> <span class="o">=</span> <span class="n">reference_chosen_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span>

        <span class="n">pi_logratios</span> <span class="o">=</span> <span class="n">pi_logratios</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">ref_logratios</span> <span class="o">=</span> <span class="n">ref_logratios</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">pi_logratios</span> <span class="o">-</span> <span class="n">ref_logratios</span>

        <span class="c1"># For sppo</span>
        <span class="n">logits_w</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span>
        <span class="n">logits_l</span> <span class="o">=</span> <span class="n">policy_rejected_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span>

        <span class="c1"># The beta is a temperature parameter for the DPO loss, typically something in the range of 0.1 to 0.5. In SPPO, beta=1/eta has a different meaning, and is usually chosen around 1e-3.</span>
        <span class="c1"># We ignore the reference model as beta -&gt; 0. The label_smoothing parameter encodes our uncertainty about the labels and</span>
        <span class="c1"># calculates a conservative SPPO loss.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;hinge&quot;</span><span class="p">:</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;ipo&quot;</span><span class="p">:</span>
            <span class="c1"># eqn (17) of the paper where beta is the regularization parameter for the IPO loss, denoted by tau in the paper.</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;sppo&quot;</span><span class="p">:</span>
            <span class="n">loss_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_w</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs_win</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">loss_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_l</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs_lose</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_w</span> <span class="o">+</span> <span class="n">loss_l</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;sppo_single&quot;</span><span class="p">:</span>
            <span class="n">loss_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_w</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">loss_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_l</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_w</span> <span class="o">+</span> <span class="n">loss_l</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;kto_pair&quot;</span><span class="p">:</span>
            <span class="c1"># eqn (7) of the HALOs paper</span>
            <span class="n">chosen_KL</span> <span class="o">=</span> <span class="p">(</span><span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rejected_KL</span> <span class="o">=</span> <span class="p">(</span><span class="n">policy_rejected_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">chosen_logratios</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span>
            <span class="n">rejected_logratios</span> <span class="o">=</span> <span class="n">policy_rejected_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span>
            <span class="c1"># As described in the KTO report, the KL term for chosen (rejected) is estimated using the rejected (chosen) half.</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">chosen_logratios</span> <span class="o">-</span> <span class="n">rejected_KL</span><span class="p">)),</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">chosen_KL</span> <span class="o">-</span> <span class="n">rejected_logratios</span><span class="p">)),</span>
                <span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown loss type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span><span class="si">}</span><span class="s2">. Should be one of [&#39;sigmoid&#39;, &#39;hinge&#39;, &#39;ipo&#39;, &#39;kto_pair&#39;]&quot;</span>
            <span class="p">)</span>

        <span class="n">chosen_rewards</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">policy_rejected_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">reference_rejected_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">losses</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_batch_logps</span><span class="p">(</span>
        <span class="n">logits</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
        <span class="n">average_log_prob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">is_encoder_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the log probabilities of the given labels under the given logits.</span>

<span class="sd">        Args:</span>
<span class="sd">            logits: Logits of the model (unnormalized). Shape: (batch_size, sequence_length, vocab_size)</span>
<span class="sd">            labels: Labels for which to compute the log probabilities. Label tokens with a value of label_pad_token_id are ignored. Shape: (batch_size, sequence_length)</span>
<span class="sd">            average_log_prob: If True, return the average log probability per (non-masked) token. Otherwise, return the sum of the log probabilities of the (non-masked) tokens.</span>
<span class="sd">            label_pad_token_id: The label pad token id.</span>
<span class="sd">            is_encoder_decoder: Whether the model is an encoder-decoder model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tensor of shape (batch_size,) containing the average/sum log probabilities of the given labels under the given logits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Logits (batch and sequence length dim) and labels must have the same shape.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">loss_mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">label_pad_token_id</span>

        <span class="c1"># dummy token; we&#39;ll ignore the losses on these tokens later</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label_pad_token_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">per_token_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">average_log_prob</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">per_token_logps</span> <span class="o">*</span> <span class="n">loss_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">loss_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">per_token_logps</span> <span class="o">*</span> <span class="n">loss_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">concatenated_forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the given model on the given batch of inputs, concatenating the chosen and rejected inputs together.</span>

<span class="sd">        We do this to avoid doing two forward passes, because it&#39;s faster for FSDP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">concatenated_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_inputs</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
            <span class="n">label_pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span><span class="p">,</span>
            <span class="n">padding_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding_value</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">len_chosen</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">],</span>
                <span class="s2">&quot;decoder_input_ids&quot;</span><span class="p">:</span> <span class="n">concatenated_batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;concatenated_decoder_input_ids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span>
            <span class="k">else</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">all_logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">],</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">logits</span>

        <span class="n">all_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_logps</span><span class="p">(</span>
            <span class="n">all_logits</span><span class="p">,</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">],</span>
            <span class="n">average_log_prob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
            <span class="n">label_pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">chosen_logps</span> <span class="o">=</span> <span class="n">all_logps</span><span class="p">[:</span><span class="n">len_chosen</span><span class="p">]</span>
        <span class="n">rejected_logps</span> <span class="o">=</span> <span class="n">all_logps</span><span class="p">[</span><span class="n">len_chosen</span><span class="p">:]</span>

        <span class="n">chosen_logits</span> <span class="o">=</span> <span class="n">all_logits</span><span class="p">[:</span><span class="n">len_chosen</span><span class="p">]</span>
        <span class="n">rejected_logits</span> <span class="o">=</span> <span class="n">all_logits</span><span class="p">[</span><span class="n">len_chosen</span><span class="p">:]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">chosen_logps</span><span class="p">,</span> <span class="n">rejected_logps</span><span class="p">,</span> <span class="n">chosen_logits</span><span class="p">,</span> <span class="n">rejected_logits</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_batch_loss_metrics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]],</span>
        <span class="n">train_eval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the SPPO loss and other metrics for the given batch of inputs for train or test.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="p">(</span>
            <span class="n">policy_chosen_logps</span><span class="p">,</span>
            <span class="n">policy_rejected_logps</span><span class="p">,</span>
            <span class="n">policy_chosen_logits</span><span class="p">,</span>
            <span class="n">policy_rejected_logits</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

        <span class="n">chosen_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_probs&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">chosen_probs_win</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_probs_win&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">chosen_probs_lose</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_probs_lose&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># if reference_chosen_logps and reference_rejected_logps in batch use them, otherwise use the reference model</span>
        <span class="k">if</span> <span class="s2">&quot;reference_chosen_logps&quot;</span> <span class="ow">in</span> <span class="n">batch</span> <span class="ow">and</span> <span class="s2">&quot;reference_rejected_logps&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">reference_chosen_logps</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_chosen_logps&quot;</span><span class="p">]</span>
            <span class="n">reference_rejected_logps</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_rejected_logps&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_ref_context</span><span class="p">():</span>
                        <span class="p">(</span>
                            <span class="n">reference_chosen_logps</span><span class="p">,</span>
                            <span class="n">reference_rejected_logps</span><span class="p">,</span>
                            <span class="n">_</span><span class="p">,</span>
                            <span class="n">_</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">reference_chosen_logps</span><span class="p">,</span>
                        <span class="n">reference_rejected_logps</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

        <span class="n">losses</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sppo_loss</span><span class="p">(</span>
            <span class="n">policy_chosen_logps</span><span class="p">,</span>
            <span class="n">policy_rejected_logps</span><span class="p">,</span>
            <span class="n">reference_chosen_logps</span><span class="p">,</span>
            <span class="n">reference_rejected_logps</span><span class="p">,</span>
            <span class="n">chosen_probs</span><span class="p">,</span>
            <span class="n">chosen_probs_win</span><span class="p">,</span>
            <span class="n">chosen_probs_lose</span><span class="p">,</span>
            <span class="c1"># rejected_probs,</span>
        <span class="p">)</span>
        <span class="n">reward_accuracies</span> <span class="o">=</span> <span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">&gt;</span> <span class="n">rejected_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;eval_&quot;</span> <span class="k">if</span> <span class="n">train_eval</span> <span class="o">==</span> <span class="s2">&quot;eval&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/accuracies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_accuracies</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/margins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">-</span> <span class="n">rejected_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logps/rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_rejected_logps</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logps/chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logits/rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_rejected_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logits/chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_chosen_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">losses</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">metrics</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">return_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_items_in_batch</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dpo_data_collator</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;compute_loss is only implemented for DPODataCollatorWithPadding, and you passed a datacollator that is different than &quot;</span>
                <span class="s2">&quot;DPODataCollatorWithPadding - you might see unexpected behavior. Alternatively, you can implement your own prediction_step method if you are using a custom data collator&quot;</span>
            <span class="p">)</span>

        <span class="n">compute_loss_context_manager</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">nullcontext</span>

        <span class="k">with</span> <span class="n">compute_loss_context_manager</span><span class="p">():</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_loss_metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

        <span class="c1"># force log the metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_outputs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_from_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate samples from the model and reference model for the given batch of inputs.&quot;&quot;&quot;</span>

        <span class="c1"># If one uses `generate_during_eval` with peft + bf16, we need to explicitly call generate with</span>
        <span class="c1"># the torch cuda amp context manager as some hidden states are silently casted to full precision.</span>
        <span class="n">generate_context_manager</span> <span class="o">=</span> <span class="n">nullcontext</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span>

        <span class="k">with</span> <span class="n">generate_context_manager</span><span class="p">():</span>
            <span class="n">policy_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">input_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span>
                <span class="n">attention_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">],</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># if reference_output in batch use that otherwise use the reference model</span>
            <span class="k">if</span> <span class="s2">&quot;reference_output&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                <span class="n">reference_output</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_output&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_ref_context</span><span class="p">():</span>
                        <span class="n">reference_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                            <span class="n">input_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span>
                            <span class="n">attention_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">],</span>
                            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                            <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reference_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="n">input_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span>
                        <span class="n">attention_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">],</span>
                        <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                        <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">policy_output</span> <span class="o">=</span> <span class="n">pad_to_length</span><span class="p">(</span><span class="n">policy_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
        <span class="n">policy_output_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">policy_output</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">reference_output</span> <span class="o">=</span> <span class="n">pad_to_length</span><span class="p">(</span><span class="n">reference_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
        <span class="n">reference_output_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">reference_output</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">policy_output_decoded</span><span class="p">,</span> <span class="n">reference_output_decoded</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prediction_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">prediction_loss_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">ignore_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dpo_data_collator</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;prediction_step is only implemented for DPODataCollatorWithPadding, and you passed a datacollator that is different than &quot;</span>
                <span class="s2">&quot;DPODataCollatorWithPadding - you might see unexpected behavior. Alternatively, you can implement your own prediction_step method if you are using a custom data collator&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">):</span>
                <span class="n">ignore_keys</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;keys_to_ignore_at_inference&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ignore_keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">prediction_context_manager</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">nullcontext</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">prediction_context_manager</span><span class="p">():</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_loss_metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>

        <span class="c1"># force log the metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prediction_loss_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># logits for the chosen and rejected samples from model</span>
        <span class="n">logits_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;eval_logits/chosen&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_logits/chosen&quot;</span><span class="p">],</span>
            <span class="s2">&quot;eval_logits/rejected&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_logits/rejected&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logits_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">store_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">train_eval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span><span class="p">[</span><span class="n">train_eval</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluation_loop</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prediction_loss_only</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metric_key_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;eval&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EvalLoopOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overriding built-in evaluation loop to store metrics for each batch.</span>
<span class="sd">        Prediction/evaluation loop, shared by `Trainer.evaluate()` and `Trainer.predict()`.</span>

<span class="sd">        Works both with or without labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Sample and save to game log if requested (for one batch to save time)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_during_eval</span><span class="p">:</span>
            <span class="c1"># Generate random indices within the range of the total number of samples</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
            <span class="n">random_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">)</span>

            <span class="c1"># Use dataloader.dataset.select to get the random batch without iterating over the DataLoader</span>
            <span class="n">random_batch_dataset</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">random_indices</span><span class="p">)</span>
            <span class="n">random_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">(</span><span class="n">random_batch_dataset</span><span class="p">)</span>
            <span class="n">random_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">(</span><span class="n">random_batch</span><span class="p">)</span>

            <span class="n">policy_output_decoded</span><span class="p">,</span> <span class="n">ref_output_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_from_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">random_batch</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;game_log&quot;</span><span class="p">:</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;Policy&quot;</span><span class="p">,</span> <span class="s2">&quot;Ref Model&quot;</span><span class="p">],</span>
                        <span class="n">rows</span><span class="o">=</span><span class="p">[</span>
                            <span class="p">[</span><span class="n">prompt</span><span class="p">,</span> <span class="n">pol</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="p">:],</span> <span class="n">ref</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="p">:]]</span>
                            <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                                <span class="n">random_batch</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="n">policy_output_decoded</span><span class="p">,</span> <span class="n">ref_output_decoded</span>
                            <span class="p">)</span>
                        <span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">log_history</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># Base evaluation</span>
        <span class="n">initial_output</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">evaluation_loop</span><span class="p">(</span>
            <span class="n">dataloader</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">prediction_loss_only</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="p">,</span> <span class="n">metric_key_prefix</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">initial_output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log `logs` on the various objects watching training, including stored metrics.</span>

<span class="sd">        Args:</span>
<span class="sd">            logs (`Dict[str, float]`):</span>
<span class="sd">                The values to log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># logs either has &#39;loss&#39; or &#39;eval_loss&#39;</span>
        <span class="n">train_eval</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="s2">&quot;loss&quot;</span> <span class="ow">in</span> <span class="n">logs</span> <span class="k">else</span> <span class="s2">&quot;eval&quot;</span>
        <span class="c1"># Add averaged stored metrics to logs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span><span class="p">[</span><span class="n">train_eval</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span><span class="p">[</span><span class="n">train_eval</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.beta" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.generate_during_eval" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">generate_during_eval</span> <span class="o">=</span> <span class="n">generate_during_eval</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.is_encoder_decoder" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">is_encoder_decoder</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_encoder_decoder</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.is_peft_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">is_peft_model</span> <span class="o">=</span> <span class="n">is_peft_available</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PeftModel</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.label_pad_token_id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">label_pad_token_id</span> <span class="o">=</span> <span class="n">label_pad_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.label_smoothing" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">label_smoothing</span> <span class="o">=</span> <span class="n">label_smoothing</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.loss_type" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">loss_type</span> <span class="o">=</span> <span class="n">loss_type</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.max_length" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.max_prompt_length" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_prompt_length</span> <span class="o">=</span> <span class="n">max_prompt_length</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.max_target_length" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_target_length</span> <span class="o">=</span> <span class="n">max_target_length</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.model_adapter_name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model_adapter_name</span> <span class="o">=</span> <span class="n">model_adapter_name</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.padding_value" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">padding_value</span> <span class="o">=</span> <span class="n">padding_value</span> <span class="k">if</span> <span class="n">padding_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.precompute_ref_log_probs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">precompute_ref_log_probs</span> <span class="o">=</span> <span class="n">precompute_ref_log_probs</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.processing_class" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">processing_class</span> <span class="o">=</span> <span class="n">processing_class</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.ref_adapter_name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">ref_adapter_name</span> <span class="o">=</span> <span class="n">ref_adapter_name</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.ref_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">ref_model</span> <span class="o">=</span> <span class="n">ref_model</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.truncation_mode" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">truncation_mode</span> <span class="o">=</span> <span class="n">truncation_mode</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.use_dpo_data_collator" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_dpo_data_collator</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.build_tokenized_answer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Llama tokenizer does satisfy <code>enc(a + b) = enc(a) + enc(b)</code>.
It does ensure <code>enc(a + b) = enc(a) + enc(a + b)[len(enc(a)):]</code>.
Reference:
    https://github.com/EleutherAI/lm-evaluation-harness/pull/531#issuecomment-1595586257</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_tokenized_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Llama tokenizer does satisfy `enc(a + b) = enc(a) + enc(b)`.</span>
<span class="sd">    It does ensure `enc(a + b) = enc(a) + enc(a + b)[len(enc(a)):]`.</span>
<span class="sd">    Reference:</span>
<span class="sd">        https://github.com/EleutherAI/lm-evaluation-harness/pull/531#issuecomment-1595586257</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">full_tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">answer</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

    <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="p">:]</span>
    <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="p">:]</span>

    <span class="c1"># Concat tokens to form `enc(a) + enc(a + b)[len(enc(a)):]`</span>
    <span class="n">full_concat_input_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">prompt_input_ids</span><span class="p">,</span> <span class="n">answer_input_ids</span><span class="p">])</span>

    <span class="c1"># Prepare input tokens for token by token comparison</span>
    <span class="n">full_input_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_concat_input_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and answer input ids should have the same length.&quot;</span><span class="p">)</span>

    <span class="c1"># On some tokenizers, like Llama-2 tokenizer, there are occasions where tokens</span>
    <span class="c1"># can be merged together when tokenizing prompt+answer. This could result</span>
    <span class="c1"># on the last token from the prompt being different when tokenized on its own</span>
    <span class="c1"># vs when done as prompt+answer.</span>
    <span class="n">response_token_ids_start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span>

    <span class="c1"># If tokenized prompt is different than both prompt+answer, then it means the</span>
    <span class="c1"># last token has changed due to merging.</span>
    <span class="k">if</span> <span class="n">prompt_input_ids</span> <span class="o">!=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]:</span>
        <span class="n">response_token_ids_start_idx</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>
    <span class="n">prompt_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_attention_mask</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and attention mask should have the same length.&quot;</span><span class="p">)</span>

    <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>
    <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">prompt_input_ids</span><span class="o">=</span><span class="n">prompt_input_ids</span><span class="p">,</span>
        <span class="n">prompt_attention_mask</span><span class="o">=</span><span class="n">prompt_attention_mask</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="o">=</span><span class="n">answer_input_ids</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="n">answer_attention_mask</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.compute_loss" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">return_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_items_in_batch</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_loss</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">return_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">num_items_in_batch</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dpo_data_collator</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;compute_loss is only implemented for DPODataCollatorWithPadding, and you passed a datacollator that is different than &quot;</span>
            <span class="s2">&quot;DPODataCollatorWithPadding - you might see unexpected behavior. Alternatively, you can implement your own prediction_step method if you are using a custom data collator&quot;</span>
        <span class="p">)</span>

    <span class="n">compute_loss_context_manager</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">nullcontext</span>

    <span class="k">with</span> <span class="n">compute_loss_context_manager</span><span class="p">():</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_loss_metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

    <span class="c1"># force log the metrics</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_outputs</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.compute_reference_log_probs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute_reference_log_probs</span><span class="p">(</span><span class="n">padded_batch</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Computes log probabilities of the reference model for a single padded batch of a DPO specific dataset.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_reference_log_probs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">padded_batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes log probabilities of the reference model for a single padded batch of a DPO specific dataset.&quot;&quot;&quot;</span>
    <span class="n">compte_ref_context_manager</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">nullcontext</span>

    <span class="c1"># compute reference logps</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">compte_ref_context_manager</span><span class="p">():</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_ref_context</span><span class="p">():</span>
                <span class="p">(</span>
                    <span class="n">reference_chosen_logps</span><span class="p">,</span>
                    <span class="n">reference_rejected_logps</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">padded_batch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">reference_chosen_logps</span><span class="p">,</span>
                <span class="n">reference_rejected_logps</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span> <span class="n">padded_batch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reference_chosen_logps</span><span class="p">,</span> <span class="n">reference_rejected_logps</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.concatenated_forward" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">concatenated_forward</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Run the given model on the given batch of inputs, concatenating the chosen and rejected inputs together.</p>
<p>We do this to avoid doing two forward passes, because it's faster for FSDP.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">concatenated_forward</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the given model on the given batch of inputs, concatenating the chosen and rejected inputs together.</span>

<span class="sd">    We do this to avoid doing two forward passes, because it&#39;s faster for FSDP.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">concatenated_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_inputs</span><span class="p">(</span>
        <span class="n">batch</span><span class="p">,</span>
        <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding_value</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">len_chosen</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">],</span>
            <span class="s2">&quot;decoder_input_ids&quot;</span><span class="p">:</span> <span class="n">concatenated_batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;concatenated_decoder_input_ids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span>
        <span class="k">else</span> <span class="p">{}</span>
    <span class="p">)</span>
    <span class="n">all_logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">],</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">logits</span>

    <span class="n">all_logps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_logps</span><span class="p">(</span>
        <span class="n">all_logits</span><span class="p">,</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">],</span>
        <span class="n">average_log_prob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">chosen_logps</span> <span class="o">=</span> <span class="n">all_logps</span><span class="p">[:</span><span class="n">len_chosen</span><span class="p">]</span>
    <span class="n">rejected_logps</span> <span class="o">=</span> <span class="n">all_logps</span><span class="p">[</span><span class="n">len_chosen</span><span class="p">:]</span>

    <span class="n">chosen_logits</span> <span class="o">=</span> <span class="n">all_logits</span><span class="p">[:</span><span class="n">len_chosen</span><span class="p">]</span>
    <span class="n">rejected_logits</span> <span class="o">=</span> <span class="n">all_logits</span><span class="p">[</span><span class="n">len_chosen</span><span class="p">:]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">chosen_logps</span><span class="p">,</span> <span class="n">rejected_logps</span><span class="p">,</span> <span class="n">chosen_logits</span><span class="p">,</span> <span class="n">rejected_logits</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.concatenated_inputs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">concatenated_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_pad_token_id</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

        <p>Concatenate the chosen and rejected inputs into a single tensor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>batch</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<span title="typing.List">List</span>, <span title="torch.LongTensor">LongTensor</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A batch of data. Must contain the keys 'chosen_input_ids' and 'rejected_input_ids', which are tensors of shape (batch_size, sequence_length).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_encoder_decoder</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the model is an encoder-decoder model.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_pad_token_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The label pad token id.</p>
              </div>
            </td>
            <td>
                  <code>-100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>padding_value</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The padding value to use for the concatenated inputs_ids.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="torch.device">device</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The device for the concatenated inputs.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="torch.LongTensor">LongTensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the concatenated inputs under the key 'concatenated_input_ids'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">concatenated_inputs</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]],</span>
    <span class="n">is_encoder_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">padding_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Concatenate the chosen and rejected inputs into a single tensor.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch: A batch of data. Must contain the keys &#39;chosen_input_ids&#39; and &#39;rejected_input_ids&#39;, which are tensors of shape (batch_size, sequence_length).</span>
<span class="sd">        is_encoder_decoder: Whether the model is an encoder-decoder model.</span>
<span class="sd">        label_pad_token_id: The label pad token id.</span>
<span class="sd">        padding_value: The padding value to use for the concatenated inputs_ids.</span>
<span class="sd">        device: The device for the concatenated inputs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary containing the concatenated inputs under the key &#39;concatenated_input_ids&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">concatenated_batch</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;chosen&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_input_ids&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">padding_value</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_attention_mask&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">concatenated_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;concatenated&quot;</span><span class="p">)</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pad_to_length</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_value</span><span class="o">=</span><span class="n">pad_value</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rejected&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_input_ids&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">padding_value</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_attention_mask&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">concatenated_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;concatenated&quot;</span><span class="p">)</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">],</span>
                    <span class="n">pad_to_length</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_value</span><span class="o">=</span><span class="n">pad_value</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">concatenated_batch</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.evaluation_loop" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">evaluation_loop</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">prediction_loss_only</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric_key_prefix</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Overriding built-in evaluation loop to store metrics for each batch.
Prediction/evaluation loop, shared by <code>Trainer.evaluate()</code> and <code>Trainer.predict()</code>.</p>
<p>Works both with or without labels.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluation_loop</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">prediction_loss_only</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ignore_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metric_key_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;eval&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EvalLoopOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overriding built-in evaluation loop to store metrics for each batch.</span>
<span class="sd">    Prediction/evaluation loop, shared by `Trainer.evaluate()` and `Trainer.predict()`.</span>

<span class="sd">    Works both with or without labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Sample and save to game log if requested (for one batch to save time)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_during_eval</span><span class="p">:</span>
        <span class="c1"># Generate random indices within the range of the total number of samples</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">random_indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">)</span>

        <span class="c1"># Use dataloader.dataset.select to get the random batch without iterating over the DataLoader</span>
        <span class="n">random_batch_dataset</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">random_indices</span><span class="p">)</span>
        <span class="n">random_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">(</span><span class="n">random_batch_dataset</span><span class="p">)</span>
        <span class="n">random_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs</span><span class="p">(</span><span class="n">random_batch</span><span class="p">)</span>

        <span class="n">policy_output_decoded</span><span class="p">,</span> <span class="n">ref_output_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_from_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">random_batch</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;game_log&quot;</span><span class="p">:</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;Policy&quot;</span><span class="p">,</span> <span class="s2">&quot;Ref Model&quot;</span><span class="p">],</span>
                    <span class="n">rows</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">[</span><span class="n">prompt</span><span class="p">,</span> <span class="n">pol</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="p">:],</span> <span class="n">ref</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="p">:]]</span>
                        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">random_batch</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="n">policy_output_decoded</span><span class="p">,</span> <span class="n">ref_output_decoded</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">log_history</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="c1"># Base evaluation</span>
    <span class="n">initial_output</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">evaluation_loop</span><span class="p">(</span>
        <span class="n">dataloader</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">prediction_loss_only</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="p">,</span> <span class="n">metric_key_prefix</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">initial_output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.generate_from_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Generate samples from the model and reference model for the given batch of inputs.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_from_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate samples from the model and reference model for the given batch of inputs.&quot;&quot;&quot;</span>

    <span class="c1"># If one uses `generate_during_eval` with peft + bf16, we need to explicitly call generate with</span>
    <span class="c1"># the torch cuda amp context manager as some hidden states are silently casted to full precision.</span>
    <span class="n">generate_context_manager</span> <span class="o">=</span> <span class="n">nullcontext</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span>

    <span class="k">with</span> <span class="n">generate_context_manager</span><span class="p">():</span>
        <span class="n">policy_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">],</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
            <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># if reference_output in batch use that otherwise use the reference model</span>
        <span class="k">if</span> <span class="s2">&quot;reference_output&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">reference_output</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_output&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_ref_context</span><span class="p">():</span>
                    <span class="n">reference_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="n">input_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span>
                        <span class="n">attention_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">],</span>
                        <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                        <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reference_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="n">input_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span>
                    <span class="n">attention_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">],</span>
                    <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                    <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="n">policy_output</span> <span class="o">=</span> <span class="n">pad_to_length</span><span class="p">(</span><span class="n">policy_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
    <span class="n">policy_output_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">policy_output</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">reference_output</span> <span class="o">=</span> <span class="n">pad_to_length</span><span class="p">(</span><span class="n">reference_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
    <span class="n">reference_output_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">reference_output</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">policy_output_decoded</span><span class="p">,</span> <span class="n">reference_output_decoded</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.get_batch_logps" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_batch_logps</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">average_log_prob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_pad_token_id</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

        <p>Compute the log probabilities of the given labels under the given logits.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>logits</code>
            </td>
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logits of the model (unnormalized). Shape: (batch_size, sequence_length, vocab_size)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>labels</code>
            </td>
            <td>
                  <code><span title="torch.LongTensor">LongTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Labels for which to compute the log probabilities. Label tokens with a value of label_pad_token_id are ignored. Shape: (batch_size, sequence_length)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>average_log_prob</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, return the average log probability per (non-masked) token. Otherwise, return the sum of the log probabilities of the (non-masked) tokens.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>label_pad_token_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The label pad token id.</p>
              </div>
            </td>
            <td>
                  <code>-100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_encoder_decoder</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the model is an encoder-decoder model.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tensor of shape (batch_size,) containing the average/sum log probabilities of the given labels under the given logits.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_batch_logps</span><span class="p">(</span>
    <span class="n">logits</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>
    <span class="n">average_log_prob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">is_encoder_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the log probabilities of the given labels under the given logits.</span>

<span class="sd">    Args:</span>
<span class="sd">        logits: Logits of the model (unnormalized). Shape: (batch_size, sequence_length, vocab_size)</span>
<span class="sd">        labels: Labels for which to compute the log probabilities. Label tokens with a value of label_pad_token_id are ignored. Shape: (batch_size, sequence_length)</span>
<span class="sd">        average_log_prob: If True, return the average log probability per (non-masked) token. Otherwise, return the sum of the log probabilities of the (non-masked) tokens.</span>
<span class="sd">        label_pad_token_id: The label pad token id.</span>
<span class="sd">        is_encoder_decoder: Whether the model is an encoder-decoder model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tensor of shape (batch_size,) containing the average/sum log probabilities of the given labels under the given logits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Logits (batch and sequence length dim) and labels must have the same shape.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">loss_mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">label_pad_token_id</span>

    <span class="c1"># dummy token; we&#39;ll ignore the losses on these tokens later</span>
    <span class="n">labels</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">label_pad_token_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">per_token_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">average_log_prob</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">per_token_logps</span> <span class="o">*</span> <span class="n">loss_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">loss_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">per_token_logps</span> <span class="o">*</span> <span class="n">loss_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.get_batch_loss_metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_batch_loss_metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Compute the SPPO loss and other metrics for the given batch of inputs for train or test.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_batch_loss_metrics</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]],</span>
    <span class="n">train_eval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the SPPO loss and other metrics for the given batch of inputs for train or test.&quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="p">(</span>
        <span class="n">policy_chosen_logps</span><span class="p">,</span>
        <span class="n">policy_rejected_logps</span><span class="p">,</span>
        <span class="n">policy_chosen_logits</span><span class="p">,</span>
        <span class="n">policy_rejected_logits</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

    <span class="n">chosen_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_probs&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">chosen_probs_win</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_probs_win&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">chosen_probs_lose</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_probs_lose&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># if reference_chosen_logps and reference_rejected_logps in batch use them, otherwise use the reference model</span>
    <span class="k">if</span> <span class="s2">&quot;reference_chosen_logps&quot;</span> <span class="ow">in</span> <span class="n">batch</span> <span class="ow">and</span> <span class="s2">&quot;reference_rejected_logps&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="n">reference_chosen_logps</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_chosen_logps&quot;</span><span class="p">]</span>
        <span class="n">reference_rejected_logps</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_rejected_logps&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_ref_context</span><span class="p">():</span>
                    <span class="p">(</span>
                        <span class="n">reference_chosen_logps</span><span class="p">,</span>
                        <span class="n">reference_rejected_logps</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span>
                    <span class="n">reference_chosen_logps</span><span class="p">,</span>
                    <span class="n">reference_rejected_logps</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

    <span class="n">losses</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sppo_loss</span><span class="p">(</span>
        <span class="n">policy_chosen_logps</span><span class="p">,</span>
        <span class="n">policy_rejected_logps</span><span class="p">,</span>
        <span class="n">reference_chosen_logps</span><span class="p">,</span>
        <span class="n">reference_rejected_logps</span><span class="p">,</span>
        <span class="n">chosen_probs</span><span class="p">,</span>
        <span class="n">chosen_probs_win</span><span class="p">,</span>
        <span class="n">chosen_probs_lose</span><span class="p">,</span>
        <span class="c1"># rejected_probs,</span>
    <span class="p">)</span>
    <span class="n">reward_accuracies</span> <span class="o">=</span> <span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">&gt;</span> <span class="n">rejected_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;eval_&quot;</span> <span class="k">if</span> <span class="n">train_eval</span> <span class="o">==</span> <span class="s2">&quot;eval&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/accuracies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_accuracies</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rewards/margins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chosen_rewards</span> <span class="o">-</span> <span class="n">rejected_rewards</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logps/rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_rejected_logps</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logps/chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logits/rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_rejected_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">logits/chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_chosen_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">losses</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.get_eval_dataloader" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_eval_dataloader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the evaluation [<code>~torch.utils.data.DataLoader</code>].</p>
<p>Subclass of transformers.src.transformers.trainer.get_eval_dataloader to precompute <code>ref_log_probs</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>eval_dataset</code>
            </td>
            <td>
                  <code>`torch.utils.data.Dataset`, *optional*</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, will override <code>self.eval_dataset</code>. If it is a [<code>~datasets.Dataset</code>], columns not accepted
by the <code>model.forward()</code> method are automatically removed. It must implement <code>__len__</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_eval_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the evaluation [`~torch.utils.data.DataLoader`].</span>

<span class="sd">    Subclass of transformers.src.transformers.trainer.get_eval_dataloader to precompute `ref_log_probs`.</span>

<span class="sd">    Args:</span>
<span class="sd">        eval_dataset (`torch.utils.data.Dataset`, *optional*):</span>
<span class="sd">            If provided, will override `self.eval_dataset`. If it is a [`~datasets.Dataset`], columns not accepted</span>
<span class="sd">            by the `model.forward()` method are automatically removed. It must implement `__len__`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trainer: evaluation requires an eval_dataset.&quot;</span><span class="p">)</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span> <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_eval_ref_log_probs</span><span class="p">:</span>
        <span class="n">dataloader_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">per_device_eval_batch_size</span><span class="p">,</span>
            <span class="s2">&quot;collate_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
            <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
            <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_pin_memory</span><span class="p">,</span>
            <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># prepare dataloader</span>
        <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">dataloader_params</span><span class="p">))</span>

        <span class="n">reference_chosen_logps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reference_rejected_logps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">padded_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Eval dataset reference log probs&quot;</span><span class="p">):</span>
            <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reference_log_probs</span><span class="p">(</span><span class="n">padded_batch</span><span class="p">)</span>
            <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">gather_for_metrics</span><span class="p">(</span>
                <span class="p">(</span><span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">reference_chosen_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_chosen_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">reference_rejected_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_rejected_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

        <span class="n">all_reference_chosen_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_chosen_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">all_reference_rejected_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_rejected_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_chosen_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_chosen_logps</span><span class="p">)</span>
        <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_rejected_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_rejected_logps</span>
        <span class="p">)</span>

        <span class="c1"># Save calculated reference_chosen_logps and reference_rejected_logps to the eval_dataset for subsequent runs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_eval_ref_log_probs</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_eval_dataloader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_dataset</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.get_train_dataloader" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_train_dataloader</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the training [<code>~torch.utils.data.DataLoader</code>].</p>
<p>Subclass of transformers.src.transformers.trainer.get_train_dataloader to precompute <code>ref_log_probs</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the training [`~torch.utils.data.DataLoader`].</span>

<span class="sd">    Subclass of transformers.src.transformers.trainer.get_train_dataloader to precompute `ref_log_probs`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span><span class="p">:</span>
        <span class="n">dataloader_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">per_device_train_batch_size</span><span class="p">,</span>
            <span class="s2">&quot;collate_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
            <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
            <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dataloader_pin_memory</span><span class="p">,</span>
            <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># prepare dataloader</span>
        <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">dataloader_params</span><span class="p">))</span>

        <span class="n">reference_chosen_logps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reference_rejected_logps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">padded_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Train dataset reference log probs&quot;</span><span class="p">):</span>
            <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reference_log_probs</span><span class="p">(</span><span class="n">padded_batch</span><span class="p">)</span>
            <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">gather_for_metrics</span><span class="p">(</span>
                <span class="p">(</span><span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">reference_chosen_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_chosen_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">reference_rejected_logps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_rejected_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

        <span class="n">all_reference_chosen_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_chosen_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">all_reference_rejected_logps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">reference_rejected_logps</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_chosen_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_chosen_logps</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_rejected_logps&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_rejected_logps</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_train_dataloader</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.log" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">log</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Log <code>logs</code> on the various objects watching training, including stored metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>logs</code>
            </td>
            <td>
                  <code>`Dict[str, float]`</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The values to log.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log `logs` on the various objects watching training, including stored metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        logs (`Dict[str, float]`):</span>
<span class="sd">            The values to log.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># logs either has &#39;loss&#39; or &#39;eval_loss&#39;</span>
    <span class="n">train_eval</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="s2">&quot;loss&quot;</span> <span class="ow">in</span> <span class="n">logs</span> <span class="k">else</span> <span class="s2">&quot;eval&quot;</span>
    <span class="c1"># Add averaged stored metrics to logs</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span><span class="p">[</span><span class="n">train_eval</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span><span class="p">[</span><span class="n">train_eval</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">start_time</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.null_ref_context" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">null_ref_context</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Context manager for handling null reference model (that is, peft adapter manipulation).</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">null_ref_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager for handling null reference model (that is, peft adapter manipulation).&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">unwrap_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
    <span class="p">)</span><span class="o">.</span><span class="n">disable_adapter</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_peft_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span> <span class="k">else</span> <span class="n">nullcontext</span><span class="p">():</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_adapter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span><span class="p">)</span>
        <span class="k">yield</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_adapter_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_adapter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_adapter_name</span> <span class="ow">or</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.prediction_step" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">prediction_step</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">prediction_loss_only</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prediction_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">],</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">prediction_loss_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">ignore_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dpo_data_collator</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;prediction_step is only implemented for DPODataCollatorWithPadding, and you passed a datacollator that is different than &quot;</span>
            <span class="s2">&quot;DPODataCollatorWithPadding - you might see unexpected behavior. Alternatively, you can implement your own prediction_step method if you are using a custom data collator&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">ignore_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">):</span>
            <span class="n">ignore_keys</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;keys_to_ignore_at_inference&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ignore_keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">prediction_context_manager</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peft_has_been_casted_to_bf16</span> <span class="k">else</span> <span class="n">nullcontext</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">prediction_context_manager</span><span class="p">():</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_batch_loss_metrics</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>

    <span class="c1"># force log the metrics</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">store_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prediction_loss_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># logits for the chosen and rejected samples from model</span>
    <span class="n">logits_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;eval_logits/chosen&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_logits/chosen&quot;</span><span class="p">],</span>
        <span class="s2">&quot;eval_logits/rejected&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_logits/rejected&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logits_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.sppo_loss" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">sppo_loss</span><span class="p">(</span><span class="n">policy_chosen_logps</span><span class="p">,</span> <span class="n">policy_rejected_logps</span><span class="p">,</span> <span class="n">reference_chosen_logps</span><span class="p">,</span> <span class="n">reference_rejected_logps</span><span class="p">,</span> <span class="n">chosen_probs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chosen_probs_win</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chosen_probs_lose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_free</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Compute the SPPO loss for a batch of policy and reference model log probabilities.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>policy_chosen_logps</code>
            </td>
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Log probabilities of the policy model for the chosen responses. Shape: (batch_size,)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>policy_rejected_logps</code>
            </td>
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Log probabilities of the policy model for the rejected responses. Shape: (batch_size,)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_chosen_logps</code>
            </td>
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Log probabilities of the reference model for the chosen responses. Shape: (batch_size,)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_rejected_logps</code>
            </td>
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Log probabilities of the reference model for the rejected responses. Shape: (batch_size,)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_free</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, we ignore the <em>provided</em> reference model and implicitly use a reference model that assigns equal probability to all responses.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of three tensors: (losses, chosen_rewards, rejected_rewards).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The losses tensor contains the SPPO loss for each example in the batch.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.FloatTensor">FloatTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chosen_rewards and rejected_rewards tensors contain the rewards for the chosen and rejected responses, respectively.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sppo_loss</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">policy_chosen_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
    <span class="n">policy_rejected_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
    <span class="n">reference_chosen_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
    <span class="n">reference_rejected_logps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span>
    <span class="n">chosen_probs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chosen_probs_win</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chosen_probs_lose</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_free</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the SPPO loss for a batch of policy and reference model log probabilities.</span>

<span class="sd">    Args:</span>
<span class="sd">        policy_chosen_logps: Log probabilities of the policy model for the chosen responses. Shape: (batch_size,)</span>
<span class="sd">        policy_rejected_logps: Log probabilities of the policy model for the rejected responses. Shape: (batch_size,)</span>
<span class="sd">        reference_chosen_logps: Log probabilities of the reference model for the chosen responses. Shape: (batch_size,)</span>
<span class="sd">        reference_rejected_logps: Log probabilities of the reference model for the rejected responses. Shape: (batch_size,)</span>
<span class="sd">        reference_free: If True, we ignore the _provided_ reference model and implicitly use a reference model that assigns equal probability to all responses.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of three tensors: (losses, chosen_rewards, rejected_rewards).</span>
<span class="sd">        The losses tensor contains the SPPO loss for each example in the batch.</span>
<span class="sd">        The chosen_rewards and rejected_rewards tensors contain the rewards for the chosen and rejected responses, respectively.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pi_logratios</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">policy_rejected_logps</span>
    <span class="k">if</span> <span class="n">reference_free</span><span class="p">:</span>
        <span class="n">ref_logratios</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_logratios</span> <span class="o">=</span> <span class="n">reference_chosen_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span>

    <span class="n">pi_logratios</span> <span class="o">=</span> <span class="n">pi_logratios</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">ref_logratios</span> <span class="o">=</span> <span class="n">ref_logratios</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">pi_logratios</span> <span class="o">-</span> <span class="n">ref_logratios</span>

    <span class="c1"># For sppo</span>
    <span class="n">logits_w</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span>
    <span class="n">logits_l</span> <span class="o">=</span> <span class="n">policy_rejected_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span>

    <span class="c1"># The beta is a temperature parameter for the DPO loss, typically something in the range of 0.1 to 0.5. In SPPO, beta=1/eta has a different meaning, and is usually chosen around 1e-3.</span>
    <span class="c1"># We ignore the reference model as beta -&gt; 0. The label_smoothing parameter encodes our uncertainty about the labels and</span>
    <span class="c1"># calculates a conservative SPPO loss.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;hinge&quot;</span><span class="p">:</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;ipo&quot;</span><span class="p">:</span>
        <span class="c1"># eqn (17) of the paper where beta is the regularization parameter for the IPO loss, denoted by tau in the paper.</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;sppo&quot;</span><span class="p">:</span>
        <span class="n">loss_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_w</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs_win</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">loss_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_l</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs_lose</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_w</span> <span class="o">+</span> <span class="n">loss_l</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;sppo_single&quot;</span><span class="p">:</span>
        <span class="n">loss_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_w</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">loss_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">logits_l</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">chosen_probs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_w</span> <span class="o">+</span> <span class="n">loss_l</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;kto_pair&quot;</span><span class="p">:</span>
        <span class="c1"># eqn (7) of the HALOs paper</span>
        <span class="n">chosen_KL</span> <span class="o">=</span> <span class="p">(</span><span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rejected_KL</span> <span class="o">=</span> <span class="p">(</span><span class="n">policy_rejected_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">chosen_logratios</span> <span class="o">=</span> <span class="n">policy_chosen_logps</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span>
        <span class="n">rejected_logratios</span> <span class="o">=</span> <span class="n">policy_rejected_logps</span> <span class="o">-</span> <span class="n">reference_rejected_logps</span>
        <span class="c1"># As described in the KTO report, the KL term for chosen (rejected) is estimated using the rejected (chosen) half.</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">chosen_logratios</span> <span class="o">-</span> <span class="n">rejected_KL</span><span class="p">)),</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">chosen_KL</span> <span class="o">-</span> <span class="n">rejected_logratios</span><span class="p">)),</span>
            <span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown loss type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span><span class="si">}</span><span class="s2">. Should be one of [&#39;sigmoid&#39;, &#39;hinge&#39;, &#39;ipo&#39;, &#39;kto_pair&#39;]&quot;</span>
        <span class="p">)</span>

    <span class="n">chosen_rewards</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="o">*</span> <span class="p">(</span>
            <span class="n">policy_chosen_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="n">reference_chosen_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="o">*</span> <span class="p">(</span>
            <span class="n">policy_rejected_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">reference_rejected_logps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">losses</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.store_metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">store_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">train_eval</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">store_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">train_eval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span><span class="p">[</span><span class="n">train_eval</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.trainer.SPPOTrainer.tokenize_row" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">tokenize_row</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Tokenize a single row from a SPPO specific dataset.</p>
<p>At this stage, we don't convert to PyTorch tensors yet; we just handle the truncation
in case the prompt + chosen or prompt + rejected responses is/are too long. First
    we truncate the prompt; if we're still too long, we truncate the chosen/rejected.</p>
<p>We also create the labels for the chosen/rejected responses, which are of length equal to
    the sum of the length of the prompt and the chosen/rejected response, with
    label_pad_token_id  for the prompt tokens.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">tokenize_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PreTrainedModel</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tokenize a single row from a SPPO specific dataset.</span>

<span class="sd">    At this stage, we don&#39;t convert to PyTorch tensors yet; we just handle the truncation</span>
<span class="sd">    in case the prompt + chosen or prompt + rejected responses is/are too long. First</span>
<span class="sd">        we truncate the prompt; if we&#39;re still too long, we truncate the chosen/rejected.</span>

<span class="sd">    We also create the labels for the chosen/rejected responses, which are of length equal to</span>
<span class="sd">        the sum of the length of the prompt and the chosen/rejected response, with</span>
<span class="sd">        label_pad_token_id  for the prompt tokens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span>
    <span class="n">rejected</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">:</span>
        <span class="c1"># Check issues below for more details</span>
        <span class="c1">#  1. https://github.com/huggingface/trl/issues/907</span>
        <span class="c1">#  2. https://github.com/EleutherAI/lm-evaluation-harness/pull/531#issuecomment-1595586257</span>
        <span class="c1">#  3. https://github.com/LianjiaTech/BELLE/issues/337</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prompt should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chosen should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">chosen_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rejected should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rejected</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rejected_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

        <span class="c1"># Last prompt token might get merged by tokenizer and</span>
        <span class="c1"># it should not be included for generation if that happens</span>
        <span class="n">prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>

        <span class="n">chosen_prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>
        <span class="n">rejected_prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>
        <span class="n">prompt_len_input_ids</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chosen_prompt_len_input_ids</span><span class="p">,</span> <span class="n">rejected_prompt_len_input_ids</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">prompt_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:</span><span class="n">prompt_len_input_ids</span><span class="p">]</span>

        <span class="c1"># Make sure prompts only have one different token at most an</span>
        <span class="c1"># and length only differs by 1 at most</span>
        <span class="n">num_diff_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">],</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span>
        <span class="p">)</span>
        <span class="n">num_diff_len</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">chosen_prompt_len_input_ids</span> <span class="o">-</span> <span class="n">rejected_prompt_len_input_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_diff_tokens</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">num_diff_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Chosen and rejected prompt_input_ids might only differ on the &quot;</span>
                <span class="s2">&quot;last token due to tokenizer merge ops.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># add BOS token to head of prompt</span>
        <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>

        <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>

        <span class="c1"># add EOS token to end of answer</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">longer_response_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]))</span>

        <span class="c1"># if combined sequence is too long, truncate the prompt</span>
        <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_start&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                        <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_end&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                        <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span> <span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown truncation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># if that&#39;s still too long, truncate the response</span>
        <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]:</span>
                    <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>

        <span class="c1"># Create labels</span>
        <span class="n">chosen_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">rejected_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
        <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
        <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>
        <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
        <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
        <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">toks</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;chosen_&quot;</span><span class="p">:</span> <span class="n">chosen_sequence_tokens</span><span class="p">,</span>
            <span class="s2">&quot;rejected_&quot;</span><span class="p">:</span> <span class="n">rejected_sequence_tokens</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">prompt_tokens</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">type_key</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">toks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">type_key</span> <span class="o">==</span> <span class="s2">&quot;token_type_ids&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">type_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">chosen_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span>
            <span class="n">chosen</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_target_length</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">rejected_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span>
            <span class="n">rejected</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_target_length</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_class</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;prepare_decoder_input_ids_from_labels&quot;</span><span class="p">):</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_decoder_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">prepare_decoder_input_ids_from_labels</span><span class="p">(</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_labels&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_decoder_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">prepare_decoder_input_ids_from_labels</span><span class="p">(</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="c1">#print(&#39;batch=======&#39;, batch.keys())</span>
    <span class="k">return</span> <span class="n">batch</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>utils</code>


</h8>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.apply_chat_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">apply_chat_template</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">skip_system_message</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_chat_template</span><span class="p">(</span>
    <span class="n">example</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">skip_system_message</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">)):</span>
        <span class="n">prompt_messages</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Prepend a system message if the first message is not a system message</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_system_message</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
                <span class="n">prompt_messages</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">})</span>
            <span class="c1"># Now we extract the final turn to define chosen/rejected responses</span>
            <span class="n">chosen_messages</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">rejected_messages</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">chosen_messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generate_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">rejected_messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generate_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">prompt_messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generate_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prompt_messages</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">chosen_messages</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span>
            <span class="n">rejected_messages</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span>
            <span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">prompt_messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generate_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_chosen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">chosen_messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generate_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_prompt&quot;</span><span class="p">])</span> <span class="p">:]</span>
            <span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">rejected_messages</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generate_prompt</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;text_prompt&quot;</span><span class="p">])</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not format example as dialogue for `sppo` task! Require `[chosen, rejected]` keys but found </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">example</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.apply_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">apply_template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_template</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
        <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">}],</span>
        <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_generate_prompt</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.from_ranks" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">from_ranks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">from_ranks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">):</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/ranking/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/ranking.npy&quot;</span><span class="p">)</span>  <span class="c1"># ranking_fp == &quot;./ranking.npy&quot;)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="n">probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rm_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
        <span class="n">prb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pairs</span><span class="p">,</span> <span class="n">pairs</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
                <span class="n">prb</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">prb</span> <span class="o">=</span> <span class="n">prb</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prb</span><span class="p">)</span>
        <span class="n">rm_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/generated/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/probabilities.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/generated/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/responses_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">},</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;generate_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmt</span>
    <span class="k">if</span> <span class="n">pairs</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="c1">#original implementation assumes pairs == 5</span>
        <span class="c1">#remove extra generate_x columns if they exist</span>
        <span class="n">cols_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;generate_</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">cols_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;generate_</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols_to_delete</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_to_delete</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rm_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rm_scores</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/generated/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/train.parquet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.prepare_dataset_from_prompts" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">prepare_dataset_from_prompts</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">num_prompts</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_dataset_from_prompts</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxlen</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">num_prompts</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

    <span class="c1"># Step 1: https://github.com/uclaml/SPPO/blob/main/scripts/generate.sh</span>
    <span class="c1"># Step 1(a): Generate data - https://github.com/uclaml/SPPO/blob/main/scripts/generate.py</span>
    <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/generated/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">apply_template</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span> <span class="n">tokenizer</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prompts</span><span class="p">):</span>
        <span class="n">set_seed</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
        <span class="n">generated_ids</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">enc</span><span class="p">,</span>  <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">top_p</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">max_new_tokens</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span>

        <span class="n">generated_text</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">generated_ids</span><span class="p">[:,</span> <span class="n">enc</span><span class="o">.</span><span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#[0]  #</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/generated/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/responses_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">generated_text</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


    <span class="c1"># Step 1(b): Rank data - https://github.com/uclaml/SPPO/blob/main/scripts/rank.py</span>
    <span class="n">all_generated</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_prompts</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/generated/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/responses_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">all_generated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

    <span class="n">candidates_texts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">all_generated</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates_texts</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/ranking/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ranking</span><span class="p">(</span><span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">candidates_texts</span><span class="p">)</span>

    <span class="c1"># Step 1(c): Compute probs - https://github.com/uclaml/SPPO/blob/main/scripts/compute_prob.py</span>
    <span class="n">from_ranks</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_prompts</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">)</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">prepare_score</span><span class="p">(</span><span class="n">num_prompts</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;probs calculated&#39;</span><span class="p">)</span>

    <span class="c1"># Step 2: https://github.com/uclaml/SPPO/blob/main/scripts/pipeline.sh</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/train.parquet&quot;</span><span class="p">)</span>
    <span class="n">processed_train</span> <span class="o">=</span> <span class="n">process_dataset</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">processed_train</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.prepare_score" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">prepare_score</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_score</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">):</span>
    <span class="c1"># Load dataset and convert to DataFrame</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/generated/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/train.parquet&quot;</span><span class="p">)</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

    <span class="c1"># Calculate metrics and probabilities</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;rm_scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">pairs</span><span class="p">:]))</span>
    <span class="n">metrics_prob</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">maxmin</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">argmin</span><span class="p">()])</span>

    <span class="c1"># Reorganize the DataFrame for easy access</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;generate_</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
    <span class="n">train_ordered</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>

    <span class="c1"># Determine chosen and rejected items based on maxmin indices</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_ordered</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">maxmin</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ordered</span><span class="p">))]</span>
    <span class="n">rejected</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_ordered</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">maxmin</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ordered</span><span class="p">))]</span>

    <span class="c1"># Calculate probabilities for chosen and rejected items</span>
    <span class="n">chosen_probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_ordered</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">maxmin</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">maxmin</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ordered</span><span class="p">))]</span>
    <span class="n">chosen_probs_win</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_prob</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">maxmin</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_prob</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_prob</span><span class="p">))]</span>
    <span class="n">chosen_probs_lose</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics_prob</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">maxmin</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_prob</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics_prob</span><span class="p">))]</span>

    <span class="c1"># Create a new DataFrame with the results</span>
    <span class="n">train_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;chosen&#39;</span><span class="p">:</span> <span class="n">chosen</span><span class="p">,</span>
        <span class="s1">&#39;rejected&#39;</span><span class="p">:</span> <span class="n">rejected</span><span class="p">,</span>
        <span class="s1">&#39;chosen_probs&#39;</span><span class="p">:</span> <span class="n">chosen_probs</span><span class="p">,</span>
        <span class="s1">&#39;chosen_probs_win&#39;</span><span class="p">:</span> <span class="n">chosen_probs_win</span><span class="p">,</span>
        <span class="s1">&#39;chosen_probs_lose&#39;</span><span class="p">:</span> <span class="n">chosen_probs_lose</span>
    <span class="p">})</span>

    <span class="c1"># Determine output directory</span>
    <span class="c1">#output_dir = &#39;-&#39;.join(output_dir.split(&#39;-&#39;)[1:])</span>
    <span class="n">OUTPATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s1">/synthetic_data_SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s1">_score&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">OUTPATH</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Save train and test datasets to parquet files</span>
    <span class="n">train_new</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">OUTPATH</span><span class="si">}</span><span class="s1">/train.parquet&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved file to </span><span class="si">{</span><span class="n">OUTPATH</span><span class="si">}</span><span class="s2">/train.parquet&quot;</span><span class="p">)</span>

    <span class="c1"># Temporary solution to make the code run, cannot use for test/evaluation purpose</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">train_new</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">train_new</span><span class="p">)))</span>
    <span class="n">test</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">OUTPATH</span><span class="si">}</span><span class="s1">/test.parquet&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved file to </span><span class="si">{</span><span class="n">OUTPATH</span><span class="si">}</span><span class="s2">/test.parquet&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">OUTPATH</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.process_dataset" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">process_dataset</span><span class="p">(</span><span class="n">raw_dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_dataset</span><span class="p">(</span><span class="n">raw_dataset</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_dataset</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column_names</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;chosen_probs&#39;</span><span class="p">,</span> <span class="s1">&#39;chosen_probs_win&#39;</span><span class="p">,</span> <span class="s1">&#39;chosen_probs_lose&#39;</span><span class="p">]]</span>

    <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="n">apply_chat_template</span><span class="p">,</span>
        <span class="n">fn_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">:</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;skip_system_message&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="n">remove_columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Formatting comparisons with prompt template&quot;</span><span class="p">,</span>
    <span class="p">)</span>


    <span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;text_prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;text_chosen&quot;</span><span class="p">:</span> <span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;text_rejected&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">raw_dataset</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.ranking" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">ranking</span><span class="p">(</span><span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ranking</span><span class="p">(</span><span class="n">sppo_temp_dir</span><span class="p">,</span> <span class="n">iter_num</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
    <span class="n">blender</span> <span class="o">=</span> <span class="n">llm_blender</span><span class="o">.</span><span class="n">Blender</span><span class="p">()</span>
    <span class="n">blender</span><span class="o">.</span><span class="n">loadranker</span><span class="p">(</span><span class="s2">&quot;llm-blender/PairRM&quot;</span><span class="p">)</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">blender</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">return_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sppo_temp_dir</span><span class="si">}</span><span class="s2">/ranking/SPPO-Iter</span><span class="si">{</span><span class="n">iter_num</span><span class="si">}</span><span class="s2">/ranking.npy&quot;</span><span class="p">,</span> <span class="n">ranks</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.algorithms.structural_control.wrappers.trl.sppotrainer.utils.set_seed" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">5775709</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/algorithms/structural_control/wrappers/trl/sppotrainer/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">5775709</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="aisteer360.evaluation" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>evaluation</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="aisteer360.evaluation.benchmark" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>benchmark</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="aisteer360.evaluation.benchmark.Benchmark" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Benchmark</code>


</h5>


    <div class="doc doc-contents ">


        <p>Benchmark framework for comparing steering pipelines on specific use cases.</p>
<p>Provides a standardized way to compare different steering control configurations against a baseline model on a given
evaluation task. Handles the complete benchmark workflow: model loading, generation, and evaluation.</p>
<p>The benchmark runs each control pipeline configuration independently, allowing for fair comparison of controls on a
common task.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>use_case</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="            UseCase (aisteer360.evaluation.use_cases.base.UseCase)" href="#aisteer360.evaluation.use_cases.base.UseCase">UseCase</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The evaluation task defining prompts, generation logic, and metrics.
Must implement <code>generate()</code> and <code>evaluate()</code> methods.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>base_model_name_or_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HuggingFace model identifier or local path to the base model.
Used for all pipeline configurations and baseline.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>steering_pipelines</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Named configurations of steering pipelines.
Keys are configuration names (e.g., "baseline", "with_activation_steering").
Values are pipelines, e.g., lists of controls (StructuralControl, StateControl, etc.).
Empty list or None creates a baseline configuration without steering.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_overrides</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runtime parameters for specific pipeline
configurations. Outer keys match <code>control_pipelines</code> keys,
inner dicts contain runtime kwargs passed to controls during generation.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hf_model_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to <code>AutoModelForCausalLM.from_pretrained()</code>.
Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generation parameters passed to model.generate().
Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device_map</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device placement strategy for model loading.
Defaults to "auto".</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/benchmark.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Benchmark</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Benchmark framework for comparing steering pipelines on specific use cases.</span>

<span class="sd">    Provides a standardized way to compare different steering control configurations against a baseline model on a given</span>
<span class="sd">    evaluation task. Handles the complete benchmark workflow: model loading, generation, and evaluation.</span>

<span class="sd">    The benchmark runs each control pipeline configuration independently, allowing for fair comparison of controls on a</span>
<span class="sd">    common task.</span>

<span class="sd">    Args:</span>
<span class="sd">        use_case (UseCase): The evaluation task defining prompts, generation logic, and metrics.</span>
<span class="sd">            Must implement `generate()` and `evaluate()` methods.</span>
<span class="sd">        base_model_name_or_path (str | Path): HuggingFace model identifier or local path to the base model.</span>
<span class="sd">            Used for all pipeline configurations and baseline.</span>
<span class="sd">        steering_pipelines (dict[str, list[Any]]): Named configurations of steering pipelines.</span>
<span class="sd">            Keys are configuration names (e.g., &quot;baseline&quot;, &quot;with_activation_steering&quot;).</span>
<span class="sd">            Values are pipelines, e.g., lists of controls (StructuralControl, StateControl, etc.).</span>
<span class="sd">            Empty list or None creates a baseline configuration without steering.</span>
<span class="sd">        runtime_overrides (dict[str, dict[str, Any]], optional): Runtime parameters for specific pipeline</span>
<span class="sd">            configurations. Outer keys match `control_pipelines` keys,</span>
<span class="sd">            inner dicts contain runtime kwargs passed to controls during generation.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        hf_model_kwargs (dict, optional): Additional arguments passed to `AutoModelForCausalLM.from_pretrained()`.</span>
<span class="sd">            Defaults to {}.</span>
<span class="sd">        gen_kwargs (dict, optional): Generation parameters passed to model.generate().</span>
<span class="sd">            Defaults to {}.</span>
<span class="sd">        device_map (str, optional): Device placement strategy for model loading.</span>
<span class="sd">            Defaults to &quot;auto&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">use_case</span><span class="p">:</span> <span class="n">UseCase</span><span class="p">,</span>
            <span class="n">base_model_name_or_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
            <span class="n">steering_pipelines</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
            <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">hf_model_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">device_map</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_case</span> <span class="o">=</span> <span class="n">use_case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model_name_or_path</span> <span class="o">=</span> <span class="n">base_model_name_or_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steering_pipelines</span> <span class="o">=</span> <span class="n">steering_pipelines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_overrides</span> <span class="o">=</span> <span class="n">runtime_overrides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hf_model_kwargs</span> <span class="o">=</span> <span class="n">hf_model_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_kwargs</span> <span class="o">=</span> <span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_map</span> <span class="o">=</span> <span class="n">device_map</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run benchmark on all configured steering pipelines.</span>

<span class="sd">        Executes the benchmark by iterating through each pipeline configuration defined in `control_pipelines`. For each</span>
<span class="sd">        configuration, calls `_run_pipeline()` to handle model setup, generation, and evaluation. Results from all</span>
<span class="sd">        pipelines are collected for comparison.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Benchmark profiles for all pipeline configurations. Keys are pipeline names from `control_pipelines`. Values are dicts containing:</span>

<span class="sd">                - &quot;generations&quot;: Generated outputs from the model</span>
<span class="sd">                - &quot;evaluations&quot;: Evaluation scores from the use case metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">steering_pipeline_name</span><span class="p">,</span> <span class="n">steering_pipeline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steering_pipelines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running pipeline: </span><span class="si">{</span><span class="n">steering_pipeline_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_pipeline</span><span class="p">(</span><span class="n">steering_pipeline</span><span class="p">)</span>
            <span class="n">profiles</span><span class="p">[</span><span class="n">steering_pipeline_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">profiles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steering_pipeline</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run steering pipeline.&quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">steering_pipeline</span><span class="p">:</span>

                <span class="c1"># todo: determine if lazy_init needed; raise warnings/errors according</span>

                <span class="c1"># build pipeline and steer</span>
                <span class="n">pipeline</span> <span class="o">=</span> <span class="n">SteeringPipeline</span><span class="p">(</span>
                    <span class="n">model_name_or_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_name_or_path</span><span class="p">,</span>
                    <span class="n">controls</span><span class="o">=</span><span class="n">steering_pipeline</span><span class="p">,</span>
                    <span class="n">device_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_map</span><span class="p">,</span>
                    <span class="n">hf_model_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hf_model_kwargs</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># todo: check if steer_kwargs are necessary</span>
                <span class="c1"># steerer = steerer.steer(**steer_kwargs)</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="n">steer</span><span class="p">()</span>

                <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">tokenizer</span>
                <span class="n">model_or_pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># baseline</span>

                <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">base_model_name_or_path</span><span class="p">,</span>
                    <span class="n">device_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_map</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hf_model_kwargs</span>
                <span class="p">)</span>
                <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_name_or_path</span><span class="p">)</span>
                <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">ensure_pad_token</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>
                <span class="n">model_or_pipeline</span> <span class="o">=</span> <span class="n">model</span>

            <span class="c1"># generate</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_case</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">model_or_pipeline</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
                <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">gen_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_kwargs</span><span class="p">,</span>
                <span class="n">runtime_overrides</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_overrides</span>
            <span class="p">)</span>

            <span class="c1"># evaluate</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_case</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;generations&quot;</span><span class="p">:</span> <span class="n">generations</span><span class="p">,</span>
                <span class="s2">&quot;evaluations&quot;</span><span class="p">:</span> <span class="n">scores</span>
            <span class="p">}</span>

        <span class="k">finally</span><span class="p">:</span>  <span class="c1"># cleanup</span>

            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">model</span>

            <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">pipeline</span>

            <span class="k">if</span> <span class="n">tokenizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">tokenizer</span>

            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export benchmark results to disk.</span>

<span class="sd">        Saves the benchmark profiles to the specified directory. Creates the directory if it doesn&#39;t exist. Delegates</span>
<span class="sd">        the actual export logic to the use case&#39;s export method, which handles format-specific serialization.</span>

<span class="sd">        Args:</span>
<span class="sd">            profiles (dict[str, Any]): Benchmark results from `run()` method.</span>
<span class="sd">                Contains generations and evaluations for each pipeline configuration.</span>
<span class="sd">            save_dir (str): Directory path where results will be saved.</span>
<span class="sd">                Will be created if it doesn&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
        <span class="n">save_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_case</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.benchmark.Benchmark.base_model_name_or_path" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_model_name_or_path</span> <span class="o">=</span> <span class="n">base_model_name_or_path</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.benchmark.Benchmark.device_map" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device_map</span> <span class="o">=</span> <span class="n">device_map</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.benchmark.Benchmark.gen_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">gen_kwargs</span> <span class="o">=</span> <span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.benchmark.Benchmark.hf_model_kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">hf_model_kwargs</span> <span class="o">=</span> <span class="n">hf_model_kwargs</span> <span class="ow">or</span> <span class="p">{}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.benchmark.Benchmark.runtime_overrides" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">runtime_overrides</span> <span class="o">=</span> <span class="n">runtime_overrides</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.benchmark.Benchmark.steering_pipelines" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">steering_pipelines</span> <span class="o">=</span> <span class="n">steering_pipelines</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.benchmark.Benchmark.use_case" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_case</span> <span class="o">=</span> <span class="n">use_case</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.benchmark.Benchmark.export" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">export</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Export benchmark results to disk.</p>
<p>Saves the benchmark profiles to the specified directory. Creates the directory if it doesn't exist. Delegates
the actual export logic to the use case's export method, which handles format-specific serialization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>profiles</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Benchmark results from <code>run()</code> method.
Contains generations and evaluations for each pipeline configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where results will be saved.
Will be created if it doesn't exist.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/benchmark.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export benchmark results to disk.</span>

<span class="sd">    Saves the benchmark profiles to the specified directory. Creates the directory if it doesn&#39;t exist. Delegates</span>
<span class="sd">    the actual export logic to the use case&#39;s export method, which handles format-specific serialization.</span>

<span class="sd">    Args:</span>
<span class="sd">        profiles (dict[str, Any]): Benchmark results from `run()` method.</span>
<span class="sd">            Contains generations and evaluations for each pipeline configuration.</span>
<span class="sd">        save_dir (str): Directory path where results will be saved.</span>
<span class="sd">            Will be created if it doesn&#39;t exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
    <span class="n">save_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_case</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.benchmark.Benchmark.run" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Run benchmark on all configured steering pipelines.</p>
<p>Executes the benchmark by iterating through each pipeline configuration defined in <code>control_pipelines</code>. For each
configuration, calls <code>_run_pipeline()</code> to handle model setup, generation, and evaluation. Results from all
pipelines are collected for comparison.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Benchmark profiles for all pipeline configurations. Keys are pipeline names from <code>control_pipelines</code>. Values are dicts containing:</p>
<ul>
<li>"generations": Generated outputs from the model</li>
<li>"evaluations": Evaluation scores from the use case metrics</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/benchmark.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run benchmark on all configured steering pipelines.</span>

<span class="sd">    Executes the benchmark by iterating through each pipeline configuration defined in `control_pipelines`. For each</span>
<span class="sd">    configuration, calls `_run_pipeline()` to handle model setup, generation, and evaluation. Results from all</span>
<span class="sd">    pipelines are collected for comparison.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Benchmark profiles for all pipeline configurations. Keys are pipeline names from `control_pipelines`. Values are dicts containing:</span>

<span class="sd">            - &quot;generations&quot;: Generated outputs from the model</span>
<span class="sd">            - &quot;evaluations&quot;: Evaluation scores from the use case metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">profiles</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">steering_pipeline_name</span><span class="p">,</span> <span class="n">steering_pipeline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steering_pipelines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running pipeline: </span><span class="si">{</span><span class="n">steering_pipeline_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_pipeline</span><span class="p">(</span><span class="n">steering_pipeline</span><span class="p">)</span>
        <span class="n">profiles</span><span class="p">[</span><span class="n">steering_pipeline_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">profiles</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="aisteer360.evaluation.metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>metrics</code>


</h4>

    <div class="doc doc-contents ">

        <p>Base classes for evaluation metrics.</p>
<p>Contains two classes:</p>
<ul>
<li><code>Metric</code>: Base class for all evaluation metrics.</li>
<li><code>LLMJudgeMetric</code>: Base class for LLM-as-a-judge metrics (subclasses <code>Metric</code>)</li>
</ul>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h5 id="aisteer360.evaluation.metrics.Factuality" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Factuality</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            LLMJudgeMetric (aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric)" href="#aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric">LLMJudgeMetric</a></code></p>


        <p>Judge factual correctness of a response to a prompt.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/generic/factuality.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Factuality</span><span class="p">(</span><span class="n">LLMJudgeMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Judge factual correctness of a response to a prompt.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="n">prompt_template</span><span class="o">=</span><span class="n">_PROMPT</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.base_prompt_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.format_instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.max_retries" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.num_return_sequences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">num_return_sequences</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_return_sequences&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">tokenizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.scale" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Factuality.use_chat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;apply_chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.metrics.Factuality.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Compute LLM judge scores for a list of responses.</p>
<p>Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple
samples are generated per response (via <code>num_return_sequences</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of text responses to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of prompts corresponding to each response.
If provided, must be the same length as responses. These prompts can be
referenced in the prompt_template using the {prompt} placeholder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score statistics containing:</p>
<ul>
<li>"mean_score": Overall average score across all responses</li>
<li>"scores": List of mean scores for each response (averaged across samples)</li>
<li>"raw_scores": List of lists containing all individual scores for each response</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prompts is provided but has different length than responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">    Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">    samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">        prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">            If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">            referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">        **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Score statistics containing:</span>

<span class="sd">            - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">            - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">            - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

    <span class="c1"># build prompts</span>
    <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
        <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

    <span class="c1"># generate</span>
    <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
            <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

            <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
    <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
        <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="aisteer360.evaluation.metrics.LLMJudgeMetric" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>LLMJudgeMetric</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Base class for LLM-as-a-judge evaluation metrics.</p>
<p>Leverages a language model to evaluate the quality of generated text responses according to customized (natural
language) criteria. The judge model evaluates each response (optionally with respect to an associated prompt and
context) and returns numerical scores within a specified range. When multiple samples are generated per prompt (via
num_return_sequences), scores are averaged to improve reliability.</p>
<p>Subclasses should define their specific evaluation criteria by providing a <code>prompt_template</code> that instructs the
judge model how to score responses. The template should use placeholders {response}, {lower_bound}, and
{upper_bound} (and optionally {prompt} and {context}). Subclasses typically override <code>__init__()</code> to set their
specific prompt template and scoring scale (e.g., see <code>metrics.generic.relevance</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_or_id</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HuggingFace model ID or loaded model instance to use as the judge.
If string, the model will be loaded automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompt_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template string for evaluation prompts. Should contain placeholders for {response},
{lower_bound}, {upper_bound}, and optionally {prompt}, {context}.
The formatted prompt will be passed to the judge model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for the judge model. If None, will be loaded from the model ID.
Required if passing a PreTrainedModel instance.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device for model inference ('cuda', 'mps', 'cpu').
Defaults to GPU if available, otherwise CPU.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score range as (min, max) tuple. Scores outside this range will be clamped.
Defaults to (1, 5).</p>
              </div>
            </td>
            <td>
                  <code>(1, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of prompts to process simultaneously. Defaults to 8.</p>
              </div>
            </td>
            <td>
                  <code>8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_retries</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum retry attempts when score parsing fails. Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generation parameters passed to the model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LLMJudgeMetric</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for LLM-as-a-judge evaluation metrics.</span>

<span class="sd">    Leverages a language model to evaluate the quality of generated text responses according to customized (natural</span>
<span class="sd">    language) criteria. The judge model evaluates each response (optionally with respect to an associated prompt and</span>
<span class="sd">    context) and returns numerical scores within a specified range. When multiple samples are generated per prompt (via</span>
<span class="sd">    num_return_sequences), scores are averaged to improve reliability.</span>

<span class="sd">    Subclasses should define their specific evaluation criteria by providing a `prompt_template` that instructs the</span>
<span class="sd">    judge model how to score responses. The template should use placeholders {response}, {lower_bound}, and</span>
<span class="sd">    {upper_bound} (and optionally {prompt} and {context}). Subclasses typically override `__init__()` to set their</span>
<span class="sd">    specific prompt template and scoring scale (e.g., see `metrics.generic.relevance`).</span>

<span class="sd">    Args:</span>
<span class="sd">        model_or_id (str | PreTrainedModel): HuggingFace model ID or loaded model instance to use as the judge.</span>
<span class="sd">            If string, the model will be loaded automatically.</span>
<span class="sd">        prompt_template (str): Template string for evaluation prompts. Should contain placeholders for {response},</span>
<span class="sd">            {lower_bound}, {upper_bound}, and optionally {prompt}, {context}.</span>
<span class="sd">            The formatted prompt will be passed to the judge model.</span>
<span class="sd">        tokenizer (Any | None): Tokenizer for the judge model. If None, will be loaded from the model ID.</span>
<span class="sd">            Required if passing a PreTrainedModel instance.</span>
<span class="sd">        device (str | None): Device for model inference (&#39;cuda&#39;, &#39;mps&#39;, &#39;cpu&#39;).</span>
<span class="sd">            Defaults to GPU if available, otherwise CPU.</span>
<span class="sd">        scale (tuple[float, float]): Score range as (min, max) tuple. Scores outside this range will be clamped.</span>
<span class="sd">            Defaults to (1, 5).</span>
<span class="sd">        batch_size (int): Number of prompts to process simultaneously. Defaults to 8.</span>
<span class="sd">        max_retries (int): Maximum retry attempts when score parsing fails. Defaults to 5.</span>
<span class="sd">        gen_kwargs (dict[str, Any] | None): Generation parameters passed to the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_or_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_name_or_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;apply_chat_template&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
            <span class="k">else</span> <span class="s2">&quot;mps&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
            <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;pad_token_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;num_return_sequences&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span> <span class="o">=</span> <span class="n">build_structured_parser</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap prompt with appropriate formatting for the model.</span>

<span class="sd">        Applies the chat template (if the model supports it) with the prompt as a user message.</span>
<span class="sd">        Otherwise, returns the prompt unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The user prompt.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The formatted prompt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_chat</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">prompt</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_batch_chunks</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split a sequence into chunks of specified size.</span>

<span class="sd">        Args:</span>
<span class="sd">            seq (Sequence[Any]): The sequence to split into chunks.</span>
<span class="sd">            chunk_size (int): Maximum size of each chunk.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Sequence[Any]: Chunks of the input sequence, each with at most chunk_size elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_score_with_retries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate replies until parsing succeeds or maximum retries reached.</span>

<span class="sd">        Attempts to generate a response and parse it (using `parse_fn`) as a score.</span>
<span class="sd">        If parsing fails, retries up to `max_retries` times.</span>
<span class="sd">        If all attempts fail, raises a warning and returns `float(&#39;nan&#39;)`.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The formatted prompt to send to the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The parsed score from the model&#39;s response, or `float(&#39;nan&#39;)` if parsing fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">reply_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
                <span class="n">prompt</span><span class="p">,</span>
                <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to parse score after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                        <span class="s2">&quot;Returning float(&#39;nan&#39;) instead.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">        Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">        samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">        Args:</span>
<span class="sd">            responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">            prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">                If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">                referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">            **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Score statistics containing:</span>

<span class="sd">                - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">                - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">                - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

        <span class="c1"># build prompts</span>
        <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
            <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
            <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

        <span class="c1"># generate</span>
        <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span>
                <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
                <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
                <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

                <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                    <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

                <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
        <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
            <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
            <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.base_prompt_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.format_instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.max_retries" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.num_return_sequences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">num_return_sequences</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_return_sequences&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">tokenizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.scale" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.use_chat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;apply_chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.metrics.LLMJudgeMetric.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Compute LLM judge scores for a list of responses.</p>
<p>Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple
samples are generated per response (via <code>num_return_sequences</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of text responses to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of prompts corresponding to each response.
If provided, must be the same length as responses. These prompts can be
referenced in the prompt_template using the {prompt} placeholder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score statistics containing:</p>
<ul>
<li>"mean_score": Overall average score across all responses</li>
<li>"scores": List of mean scores for each response (averaged across samples)</li>
<li>"raw_scores": List of lists containing all individual scores for each response</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prompts is provided but has different length than responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">    Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">    samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">        prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">            If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">            referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">        **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Score statistics containing:</span>

<span class="sd">            - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">            - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">            - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

    <span class="c1"># build prompts</span>
    <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
        <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

    <span class="c1"># generate</span>
    <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
            <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

            <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
    <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
        <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="aisteer360.evaluation.metrics.Metric" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Metric</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Base-class for evaluation metrics.</p>
<p>Provides a standardized interface for computing evaluation scores on model-generated responses. Subclasses should
define their specific scoring logic in <code>compute()</code> and can accept additional configuration through constructor
arguments stored in <code>extras</code>.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Metric</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base-class for evaluation metrics.</span>

<span class="sd">    Provides a standardized interface for computing evaluation scores on model-generated responses. Subclasses should</span>
<span class="sd">    define their specific scoring logic in `compute()` and can accept additional configuration through constructor</span>
<span class="sd">    arguments stored in `extras`.</span>

<span class="sd">    Args:</span>
<span class="sd">        **extras</span>
<span class="sd">            Required extras for the metric (e.g., LLM, tokenizer, etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">extras</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">extras</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Base compute method.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Metric.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Metric.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.metrics.Metric.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <p>Base compute method.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base compute method.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="aisteer360.evaluation.metrics.Perplexity" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Perplexity</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Compute token-level perplexity for a batch of sentences.</p>
<p>Perplexity is the exponentiated mean cross-entropy between the language model’s predicted distribution and the true
next token. Lower is better.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_or_id</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face model ID or an already-instantiated causal language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer to use.  Leave <code>None</code> when passing a model ID to automatically load the matching tokenizer.
Defaults to <code>None</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of sentences per forward pass. Higher is faster until GPU memory becomes the
bottleneck. Defaults to <code>16</code>.</p>
              </div>
            </td>
            <td>
                  <code>16</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_bos</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to prepend the tokenizer’s BOS token so the first word in each sentence is
also scored. Ignored if the tokenizer has no BOS token. Defaults to <code>True</code>.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set, truncate inputs to this length so they fit the model’s context
window. <code>None</code> disables truncation. Defaults to <code>None</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>"cuda"</code> or <code>"cpu"</code>. When <code>None</code>, automatically selects GPU if available.
Defaults to <code>None</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            add_bos = add_bos and self.tokenizer.bos_token_id is not None

  
      instance-attribute
   (aisteer360.evaluation.metrics.Perplexity.add_bos)" href="#aisteer360.evaluation.metrics.Perplexity.add_bos">add_bos</a></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether a BOS token is prepended before scoring.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            batch_size = batch_size

  
      instance-attribute
   (aisteer360.evaluation.metrics.Perplexity.batch_size)" href="#aisteer360.evaluation.metrics.Perplexity.batch_size">batch_size</a></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of sentences processed per forward pass.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            device = device or ('cuda' if torch.cuda.is_available() else 'cpu')

  
      instance-attribute
   (aisteer360.evaluation.metrics.Perplexity.device)" href="#aisteer360.evaluation.metrics.Perplexity.device">device</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The device actually selected for computation (<code>"cuda"</code> or <code>"cpu"</code>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            max_length = max_length

  
      instance-attribute
   (aisteer360.evaluation.metrics.Perplexity.max_length)" href="#aisteer360.evaluation.metrics.Perplexity.max_length">max_length</a></code></td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Truncation length for inputs, or <code>None</code> for no truncation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            model = AutoModelForCausalLM.from_pretrained(model_or_id)

  
      instance-attribute
   (aisteer360.evaluation.metrics.Perplexity.model)" href="#aisteer360.evaluation.metrics.Perplexity.model">model</a></code></td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded causal language model used to score tokens.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            tokenizer = tokenizer or AutoTokenizer.from_pretrained(model_or_id)

  
      instance-attribute
   (aisteer360.evaluation.metrics.Perplexity.tokenizer)" href="#aisteer360.evaluation.metrics.Perplexity.tokenizer">tokenizer</a></code></td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer used for encoding, padding, and BOS handling.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/generic/perplexity.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Perplexity</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute token-level perplexity for a batch of sentences.</span>

<span class="sd">    Perplexity is the exponentiated mean cross-entropy between the language model’s predicted distribution and the true</span>
<span class="sd">    next token. Lower is better.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_or_id (str | torch.nn.Module): Hugging Face model ID or an already-instantiated causal language model.</span>
<span class="sd">        tokenizer (transformers.PreTrainedTokenizer | None, optional):</span>
<span class="sd">            Tokenizer to use.  Leave ``None`` when passing a model ID to automatically load the matching tokenizer.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">        batch_size (int, optional): Number of sentences per forward pass. Higher is faster until GPU memory becomes the</span>
<span class="sd">            bottleneck. Defaults to ``16``.</span>
<span class="sd">        add_bos (bool, optional): Whether to prepend the tokenizer’s BOS token so the first word in each sentence is</span>
<span class="sd">            also scored. Ignored if the tokenizer has no BOS token. Defaults to ``True``.</span>
<span class="sd">        max_length (int | None, optional): If set, truncate inputs to this length so they fit the model’s context</span>
<span class="sd">            window. ``None`` disables truncation. Defaults to ``None``.</span>
<span class="sd">        device (str | None, optional): ``&quot;cuda&quot;`` or ``&quot;cpu&quot;``. When ``None``, automatically selects GPU if available.</span>
<span class="sd">            Defaults to ``None``.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        add_bos (bool): Whether a BOS token is prepended before scoring.</span>
<span class="sd">        batch_size (int): Number of sentences processed per forward pass.</span>
<span class="sd">        device (str): The device actually selected for computation (``&quot;cuda&quot;`` or ``&quot;cpu&quot;``).</span>
<span class="sd">        max_length (int | None): Truncation length for inputs, or ``None`` for no truncation.</span>
<span class="sd">        model (transformers.PreTrainedModel): The loaded causal language model used to score tokens.</span>
<span class="sd">        tokenizer (transformers.PreTrainedTokenizer): Tokenizer used for encoding, padding, and BOS handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">add_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># model object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_or_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_name_or_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bos</span> <span class="o">=</span> <span class="n">add_bos</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">({</span><span class="s2">&quot;pad_token&quot;</span><span class="p">:</span> <span class="s2">&quot;[PAD]&quot;</span><span class="p">})</span>
            <span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute perplexity for each response (and the mean across the batch).</span>

<span class="sd">        Args:</span>
<span class="sd">            responses (list[str]): Text sequences to score.</span>
<span class="sd">            prompts (list[str] | None, optional): Unused here; present for a uniform metric API.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, float]: A dict with keys:</span>

<span class="sd">                - ``&quot;mean_perplexity&quot;``: mean perplexity over all inputs.</span>
<span class="sd">                - ``&quot;perplexities&quot;``: list of per-sample perplexities in input order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">perplexities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">local_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span> <span class="n">local_batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">local_batch_size</span><span class="p">]</span>

            <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">truncation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos</span><span class="p">:</span>
                <span class="n">bos_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">bos_tokens</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="n">loss_per_token</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
                <span class="n">logits</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
            <span class="n">seq_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_per_token</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">perplexities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">seq_loss</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;mean_perplexity&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">perplexities</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">perplexities</span><span class="p">),</span>
            <span class="s2">&quot;perplexities&quot;</span><span class="p">:</span> <span class="n">perplexities</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.add_bos" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">add_bos</span> <span class="o">=</span> <span class="n">add_bos</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.max_length" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Perplexity.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.metrics.Perplexity.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Compute perplexity for each response (and the mean across the batch).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text sequences to score.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unused here; present for a uniform metric API.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, float]: A dict with keys:</p>
<ul>
<li><code>"mean_perplexity"</code>: mean perplexity over all inputs.</li>
<li><code>"perplexities"</code>: list of per-sample perplexities in input order.</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/generic/perplexity.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute perplexity for each response (and the mean across the batch).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): Text sequences to score.</span>
<span class="sd">        prompts (list[str] | None, optional): Unused here; present for a uniform metric API.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, float]: A dict with keys:</span>

<span class="sd">            - ``&quot;mean_perplexity&quot;``: mean perplexity over all inputs.</span>
<span class="sd">            - ``&quot;perplexities&quot;``: list of per-sample perplexities in input order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perplexities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">local_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span> <span class="n">local_batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">local_batch_size</span><span class="p">]</span>

        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
            <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos</span><span class="p">:</span>
            <span class="n">bos_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">bos_tokens</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="n">loss_per_token</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
            <span class="n">logits</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
        <span class="n">seq_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_per_token</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">perplexities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">seq_loss</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_perplexity&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">perplexities</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">perplexities</span><span class="p">),</span>
        <span class="s2">&quot;perplexities&quot;</span><span class="p">:</span> <span class="n">perplexities</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h5 id="aisteer360.evaluation.metrics.Relevance" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Relevance</code>


</h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            LLMJudgeMetric (aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric)" href="#aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric">LLMJudgeMetric</a></code></p>


        <p>Judge relevance of a response to a prompt.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/generic/relevance.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Relevance</span><span class="p">(</span><span class="n">LLMJudgeMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Judge relevance of a response to a prompt.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="n">prompt_template</span><span class="o">=</span><span class="n">_PROMPT</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.base_prompt_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.format_instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.max_retries" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.num_return_sequences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">num_return_sequences</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_return_sequences&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">tokenizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.scale" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.metrics.Relevance.use_chat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;apply_chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.metrics.Relevance.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Compute LLM judge scores for a list of responses.</p>
<p>Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple
samples are generated per response (via <code>num_return_sequences</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of text responses to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of prompts corresponding to each response.
If provided, must be the same length as responses. These prompts can be
referenced in the prompt_template using the {prompt} placeholder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score statistics containing:</p>
<ul>
<li>"mean_score": Overall average score across all responses</li>
<li>"scores": List of mean scores for each response (averaged across samples)</li>
<li>"raw_scores": List of lists containing all individual scores for each response</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prompts is provided but has different length than responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">    Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">    samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">        prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">            If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">            referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">        **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Score statistics containing:</span>

<span class="sd">            - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">            - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">            - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

    <span class="c1"># build prompts</span>
    <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
        <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

    <span class="c1"># generate</span>
    <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
            <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

            <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
    <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
        <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>



<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.metrics.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h6 id="aisteer360.evaluation.metrics.base.Metric" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Metric</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Base-class for evaluation metrics.</p>
<p>Provides a standardized interface for computing evaluation scores on model-generated responses. Subclasses should
define their specific scoring logic in <code>compute()</code> and can accept additional configuration through constructor
arguments stored in <code>extras</code>.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Metric</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base-class for evaluation metrics.</span>

<span class="sd">    Provides a standardized interface for computing evaluation scores on model-generated responses. Subclasses should</span>
<span class="sd">    define their specific scoring logic in `compute()` and can accept additional configuration through constructor</span>
<span class="sd">    arguments stored in `extras`.</span>

<span class="sd">    Args:</span>
<span class="sd">        **extras</span>
<span class="sd">            Required extras for the metric (e.g., LLM, tokenizer, etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">extras</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extras</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">extras</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Base compute method.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base.Metric.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base.Metric.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.evaluation.metrics.base.Metric.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Base compute method.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base compute method.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.metrics.base_judge" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base_judge</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h6 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>LLMJudgeMetric</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Base class for LLM-as-a-judge evaluation metrics.</p>
<p>Leverages a language model to evaluate the quality of generated text responses according to customized (natural
language) criteria. The judge model evaluates each response (optionally with respect to an associated prompt and
context) and returns numerical scores within a specified range. When multiple samples are generated per prompt (via
num_return_sequences), scores are averaged to improve reliability.</p>
<p>Subclasses should define their specific evaluation criteria by providing a <code>prompt_template</code> that instructs the
judge model how to score responses. The template should use placeholders {response}, {lower_bound}, and
{upper_bound} (and optionally {prompt} and {context}). Subclasses typically override <code>__init__()</code> to set their
specific prompt template and scoring scale (e.g., see <code>metrics.generic.relevance</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_or_id</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HuggingFace model ID or loaded model instance to use as the judge.
If string, the model will be loaded automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompt_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template string for evaluation prompts. Should contain placeholders for {response},
{lower_bound}, {upper_bound}, and optionally {prompt}, {context}.
The formatted prompt will be passed to the judge model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for the judge model. If None, will be loaded from the model ID.
Required if passing a PreTrainedModel instance.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Device for model inference ('cuda', 'mps', 'cpu').
Defaults to GPU if available, otherwise CPU.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score range as (min, max) tuple. Scores outside this range will be clamped.
Defaults to (1, 5).</p>
              </div>
            </td>
            <td>
                  <code>(1, 5)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of prompts to process simultaneously. Defaults to 8.</p>
              </div>
            </td>
            <td>
                  <code>8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_retries</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum retry attempts when score parsing fails. Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generation parameters passed to the model.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LLMJudgeMetric</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for LLM-as-a-judge evaluation metrics.</span>

<span class="sd">    Leverages a language model to evaluate the quality of generated text responses according to customized (natural</span>
<span class="sd">    language) criteria. The judge model evaluates each response (optionally with respect to an associated prompt and</span>
<span class="sd">    context) and returns numerical scores within a specified range. When multiple samples are generated per prompt (via</span>
<span class="sd">    num_return_sequences), scores are averaged to improve reliability.</span>

<span class="sd">    Subclasses should define their specific evaluation criteria by providing a `prompt_template` that instructs the</span>
<span class="sd">    judge model how to score responses. The template should use placeholders {response}, {lower_bound}, and</span>
<span class="sd">    {upper_bound} (and optionally {prompt} and {context}). Subclasses typically override `__init__()` to set their</span>
<span class="sd">    specific prompt template and scoring scale (e.g., see `metrics.generic.relevance`).</span>

<span class="sd">    Args:</span>
<span class="sd">        model_or_id (str | PreTrainedModel): HuggingFace model ID or loaded model instance to use as the judge.</span>
<span class="sd">            If string, the model will be loaded automatically.</span>
<span class="sd">        prompt_template (str): Template string for evaluation prompts. Should contain placeholders for {response},</span>
<span class="sd">            {lower_bound}, {upper_bound}, and optionally {prompt}, {context}.</span>
<span class="sd">            The formatted prompt will be passed to the judge model.</span>
<span class="sd">        tokenizer (Any | None): Tokenizer for the judge model. If None, will be loaded from the model ID.</span>
<span class="sd">            Required if passing a PreTrainedModel instance.</span>
<span class="sd">        device (str | None): Device for model inference (&#39;cuda&#39;, &#39;mps&#39;, &#39;cpu&#39;).</span>
<span class="sd">            Defaults to GPU if available, otherwise CPU.</span>
<span class="sd">        scale (tuple[float, float]): Score range as (min, max) tuple. Scores outside this range will be clamped.</span>
<span class="sd">            Defaults to (1, 5).</span>
<span class="sd">        batch_size (int): Number of prompts to process simultaneously. Defaults to 8.</span>
<span class="sd">        max_retries (int): Maximum retry attempts when score parsing fails. Defaults to 5.</span>
<span class="sd">        gen_kwargs (dict[str, Any] | None): Generation parameters passed to the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">PreTrainedModel</span><span class="p">,</span>
        <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_or_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_name_or_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;apply_chat_template&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
            <span class="k">else</span> <span class="s2">&quot;mps&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
            <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;max_new_tokens&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="n">gen_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;pad_token_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;num_return_sequences&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generation_config</span> <span class="o">=</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="o">**</span><span class="n">gen_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span> <span class="o">=</span> <span class="n">build_structured_parser</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap prompt with appropriate formatting for the model.</span>

<span class="sd">        Applies the chat template (if the model supports it) with the prompt as a user message.</span>
<span class="sd">        Otherwise, returns the prompt unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The user prompt.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The formatted prompt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_chat</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">prompt</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_batch_chunks</span><span class="p">(</span><span class="n">seq</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split a sequence into chunks of specified size.</span>

<span class="sd">        Args:</span>
<span class="sd">            seq (Sequence[Any]): The sequence to split into chunks.</span>
<span class="sd">            chunk_size (int): Maximum size of each chunk.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Sequence[Any]: Chunks of the input sequence, each with at most chunk_size elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_score_with_retries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate replies until parsing succeeds or maximum retries reached.</span>

<span class="sd">        Attempts to generate a response and parse it (using `parse_fn`) as a score.</span>
<span class="sd">        If parsing fails, retries up to `max_retries` times.</span>
<span class="sd">        If all attempts fail, raises a warning and returns `float(&#39;nan&#39;)`.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The formatted prompt to send to the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The parsed score from the model&#39;s response, or `float(&#39;nan&#39;)` if parsing fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">reply_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
                <span class="n">prompt</span><span class="p">,</span>
                <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to parse score after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                        <span class="s2">&quot;Returning float(&#39;nan&#39;) instead.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">        Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">        samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">        Args:</span>
<span class="sd">            responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">            prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">                If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">                referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">            **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Score statistics containing:</span>

<span class="sd">                - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">                - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">                - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

        <span class="c1"># build prompts</span>
        <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
            <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
            <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

        <span class="c1"># generate</span>
        <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span>
                <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
                <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
                <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

                <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                    <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

                <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

        <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
        <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
            <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
            <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.base_prompt_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.format_instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.max_retries" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.num_return_sequences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">num_return_sequences</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_return_sequences&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">tokenizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.scale" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.use_chat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;apply_chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Compute LLM judge scores for a list of responses.</p>
<p>Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple
samples are generated per response (via <code>num_return_sequences</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of text responses to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of prompts corresponding to each response.
If provided, must be the same length as responses. These prompts can be
referenced in the prompt_template using the {prompt} placeholder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score statistics containing:</p>
<ul>
<li>"mean_score": Overall average score across all responses</li>
<li>"scores": List of mean scores for each response (averaged across samples)</li>
<li>"raw_scores": List of lists containing all individual scores for each response</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prompts is provided but has different length than responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">    Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">    samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">        prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">            If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">            referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">        **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Score statistics containing:</span>

<span class="sd">            - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">            - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">            - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

    <span class="c1"># build prompts</span>
    <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
        <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

    <span class="c1"># generate</span>
    <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
            <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

            <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
    <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
        <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.metrics.base_judge.build_structured_parser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">build_structured_parser</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Build a StructuredOutputParser and parsing function for rating predictions.</p>
<p>Constructs a <code>StructuredOutputParser</code> configured with a single <code>ResponseSchema</code> that expects a float score within
the specified scale range. It also returns a parsing function that extracts and validates the score from text,
ensuring the result is clamped between the provided bounds.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>scale</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A <code>(low, high)</code> tuple specifying the valid inclusive range for the score.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_structured_parser</span><span class="p">(</span><span class="n">scale</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a StructuredOutputParser and parsing function for rating predictions.</span>

<span class="sd">    Constructs a `StructuredOutputParser` configured with a single `ResponseSchema` that expects a float score within</span>
<span class="sd">    the specified scale range. It also returns a parsing function that extracts and validates the score from text,</span>
<span class="sd">    ensuring the result is clamped between the provided bounds.</span>

<span class="sd">    Args:</span>
<span class="sd">        scale (tuple[float, float]): A `(low, high)` tuple specifying the valid inclusive range for the score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">scale</span>
    <span class="n">score_schema</span> <span class="o">=</span> <span class="n">ResponseSchema</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;A single float between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2"> (inclusive) that rates the prediction.&quot;</span>
    <span class="p">)</span>
    <span class="n">output_parser</span> <span class="o">=</span> <span class="n">StructuredOutputParser</span><span class="o">.</span><span class="n">from_response_schemas</span><span class="p">([</span><span class="n">score_schema</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_fn</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse and validate a score from text using the structured output parser.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple with elements:</span>

<span class="sd">                - StructuredOutputParser: The parser configured with the score schema.</span>
<span class="sd">                - Callable[[str, tuple[float, float]], float]: A function that takes a raw text response and the</span>
<span class="sd">                  `(low, high)` scale, extracts the score, converts it to a float, and clamps it within the valid range.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the score cannot be parsed from the text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">output_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">OutputParserException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse score: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">output_parser</span><span class="p">,</span> <span class="n">parse_fn</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.metrics.custom" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>custom</code>


</h5>

    <div class="doc doc-contents ">

        <p>Custom metrics for specific evaluation use cases.</p>
<p>This module contains metrics tailored to particular use cases, organized by subdirectory. Unlike generic metrics that
work across any use case, custom metrics are designed with specific evaluation contexts in mind (e.g., question
answering, instruction following, etc.).</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>commonsense_mcqa</code>


</h6>

    <div class="doc doc-contents ">

        <p>Evaluation metrics for the <code>CommonsenseMCQA</code> use case.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h7 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_accuracy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>mcqa_accuracy</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_accuracy.MCQAAccuracy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>MCQAAccuracy</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Exact-match accuracy for multiple-choice QA.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/commonsense_mcqa/mcqa_accuracy.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MCQAAccuracy</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exact-match accuracy for multiple-choice QA.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reference_answers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">question_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes trial-level and question-level accuracy metrics.</span>

<span class="sd">        Args:</span>
<span class="sd">            responses: List of predicted answer choices (e.g., &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;).</span>
<span class="sd">            prompts: List of question prompts (unused, for interface compatibility).</span>
<span class="sd">            reference_answers: List of correct answer choices.</span>
<span class="sd">            question_ids: Optional question IDs for grouping responses by question.</span>
<span class="sd">            **kwargs: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of accuracy score statistics with values:</span>

<span class="sd">                - &quot;trial_mean&quot;: micro (attempt-level accuracy)</span>
<span class="sd">                - &quot;trial_std&quot;: sample std-dev over trials</span>
<span class="sd">                - &quot;question_mean&quot;: macro (majority-vote accuracy)</span>
<span class="sd">                - &quot;question_std&quot;: sample std-dev over questions</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If reference_answers is None or length mismatches occur.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">reference_answers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MCQAAccuracy needs `reference_answers`.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_answers</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`responses` and `reference_answers` must be the same length.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">question_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">question_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`question_ids` must match length of `responses`.&quot;</span><span class="p">)</span>

        <span class="c1"># micro</span>
        <span class="n">attempt_correct</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">choice</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">answer</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">choice</span><span class="p">,</span> <span class="n">answer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">reference_answers</span><span class="p">)</span> <span class="k">if</span> <span class="n">choice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>
        <span class="n">attempt_accuracy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">attempt_correct</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">attempt_correct</span><span class="p">)</span> <span class="k">if</span> <span class="n">attempt_correct</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">attempt_accuracy_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_std</span><span class="p">(</span><span class="n">attempt_correct</span><span class="p">,</span> <span class="n">attempt_accuracy</span><span class="p">)</span>

        <span class="c1"># macro</span>
        <span class="k">if</span> <span class="n">question_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">question_accuracy</span> <span class="o">=</span> <span class="n">attempt_accuracy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">votes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">is_correct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">question_ids</span><span class="p">,</span> <span class="n">attempt_correct</span><span class="p">):</span>
                <span class="n">votes</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_correct</span><span class="p">)</span>

            <span class="n">majority_outcomes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">vote</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">vote</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">vote</span> <span class="ow">in</span> <span class="n">votes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">question_accuracy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">majority_outcomes</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">votes</span><span class="p">)</span> <span class="k">if</span> <span class="n">votes</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="n">question_accuracy_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_std</span><span class="p">(</span><span class="n">majority_outcomes</span><span class="p">,</span> <span class="n">question_accuracy</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;trial_mean&quot;</span><span class="p">:</span> <span class="n">attempt_accuracy</span><span class="p">,</span>
            <span class="s2">&quot;trial_std&quot;</span><span class="p">:</span> <span class="n">attempt_accuracy_std</span><span class="p">,</span>
            <span class="s2">&quot;question_mean&quot;</span><span class="p">:</span> <span class="n">question_accuracy</span><span class="p">,</span>
            <span class="s2">&quot;question_std&quot;</span><span class="p">:</span> <span class="n">question_accuracy_std</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_sample_std</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes sample standard deviation for binary outcomes.</span>

<span class="sd">        Args:</span>
<span class="sd">            binary: List of binary values (0 or 1).</span>
<span class="sd">            mean: Pre-computed mean of the binary values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Sample standard deviation using Bessel&#39;s correction (n-1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">var</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">binary</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_accuracy.MCQAAccuracy.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_accuracy.MCQAAccuracy.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_accuracy.MCQAAccuracy.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_answers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">question_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Computes trial-level and question-level accuracy metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of predicted answer choices (e.g., 'A', 'B', 'C', 'D').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of question prompts (unused, for interface compatibility).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_answers</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of correct answer choices.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>question_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional question IDs for grouping responses by question.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of accuracy score statistics with values:</p>
<ul>
<li>"trial_mean": micro (attempt-level accuracy)</li>
<li>"trial_std": sample std-dev over trials</li>
<li>"question_mean": macro (majority-vote accuracy)</li>
<li>"question_std": sample std-dev over questions</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If reference_answers is None or length mismatches occur.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/commonsense_mcqa/mcqa_accuracy.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reference_answers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">question_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes trial-level and question-level accuracy metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        responses: List of predicted answer choices (e.g., &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;).</span>
<span class="sd">        prompts: List of question prompts (unused, for interface compatibility).</span>
<span class="sd">        reference_answers: List of correct answer choices.</span>
<span class="sd">        question_ids: Optional question IDs for grouping responses by question.</span>
<span class="sd">        **kwargs: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of accuracy score statistics with values:</span>

<span class="sd">            - &quot;trial_mean&quot;: micro (attempt-level accuracy)</span>
<span class="sd">            - &quot;trial_std&quot;: sample std-dev over trials</span>
<span class="sd">            - &quot;question_mean&quot;: macro (majority-vote accuracy)</span>
<span class="sd">            - &quot;question_std&quot;: sample std-dev over questions</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If reference_answers is None or length mismatches occur.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">reference_answers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MCQAAccuracy needs `reference_answers`.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reference_answers</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`responses` and `reference_answers` must be the same length.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">question_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">question_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`question_ids` must match length of `responses`.&quot;</span><span class="p">)</span>

    <span class="c1"># micro</span>
    <span class="n">attempt_correct</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">choice</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">answer</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">choice</span><span class="p">,</span> <span class="n">answer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">reference_answers</span><span class="p">)</span> <span class="k">if</span> <span class="n">choice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">]</span>
    <span class="n">attempt_accuracy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">attempt_correct</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">attempt_correct</span><span class="p">)</span> <span class="k">if</span> <span class="n">attempt_correct</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="n">attempt_accuracy_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_std</span><span class="p">(</span><span class="n">attempt_correct</span><span class="p">,</span> <span class="n">attempt_accuracy</span><span class="p">)</span>

    <span class="c1"># macro</span>
    <span class="k">if</span> <span class="n">question_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">question_accuracy</span> <span class="o">=</span> <span class="n">attempt_accuracy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">votes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">qid</span><span class="p">,</span> <span class="n">is_correct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">question_ids</span><span class="p">,</span> <span class="n">attempt_correct</span><span class="p">):</span>
            <span class="n">votes</span><span class="p">[</span><span class="n">qid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_correct</span><span class="p">)</span>

        <span class="n">majority_outcomes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">vote</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">vote</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">vote</span> <span class="ow">in</span> <span class="n">votes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">question_accuracy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">majority_outcomes</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">votes</span><span class="p">)</span> <span class="k">if</span> <span class="n">votes</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">question_accuracy_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_std</span><span class="p">(</span><span class="n">majority_outcomes</span><span class="p">,</span> <span class="n">question_accuracy</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;trial_mean&quot;</span><span class="p">:</span> <span class="n">attempt_accuracy</span><span class="p">,</span>
        <span class="s2">&quot;trial_std&quot;</span><span class="p">:</span> <span class="n">attempt_accuracy_std</span><span class="p">,</span>
        <span class="s2">&quot;question_mean&quot;</span><span class="p">:</span> <span class="n">question_accuracy</span><span class="p">,</span>
        <span class="s2">&quot;question_std&quot;</span><span class="p">:</span> <span class="n">question_accuracy_std</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_calibration" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>mcqa_calibration</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_calibration.MCQACalibration" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>MCQACalibration</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Calibration metrics for multiple-choice QA.</p>
<p>Measures how well model confidence scores align with actual performance using Expected Calibration Error (ECE)
and related metrics.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/commonsense_mcqa/mcqa_calibration.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MCQACalibration</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calibration metrics for multiple-choice QA.</span>

<span class="sd">    Measures how well model confidence scores align with actual performance using Expected Calibration Error (ECE)</span>
<span class="sd">    and related metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">reference_answers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">confidence_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">question_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes calibration metrics for model predictions.</span>

<span class="sd">        Args:</span>
<span class="sd">            responses: List of predicted answer choices (e.g., &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;).</span>
<span class="sd">            reference_answers: List of correct answer choices.</span>
<span class="sd">            confidence_scores: List of model confidence scores (0.0 to 1.0).</span>
<span class="sd">            question_ids: Optional question IDs (unused, for interface compatibility).</span>
<span class="sd">            **kwargs: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of calibration metrics with values:</span>

<span class="sd">                - &quot;ece&quot;: Expected Calibration Error (lower is better, 0.0 is perfect)</span>
<span class="sd">                - &quot;avg_confidence&quot;: Model&#39;s average confidence across all predictions</span>
<span class="sd">                - &quot;overconfidence&quot;: avg_confidence - accuracy (positive means overconfident)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If reference_answers or confidence_scores is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">reference_answers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MCQACalibration needs `reference_answers`.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">confidence_scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MCQACalibration needs `confidence_scores`.&quot;</span><span class="p">)</span>

        <span class="c1"># calculate ece</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">resp</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">reference_answers</span><span class="p">,</span> <span class="n">confidence_scores</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>
        <span class="n">responses</span><span class="p">,</span> <span class="n">answers</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">valid_data</span><span class="p">)</span>
        <span class="n">confidences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">confidences</span><span class="p">)</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">response</span> <span class="o">==</span> <span class="n">answer</span> <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">answer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">answers</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">avg_confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">confidences</span><span class="p">))</span>
        <span class="n">avg_accuracy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">accuracies</span><span class="p">))</span>
        <span class="n">ece</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_ece</span><span class="p">(</span><span class="n">confidences</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;ece&quot;</span><span class="p">:</span> <span class="n">ece</span><span class="p">,</span>
            <span class="s2">&quot;avg_confidence&quot;</span><span class="p">:</span> <span class="n">avg_confidence</span><span class="p">,</span>
            <span class="s2">&quot;overconfidence&quot;</span><span class="p">:</span> <span class="n">avg_confidence</span> <span class="o">-</span> <span class="n">avg_accuracy</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_ece</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidences</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates Expected Calibration Error using binned confidence scores.</span>

<span class="sd">        ECE measures the difference between confidence and accuracy across confidence bins. For each bin, it computes</span>
<span class="sd">        the absolute difference between average confidence and average accuracy, weighted by the proportion of samples</span>
<span class="sd">        in that bin.</span>

<span class="sd">        Args:</span>
<span class="sd">            confidences: Array of confidence scores (0.0 to 1.0).</span>
<span class="sd">            accuracies: Array of binary accuracy values (0.0 or 1.0).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Expected Calibration Error as a float between 0.0 and 1.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bin_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ece</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">in_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">confidences</span> <span class="o">&gt;=</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">confidences</span> <span class="o">&lt;=</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">in_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">confidences</span> <span class="o">&gt;=</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">confidences</span> <span class="o">&lt;</span> <span class="n">bin_boundaries</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">prop_in_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">in_bin</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prop_in_bin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bin_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">accuracies</span><span class="p">[</span><span class="n">in_bin</span><span class="p">])</span>
                <span class="n">bin_confidence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">confidences</span><span class="p">[</span><span class="n">in_bin</span><span class="p">])</span>
                <span class="n">ece</span> <span class="o">+=</span> <span class="n">prop_in_bin</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bin_confidence</span> <span class="o">-</span> <span class="n">bin_accuracy</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">ece</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_calibration.MCQACalibration.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_calibration.MCQACalibration.n_bins" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_calibration.MCQACalibration.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_calibration.MCQACalibration.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">reference_answers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence_scores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">question_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Computes calibration metrics for model predictions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of predicted answer choices (e.g., 'A', 'B', 'C', 'D').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>reference_answers</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of correct answer choices.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>confidence_scores</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of model confidence scores (0.0 to 1.0).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>question_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional question IDs (unused, for interface compatibility).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of calibration metrics with values:</p>
<ul>
<li>"ece": Expected Calibration Error (lower is better, 0.0 is perfect)</li>
<li>"avg_confidence": Model's average confidence across all predictions</li>
<li>"overconfidence": avg_confidence - accuracy (positive means overconfident)</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If reference_answers or confidence_scores is None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/commonsense_mcqa/mcqa_calibration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">reference_answers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">confidence_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">question_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes calibration metrics for model predictions.</span>

<span class="sd">    Args:</span>
<span class="sd">        responses: List of predicted answer choices (e.g., &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;).</span>
<span class="sd">        reference_answers: List of correct answer choices.</span>
<span class="sd">        confidence_scores: List of model confidence scores (0.0 to 1.0).</span>
<span class="sd">        question_ids: Optional question IDs (unused, for interface compatibility).</span>
<span class="sd">        **kwargs: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of calibration metrics with values:</span>

<span class="sd">            - &quot;ece&quot;: Expected Calibration Error (lower is better, 0.0 is perfect)</span>
<span class="sd">            - &quot;avg_confidence&quot;: Model&#39;s average confidence across all predictions</span>
<span class="sd">            - &quot;overconfidence&quot;: avg_confidence - accuracy (positive means overconfident)</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If reference_answers or confidence_scores is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">reference_answers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MCQACalibration needs `reference_answers`.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">confidence_scores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MCQACalibration needs `confidence_scores`.&quot;</span><span class="p">)</span>

    <span class="c1"># calculate ece</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">resp</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">reference_answers</span><span class="p">,</span> <span class="n">confidence_scores</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">]</span>
    <span class="n">responses</span><span class="p">,</span> <span class="n">answers</span><span class="p">,</span> <span class="n">confidences</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">valid_data</span><span class="p">)</span>
    <span class="n">confidences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">confidences</span><span class="p">)</span>
    <span class="n">accuracies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">response</span> <span class="o">==</span> <span class="n">answer</span> <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">answer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">answers</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">avg_confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">confidences</span><span class="p">))</span>
    <span class="n">avg_accuracy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">accuracies</span><span class="p">))</span>
    <span class="n">ece</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_ece</span><span class="p">(</span><span class="n">confidences</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;ece&quot;</span><span class="p">:</span> <span class="n">ece</span><span class="p">,</span>
        <span class="s2">&quot;avg_confidence&quot;</span><span class="p">:</span> <span class="n">avg_confidence</span><span class="p">,</span>
        <span class="s2">&quot;overconfidence&quot;</span><span class="p">:</span> <span class="n">avg_confidence</span> <span class="o">-</span> <span class="n">avg_accuracy</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_positional_bias" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>mcqa_positional_bias</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_positional_bias.MCQAPositionalBias" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>MCQAPositionalBias</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Positional bias metrics for multiple-choice QA.</p>
<p>Measures whether the model exhibits bias toward selecting certain answer positions.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/commonsense_mcqa/mcqa_positional_bias.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MCQAPositionalBias</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Positional bias metrics for multiple-choice QA.</span>

<span class="sd">    Measures whether the model exhibits bias toward selecting certain answer positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">question_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes positional bias metrics for model predictions.</span>

<span class="sd">        Calculates how much the model&#39;s choice frequencies deviate from uniform distribution across answer positions.</span>
<span class="sd">        For K answer choices, each position should ideally be selected 1/K of the time.</span>

<span class="sd">        Args:</span>
<span class="sd">            responses: List of predicted answer choices (e.g., &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;).</span>
<span class="sd">            prompts: List of question prompts (unused, for interface compatibility).</span>
<span class="sd">            question_ids: Optional question IDs for computing per-question bias variance.</span>
<span class="sd">            **kwargs: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of positional bias metrics with values:</span>

<span class="sd">                - &quot;mean&quot;: Overall positional bias (mean |f_i - 1/K| across positions)</span>
<span class="sd">                - &quot;std&quot;: Sample standard deviation of bias computed per question</span>

<span class="sd">        Note:</span>

<span class="sd">        - If question_ids is None, per-question analysis is skipped and std will be 0.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">valid_responses</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="n">position_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">valid_responses</span><span class="p">)</span>
        <span class="n">total_responses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_responses</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">position_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">position_frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">position_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_responses</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>
        <span class="n">expected_frequency</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

        <span class="c1"># positional bias per question</span>
        <span class="n">bias_per_question</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">responses_by_question</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">question_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">question_ids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">responses_by_question</span><span class="p">[</span><span class="n">question_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">question_id</span><span class="p">,</span> <span class="n">question_responses</span> <span class="ow">in</span> <span class="n">responses_by_question</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">question_responses</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">counts_for_question</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">question_responses</span><span class="p">)</span>
            <span class="n">total_for_question</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">question_responses</span><span class="p">)</span>
            <span class="n">frequencies_for_question</span> <span class="o">=</span> <span class="p">[</span><span class="n">counts_for_question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_for_question</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>
            <span class="n">bias_for_question</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">expected_frequency</span><span class="p">)</span> <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">frequencies_for_question</span><span class="p">])</span>
            <span class="n">bias_per_question</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias_for_question</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">expected_frequency</span><span class="p">)</span> <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">position_frequencies</span><span class="p">]),</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bias_per_question</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bias_per_question</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_positional_bias.MCQAPositionalBias.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_positional_bias.MCQAPositionalBias.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.commonsense_mcqa.mcqa_positional_bias.MCQAPositionalBias.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">question_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Computes positional bias metrics for model predictions.</p>
<p>Calculates how much the model's choice frequencies deviate from uniform distribution across answer positions.
For K answer choices, each position should ideally be selected 1/K of the time.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of predicted answer choices (e.g., 'A', 'B', 'C', 'D').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of question prompts (unused, for interface compatibility).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>question_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional question IDs for computing per-question bias variance.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of positional bias metrics with values:</p>
<ul>
<li>"mean": Overall positional bias (mean |f_i - 1/K| across positions)</li>
<li>"std": Sample standard deviation of bias computed per question</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>If question_ids is None, per-question analysis is skipped and std will be 0.0.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/commonsense_mcqa/mcqa_positional_bias.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">question_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes positional bias metrics for model predictions.</span>

<span class="sd">    Calculates how much the model&#39;s choice frequencies deviate from uniform distribution across answer positions.</span>
<span class="sd">    For K answer choices, each position should ideally be selected 1/K of the time.</span>

<span class="sd">    Args:</span>
<span class="sd">        responses: List of predicted answer choices (e.g., &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;).</span>
<span class="sd">        prompts: List of question prompts (unused, for interface compatibility).</span>
<span class="sd">        question_ids: Optional question IDs for computing per-question bias variance.</span>
<span class="sd">        **kwargs: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of positional bias metrics with values:</span>

<span class="sd">            - &quot;mean&quot;: Overall positional bias (mean |f_i - 1/K| across positions)</span>
<span class="sd">            - &quot;std&quot;: Sample standard deviation of bias computed per question</span>

<span class="sd">    Note:</span>

<span class="sd">    - If question_ids is None, per-question analysis is skipped and std will be 0.0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">valid_responses</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">responses</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">position_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">valid_responses</span><span class="p">)</span>
    <span class="n">total_responses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_responses</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">position_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">position_frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">position_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_responses</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>
    <span class="n">expected_frequency</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

    <span class="c1"># positional bias per question</span>
    <span class="n">bias_per_question</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">responses_by_question</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">question_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">question_ids</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">responses_by_question</span><span class="p">[</span><span class="n">question_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">question_id</span><span class="p">,</span> <span class="n">question_responses</span> <span class="ow">in</span> <span class="n">responses_by_question</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">question_responses</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">counts_for_question</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">question_responses</span><span class="p">)</span>
        <span class="n">total_for_question</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">question_responses</span><span class="p">)</span>
        <span class="n">frequencies_for_question</span> <span class="o">=</span> <span class="p">[</span><span class="n">counts_for_question</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_for_question</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>
        <span class="n">bias_for_question</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">expected_frequency</span><span class="p">)</span> <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">frequencies_for_question</span><span class="p">])</span>
        <span class="n">bias_per_question</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias_for_question</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">freq</span> <span class="o">-</span> <span class="n">expected_frequency</span><span class="p">)</span> <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">position_frequencies</span><span class="p">]),</span>
        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">bias_per_question</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bias_per_question</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.evaluation.metrics.custom.instruction_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>instruction_following</code>


</h6>

    <div class="doc doc-contents ">

        <p>Evaluation metrics for the <code>InstructionFollowing</code> use case.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h7 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>helpers</code>


</h7>

    <div class="doc doc-contents ">

        <p>We have omitted the documentation details on the IFEval functions (located in <code>helpers/</code>) from our API reference. For details please see the
IFEval repo: <a href="https://github.com/google-research/google-research/tree/master/instruction_following_eval">https://github.com/google-research/google-research/tree/master/instruction_following_eval</a>.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h8 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>evaluation_main</code>


</h8>

    <div class="doc doc-contents ">

        <p>Binary of evaluating instruction following. See README.md.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.InputExample" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>InputExample</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">









              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">InputExample</span><span class="p">:</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">instruction_id_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">kwargs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.InputExample.instruction_id_list" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">instruction_id_list</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.InputExample.key" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">key</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.InputExample.kwargs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">kwargs</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.InputExample.prompt" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">prompt</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.OutputExample" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>OutputExample</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">









              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OutputExample</span><span class="p">:</span>
    <span class="n">instruction_id_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">follow_all_instructions</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">follow_instruction_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.OutputExample.follow_all_instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">follow_all_instructions</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.OutputExample.follow_instruction_list" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">follow_instruction_list</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.OutputExample.instruction_id_list" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">instruction_id_list</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.OutputExample.prompt" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">prompt</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.OutputExample.response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">response</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>






  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">main</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">app</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;Too many command-line arguments.&quot;</span><span class="p">)</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">read_prompt_list</span><span class="p">(</span><span class="n">_INPUT_DATA</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">prompt_to_response</span> <span class="o">=</span> <span class="n">read_prompt_to_response_dict</span><span class="p">(</span><span class="n">_INPUT_RESPONSE_DATA</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># get instruction following results</span>
    <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">output_file_name</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">test_instruction_following_strict</span><span class="p">,</span> <span class="s2">&quot;eval_results_strict&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">test_instruction_following_loose</span><span class="p">,</span> <span class="s2">&quot;eval_results_loose&quot;</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">prompt_to_response</span><span class="p">))</span>
        <span class="n">follow_all_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">follow_all_instructions</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">follow_all_instructions</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Accuracy: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">)</span>

        <span class="n">output_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_OUTPUT_DIR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_file_name</span> <span class="o">+</span> <span class="s2">&quot;.jsonl&quot;</span><span class="p">)</span>
        <span class="n">write_outputs</span><span class="p">(</span><span class="n">output_file_name</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generated: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">)</span>

        <span class="c1"># Prints instruction following accuracy report.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file_name</span><span class="si">}</span><span class="s2"> Accuracy Scores:&quot;</span><span class="p">)</span>
        <span class="n">print_report</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.print_report" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">print_report</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Prints a report on accuracy scores.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_report</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prints a report on accuracy scores.&quot;&quot;&quot;</span>

    <span class="n">prompt_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prompt_correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">instruction_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">instruction_correct</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">tier0_total</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">tier0_correct</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">tier1_total</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">tier1_correct</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">follow_instruction_list</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">follow_instruction_list</span>
        <span class="n">instruction_id_list</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">instruction_id_list</span>

        <span class="n">prompt_total</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">follow_instruction_list</span><span class="p">):</span>
            <span class="n">prompt_correct</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">instruction_total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instruction_id_list</span><span class="p">)</span>
        <span class="n">instruction_correct</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">follow_instruction_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">instruction_id</span><span class="p">,</span> <span class="n">followed_or_not</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">instruction_id_list</span><span class="p">,</span> <span class="n">follow_instruction_list</span>
        <span class="p">):</span>
            <span class="n">instruction_id</span> <span class="o">=</span> <span class="n">instruction_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tier0_total</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">followed_or_not</span><span class="p">:</span>
                <span class="n">tier0_correct</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">instruction_id</span><span class="p">,</span> <span class="n">followed_or_not</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">instruction_id_list</span><span class="p">,</span> <span class="n">follow_instruction_list</span>
        <span class="p">):</span>
            <span class="n">tier1_total</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">followed_or_not</span><span class="p">:</span>
                <span class="n">tier1_correct</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># print(f&quot;prompt-level: {prompt_correct / prompt_total}&quot;)</span>
    <span class="c1"># print(f&quot;instruction-level: {instruction_correct / instruction_total}&quot;)</span>
    <span class="c1"># print()</span>
    <span class="k">for</span> <span class="n">instruction_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tier0_total</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">tier0_correct</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span> <span class="o">/</span> <span class="n">tier0_total</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span>
    <span class="c1">#   print(f&quot;{instruction_id} {accuracy}&quot;)</span>
    <span class="c1"># print()</span>
    <span class="k">for</span> <span class="n">instruction_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tier1_total</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">tier1_correct</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span> <span class="o">/</span> <span class="n">tier1_total</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span>
        <span class="c1"># print(f&quot;{instruction_id} {accuracy}&quot;)</span>

    <span class="k">return</span> <span class="n">prompt_correct</span> <span class="o">/</span> <span class="n">prompt_total</span><span class="p">,</span> <span class="n">instruction_correct</span> <span class="o">/</span> <span class="n">instruction_total</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.read_prompt_list" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">read_prompt_list</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Read inputs from jsonl.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_prompt_list</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read inputs from jsonl.&quot;&quot;&quot;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">example</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">InputExample</span><span class="p">(</span>
                        <span class="n">key</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span>
                        <span class="n">instruction_id_list</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">],</span>
                        <span class="n">prompt</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
                        <span class="n">kwargs</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">input_jsonl</span><span class="p">:</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">InputExample</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">],</span>
                    <span class="n">instruction_id_list</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">],</span>
                    <span class="n">prompt</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">inputs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.read_prompt_to_response_dict" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">read_prompt_to_response_dict</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Creates dictionary matching prompt and response.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_prompt_to_response_dict</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates dictionary matching prompt and response.&quot;&quot;&quot;</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_jsonl</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">example</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">return_dict</span><span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">input_jsonl</span><span class="p">:</span>
            <span class="c1"># print(&quot;here&quot;)</span>
            <span class="c1"># print(example)</span>
            <span class="n">return_dict</span><span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">return_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.test_instruction_following_loose" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">test_instruction_following_loose</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">prompt_to_response</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Tests response for an upper bound for following instructions.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_instruction_following_loose</span><span class="p">(</span>
    <span class="n">inp</span><span class="p">,</span>
    <span class="n">prompt_to_response</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests response for an upper bound for following instructions.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">prompt_to_response</span><span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">prompt</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">response_remove_first</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">response_remove_last</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">response_remove_both</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">revised_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">revised_response_remove_first</span> <span class="o">=</span> <span class="n">response_remove_first</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">revised_response_remove_last</span> <span class="o">=</span> <span class="n">response_remove_last</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">revised_response_remove_both</span> <span class="o">=</span> <span class="n">response_remove_both</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">all_responses</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">response</span><span class="p">,</span>
        <span class="n">revised_response</span><span class="p">,</span>
        <span class="n">response_remove_first</span><span class="p">,</span>
        <span class="n">response_remove_last</span><span class="p">,</span>
        <span class="n">response_remove_both</span><span class="p">,</span>
        <span class="n">revised_response_remove_first</span><span class="p">,</span>
        <span class="n">revised_response_remove_last</span><span class="p">,</span>
        <span class="n">revised_response_remove_both</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">instruction_list</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">instruction_id_list</span>
    <span class="n">is_following_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">instruction_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">instruction_list</span><span class="p">):</span>
        <span class="n">instruction_cls</span> <span class="o">=</span> <span class="n">instructions_registry</span><span class="o">.</span><span class="n">INSTRUCTION_DICT</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span>
        <span class="n">instruction</span> <span class="o">=</span> <span class="n">instruction_cls</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

        <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="o">**</span><span class="n">inp</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">get_instruction_args</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span>

        <span class="n">is_following</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">all_responses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">is_following</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="n">is_following_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_following</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">OutputExample</span><span class="p">(</span>
        <span class="n">instruction_id_list</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">instruction_id_list</span><span class="p">,</span>
        <span class="n">prompt</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
        <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="n">follow_all_instructions</span><span class="o">=</span><span class="nb">all</span><span class="p">(</span><span class="n">is_following_list</span><span class="p">),</span>
        <span class="n">follow_instruction_list</span><span class="o">=</span><span class="n">is_following_list</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.test_instruction_following_strict" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">test_instruction_following_strict</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">prompt_to_response</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Tests response to see if instrutions are followed.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_instruction_following_strict</span><span class="p">(</span>
    <span class="n">inp</span><span class="p">,</span>
    <span class="n">prompt_to_response</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests response to see if instrutions are followed.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">prompt_to_response</span><span class="p">[</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]]</span>
    <span class="n">instruction_list</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">]</span>
    <span class="n">is_following_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">instruction_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">instruction_list</span><span class="p">):</span>
        <span class="n">instruction_cls</span> <span class="o">=</span> <span class="n">instructions_registry</span><span class="o">.</span><span class="n">INSTRUCTION_DICT</span><span class="p">[</span><span class="n">instruction_id</span><span class="p">]</span>
        <span class="n">instruction</span> <span class="o">=</span> <span class="n">instruction_cls</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

        <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="o">**</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">get_instruction_args</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="n">is_following_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_following_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">OutputExample</span><span class="p">(</span>
        <span class="n">instruction_id_list</span><span class="o">=</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">],</span>
        <span class="n">prompt</span><span class="o">=</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
        <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="n">follow_all_instructions</span><span class="o">=</span><span class="nb">all</span><span class="p">(</span><span class="n">is_following_list</span><span class="p">),</span>
        <span class="n">follow_instruction_list</span><span class="o">=</span><span class="n">is_following_list</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.evaluation_main.write_outputs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">write_outputs</span><span class="p">(</span><span class="n">output_jsonl_filename</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Writes outputs to jsonl.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/evaluation_main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_outputs</span><span class="p">(</span><span class="n">output_jsonl_filename</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes outputs to jsonl.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">outputs</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_jsonl_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="n">attr_name</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>instructions</code>


</h8>

    <div class="doc doc-contents ">

        <p>Library of instructions.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.BulletListChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>BulletListChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the bullet list in the prompt.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BulletListChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the bullet list in the prompt.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_bullets</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_bullets: An integer specifying the exact number of bullet lists</span>
<span class="sd">        that is required to appear in the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="o">=</span> <span class="n">num_bullets</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_BULLETS</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Your answer must contain exactly </span><span class="si">{num_bullets}</span><span class="s2"> bullet points. &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;Use the markdown bullet points such as:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;* This is point 1. </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;* This is point 2&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">num_bullets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_bullets&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_bullets&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Check if the number of bullet lists meets the requirement.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response. The response is expected to</span>
<span class="sd">        contain some bullet lists that start with `\*`.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the actual number of bullet lists in the response meets the</span>
<span class="sd">      requirement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bullet_lists</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*\*[^\*].*$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="n">bullet_lists_2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*-.*$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="n">num_bullet_lists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bullet_lists</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">bullet_lists_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_bullet_lists</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.BulletListChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.BulletListChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">num_bullets</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_bullets</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the exact number of bullet lists
that is required to appear in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_bullets</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    num_bullets: An integer specifying the exact number of bullet lists</span>
<span class="sd">      that is required to appear in the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="o">=</span> <span class="n">num_bullets</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_BULLETS</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Your answer must contain exactly </span><span class="si">{num_bullets}</span><span class="s2"> bullet points. &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Use the markdown bullet points such as:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;* This is point 1. </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;* This is point 2&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">num_bullets</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.BulletListChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check if the number of bullet lists meets the requirement.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response. The response is expected to
contain some bullet lists that start with <code>\*</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the actual number of bullet lists in the response meets the</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>requirement.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Check if the number of bullet lists meets the requirement.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response. The response is expected to</span>
<span class="sd">      contain some bullet lists that start with `\*`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the actual number of bullet lists in the response meets the</span>
<span class="sd">    requirement.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">bullet_lists</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*\*[^\*].*$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
  <span class="n">bullet_lists_2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*-.*$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
  <span class="n">num_bullet_lists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bullet_lists</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">bullet_lists_2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">num_bullet_lists</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.BulletListChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_bullets&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bullets</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.BulletListChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_bullets&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalLettersEnglishChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>CapitalLettersEnglishChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks that the response is in english and is in all capital letters.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CapitalLettersEnglishChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the response is in english and is in all capital letters.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Your entire response should be in English, and in all capital letters.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks that the response is in English and in all capital letters.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;en&quot;</span>
    <span class="k">except</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">LangDetectException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="c1"># Count as instruction is followed.</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="s2">&quot;Unable to detect language for text </span><span class="si">%s</span><span class="s2"> due to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">e</span>
      <span class="p">)</span>  <span class="c1"># refex: disable=pytotw.037</span>
      <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalLettersEnglishChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalLettersEnglishChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Your entire response should be in English, and in all capital letters.&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalLettersEnglishChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks that the response is in English and in all capital letters.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the response is in English and in all capital letters.&quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;en&quot;</span>
  <span class="k">except</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">LangDetectException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Count as instruction is followed.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;Unable to detect language for text </span><span class="si">%s</span><span class="s2"> due to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">e</span>
    <span class="p">)</span>  <span class="c1"># refex: disable=pytotw.037</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalLettersEnglishChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1405</span>
<span class="normal">1406</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalLettersEnglishChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalWordFrequencyChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>CapitalWordFrequencyChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks frequency of words with all capital letters.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CapitalWordFrequencyChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks frequency of words with all capital letters.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">capital_frequency</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">capital_relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      capital_frequency: An integer that represents the number of words that</span>
<span class="sd">        should be in all capital letters.</span>
<span class="sd">      capital_relation: A string that is &#39;at least&#39; or &#39;at most&#39; that refers to</span>
<span class="sd">        the frequency.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">capital_frequency</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_ALL_CAPITAL_WORD_FREQUENCY</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">capital_relation</span>
    <span class="k">if</span> <span class="n">capital_relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">capital_relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">capital_relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span>
      <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;In your response, words with all capital letters should appear&quot;</span>
        <span class="s2">&quot; </span><span class="si">{relation}</span><span class="s2"> </span><span class="si">{frequency}</span><span class="s2"> times.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span> <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span>
    <span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyword args of build description.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;capital_frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
        <span class="s2">&quot;capital_relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
    <span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;capital_frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;capital_relation&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks the frequency of words with all capital letters.&quot;&quot;&quot;</span>
    <span class="c1"># Hyphenated words will count as one word</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">capital_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">isupper</span><span class="p">()]</span>

    <span class="n">capital_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">capital_words</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">capital_words</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">capital_words</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalWordFrequencyChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalWordFrequencyChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="n">capital_frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">capital_relation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>capital_frequency</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer that represents the number of words that
should be in all capital letters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>capital_relation</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string that is 'at least' or 'at most' that refers to
the frequency.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">capital_frequency</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">capital_relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    capital_frequency: An integer that represents the number of words that</span>
<span class="sd">      should be in all capital letters.</span>
<span class="sd">    capital_relation: A string that is &#39;at least&#39; or &#39;at most&#39; that refers to</span>
<span class="sd">      the frequency.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">capital_frequency</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_ALL_CAPITAL_WORD_FREQUENCY</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">capital_relation</span>
  <span class="k">if</span> <span class="n">capital_relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">capital_relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">capital_relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span>
    <span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;In your response, words with all capital letters should appear&quot;</span>
      <span class="s2">&quot; </span><span class="si">{relation}</span><span class="s2"> </span><span class="si">{frequency}</span><span class="s2"> times.&quot;</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span> <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalWordFrequencyChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks the frequency of words with all capital letters.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the frequency of words with all capital letters.&quot;&quot;&quot;</span>
  <span class="c1"># Hyphenated words will count as one word</span>
  <span class="n">words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">capital_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">isupper</span><span class="p">()]</span>

  <span class="n">capital_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">capital_words</span><span class="p">)</span>

  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">capital_words</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">capital_words</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalWordFrequencyChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyword args of build description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyword args of build description.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span>
      <span class="s2">&quot;capital_frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
      <span class="s2">&quot;capital_relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
  <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CapitalWordFrequencyChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;capital_frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;capital_relation&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CommaChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>CommaChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the response for no commas.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CommaChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the response for no commas.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;In your entire response, refrain from the use of any commas.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks that the response does not contain commas.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\,&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CommaChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CommaChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;In your entire response, refrain from the use of any commas.&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CommaChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks that the response does not contain commas.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the response does not contain commas.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\,&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CommaChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1468</span>
<span class="normal">1469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.CommaChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedResponseChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ConstrainedResponseChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the constrained response.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ConstrainedResponseChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the constrained response.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
    <span class="c1"># A sequence of string(s) representing the options of the expected response.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_constrained_responses</span> <span class="o">=</span> <span class="n">_CONSTRAINED_RESPONSE_OPTIONS</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Answer with one of the following options: </span><span class="si">{response_options}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">response_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_constrained_responses</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response matches the constrained options.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the actual response contains one of the options in the constrained</span>
<span class="sd">      responses; otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">constrained_response</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrained_responses</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">constrained_response</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedResponseChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedResponseChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
  <span class="c1"># A sequence of string(s) representing the options of the expected response.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_constrained_responses</span> <span class="o">=</span> <span class="n">_CONSTRAINED_RESPONSE_OPTIONS</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Answer with one of the following options: </span><span class="si">{response_options}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">response_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_constrained_responses</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedResponseChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response matches the constrained options.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the actual response contains one of the options in the constrained</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>responses; otherwise False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response matches the constrained options.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the actual response contains one of the options in the constrained</span>
<span class="sd">    responses; otherwise False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">constrained_response</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrained_responses</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">constrained_response</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">True</span>
  <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedResponseChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedResponseChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedStartChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ConstrainedStartChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the response start.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ConstrainedStartChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the response start.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">starter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      starter: A string representing the keyward that the response should start</span>
<span class="sd">        with.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="o">=</span> <span class="n">starter</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starter</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">starter</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_STARTER_OPTIONS</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;During the conversation, when it is your turn, &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;please always start with </span><span class="si">{starter}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">starter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_starter</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;starter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;starter&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response starts with the constrained keyword or phrase.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the response starts with the given phrase or keyword that is</span>
<span class="sd">      contained in `instruction_args`; otherwise, False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^\s*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;.*$&quot;</span>
    <span class="n">response_with_constrained_start</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">response_pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                                <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">response_with_constrained_start</span> <span class="k">else</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedStartChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedStartChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">starter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>starter</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the keyward that the response should start
with.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">starter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    starter: A string representing the keyward that the response should start</span>
<span class="sd">      with.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="o">=</span> <span class="n">starter</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starter</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">starter</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_STARTER_OPTIONS</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;During the conversation, when it is your turn, &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;please always start with </span><span class="si">{starter}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">starter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_starter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedStartChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response starts with the constrained keyword or phrase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the response starts with the given phrase or keyword that is</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contained in <code>instruction_args</code>; otherwise, False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response starts with the constrained keyword or phrase.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the response starts with the given phrase or keyword that is</span>
<span class="sd">    contained in `instruction_args`; otherwise, False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">response_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^\s*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;.*$&quot;</span>
  <span class="n">response_with_constrained_start</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">response_pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                              <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">response_with_constrained_start</span> <span class="k">else</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedStartChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;starter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starter</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ConstrainedStartChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;starter&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.EndChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>EndChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks that the prompt ends with a given phrase.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EndChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the prompt ends with a given phrase.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">end_phrase</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      end_phrase: A string representing the phrase the response should end with.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">end_phrase</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_phrase</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">end_phrase</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_ENDING_OPTIONS</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Finish your response with this exact phrase </span><span class="si">{ender}</span><span class="s2">. &quot;</span>
        <span class="s2">&quot;No other words should follow this phrase.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;end_phrase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;end_phrase&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response ends with the expected phrase.&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.EndChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.EndChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">end_phrase</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>end_phrase</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the phrase the response should end with.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">end_phrase</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    end_phrase: A string representing the phrase the response should end with.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">end_phrase</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_phrase</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">end_phrase</span>
  <span class="p">)</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_ENDING_OPTIONS</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Finish your response with this exact phrase </span><span class="si">{ender}</span><span class="s2">. &quot;</span>
      <span class="s2">&quot;No other words should follow this phrase.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.EndChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response ends with the expected phrase.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response ends with the expected phrase.&quot;&quot;&quot;</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.EndChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1273</span>
<span class="normal">1274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;end_phrase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_phrase</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.EndChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;end_phrase&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ForbiddenWords" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ForbiddenWords</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks that specified words are not used in response.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ForbiddenWords</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that specified words are not used in response.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forbidden_words</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      forbidden_words: A sequences of strings respresenting words that are not</span>
<span class="sd">        allowed in the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">forbidden_words</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span>
          <span class="n">num_keywords</span><span class="o">=</span><span class="n">_NUM_KEYWORDS</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">forbidden_words</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Do not include keywords </span><span class="si">{forbidden_words}</span><span class="s2"> in the response.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span>
    <span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;forbidden_words&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;forbidden_words&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the response does not contain the expected keywords.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b&quot;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\b&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ForbiddenWords.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ForbiddenWords.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="n">forbidden_words</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>forbidden_words</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequences of strings respresenting words that are not
allowed in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forbidden_words</span> <span class="o">=</span> <span class="kc">None</span>
                      <span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    forbidden_words: A sequences of strings respresenting words that are not</span>
<span class="sd">      allowed in the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">forbidden_words</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span>
        <span class="n">num_keywords</span><span class="o">=</span><span class="n">_NUM_KEYWORDS</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">forbidden_words</span><span class="p">))</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Do not include keywords </span><span class="si">{forbidden_words}</span><span class="s2"> in the response.&quot;</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ForbiddenWords.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check if the response does not contain the expected keywords.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check if the response does not contain the expected keywords.&quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b&quot;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\b&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">False</span>
  <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ForbiddenWords.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;forbidden_words&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forbidden_words</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ForbiddenWords.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;forbidden_words&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.HighlightSectionChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>HighlightSectionChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the highlighted section.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HighlightSectionChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the highlighted section.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_highlights</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_highlights: An integer specifying the minimum number of highlighted</span>
<span class="sd">        sections.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="o">=</span> <span class="n">num_highlights</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_HIGHLIGHTED_SECTIONS</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Highlight at least </span><span class="si">{num_highlights}</span><span class="s2"> sections in your answer with &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;markdown, i.e. *highlighted section*.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_highlights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_highlights&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_highlights&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the number of highlighted sections meets the requirement.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: a string repesenting the response. The response is expected to</span>
<span class="sd">        contain highlighted sections in the format of *highlighted*.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the actual number of highlighted sections in the format of</span>
<span class="sd">      *highlighed sections* meets the minimum requirement; otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_highlights</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*[^\n\*]*\*&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">double_highlights</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\*[^\n\*]*\*\*&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="n">highlights</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">highlight</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">num_highlights</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="n">double_highlights</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">highlight</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">num_highlights</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">num_highlights</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.HighlightSectionChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.HighlightSectionChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">num_highlights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_highlights</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the minimum number of highlighted
sections.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_highlights</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    num_highlights: An integer specifying the minimum number of highlighted</span>
<span class="sd">      sections.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="o">=</span> <span class="n">num_highlights</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_HIGHLIGHTED_SECTIONS</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Highlight at least </span><span class="si">{num_highlights}</span><span class="s2"> sections in your answer with &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;markdown, i.e. *highlighted section*.&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_highlights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.HighlightSectionChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the number of highlighted sections meets the requirement.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a string repesenting the response. The response is expected to
contain highlighted sections in the format of <em>highlighted</em>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the actual number of highlighted sections in the format of</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>highlighed sections</em> meets the minimum requirement; otherwise False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the number of highlighted sections meets the requirement.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: a string repesenting the response. The response is expected to</span>
<span class="sd">      contain highlighted sections in the format of *highlighted*.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the actual number of highlighted sections in the format of</span>
<span class="sd">    *highlighed sections* meets the minimum requirement; otherwise False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">num_highlights</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">highlights</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*[^\n\*]*\*&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="n">double_highlights</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\*[^\n\*]*\*\*&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="n">highlights</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">highlight</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
      <span class="n">num_highlights</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">for</span> <span class="n">highlight</span> <span class="ow">in</span> <span class="n">double_highlights</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">highlight</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
      <span class="n">num_highlights</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="k">return</span> <span class="n">num_highlights</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.HighlightSectionChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_highlights&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_highlights</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.HighlightSectionChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_highlights&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Instruction</code>


</h9>


    <div class="doc doc-contents ">


        <p>An instruction template.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Instruction</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;An instruction template.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction_id</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">instruction_id</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`build_description` not implemented.&quot;</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`get_instruction_args` not implemented.&quot;</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`get_instruction_args_keys` not implemented.&quot;</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`check_following` not implemented.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`build_description` not implemented.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
  <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`check_following` not implemented.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`get_instruction_args` not implemented.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;`get_instruction_args_keys` not implemented.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.JsonFormat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>JsonFormat</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the Json format.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JsonFormat</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the Json format.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Entire output should be wrapped in JSON format. You can use markdown&quot;</span>
        <span class="s2">&quot; ticks such as ```.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```json&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```Json&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```JSON&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.JsonFormat.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.JsonFormat.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Entire output should be wrapped in JSON format. You can use markdown&quot;</span>
      <span class="s2">&quot; ticks such as ```.&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.JsonFormat.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
  <span class="n">value</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```json&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```Json&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```JSON&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.JsonFormat.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.JsonFormat.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeySentenceChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>KeySentenceChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the existence of certain key sentences.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KeySentenceChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the existence of certain key sentences.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_sentences</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">num_sentences</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      key_sentences: A sequences of strings representing the key sentences that</span>
<span class="sd">        are expected in the response.</span>
<span class="sd">      num_sentences: The number of key sentences that are expected to be seen in</span>
<span class="sd">        the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">key_sentences</span><span class="p">:</span>
      <span class="c1"># TODO(jeffrey) make a generate sentences function? wonderwords package</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;For now, this is fine.&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span> <span class="o">=</span> <span class="n">key_sentences</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">num_sentences</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span> <span class="o">=</span> <span class="n">num_sentences</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Include </span><span class="si">{num_sentences}</span><span class="s2"> of the following sentences </span><span class="si">{key_sentences}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">num_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span><span class="p">,</span> <span class="n">key_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span>
    <span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span><span class="p">,</span>
            <span class="s2">&quot;key_sentences&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span><span class="p">)}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">,</span> <span class="s2">&quot;key_sentences&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response contains the expected key sentences.&quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">split_into_sentences</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeySentenceChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeySentenceChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="n">key_sentences</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_sentences</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key_sentences</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequences of strings representing the key sentences that
are expected in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_sentences</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of key sentences that are expected to be seen in
the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_sentences</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">num_sentences</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    key_sentences: A sequences of strings representing the key sentences that</span>
<span class="sd">      are expected in the response.</span>
<span class="sd">    num_sentences: The number of key sentences that are expected to be seen in</span>
<span class="sd">      the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">key_sentences</span><span class="p">:</span>
    <span class="c1"># TODO(jeffrey) make a generate sentences function? wonderwords package</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;For now, this is fine.&quot;</span><span class="p">])</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span> <span class="o">=</span> <span class="n">key_sentences</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">num_sentences</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span> <span class="o">=</span> <span class="n">num_sentences</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Include </span><span class="si">{num_sentences}</span><span class="s2"> of the following sentences </span><span class="si">{key_sentences}</span><span class="s2">&quot;</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">num_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span><span class="p">,</span> <span class="n">key_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeySentenceChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response contains the expected key sentences.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response contains the expected key sentences.&quot;&quot;&quot;</span>
  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">sentences</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">split_into_sentences</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="k">return</span> <span class="n">count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeySentenceChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences</span><span class="p">,</span>
          <span class="s2">&quot;key_sentences&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_sentences</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeySentenceChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">,</span> <span class="s2">&quot;key_sentences&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>KeywordChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the exisitence of certain keywords.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KeywordChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the exisitence of certain keywords.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keywords</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      keywords: A sequence of strings representing the keywords that are</span>
<span class="sd">        expected in the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span>
          <span class="n">num_keywords</span><span class="o">=</span><span class="n">_NUM_KEYWORDS</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="n">keywords</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Include keywords </span><span class="si">{keywords}</span><span class="s2"> in the response.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;keywords&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the response contain the expected keywords.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>keywords</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A sequence of strings representing the keywords that are
expected in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keywords</span> <span class="o">=</span> <span class="kc">None</span>
                      <span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    keywords: A sequence of strings representing the keywords that are</span>
<span class="sd">      expected in the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span>
        <span class="n">num_keywords</span><span class="o">=</span><span class="n">_NUM_KEYWORDS</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="n">keywords</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Include keywords </span><span class="si">{keywords}</span><span class="s2"> in the response.&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check if the response contain the expected keywords.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check if the response contain the expected keywords.&quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">False</span>
  <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;keywords&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordFrequencyChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>KeywordFrequencyChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the keyword frequency.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KeywordFrequencyChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the keyword frequency.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keyword</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">frequency</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      keyword: A string representing a keyword that is expected in the response.</span>
<span class="sd">      frequency: An integer specifying the number of times `keyword` is expected</span>
<span class="sd">        to appear in the response.</span>
<span class="sd">      relation: A string in (`less than`, `at least`), defining the relational</span>
<span class="sd">        operator for comparison.</span>
<span class="sd">        Two relational comparisons are supported for now:</span>
<span class="sd">        if &#39;less than&#39;, the actual number of occurrences &lt; frequency;</span>
<span class="sd">        if &#39;at least&#39;, the actual number of occurrences &gt;= frequency.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span><span class="n">num_keywords</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">frequency</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_KEYWORD_FREQUENCY</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">relation</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;In your response, the word </span><span class="si">{keyword}</span><span class="s2"> should appear </span><span class="si">{relation}</span><span class="s2"> &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;</span><span class="si">{frequency}</span><span class="s2"> times.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span><span class="p">,</span>
        <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span><span class="p">,</span>
            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
            <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response contain the keyword with required frequency.&quot;&quot;&quot;</span>
    <span class="n">actual_occurrences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">actual_occurrences</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">actual_occurrences</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordFrequencyChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordFrequencyChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>keyword</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing a keyword that is expected in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frequency</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the number of times <code>keyword</code> is expected
to appear in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>relation</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string in (<code>less than</code>, <code>at least</code>), defining the relational
operator for comparison.
Two relational comparisons are supported for now:
if 'less than', the actual number of occurrences &lt; frequency;
if 'at least', the actual number of occurrences &gt;= frequency.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keyword</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">frequency</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    keyword: A string representing a keyword that is expected in the response.</span>
<span class="sd">    frequency: An integer specifying the number of times `keyword` is expected</span>
<span class="sd">      to appear in the response.</span>
<span class="sd">    relation: A string in (`less than`, `at least`), defining the relational</span>
<span class="sd">      operator for comparison.</span>
<span class="sd">      Two relational comparisons are supported for now:</span>
<span class="sd">      if &#39;less than&#39;, the actual number of occurrences &lt; frequency;</span>
<span class="sd">      if &#39;at least&#39;, the actual number of occurrences &gt;= frequency.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span><span class="n">num_keywords</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">frequency</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_KEYWORD_FREQUENCY</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">relation</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;In your response, the word </span><span class="si">{keyword}</span><span class="s2"> should appear </span><span class="si">{relation}</span><span class="s2"> &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;</span><span class="si">{frequency}</span><span class="s2"> times.&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span><span class="p">,</span>
      <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
      <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordFrequencyChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response contain the keyword with required frequency.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response contain the keyword with required frequency.&quot;&quot;&quot;</span>
  <span class="n">actual_occurrences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">))</span>

  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">actual_occurrences</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">actual_occurrences</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordFrequencyChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keyword</span><span class="p">,</span>
          <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
          <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.KeywordFrequencyChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;keyword&quot;</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LetterFrequencyChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>LetterFrequencyChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks letter frequency.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LetterFrequencyChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks letter frequency.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">letter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">let_frequency</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">let_relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      letter: A string representing a letter that is expected in the response.</span>
<span class="sd">      let_frequency: An integer specifying the number of times `keyword` is</span>
<span class="sd">        expected to appear in the response.</span>
<span class="sd">      let_relation: A string in (`less than`, `at least`), defining the</span>
<span class="sd">        relational operator for comparison. Two relational comparisons are</span>
<span class="sd">        supported for now; if &#39;less than&#39;, the actual number of</span>
<span class="sd">        occurrences &lt; frequency; if &#39;at least&#39;, the actual number of</span>
<span class="sd">        occurrences &gt;= frequency.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">letter</span>
        <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">97</span>
        <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">122</span>
    <span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span> <span class="o">=</span> <span class="n">letter</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">let_frequency</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_LETTER_FREQUENCY</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">let_relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">let_relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">let_relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span>
      <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">let_relation</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;In your response, the letter </span><span class="si">{letter}</span><span class="s2"> should appear </span><span class="si">{let_relation}</span><span class="s2">&quot;</span>
        <span class="s2">&quot; </span><span class="si">{let_frequency}</span><span class="s2"> times.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">letter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">,</span>
        <span class="n">let_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
        <span class="n">let_relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
    <span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyword args of build description.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;letter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">,</span>
            <span class="s2">&quot;let_frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
            <span class="s2">&quot;let_relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;letter&quot;</span><span class="p">,</span> <span class="s2">&quot;let_frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;let_relation&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks that the response contains the letter at the right frequency.&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">letters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">letters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">letters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LetterFrequencyChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LetterFrequencyChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">letter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">let_frequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">let_relation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>letter</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing a letter that is expected in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>let_frequency</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the number of times <code>keyword</code> is
expected to appear in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>let_relation</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string in (<code>less than</code>, <code>at least</code>), defining the
relational operator for comparison. Two relational comparisons are
supported for now; if 'less than', the actual number of
occurrences &lt; frequency; if 'at least', the actual number of
occurrences &gt;= frequency.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">letter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">let_frequency</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">let_relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    letter: A string representing a letter that is expected in the response.</span>
<span class="sd">    let_frequency: An integer specifying the number of times `keyword` is</span>
<span class="sd">      expected to appear in the response.</span>
<span class="sd">    let_relation: A string in (`less than`, `at least`), defining the</span>
<span class="sd">      relational operator for comparison. Two relational comparisons are</span>
<span class="sd">      supported for now; if &#39;less than&#39;, the actual number of</span>
<span class="sd">      occurrences &lt; frequency; if &#39;at least&#39;, the actual number of</span>
<span class="sd">      occurrences &gt;= frequency.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="p">(</span>
      <span class="ow">not</span> <span class="n">letter</span>
      <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">97</span>
      <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">122</span>
  <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span> <span class="o">=</span> <span class="n">letter</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">let_frequency</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_LETTER_FREQUENCY</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">let_relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">let_relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">let_relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span>
    <span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">let_relation</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;In your response, the letter </span><span class="si">{letter}</span><span class="s2"> should appear </span><span class="si">{let_relation}</span><span class="s2">&quot;</span>
      <span class="s2">&quot; </span><span class="si">{let_frequency}</span><span class="s2"> times.&quot;</span>
  <span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">letter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">,</span>
      <span class="n">let_frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
      <span class="n">let_relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LetterFrequencyChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks that the response contains the letter at the right frequency.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the response contains the letter at the right frequency.&quot;&quot;&quot;</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="n">letters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">letters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">letters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LetterFrequencyChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyword args of build description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyword args of build description.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;letter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_letter</span><span class="p">,</span>
          <span class="s2">&quot;let_frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
          <span class="s2">&quot;let_relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LetterFrequencyChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;letter&quot;</span><span class="p">,</span> <span class="s2">&quot;let_frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;let_relation&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LowercaseLettersEnglishChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>LowercaseLettersEnglishChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks that the response is in english and is in all lowercase letters.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LowercaseLettersEnglishChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the response is in english and is in all lowercase letters.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Your entire response should be in English, and in all lowercase&quot;</span>
        <span class="s2">&quot; letters. No capital letters are allowed.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks that the response is in English and in all lowercase letters.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;en&quot;</span>
    <span class="k">except</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">LangDetectException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="c1"># Count as instruction is followed.</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="s2">&quot;Unable to detect language for text </span><span class="si">%s</span><span class="s2"> due to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">e</span>
      <span class="p">)</span>  <span class="c1"># refex: disable=pytotw.037</span>
      <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LowercaseLettersEnglishChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LowercaseLettersEnglishChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Your entire response should be in English, and in all lowercase&quot;</span>
      <span class="s2">&quot; letters. No capital letters are allowed.&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LowercaseLettersEnglishChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks that the response is in English and in all lowercase letters.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the response is in English and in all lowercase letters.&quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;en&quot;</span>
  <span class="k">except</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">LangDetectException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Count as instruction is followed.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;Unable to detect language for text </span><span class="si">%s</span><span class="s2"> due to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">e</span>
    <span class="p">)</span>  <span class="c1"># refex: disable=pytotw.037</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LowercaseLettersEnglishChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1437</span>
<span class="normal">1438</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.LowercaseLettersEnglishChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfSentences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>NumberOfSentences</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the number of sentences.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NumberOfSentences</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the number of sentences.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_sentences</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_sentences: An integer specifying the number of sentences as a</span>
<span class="sd">        threshold.</span>
<span class="sd">      relation: A string in (`less than`, `at least`), defining the relational</span>
<span class="sd">        operator for comparison.</span>
<span class="sd">        Two relational comparisons are supported for now:</span>
<span class="sd">        if &#39;less than&#39;, the actual number of sentences &lt; the threshold;</span>
<span class="sd">        if &#39;at least&#39;, the actual number of sentences &gt;= the threshold.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The number of sentences as a threshold for comparison.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="o">=</span> <span class="n">num_sentences</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_MAX_NUM_SENTENCES</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">relation</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Your response should contain </span><span class="si">{relation}</span><span class="s2"> </span><span class="si">{num_sentences}</span><span class="s2"> sentences.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
        <span class="n">num_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span><span class="p">,</span>
            <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the number of sentences follows the instruction.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the response follows the instruction.</span>

<span class="sd">    Raise:</span>
<span class="sd">        ValueError if the string in `instruction_args` is not in</span>
<span class="sd">        [`less_than`, `at_least`].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_sentences</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_sentences</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">num_sentences</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">num_sentences</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfSentences.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfSentences.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">num_sentences</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_sentences</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the number of sentences as a
threshold.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>relation</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string in (<code>less than</code>, <code>at least</code>), defining the relational
operator for comparison.
Two relational comparisons are supported for now:
if 'less than', the actual number of sentences &lt; the threshold;
if 'at least', the actual number of sentences &gt;= the threshold.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_sentences</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    num_sentences: An integer specifying the number of sentences as a</span>
<span class="sd">      threshold.</span>
<span class="sd">    relation: A string in (`less than`, `at least`), defining the relational</span>
<span class="sd">      operator for comparison.</span>
<span class="sd">      Two relational comparisons are supported for now:</span>
<span class="sd">      if &#39;less than&#39;, the actual number of sentences &lt; the threshold;</span>
<span class="sd">      if &#39;at least&#39;, the actual number of sentences &gt;= the threshold.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># The number of sentences as a threshold for comparison.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="o">=</span> <span class="n">num_sentences</span>
  <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_MAX_NUM_SENTENCES</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">relation</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Your response should contain </span><span class="si">{relation}</span><span class="s2"> </span><span class="si">{num_sentences}</span><span class="s2"> sentences.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
      <span class="n">num_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfSentences.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check if the number of sentences follows the instruction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the response follows the instruction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="raise" open>
  <summary>Raise</summary>
  <p>ValueError if the string in <code>instruction_args</code> is not in
[<code>less_than</code>, <code>at_least</code>].</p>
</details>

            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check if the number of sentences follows the instruction.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the response follows the instruction.</span>

<span class="sd">  Raise:</span>
<span class="sd">      ValueError if the string in `instruction_args` is not in</span>
<span class="sd">      [`less_than`, `at_least`].</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">num_sentences</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_sentences</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">num_sentences</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span>
  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">num_sentences</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfSentences.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sentences_threshold</span><span class="p">,</span>
          <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfSentences.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_sentences&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfWords" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>NumberOfWords</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the number of words.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NumberOfWords</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the number of words.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_words</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_words: An integer specifying the number of words contained in the</span>
<span class="sd">        response.</span>
<span class="sd">      relation: A string in (`less than`, `at least`), defining the relational</span>
<span class="sd">        operator for comparison.</span>
<span class="sd">        Two relational comparisons are supported for now:</span>
<span class="sd">        if &#39;less than&#39;, the actual number of words &lt; num_words;</span>
<span class="sd">        if &#39;at least&#39;, the actual number of words &gt;= num_words.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="o">=</span> <span class="n">num_words</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
          <span class="n">_NUM_WORDS_LOWER_LIMIT</span><span class="p">,</span> <span class="n">_NUM_WORDS_UPPER_LIMIT</span>
      <span class="p">)</span>

    <span class="k">if</span> <span class="n">relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">relation</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Answer with </span><span class="si">{relation}</span><span class="s2"> </span><span class="si">{num_words}</span><span class="s2"> words.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
        <span class="n">num_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_words&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span><span class="p">,</span>
            <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_words&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response contains the expected number of words.&quot;&quot;&quot;</span>
    <span class="n">num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">num_words</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="k">return</span> <span class="n">num_words</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfWords.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfWords.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">num_words</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_words</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the number of words contained in the
response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>relation</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string in (<code>less than</code>, <code>at least</code>), defining the relational
operator for comparison.
Two relational comparisons are supported for now:
if 'less than', the actual number of words &lt; num_words;
if 'at least', the actual number of words &gt;= num_words.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_words</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">relation</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    num_words: An integer specifying the number of words contained in the</span>
<span class="sd">      response.</span>
<span class="sd">    relation: A string in (`less than`, `at least`), defining the relational</span>
<span class="sd">      operator for comparison.</span>
<span class="sd">      Two relational comparisons are supported for now:</span>
<span class="sd">      if &#39;less than&#39;, the actual number of words &lt; num_words;</span>
<span class="sd">      if &#39;at least&#39;, the actual number of words &gt;= num_words.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="o">=</span> <span class="n">num_words</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
        <span class="n">_NUM_WORDS_LOWER_LIMIT</span><span class="p">,</span> <span class="n">_NUM_WORDS_UPPER_LIMIT</span>
    <span class="p">)</span>

  <span class="k">if</span> <span class="n">relation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_COMPARISON_RELATION</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_COMPARISON_RELATION</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The supported relation for comparison must be in &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_COMPARISON_RELATION</span><span class="si">}</span><span class="s2">, but </span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s2"> is given.&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">=</span> <span class="n">relation</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Answer with </span><span class="si">{relation}</span><span class="s2"> </span><span class="si">{num_words}</span><span class="s2"> words.&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">relation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">,</span>
      <span class="n">num_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfWords.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response contains the expected number of words.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response contains the expected number of words.&quot;&quot;&quot;</span>
  <span class="n">num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">num_words</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span>
  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span> <span class="o">==</span> <span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">num_words</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfWords.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_words&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_words</span><span class="p">,</span>
          <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison_relation</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.NumberOfWords.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_words&quot;</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ParagraphChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the paragraphs.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParagraphChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the paragraphs.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_paragraphs: An integer specifying the number of paragraphs.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">num_paragraphs</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_PARAGRAPHS</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;There should be </span><span class="si">{num_paragraphs}</span><span class="s2"> paragraphs. &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;Paragraphs are separated with the markdown divider: ***&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks the response contains required number of paragraphs.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response. The response may contain</span>
<span class="sd">        paragraphs that are separated by the markdown divider: `***`.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the actual number of paragraphs is the same as required;</span>
<span class="sd">      otherwise, False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s?\*\*\*\s?&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">paragraph</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">num_paragraphs</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">num_paragraphs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">num_paragraphs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_paragraphs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the number of paragraphs.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    num_paragraphs: An integer specifying the number of paragraphs.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">num_paragraphs</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_PARAGRAPHS</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;There should be </span><span class="si">{num_paragraphs}</span><span class="s2"> paragraphs. &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Paragraphs are separated with the markdown divider: ***&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks the response contains required number of paragraphs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response. The response may contain
paragraphs that are separated by the markdown divider: <code>***</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the actual number of paragraphs is the same as required;</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>otherwise, False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the response contains required number of paragraphs.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response. The response may contain</span>
<span class="sd">      paragraphs that are separated by the markdown divider: `***`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the actual number of paragraphs is the same as required;</span>
<span class="sd">    otherwise, False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s?\*\*\*\s?&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">paragraph</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">num_paragraphs</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

  <span class="k">return</span> <span class="n">num_paragraphs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphFirstWordCheck" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ParagraphFirstWordCheck</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the paragraph and the first word of the nth paragraph.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParagraphFirstWordCheck</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the paragraph and the first word of the nth paragraph.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">first_word</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_paragraphs: An integer indicating the number of paragraphs expected</span>
<span class="sd">        in the response. A paragraph is a subset of the string that is</span>
<span class="sd">        expected to be separated by &#39;\n\n&#39;.</span>
<span class="sd">      nth_paragraph: An integer indicating the paragraph number that we look at.</span>
<span class="sd">        Note that n starts from 1.</span>
<span class="sd">      first_word: A string that represent the first word of the bth paragraph.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">num_paragraphs</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_PARAGRAPHS</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">=</span> <span class="n">nth_paragraph</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span>
    <span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="o">=</span> <span class="n">first_word</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span><span class="n">num_keywords</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;There should be </span><span class="si">{num_paragraphs}</span><span class="s2"> paragraphs. &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;Paragraphs and only paragraphs are separated with each other by two &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;new lines as if it was &#39;</span><span class="se">\\</span><span class="s2">n</span><span class="se">\\</span><span class="s2">n&#39; in python. &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;Paragraph </span><span class="si">{nth_paragraph}</span><span class="s2"> must start with word </span><span class="si">{first_word}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">num_paragraphs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">,</span>
        <span class="n">nth_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span><span class="p">,</span>
        <span class="n">first_word</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">,</span>
            <span class="s2">&quot;nth_paragraph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span><span class="p">,</span>
            <span class="s2">&quot;first_word&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">,</span> <span class="s2">&quot;nth_paragraph&quot;</span><span class="p">,</span> <span class="s2">&quot;first_word&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks for required number of paragraphs and correct first word.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: a string representing the response. The response may contain</span>
<span class="sd">        paragraphs that are separated by two new lines and the first word of</span>
<span class="sd">        the nth paragraph will have to match a specified word.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the number of paragraphs is the same as required and the first</span>
<span class="sd">      word of the specified paragraph is the same as required. Otherwise, false.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\n&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">paragraph</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">num_paragraphs</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># check that index doesn&#39;t go out of bounds</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">&lt;=</span> <span class="n">num_paragraphs</span><span class="p">:</span>
      <span class="n">paragraph</span> <span class="o">=</span> <span class="n">paragraphs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">paragraph</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="n">first_word</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">punctuation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">}</span>

    <span class="c1"># get first word and remove punctuation</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">paragraph</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># TODO(jeffrey): make more complex?</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">punctuation</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="n">first_word</span> <span class="o">+=</span> <span class="n">letter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">num_paragraphs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span>
        <span class="ow">and</span> <span class="n">first_word</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphFirstWordCheck.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphFirstWordCheck.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nth_paragraph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">first_word</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_paragraphs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer indicating the number of paragraphs expected
in the response. A paragraph is a subset of the string that is
expected to be separated by '\n\n'.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nth_paragraph</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer indicating the paragraph number that we look at.
Note that n starts from 1.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>first_word</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string that represent the first word of the bth paragraph.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">first_word</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    num_paragraphs: An integer indicating the number of paragraphs expected</span>
<span class="sd">      in the response. A paragraph is a subset of the string that is</span>
<span class="sd">      expected to be separated by &#39;\n\n&#39;.</span>
<span class="sd">    nth_paragraph: An integer indicating the paragraph number that we look at.</span>
<span class="sd">      Note that n starts from 1.</span>
<span class="sd">    first_word: A string that represent the first word of the bth paragraph.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">num_paragraphs</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_PARAGRAPHS</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">=</span> <span class="n">nth_paragraph</span>
  <span class="k">if</span> <span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="ow">is</span> <span class="kc">None</span>
      <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">&lt;=</span> <span class="mi">0</span>
      <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span>
  <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="o">=</span> <span class="n">first_word</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span><span class="n">num_keywords</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;There should be </span><span class="si">{num_paragraphs}</span><span class="s2"> paragraphs. &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Paragraphs and only paragraphs are separated with each other by two &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;new lines as if it was &#39;</span><span class="se">\\</span><span class="s2">n</span><span class="se">\\</span><span class="s2">n&#39; in python. &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;Paragraph </span><span class="si">{nth_paragraph}</span><span class="s2"> must start with word </span><span class="si">{first_word}</span><span class="s2">.&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">num_paragraphs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">,</span>
      <span class="n">nth_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span><span class="p">,</span>
      <span class="n">first_word</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphFirstWordCheck.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks for required number of paragraphs and correct first word.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a string representing the response. The response may contain
paragraphs that are separated by two new lines and the first word of
the nth paragraph will have to match a specified word.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the number of paragraphs is the same as required and the first</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>word of the specified paragraph is the same as required. Otherwise, false.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks for required number of paragraphs and correct first word.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: a string representing the response. The response may contain</span>
<span class="sd">      paragraphs that are separated by two new lines and the first word of</span>
<span class="sd">      the nth paragraph will have to match a specified word.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the number of paragraphs is the same as required and the first</span>
<span class="sd">    word of the specified paragraph is the same as required. Otherwise, false.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\n\n&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">paragraphs</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">paragraph</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
      <span class="n">num_paragraphs</span> <span class="o">-=</span> <span class="mi">1</span>

  <span class="c1"># check that index doesn&#39;t go out of bounds</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">&lt;=</span> <span class="n">num_paragraphs</span><span class="p">:</span>
    <span class="n">paragraph</span> <span class="o">=</span> <span class="n">paragraphs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">paragraph</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">False</span>

  <span class="n">first_word</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">punctuation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">}</span>

  <span class="c1"># get first word and remove punctuation</span>
  <span class="n">word</span> <span class="o">=</span> <span class="n">paragraph</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="c1"># TODO(jeffrey): make more complex?</span>
  <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
  <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">punctuation</span><span class="p">:</span>
      <span class="k">break</span>
    <span class="n">first_word</span> <span class="o">+=</span> <span class="n">letter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

  <span class="k">return</span> <span class="p">(</span>
      <span class="n">num_paragraphs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span>
      <span class="ow">and</span> <span class="n">first_word</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphFirstWordCheck.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_paragraphs</span><span class="p">,</span>
          <span class="s2">&quot;nth_paragraph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nth_paragraph</span><span class="p">,</span>
          <span class="s2">&quot;first_word&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_word</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ParagraphFirstWordCheck.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_paragraphs&quot;</span><span class="p">,</span> <span class="s2">&quot;nth_paragraph&quot;</span><span class="p">,</span> <span class="s2">&quot;first_word&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PlaceholderChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>PlaceholderChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the placeholders in template writing.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PlaceholderChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the placeholders in template writing.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_placeholders</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      num_placeholders: An integer denoting the minimum number of</span>
<span class="sd">        placeholders required in the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="o">=</span> <span class="n">num_placeholders</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_PLACEHOLDERS</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;The response must contain at least </span><span class="si">{num_placeholders}</span><span class="s2"> placeholders &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;represented by square brackets, such as [address].&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">num_placeholders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_placeholders&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_placeholders&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the number of placeholders follows the instruction.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the actual number of placeholders in the response is greater than</span>
<span class="sd">      or equal to `num_placeholders`; otherwise, False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">placeholders</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*?\]&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">num_placeholders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">placeholders</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_placeholders</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PlaceholderChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PlaceholderChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">num_placeholders</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>num_placeholders</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer denoting the minimum number of
placeholders required in the response.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">num_placeholders</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    num_placeholders: An integer denoting the minimum number of</span>
<span class="sd">      placeholders required in the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="o">=</span> <span class="n">num_placeholders</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_PLACEHOLDERS</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;The response must contain at least </span><span class="si">{num_placeholders}</span><span class="s2"> placeholders &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;represented by square brackets, such as [address].&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">num_placeholders</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PlaceholderChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check if the number of placeholders follows the instruction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the actual number of placeholders in the response is greater than</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>or equal to <code>num_placeholders</code>; otherwise, False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check if the number of placeholders follows the instruction.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the actual number of placeholders in the response is greater than</span>
<span class="sd">    or equal to `num_placeholders`; otherwise, False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">placeholders</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*?\]&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="n">num_placeholders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">placeholders</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">num_placeholders</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PlaceholderChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;num_placeholders&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_placeholders</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PlaceholderChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;num_placeholders&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PostscriptChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>PostscriptChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the postscript.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PostscriptChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the postscript.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">postscript_marker</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      postscript_marker: A string containing the keyword that marks the start</span>
<span class="sd">        of the postscript section.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">=</span> <span class="n">postscript_marker</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">postscript_marker</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">postscript_marker</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_POSTSCRIPT_MARKER</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;At the end of your response, please explicitly add a postscript &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;starting with </span><span class="si">{postscript}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">postscript</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;postscript_marker&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;postscript_marker&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response follows the postscript format.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: a string representing the response. The response is expected to</span>
<span class="sd">        contain a postscript section.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the response contains a postscript section starting with</span>
<span class="sd">      the keyword containing in the `instruction_args`; otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">==</span> <span class="s2">&quot;P.P.S&quot;</span><span class="p">:</span>
      <span class="n">postscript_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s*p\.\s?p\.\s?s.*$&quot;</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">==</span> <span class="s2">&quot;P.S.&quot;</span><span class="p">:</span>
      <span class="n">postscript_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s*p\.\s?s\..*$&quot;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">postscript_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;.*$&quot;</span>
    <span class="n">postscript</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">postscript_pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">postscript</span> <span class="k">else</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PostscriptChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PostscriptChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">postscript_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>postscript_marker</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string containing the keyword that marks the start
of the postscript section.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">postscript_marker</span> <span class="o">=</span> <span class="kc">None</span>
                      <span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    postscript_marker: A string containing the keyword that marks the start</span>
<span class="sd">      of the postscript section.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">=</span> <span class="n">postscript_marker</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
      <span class="n">postscript_marker</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">postscript_marker</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_POSTSCRIPT_MARKER</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;At the end of your response, please explicitly add a postscript &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;starting with </span><span class="si">{postscript}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">postscript</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PostscriptChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response follows the postscript format.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a string representing the response. The response is expected to
contain a postscript section.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the response contains a postscript section starting with</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the keyword containing in the <code>instruction_args</code>; otherwise False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response follows the postscript format.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: a string representing the response. The response is expected to</span>
<span class="sd">      contain a postscript section.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the response contains a postscript section starting with</span>
<span class="sd">    the keyword containing in the `instruction_args`; otherwise False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">==</span> <span class="s2">&quot;P.P.S&quot;</span><span class="p">:</span>
    <span class="n">postscript_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s*p\.\s?p\.\s?s.*$&quot;</span>
  <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span> <span class="o">==</span> <span class="s2">&quot;P.S.&quot;</span><span class="p">:</span>
    <span class="n">postscript_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s*p\.\s?s\..*$&quot;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">postscript_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;.*$&quot;</span>
  <span class="n">postscript</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">postscript_pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">postscript</span> <span class="k">else</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PostscriptChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;postscript_marker&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postscript_marker</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.PostscriptChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;postscript_marker&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.QuotationChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>QuotationChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks response is wrapped with double quotation marks.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">QuotationChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks response is wrapped with double quotation marks.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Wrap your entire response with double quotation marks.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyword args of build description.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response is wrapped with double quotation marks.&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.QuotationChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.QuotationChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Wrap your entire response with double quotation marks.&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.QuotationChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response is wrapped with double quotation marks.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response is wrapped with double quotation marks.&quot;&quot;&quot;</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.QuotationChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyword args of build description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyword args of build description.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.QuotationChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RepeatPromptThenAnswer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>RepeatPromptThenAnswer</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks that Prompt is first repeated then answered.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RepeatPromptThenAnswer</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that Prompt is first repeated then answered.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prompt_to_repeat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      prompt_to_repeat: The prompt that is meant to be repeated.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_to_repeat</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prompt_to_repeat must be set.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_to_repeat</span> <span class="o">=</span> <span class="n">prompt_to_repeat</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;First repeat the request word for word without change,&quot;</span>
        <span class="s2">&quot; then give your answer (1. do not say any words or characters&quot;</span>
        <span class="s2">&quot; before repeating the request; 2. the request you need to repeat&quot;</span>
        <span class="s2">&quot; does not include this sentence)&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prompt_to_repeat&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_to_repeat</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;prompt_to_repeat&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_to_repeat</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RepeatPromptThenAnswer.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RepeatPromptThenAnswer.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">prompt_to_repeat</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt_to_repeat</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prompt that is meant to be repeated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prompt_to_repeat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    prompt_to_repeat: The prompt that is meant to be repeated.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">prompt_to_repeat</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;prompt_to_repeat must be set.&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_to_repeat</span> <span class="o">=</span> <span class="n">prompt_to_repeat</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;First repeat the request word for word without change,&quot;</span>
      <span class="s2">&quot; then give your answer (1. do not say any words or characters&quot;</span>
      <span class="s2">&quot; before repeating the request; 2. the request you need to repeat&quot;</span>
      <span class="s2">&quot; does not include this sentence)&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RepeatPromptThenAnswer.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_to_repeat</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RepeatPromptThenAnswer.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1238</span>
<span class="normal">1239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prompt_to_repeat&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_to_repeat</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RepeatPromptThenAnswer.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;prompt_to_repeat&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>RephraseChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the repharse.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RephraseChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the repharse.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">original_message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      original_message: A string representing the original message. The</span>
<span class="sd">        rephrased response should only change its words/sentences in between</span>
<span class="sd">        its two asterisks, for example, *change me*. Both original and rephrased</span>
<span class="sd">        messages should contain the changes in the form of *change me*.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_change</span><span class="p">(</span><span class="n">original_message</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message </span><span class="si">{</span><span class="n">original_message</span><span class="si">}</span><span class="s2"> does not contain changes &quot;</span>
                       <span class="s2">&quot;in the form of *change me*.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_reference_without_change</span> <span class="o">=</span> <span class="n">original_message</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Rephrasing: Your rephrased response should only&quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;change the words/sentences in between two asterisks&quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;such as *change me*.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;original_message&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_without_change</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;original_message&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checks if the rephrasing follows the instruction.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response, which is expected to rephras</span>
<span class="sd">        the string of `instruction_args`.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if `value` and `instruction_args` only differ by the words/sentences</span>
<span class="sd">      in between two asterisks such as *change me*; otherwise, False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_change</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not contain &quot;</span>
                       <span class="s2">&quot;changes in the form of *change me*.&quot;</span><span class="p">)</span>

    <span class="n">response_without_changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_changes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">reference_without_changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_changes</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_without_change</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response_without_changes</span> <span class="o">==</span> <span class="n">reference_without_changes</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">is_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if there is change in the response in the form of *change me*.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*.*\*&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">strip_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strips off the changes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*.*\*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">original_message</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>original_message</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the original message. The
rephrased response should only change its words/sentences in between
its two asterisks, for example, <em>change me</em>. Both original and rephrased
messages should contain the changes in the form of <em>change me</em>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">original_message</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    original_message: A string representing the original message. The</span>
<span class="sd">      rephrased response should only change its words/sentences in between</span>
<span class="sd">      its two asterisks, for example, *change me*. Both original and rephrased</span>
<span class="sd">      messages should contain the changes in the form of *change me*.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_change</span><span class="p">(</span><span class="n">original_message</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message </span><span class="si">{</span><span class="n">original_message</span><span class="si">}</span><span class="s2"> does not contain changes &quot;</span>
                     <span class="s2">&quot;in the form of *change me*.&quot;</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_reference_without_change</span> <span class="o">=</span> <span class="n">original_message</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Rephrasing: Your rephrased response should only&quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;change the words/sentences in between two asterisks&quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;such as *change me*.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the rephrasing follows the instruction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response, which is expected to rephras
the string of <code>instruction_args</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if <code>value</code> and <code>instruction_args</code> only differ by the words/sentences</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>in between two asterisks such as <em>change me</em>; otherwise, False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Checks if the rephrasing follows the instruction.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response, which is expected to rephras</span>
<span class="sd">      the string of `instruction_args`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if `value` and `instruction_args` only differ by the words/sentences</span>
<span class="sd">    in between two asterisks such as *change me*; otherwise, False.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_change</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not contain &quot;</span>
                     <span class="s2">&quot;changes in the form of *change me*.&quot;</span><span class="p">)</span>

  <span class="n">response_without_changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_changes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">reference_without_changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_changes</span><span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_reference_without_change</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">response_without_changes</span> <span class="o">==</span> <span class="n">reference_without_changes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;original_message&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_without_change</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;original_message&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker.is_change" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">is_change</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check if there is change in the response in the form of <em>change me</em>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check if there is change in the response in the form of *change me*.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*.*\*&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseChecker.strip_changes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">strip_changes</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Strips off the changes.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">strip_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Strips off the changes.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*.*\*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseParagraph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>RephraseParagraph</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks that the paragraph is rephrased.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RephraseParagraph</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks that the paragraph is rephrased.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span>
                        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Builds the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      original_paragraph: A string presenting the original paragraph. The</span>
<span class="sd">        rephrases response should have betweeb low-high words in generic.</span>
<span class="sd">      low: An integer presenting the lower bound of similar words.</span>
<span class="sd">      high: An integer representing the upper bound of similar words.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO(jeffrey) make more encompassing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_paragraph</span> <span class="o">=</span> <span class="n">original_paragraph</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="o">=</span> <span class="n">low</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">=</span> <span class="n">high</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Rephrase the following paragraph: &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;</span><span class="si">{original_paragraph}</span><span class="se">\n</span><span class="s2">Your response should have &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;between </span><span class="si">{low}</span><span class="s2"> and </span><span class="si">{high}</span><span class="s2"> of the same words. &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;Words are the same if and only if all of the &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;letters, ignoring cases, are the same. For &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;example, &#39;run&#39; is the same as &#39;Run&#39; but different &quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;to &#39;ran&#39;.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_paragraph</span><span class="o">=</span><span class="n">original_paragraph</span><span class="p">,</span>
                                    <span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;original_paragraph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_paragraph</span><span class="p">,</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">,</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;original_paragraph&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">val_words</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">original_words</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_paragraph</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">similar_words</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">dict_val</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">val_words</span><span class="p">)</span>
    <span class="n">dict_original</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">original_words</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">dict_original</span><span class="p">:</span>
      <span class="n">similar_words</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dict_original</span><span class="p">[</span><span class="n">word</span><span class="p">],</span> <span class="n">dict_val</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">similar_words</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="ow">and</span> <span class="n">similar_words</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseParagraph.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseParagraph.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Builds the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>original_paragraph</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string presenting the original paragraph. The
rephrases response should have betweeb low-high words in generic.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>low</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer presenting the lower bound of similar words.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>high</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer representing the upper bound of similar words.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span>
                      <span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Builds the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    original_paragraph: A string presenting the original paragraph. The</span>
<span class="sd">      rephrases response should have betweeb low-high words in generic.</span>
<span class="sd">    low: An integer presenting the lower bound of similar words.</span>
<span class="sd">    high: An integer representing the upper bound of similar words.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># TODO(jeffrey) make more encompassing</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_original_paragraph</span> <span class="o">=</span> <span class="n">original_paragraph</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="o">=</span> <span class="n">low</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_high</span> <span class="o">=</span> <span class="n">high</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Rephrase the following paragraph: &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;</span><span class="si">{original_paragraph}</span><span class="se">\n</span><span class="s2">Your response should have &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;between </span><span class="si">{low}</span><span class="s2"> and </span><span class="si">{high}</span><span class="s2"> of the same words. &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;Words are the same if and only if all of the &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;letters, ignoring cases, are the same. For &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;example, &#39;run&#39; is the same as &#39;Run&#39; but different &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;to &#39;ran&#39;.&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original_paragraph</span><span class="o">=</span><span class="n">original_paragraph</span><span class="p">,</span>
                                  <span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseParagraph.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
  <span class="n">val_words</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
  <span class="n">original_words</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_paragraph</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
  <span class="n">similar_words</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="n">dict_val</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">val_words</span><span class="p">)</span>
  <span class="n">dict_original</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">original_words</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">dict_original</span><span class="p">:</span>
    <span class="n">similar_words</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dict_original</span><span class="p">[</span><span class="n">word</span><span class="p">],</span> <span class="n">dict_val</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">similar_words</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span> <span class="ow">and</span> <span class="n">similar_words</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseParagraph.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;original_paragraph&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_paragraph</span><span class="p">,</span>
          <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_low</span><span class="p">,</span>
          <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_high</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.RephraseParagraph.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;original_paragraph&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ResponseLanguageChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>ResponseLanguageChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check the language of the entire response.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ResponseLanguageChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the language of the entire response.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      language: A string representing the expected language of the response. The</span>
<span class="sd">        language has to comply to the 97 types defined in</span>
<span class="sd">        `langid.py` (https://pypi.org/project/langid/1.1.5/), which follows</span>
<span class="sd">        ISO 639-1 codes (https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes);</span>
<span class="sd">        for example, `en` for English, `zh` for Chinese, `fr` for French.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_language</span> <span class="o">=</span> <span class="n">language</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_language</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_LANGUAGES</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="c1"># TODO(tianjianlu): opens the description generation to more choices.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Your ENTIRE response should be in </span><span class="si">{language}</span><span class="s2"> language, no other &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;language is allowed.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">_LANGUAGES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_language</span><span class="p">])</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the language of the entire response follows the instruction.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the language of `value` follows instruction; otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language</span>
    <span class="k">except</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">LangDetectException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="c1"># Count as instruction is followed.</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
          <span class="s2">&quot;Unable to detect language for text </span><span class="si">%s</span><span class="s2"> due to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">e</span>
      <span class="p">)</span>  <span class="c1"># refex: disable=pytotw.037</span>
      <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ResponseLanguageChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ResponseLanguageChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>language</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the expected language of the response. The
language has to comply to the 97 types defined in
<code>langid.py</code> (https://pypi.org/project/langid/1.1.5/), which follows
ISO 639-1 codes (https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes);
for example, <code>en</code> for English, <code>zh</code> for Chinese, <code>fr</code> for French.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">language</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    language: A string representing the expected language of the response. The</span>
<span class="sd">      language has to comply to the 97 types defined in</span>
<span class="sd">      `langid.py` (https://pypi.org/project/langid/1.1.5/), which follows</span>
<span class="sd">      ISO 639-1 codes (https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes);</span>
<span class="sd">      for example, `en` for English, `zh` for Chinese, `fr` for French.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_language</span> <span class="o">=</span> <span class="n">language</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_language</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_LANGUAGES</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
  <span class="c1"># TODO(tianjianlu): opens the description generation to more choices.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Your ENTIRE response should be in </span><span class="si">{language}</span><span class="s2"> language, no other &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;language is allowed.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">_LANGUAGES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_language</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ResponseLanguageChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check if the language of the entire response follows the instruction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the language of <code>value</code> follows instruction; otherwise False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check if the language of the entire response follows the instruction.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the language of `value` follows instruction; otherwise False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language</span>
  <span class="k">except</span> <span class="n">langdetect</span><span class="o">.</span><span class="n">LangDetectException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Count as instruction is followed.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;Unable to detect language for text </span><span class="si">%s</span><span class="s2"> due to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">e</span>
    <span class="p">)</span>  <span class="c1"># refex: disable=pytotw.037</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ResponseLanguageChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.ResponseLanguageChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.SectionChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>SectionChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the sections.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SectionChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the sections.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">section_spliter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">num_sections</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">    Args:</span>
<span class="sd">      section_spliter: A string represents the section spliter keyword that</span>
<span class="sd">        marks a new section, i.e., `Section` or `SECTION`.</span>
<span class="sd">      num_sections: An integer specifying the number of sections.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A string representing the instruction description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span> <span class="o">=</span> <span class="n">section_spliter</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">section_spliter</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">section_spliter</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_SECTION_SPLITER</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="o">=</span> <span class="n">num_sections</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_SECTIONS</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Your response must have </span><span class="si">{num_sections}</span><span class="s2"> sections. Mark the beginning &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;of each section with </span><span class="si">{section_spliter}</span><span class="s2"> X, such as:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;</span><span class="si">{section_spliter}</span><span class="s2"> 1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;[content of section 1]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;</span><span class="si">{section_spliter}</span><span class="s2"> 2</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;[content of section 2]&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">num_sections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span><span class="p">,</span>
        <span class="n">section_spliter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;section_spliter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span><span class="p">,</span>
            <span class="s2">&quot;num_sections&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;section_spliter&quot;</span><span class="p">,</span> <span class="s2">&quot;num_sections&quot;</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks the response contains multiple sections.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response. The response is expected</span>
<span class="sd">        to contain multiple sections (number of sections is greater than 1).</span>
<span class="sd">        A new section starts with `Section 1`, where the number denotes the</span>
<span class="sd">        section index.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the number of sections in the response is greater than or equal to</span>
<span class="sd">      the minimum number of sections; otherwise, False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">section_splitter_patten</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s?&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span>  <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s?\d+\s?&quot;</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">section_splitter_patten</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">num_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">num_sections</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.SectionChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.SectionChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">section_spliter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_sections</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>section_spliter</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string represents the section spliter keyword that
marks a new section, i.e., <code>Section</code> or <code>SECTION</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_sections</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An integer specifying the number of sections.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the instruction description.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">section_spliter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">num_sections</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.</span>

<span class="sd">  Args:</span>
<span class="sd">    section_spliter: A string represents the section spliter keyword that</span>
<span class="sd">      marks a new section, i.e., `Section` or `SECTION`.</span>
<span class="sd">    num_sections: An integer specifying the number of sections.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A string representing the instruction description.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span> <span class="o">=</span> <span class="n">section_spliter</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
      <span class="n">section_spliter</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">section_spliter</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">_SECTION_SPLITER</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="o">=</span> <span class="n">num_sections</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_NUM_SECTIONS</span><span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Your response must have </span><span class="si">{num_sections}</span><span class="s2"> sections. Mark the beginning &quot;</span> <span class="o">+</span>
      <span class="s2">&quot;of each section with </span><span class="si">{section_spliter}</span><span class="s2"> X, such as:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;</span><span class="si">{section_spliter}</span><span class="s2"> 1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;[content of section 1]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;</span><span class="si">{section_spliter}</span><span class="s2"> 2</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
      <span class="s2">&quot;[content of section 2]&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">num_sections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span><span class="p">,</span>
      <span class="n">section_spliter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.SectionChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks the response contains multiple sections.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response. The response is expected
to contain multiple sections (number of sections is greater than 1).
A new section starts with <code>Section 1</code>, where the number denotes the
section index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the number of sections in the response is greater than or equal to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the minimum number of sections; otherwise, False.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the response contains multiple sections.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response. The response is expected</span>
<span class="sd">      to contain multiple sections (number of sections is greater than 1).</span>
<span class="sd">      A new section starts with `Section 1`, where the number denotes the</span>
<span class="sd">      section index.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if the number of sections in the response is greater than or equal to</span>
<span class="sd">    the minimum number of sections; otherwise, False.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">section_splitter_patten</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s?&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span>  <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\s?\d+\s?&quot;</span>
  <span class="n">sections</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">section_splitter_patten</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="n">num_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="n">num_sections</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.SectionChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;section_spliter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_section_spliter</span><span class="p">,</span>
          <span class="s2">&quot;num_sections&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_sections</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.SectionChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;section_spliter&quot;</span><span class="p">,</span> <span class="s2">&quot;num_sections&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TitleChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>TitleChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Checks the response for a title.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TitleChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks the response for a title.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Your answer must contain a title, wrapped in double angular brackets,&quot;</span>
        <span class="s2">&quot; such as &lt;&lt;poem of joy&gt;&gt;.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response contains a title.&quot;&quot;&quot;</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;&lt;[^\n]+&gt;&gt;&quot;</span>
    <span class="n">re_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">re_pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TitleChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TitleChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Your answer must contain a title, wrapped in double angular brackets,&quot;</span>
      <span class="s2">&quot; such as &lt;&lt;poem of joy&gt;&gt;.&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TitleChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response contains a title.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response contains a title.&quot;&quot;&quot;</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;&lt;[^\n]+&gt;&gt;&quot;</span>
  <span class="n">re_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
  <span class="n">titles</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">re_pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">titles</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
      <span class="k">return</span> <span class="kc">True</span>
  <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TitleChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1298</span>
<span class="normal">1299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TitleChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TwoResponsesChecker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>TwoResponsesChecker</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Instruction (aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction)" href="#aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.Instruction">Instruction</a></code></p>


        <p>Check that two responses were given.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TwoResponsesChecker</span><span class="p">(</span><span class="n">Instruction</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check that two responses were given.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Give two different responses. Responses and only responses should&quot;</span>
        <span class="s2">&quot; be separated by 6 asterisk symbols: ******.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the response has two different answers.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: A string representing the response.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if two responses are detected and false otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_responses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;******&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
          <span class="k">return</span> <span class="kc">False</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">valid_responses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="ow">and</span> <span class="n">valid_responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">valid_responses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TwoResponsesChecker.id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="nb">id</span> <span class="o">=</span> <span class="n">instruction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TwoResponsesChecker.build_description" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">build_description</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Build the instruction description.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Build the instruction description.&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span> <span class="o">=</span> <span class="p">(</span>
      <span class="s2">&quot;Give two different responses. Responses and only responses should&quot;</span>
      <span class="s2">&quot; be separated by 6 asterisk symbols: ******.&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description_pattern</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TwoResponsesChecker.check_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">check_following</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Checks if the response has two different answers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representing the response.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if two responses are detected and false otherwise.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_following</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Checks if the response has two different answers.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A string representing the response.</span>

<span class="sd">  Returns:</span>
<span class="sd">    True if two responses are detected and false otherwise.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">valid_responses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
  <span class="n">responses</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;******&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">valid_responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
      <span class="nb">len</span><span class="p">(</span><span class="n">valid_responses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
      <span class="ow">and</span> <span class="n">valid_responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">valid_responses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TwoResponsesChecker.get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the keyward args of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the keyward args of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions.TwoResponsesChecker.get_instruction_args_keys" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_instruction_args_keys</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Returns the args keys of <code>build_description</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_instruction_args_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Returns the args keys of `build_description`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_registry" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>instructions_registry</code>


</h8>

    <div class="doc doc-contents ">

        <p>Registry of all instructions.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_registry.INSTRUCTION_CONFLICTS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">INSTRUCTION_CONFLICTS</span> <span class="o">=</span> <span class="p">{</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;existence&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;existence&#39;</span><span class="p">},</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;frequency&#39;</span><span class="p">},</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;forbidden_words&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;forbidden_words&#39;</span><span class="p">},</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;letter_frequency&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;letter_frequency&#39;</span><span class="p">},</span> <span class="n">_LANGUAGE</span> <span class="o">+</span> <span class="s1">&#39;response_language&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_LANGUAGE</span> <span class="o">+</span> <span class="s1">&#39;response_language&#39;</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;multiple_sections&#39;</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;existence&#39;</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;forbidden_words&#39;</span><span class="p">,</span> <span class="n">_STARTEND</span> <span class="o">+</span> <span class="s1">&#39;end_checker&#39;</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_capital&#39;</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_lowercase&#39;</span><span class="p">},</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_sentences&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_sentences&#39;</span><span class="p">},</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_paragraphs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_paragraphs&#39;</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;nth_paragraph_first_word&#39;</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_sentences&#39;</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;nth_paragraph_first_word&#39;</span><span class="p">},</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_words&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_words&#39;</span><span class="p">},</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;nth_paragraph_first_word&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;nth_paragraph_first_word&#39;</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_paragraphs&#39;</span><span class="p">},</span> <span class="n">_CONTENT</span> <span class="o">+</span> <span class="s1">&#39;number_placeholders&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_CONTENT</span> <span class="o">+</span> <span class="s1">&#39;number_placeholders&#39;</span><span class="p">},</span> <span class="n">_CONTENT</span> <span class="o">+</span> <span class="s1">&#39;postscript&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_CONTENT</span> <span class="o">+</span> <span class="s1">&#39;postscript&#39;</span><span class="p">},</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;number_bullet_lists&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;number_bullet_lists&#39;</span><span class="p">},</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;constrained_response&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">INSTRUCTION_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;number_highlighted_sections&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;number_highlighted_sections&#39;</span><span class="p">},</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;multiple_sections&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;multiple_sections&#39;</span><span class="p">,</span> <span class="n">_LANGUAGE</span> <span class="o">+</span> <span class="s1">&#39;response_language&#39;</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;number_highlighted_sections&#39;</span><span class="p">},</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;json_format&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">INSTRUCTION_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;forbidden_words&#39;</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;existence&#39;</span><span class="p">}),</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;title&#39;</span><span class="p">},</span> <span class="n">_COMBINATION</span> <span class="o">+</span> <span class="s1">&#39;two_responses&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">INSTRUCTION_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;forbidden_words&#39;</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;existence&#39;</span><span class="p">,</span> <span class="n">_LANGUAGE</span> <span class="o">+</span> <span class="s1">&#39;response_language&#39;</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">_PUNCTUATION</span> <span class="o">+</span> <span class="s1">&#39;no_comma&#39;</span><span class="p">}),</span> <span class="n">_COMBINATION</span> <span class="o">+</span> <span class="s1">&#39;repeat_prompt&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">INSTRUCTION_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;existence&#39;</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">_PUNCTUATION</span> <span class="o">+</span> <span class="s1">&#39;no_comma&#39;</span><span class="p">}),</span> <span class="n">_STARTEND</span> <span class="o">+</span> <span class="s1">&#39;end_checker&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_STARTEND</span> <span class="o">+</span> <span class="s1">&#39;end_checker&#39;</span><span class="p">},</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;capital_word_frequency&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;capital_word_frequency&#39;</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_lowercase&#39;</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_capital&#39;</span><span class="p">},</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_capital&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_capital&#39;</span><span class="p">},</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_lowercase&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_lowercase&#39;</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_capital&#39;</span><span class="p">},</span> <span class="n">_PUNCTUATION</span> <span class="o">+</span> <span class="s1">&#39;no_comma&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_PUNCTUATION</span> <span class="o">+</span> <span class="s1">&#39;no_comma&#39;</span><span class="p">},</span> <span class="n">_STARTEND</span> <span class="o">+</span> <span class="s1">&#39;quotation&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">_STARTEND</span> <span class="o">+</span> <span class="s1">&#39;quotation&#39;</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;title&#39;</span><span class="p">}}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_registry.INSTRUCTION_DICT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">INSTRUCTION_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;existence&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeywordChecker</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeywordFrequencyChecker</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;forbidden_words&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ForbiddenWords</span><span class="p">,</span> <span class="n">_KEYWORD</span> <span class="o">+</span> <span class="s1">&#39;letter_frequency&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">LetterFrequencyChecker</span><span class="p">,</span> <span class="n">_LANGUAGE</span> <span class="o">+</span> <span class="s1">&#39;response_language&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ResponseLanguageChecker</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_sentences&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfSentences</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_paragraphs&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphChecker</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;number_words&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfWords</span><span class="p">,</span> <span class="n">_LENGTH</span> <span class="o">+</span> <span class="s1">&#39;nth_paragraph_first_word&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphFirstWordCheck</span><span class="p">,</span> <span class="n">_CONTENT</span> <span class="o">+</span> <span class="s1">&#39;number_placeholders&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PlaceholderChecker</span><span class="p">,</span> <span class="n">_CONTENT</span> <span class="o">+</span> <span class="s1">&#39;postscript&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PostscriptChecker</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;number_bullet_lists&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">BulletListChecker</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;constrained_response&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ConstrainedResponseChecker</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;number_highlighted_sections&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">HighlightSectionChecker</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;multiple_sections&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">SectionChecker</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;json_format&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">JsonFormat</span><span class="p">,</span> <span class="n">_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">TitleChecker</span><span class="p">,</span> <span class="n">_COMBINATION</span> <span class="o">+</span> <span class="s1">&#39;two_responses&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">TwoResponsesChecker</span><span class="p">,</span> <span class="n">_COMBINATION</span> <span class="o">+</span> <span class="s1">&#39;repeat_prompt&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">RepeatPromptThenAnswer</span><span class="p">,</span> <span class="n">_STARTEND</span> <span class="o">+</span> <span class="s1">&#39;end_checker&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">EndChecker</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;capital_word_frequency&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CapitalWordFrequencyChecker</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_capital&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CapitalLettersEnglishChecker</span><span class="p">,</span> <span class="n">_CHANGE_CASES</span> <span class="o">+</span> <span class="s1">&#39;english_lowercase&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">LowercaseLettersEnglishChecker</span><span class="p">,</span> <span class="n">_PUNCTUATION</span> <span class="o">+</span> <span class="s1">&#39;no_comma&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CommaChecker</span><span class="p">,</span> <span class="n">_STARTEND</span> <span class="o">+</span> <span class="s1">&#39;quotation&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">QuotationChecker</span><span class="p">}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_registry.conflict_make" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">conflict_make</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Makes sure if A conflicts with B, B will conflict with A.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>conflicts</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of potential conflicts where key is instruction id
and value is set of instruction ids that it conflicts with.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Revised version of the dictionary. All instructions conflict with</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>themselves. If A conflicts with B, B will conflict with A.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_registry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">conflict_make</span><span class="p">(</span><span class="n">conflicts</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Makes sure if A conflicts with B, B will conflict with A.</span>

<span class="sd">  Args:</span>
<span class="sd">    conflicts: Dictionary of potential conflicts where key is instruction id</span>
<span class="sd">      and value is set of instruction ids that it conflicts with.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Revised version of the dictionary. All instructions conflict with</span>
<span class="sd">    themselves. If A conflicts with B, B will conflict with A.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
      <span class="n">conflicts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">conflicts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">conflicts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>instructions_test</code>


</h8>

    <div class="doc doc-contents ">

        <p>Tests for instructions.py.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>InstructionsTest</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="absl.testing.parameterized.TestCase">TestCase</span></code></p>









              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  23</span>
<span class="normal">  24</span>
<span class="normal">  25</span>
<span class="normal">  26</span>
<span class="normal">  27</span>
<span class="normal">  28</span>
<span class="normal">  29</span>
<span class="normal">  30</span>
<span class="normal">  31</span>
<span class="normal">  32</span>
<span class="normal">  33</span>
<span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InstructionsTest</span><span class="p">(</span><span class="n">parameterized</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

  <span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
      <span class="p">[</span>
          <span class="p">{</span>
              <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                  <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">_language=</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s1">&#39;</span>
              <span class="p">),</span>
              <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
              <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;The response is English&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">)]</span>
      <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">test_response_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test on single language response.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;language:response_language&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ResponseLanguageChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

  <span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
      <span class="p">[</span>
          <span class="p">{</span>
              <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                  <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">_language=</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s1">&#39;</span>
              <span class="p">),</span>
              <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
              <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;Desayunamos en McDonald&#39;s hoy&quot;</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">),</span>
                                     <span class="p">(</span><span class="s1">&#39;Today we visit the Louvre&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">),]</span>
      <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">test_response_multilanguage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test on responses that contain multi-language tokens.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;language:response_language&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ResponseLanguageChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>

  <span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
      <span class="p">[</span>
          <span class="p">{</span>
              <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                  <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">_relation=</span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;_num_sentences=</span><span class="si">{</span><span class="n">num_sentences</span><span class="si">}</span><span class="s1">_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
              <span class="p">),</span>
              <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
              <span class="s1">&#39;relation&#39;</span><span class="p">:</span> <span class="n">relation</span><span class="p">,</span>
              <span class="s1">&#39;num_sentences&#39;</span><span class="p">:</span> <span class="n">num_sentences</span><span class="p">,</span>
              <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
              <span class="p">(</span><span class="s1">&#39;xx,x. xx,x! xx/x. x</span><span class="si">{x}</span><span class="s1">x?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="mi">4</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
              <span class="p">(</span><span class="s1">&#39;xxxx. xx,x! xxxx. x(x)x?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="mi">5</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">(</span><span class="s1">&#39;xxxx. xx,x! xx|x. x&amp;x x?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="mi">4</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">(</span><span class="s1">&#39;xx-x. xx,x! xx}x. x,xx?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="mi">5</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
          <span class="p">]</span>
      <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">test_number_sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the number of sentences.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraints:number_sentences&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfSentences</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">relation</span><span class="o">=</span><span class="n">relation</span><span class="p">,</span>
                                  <span class="n">num_sentences</span><span class="o">=</span><span class="n">num_sentences</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

  <span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
      <span class="p">[</span>
          <span class="p">{</span>
              <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                  <span class="sa">f</span><span class="s1">&#39;_templated=</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s1">_num_placeholders=</span><span class="si">{</span><span class="n">num_placeholders</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
              <span class="p">),</span>
              <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">template</span><span class="p">,</span>
              <span class="s1">&#39;num_placeholders&#39;</span><span class="p">:</span> <span class="n">num_placeholders</span><span class="p">,</span>
              <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_placeholders</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
              <span class="p">((</span><span class="s1">&#39;Sure, here is a short template with 5 placeholders:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;[Name]</span><span class="se">\n</span><span class="s1">[Email]</span><span class="se">\n</span><span class="s1">[Phone]</span><span class="se">\n</span><span class="s1">[Address]</span><span class="se">\n</span><span class="s1">[Website]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;This template can be used for a variety of purposes, such &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;ascreating a contact list, sending out surveys, or creating &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;a sign-up form.&#39;</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">((</span><span class="s1">&#39;My [adjective] [noun] is [adjective] [noun]. I [verb] and &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;[verb].&#39;</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
              <span class="p">]</span>
      <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">test_number_placeholders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_placeholders</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the number of placeholders.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_content:number_placeholders&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PlaceholderChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_placeholders</span><span class="o">=</span><span class="n">num_placeholders</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

  <span class="n">BULLET_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  A Markdown bullet point is a way of formatting text to create a list. To</span>
<span class="s2">  create a bullet point, start each line with an asterisk (*). For example:</span>
<span class="s2">  * This is a bullet point.</span>
<span class="s2">  *(no space required)Another bullet point.</span>
<span class="s2">  * (no newline ending required)Another bullet point.</span>
<span class="s2">  markdown bullet points are often used to create to-do lists or to list items</span>
<span class="s2">  in a step-by-step guide.&quot;&quot;&quot;</span>
  <span class="n">BULLET_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Check that inline asterisk (*), *, will not be counted. Only * that starts a</span>
<span class="s2">  bullet list will be counted:</span>
<span class="s2">    * This is a bullet point.</span>
<span class="s2">    * Another bullet point.</span>
<span class="s2">    . dot is not counted&quot;&quot;&quot;</span>
  <span class="n">BULLET_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Here are three bullets starting with asterisk:</span>
<span class="s2">  * I am a large language model, also known as a conversational AI.</span>
<span class="s2">  * I am trained on a massive amount of text data, and I am able to communicate.</span>
<span class="s2">  * I am still under development, but I am learning new things every day.&quot;&quot;&quot;</span>

  <span class="n">BULLET_TEST_MESSAGE_4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Here are three markdown bullets:</span>
<span class="s2">  - I am a large language model, also known as a conversational AI.</span>
<span class="s2">  - I am trained on a massive amount of text data, and I am able to communicate.</span>
<span class="s2">  -I am still under development, but I am learning new things every day.&quot;&quot;&quot;</span>

  <span class="n">BULLET_TEST_MESSAGE_5</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Paragraph 1</span>
<span class="s2">  ***</span>
<span class="s2">  Paragraph 2</span>
<span class="s2">  ***</span>
<span class="s2">  Paragraph 3</span>
<span class="s2">  * only one bullet point</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
      <span class="p">[</span>
          <span class="p">{</span>
              <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                  <span class="sa">f</span><span class="s1">&#39;_templated=</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s1">_num_bullets=</span><span class="si">{</span><span class="n">num_bullets</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
              <span class="p">),</span>
              <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">template</span><span class="p">,</span>
              <span class="s1">&#39;num_bullets&#39;</span><span class="p">:</span> <span class="n">num_bullets</span><span class="p">,</span>
              <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_bullets</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
              <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
      <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">test_number_bullet_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_bullets</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the number of bullets.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:exact_number_bullet_points&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">BulletListChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_bullets</span><span class="o">=</span><span class="n">num_bullets</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

  <span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2"> My answer is no.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
  <span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;My answer is no.   &quot;&quot;&quot;</span>
  <span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  My answer is no. I am still under development and I am always learning and</span>
<span class="s2">  improving. I am not the best chatbot in the world, but I am striving to be</span>
<span class="s2">  the best that I can be.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_constrained_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the constrained response checker.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:constrained_response&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ConstrainedResponseChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;test with CONSTRAINED_RESPONSE_TEST_RESPONSE_1&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;test with CONSTRAINED_RESPONSE_TEST_RESPONSE_2&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_2</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;test with CONSTRAINED_RESPONSE_TEST_RESPONSE_3&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_3</span><span class="p">))</span>

  <span class="n">HIGHLIGHTED_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  To highlight text with Markdown, you can use the * character before and after</span>
<span class="s2">  the text you want to highlight. For example, if you want to highlight the</span>
<span class="s2">  word `hello`, you would type:*hello*, You can also use the ** character to</span>
<span class="s2">  create bold text. For example, if you want to bold the word `hello`, you</span>
<span class="s2">  would type: **hello** &quot;&quot;&quot;</span>
  <span class="n">HIGHLIGHTED_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Sure, here are the numerical methods for solving partial differential</span>
<span class="s2">  equations highlighted with Markdown:</span>
<span class="s2">  *Finite difference methods</span>
<span class="s2">  *Finite element methods*</span>
<span class="s2">  *Boundary element methods</span>
<span class="s2">  *Monte Carlo methods</span>
<span class="s2">  I hope this helps!&quot;&quot;&quot;</span>
  <span class="n">HIGHLIGHTED_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  There is allowed to be *two different* highlighted *sections in the same*</span>
<span class="s2">  line. **This is also true** for **double markdown highlights.**</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
      <span class="p">[</span>
          <span class="p">{</span>
              <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                  <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;_min_num_highlights=</span><span class="si">{</span><span class="n">min_num_highlights</span><span class="si">}</span><span class="s1">&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
              <span class="p">),</span>
              <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
              <span class="s1">&#39;min_num_highlights&#39;</span><span class="p">:</span> <span class="n">min_num_highlights</span><span class="p">,</span>
              <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">min_num_highlights</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
              <span class="p">(</span><span class="n">HIGHLIGHTED_TEST_MESSAGE_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
              <span class="p">(</span><span class="n">HIGHLIGHTED_TEST_MESSAGE_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
              <span class="p">(</span><span class="n">HIGHLIGHTED_TEST_MESSAGE_3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
      <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">test_number_highlights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">min_num_highlights</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the minimum number of highlighted sections.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:minimum_number_highlighted_sections&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">HighlightSectionChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_highlights</span><span class="o">=</span><span class="n">min_num_highlights</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

  <span class="n">SECTION_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Your response must have multiple sections. Mark the beginning of each section</span>
<span class="s2">  with &quot;Section X&quot;, such as:</span>
<span class="s2">  Section 1</span>
<span class="s2">  [content of section 1]</span>
<span class="s2">  Section 2</span>
<span class="s2">  [content of section 2]&quot;&quot;&quot;</span>

  <span class="n">SECTION_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SECTION 1</span>
<span class="s2">  [content of section 1]</span>
<span class="s2">  SECTION 2</span>
<span class="s2">  [content of section 2]&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_section_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the number of sections.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:multiple_sections&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">SectionChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">section_keyword</span> <span class="o">=</span> <span class="s1">&#39;Section&#39;</span>
    <span class="n">min_num_sections</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">section_spliter</span><span class="o">=</span><span class="n">section_keyword</span><span class="p">,</span>
                                  <span class="n">num_sections</span><span class="o">=</span><span class="n">min_num_sections</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">section_keyword</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">min_num_sections</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SECTION_TEST_MESSAGE_1</span><span class="p">))</span>

    <span class="n">section_keyword</span> <span class="o">=</span> <span class="s1">&#39;SECTION&#39;</span>
    <span class="n">min_num_sections</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">section_spliter</span><span class="o">=</span><span class="n">section_keyword</span><span class="p">,</span>
                                  <span class="n">num_sections</span><span class="o">=</span><span class="n">min_num_sections</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">section_keyword</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">min_num_sections</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SECTION_TEST_MESSAGE_2</span><span class="p">))</span>

  <span class="n">PARAGRAPH_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  paragraph 1</span>
<span class="s2">  ***</span>
<span class="s2">  paragraph 2</span>
<span class="s2">  ***</span>
<span class="s2">  paragraph 3&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">          ***</span>
<span class="s2">  paragraph 1</span>
<span class="s2">          ***</span>
<span class="s2">      paragraph 2</span>
<span class="s2">          ***</span>
<span class="s2">      paragraph 3&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  paragraph 1</span>
<span class="s2">          ***</span>
<span class="s2">      paragraph 2</span>
<span class="s2">          ***</span>
<span class="s2">      paragraph 3</span>
<span class="s2">          ***&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_TEST_MESSAGE_4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  paragraph 1</span>
<span class="s2">          ***</span>
<span class="s2">      paragraph 2</span>
<span class="s2">          ***</span>
<span class="s2">          ***&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_paragraph_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the number of sections.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraint:number_paragraphs&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_1</span><span class="si">}</span><span class="s1"> and &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_1</span><span class="p">))</span>

    <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_2</span><span class="si">}</span><span class="s1"> and &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_2</span><span class="p">))</span>

    <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_3</span><span class="si">}</span><span class="s1"> and &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_3</span><span class="p">))</span>

    <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_4</span><span class="si">}</span><span class="s1"> and &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_4</span><span class="p">))</span>

  <span class="n">POSTSCRIPT_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  I will do my best to follow your instructions and always start my responses</span>
<span class="s2">  with &quot;My response is:&quot;. I will try to be as consistent as possible, but</span>
<span class="s2">  please be patient with me if I make a mistake. I am still under development,</span>
<span class="s2">  and I am always learning new things.</span>

<span class="s2">  P.S. I hope this is what you were looking for.&quot;&quot;&quot;</span>

  <span class="n">POSTSCRIPT_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Sure, here is my response with a postscript starting with P.P.S.:</span>

<span class="s2">  My response is: I hope this answers your question.</span>

<span class="s2">  P.P.S. I am always happy to answer any other questions you may have.</span>

<span class="s2">  Do you have any other questions for me?&quot;&quot;&quot;</span>

  <span class="c1"># Postscript does not have to start as a new line.</span>
  <span class="c1"># Relaxed the constraint in cl/525253841.</span>
  <span class="n">POSTSCRIPT_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The radius of a unit circle is 1. However, I can give you a funny and wrong</span>
<span class="s2">  answer: the radius of a unit circle is 0. This is because a unit circle is a</span>
<span class="s2">  circle with a radius of 1, and if the radius is 0, then the circle has no</span>
<span class="s2">  size and is just a point. (not starting a new line) P.S. I hope you enjoyed</span>
<span class="s2">  my joke!&quot;&quot;&quot;</span>

  <span class="n">POSTSCRIPT_TEST_MESSAGE_4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  If the length of a square is one, the area of the square will also be one.</span>
<span class="s2">  p.p.s what if the entire response was lower case letters?</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">POSTSCRIPT_TEST_MESSAGE_5</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The mysteries of space and time are mysterious.</span>
<span class="s2">  P. S. Sometimes there are even spaces between P. and S..</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_postscript_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the postscript checker.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_content:postscript&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PostscriptChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_POSTSCRIPT_MARKER</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_1</span><span class="p">))</span>

    <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;PS:&#39;</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_1</span><span class="p">))</span>

    <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_POSTSCRIPT_MARKER</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_2</span><span class="p">))</span>

    <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;P.S.&#39;</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_3</span><span class="p">))</span>

    <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;P.P.S&#39;</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_4</span><span class="p">))</span>

    <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;P.S.&#39;</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_5</span><span class="p">))</span>

  <span class="n">CONSTRAINED_START_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  My response is: ASIC is a specialized chip for specific tasks in electronic</span>
<span class="s2">  devices, offering advantages in efficiency and processing speed.&quot;&quot;&quot;</span>

  <span class="n">CONSTRAINED_START_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        My response is: ASIC is a specialized chip for specific tasks in</span>
<span class="s2">  electronic</span>
<span class="s2">  devices, offering advantages in efficiency and processing speed.&quot;&quot;&quot;</span>

  <span class="n">CONSTRAINED_START_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  An ASIC, or Application-Specific Integrated Circuit, is a type of specialized</span>
<span class="s2">  chip that, my response is, is designed to perform specific tasks in electronic</span>
<span class="s2">  devices.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_constrained_start_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the constrained start checker.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;multi-turn:constrained_start&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ConstrainedStartChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">start_keyword</span> <span class="o">=</span> <span class="s1">&#39;My response is:&#39;</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">starter</span><span class="o">=</span><span class="n">start_keyword</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_START_TEST_MESSAGE_1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">start_keyword</span><span class="si">}</span><span class="s1"> with spaces in the beginning&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_START_TEST_MESSAGE_2</span><span class="p">))</span>

    <span class="n">start_keyword</span> <span class="o">=</span> <span class="s1">&#39;my response is&#39;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">start_keyword</span><span class="si">}</span><span class="s1"> embedded in the middle&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_START_TEST_MESSAGE_3</span><span class="p">))</span>

  <span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  I am *content*.&quot;&quot;&quot;</span>
  <span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  I am *happy*.&quot;&quot;&quot;</span>

  <span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_NOCHANGE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  I am .&quot;&quot;&quot;</span>

  <span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  I am [content].&quot;&quot;&quot;</span>

  <span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  It is raining heavily *at this moment*.&quot;&quot;&quot;</span>
  <span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  *At present,* there is heavy rainfall occurring.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_rephrase_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the rephrase checker.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:rephrasing&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">RephraseChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1</span><span class="p">))</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_NOCHANGE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_NOCHANGE</span><span class="p">)</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_FORMAT</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_FORMAT</span><span class="p">)</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_2</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_2</span><span class="p">))</span>

  <span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Paris is a city of beauty and romance. The romantic river Seine winds its way</span>
<span class="s2">  through the city, past iconic landmarks like the Eiffel Tower and the Louvre</span>
<span class="s2">  Museum, where the Mona Lisa resides. Whether you&#39;re taking a boat cruise down</span>
<span class="s2">  the river or simply strolling along the banks, you&#39;re sure to be captivated</span>
<span class="s2">  by the city&#39;s charm.&quot;&quot;&quot;</span>

  <span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Paris is a city of beauty, romance, and history. It is home to some of the</span>
<span class="s2">  most iconic landmarks in the world, including the Eiffel Tower, the Louvre</span>
<span class="s2">  Museum, and the Notre Dame Cathedral. The city is also known for its romantic</span>
<span class="s2">  river cruises, its delicious food, and its stylish people.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">KEYWORDS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;romantic&#39;</span><span class="p">,</span> <span class="s1">&#39;river&#39;</span><span class="p">,</span> <span class="s1">&#39;Mona Lisa&#39;</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_keyword_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the inclusion of keywords.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:include_keywords&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeywordChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KEYWORDS</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_1</span><span class="p">))</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KEYWORDS</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_2</span><span class="p">))</span>

  <span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  keyword, Keyword, KEYWORD</span>
<span class="s2">  &quot;&quot;&quot;</span>
  <span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span> <span class="o">=</span> <span class="s1">&#39;  keyword &#39;</span>

  <span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    *keyword</span>
<span class="s2">    *Keyword</span>
<span class="s2">    *KEYWORD</span>
<span class="s2">  &quot;&quot;&quot;</span>
  <span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_2</span> <span class="o">=</span> <span class="s1">&#39;KEYWORD&#39;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_keyword_frequency_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the frequency of keywords.&quot;&quot;&quot;</span>

    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:keyword_frequency&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeywordFrequencyChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="p">,</span>
                                  <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                                  <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_1</span><span class="p">))</span>

    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="p">,</span>
                                  <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                                  <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_1</span><span class="p">))</span>

    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_2</span><span class="p">,</span>
                                  <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                                  <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_2</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_2</span><span class="p">))</span>

  <span class="n">TEST_NUM_WORDS_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  d3sCRi7 lArge lAnguagE M0del w1tH 20 w0RdS.&quot;&quot;&quot;</span>

  <span class="n">TEST_NUM_WORDS_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  L4RGE L4NGU4GE M0DEL: AI syst3m th4t und3rstands, g3n3r4tes, or tr4nsforms</span>
<span class="s2">  l4ngu4g3 b4s3d on pr3vious l3arning &amp; d4t4.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_num_words_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the checker on the number of words.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraint:number_words&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfWords</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">word_counts</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">word_counts</span><span class="p">,</span>
                                  <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">word_counts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_1</span><span class="p">))</span>

    <span class="n">word_counts</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">word_counts</span><span class="p">,</span>
                                  <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="si">}</span><span class="s1"> less than </span><span class="si">{</span><span class="n">word_counts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="p">))</span>

    <span class="n">word_counts</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">word_counts</span><span class="p">,</span>
                                  <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="si">}</span><span class="s1"> at least </span><span class="si">{</span><span class="n">word_counts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="p">))</span>

  <span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  paragraph 1</span>

<span class="s2">  I paragraph 2</span>

<span class="s2">  paragraph 3&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_FIRST_WORD_TEST_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  paragraph 1</span>

<span class="s2">  I paragraph 2&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_FIRST_WORD_TEST_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  paragraph 1</span>

<span class="s2">  fail paragraph 2</span>

<span class="s2">  paragraph 3&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Wow this is a very long response.</span>

<span class="s2">  I can&#39;t believe there is more than three paragraphs.</span>

<span class="s2">  Really more than three? No way!</span>

<span class="s2">  I can&#39;t believe it but I guess I am living proof.</span>

<span class="s2">  Haha, you go that right.&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_FIRST_WORD_TEST_5</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Wow this is a very long response.</span>

<span class="s2">  I can&#39;t believe there is more than three paragraphs.</span>

<span class="s2">  &quot;Really?! more than three? No way!&quot;</span>

<span class="s2">  I can&#39;t believe it but I guess I am living proof.</span>

<span class="s2">  Haha, you go that right.&quot;&quot;&quot;</span>

  <span class="n">PARAGRAPH_FIRST_WORD_TEST_6</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Wow this is a very long response.</span>

<span class="s2">  I can&#39;t believe there is more than three paragraphs.</span>

<span class="s2">  Rea!lly more than three? No way!</span>

<span class="s2">  I can&#39;t believe it but I guess I am living proof.</span>

<span class="s2">  Haha, you go that right.&quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_paragraph_first_word</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test number of paragraphs and first word of nth paragraph.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraints:nth_paragraph_first_word&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphFirstWordCheck</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_2</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_3</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_5</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_6</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span>
          <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_2</span>
          <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_3</span><span class="p">):</span>
        <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">first_word</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
      <span class="k">elif</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span><span class="p">:</span>
        <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">first_word</span> <span class="o">=</span> <span class="s1">&#39;haha&#39;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">first_word</span> <span class="o">=</span> <span class="s1">&#39;Really&#39;</span>

      <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
          <span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">,</span>
          <span class="n">nth_paragraph</span><span class="o">=</span><span class="n">nth_paragraph</span><span class="p">,</span>
          <span class="n">first_word</span><span class="o">=</span><span class="n">first_word</span><span class="p">,</span>
      <span class="p">)</span>
      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
          <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">. Test for &#39;</span>
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs and &#39;</span>
          <span class="sa">f</span><span class="s1">&#39;for paragraph </span><span class="si">{</span><span class="n">nth_paragraph</span><span class="si">}</span><span class="s1"> &#39;</span>
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">first_word</span><span class="si">}</span><span class="s1"> is first word&#39;</span>
      <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span>
            <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span>
            <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_5</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>

  <span class="n">TEST_KEY_SENTENCES_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Puppies are fun. They are playful, energetic, and always up for a good time.</span>
<span class="s2">Puppies love to run, jump, and play fetch. They are also very good at</span>
<span class="s2">cuddling and giving kisses. If you are looking for a fun and loving pet,</span>
<span class="s2">a puppy is a great choice.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_KEY_SENTENCES_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  I like to eat candy. When I&#39;m feeling happy, sad, or even angry, candy</span>
<span class="s2">always makes me feel better. I like to share candy with my friends and</span>
<span class="s2">family. It&#39;s a great way to show them how much I care.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_KEY_SENTENCES_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">I know that candy isn&#39;t the healthiest thing to eat, but I don&#39;t care.</span>
<span class="s2">I love it too much. I&#39;ll just have to make sure to eat it in moderation.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">key_sentences</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Puppies love to run, jump, and play fetch.&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;I like to eat candy.&#39;</span><span class="p">,</span> <span class="s1">&#39;Puppies are fun.&#39;</span><span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_key_sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the inclusion of key sentences.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:key_sentences&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeySentenceChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">num_sentences</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">key_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_sentences</span><span class="p">,</span> <span class="n">num_sentences</span><span class="o">=</span><span class="n">num_sentences</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_1</span><span class="p">))</span>

    <span class="n">num_sentences</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">key_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_sentences</span><span class="p">,</span> <span class="n">num_sentences</span><span class="o">=</span><span class="n">num_sentences</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_2</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_3</span><span class="p">))</span>

  <span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The Nazis came to power in 1933 through a combination of legal and illegal</span>
<span class="s2">  means. Hitler was appointed chancellor by President Paul von Hindenburg, and</span>
<span class="s2">  the Nazis quickly consolidated their power by passing a series of laws that</span>
<span class="s2">  restricted the rights of opposition parties and individuals. By 1934, Hitler</span>
<span class="s2">  had become dictator of Germany.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Dinosaurs were a diverse group of reptiles that dominated the Earth for over</span>
<span class="s2">  160 million years. They came in all shapes and sizes, from the tiny</span>
<span class="s2">  Compsognathus to the massive Argentinosaurus. Dinosaurs were the most</span>
<span class="s2">  successful land animals on Earth until they went extinct about 66 million</span>
<span class="s2">  years ago. The exact cause of their extinction is still unknown, but it</span>
<span class="s2">  is thought to have been a combination of factors, including an asteroid</span>
<span class="s2">  impact and climate change.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  GPT, or Generative Pre-trained Transformer, is a family of neural network</span>
<span class="s2">  models that uses the transformer architecture. GPT models are trained on a</span>
<span class="s2">  massive dataset of text and code, and can be used for a variety of tasks,</span>
<span class="s2">  including text generation, translation, and question answering. GPT models</span>
<span class="s2">  have been shown to be very effective at these tasks, and are being used by</span>
<span class="s2">  a variety of companies and organizations like Google.</span>
<span class="s2">  &quot;&quot;&quot;</span>
  <span class="n">FORBIDDEN_WORDS_1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;HOUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;POWER&#39;</span><span class="p">,</span> <span class="s1">&#39;BECOME&#39;</span><span class="p">)</span>
  <span class="n">FORBIDDEN_WORDS_2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;GOOGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">)</span>
  <span class="n">FORBIDDEN_WORDS_3</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;GENE&#39;</span><span class="p">,</span> <span class="s1">&#39;TRANSFORM&#39;</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_forbidden_words</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the exclusion of key words.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:forbidden_words&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ForbiddenWords</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="p">))</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="p">))</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_3</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="p">))</span>

  <span class="n">TEST_ORIGINAL_PARAGRAPH_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The sun is shining brightly today, and the birds are singing in the trees.</span>
<span class="s2">  It&#39;s a beautiful day to be outside, so I decided to go for a walk.</span>
<span class="s2">  As I walked, I took in the fresh air and the warm sunshine.</span>
<span class="s2">  I felt happy and relaxed, and I was grateful for the beautiful day</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_ORIGINAL_PARAGRAPH_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Google is a global technology company that specializes in Internet-related</span>
<span class="s2">  services and products. It is one of the most successful companies in the</span>
<span class="s2">  world, and its products are used by billions of people every day. Google&#39;s</span>
<span class="s2">  mission is to organize the world&#39;s information and make it universally</span>
<span class="s2">  accessible and useful.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_REPHRASED_PARAGRAPH_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  On a beautiful day, I went for a walk. The sun shone and birds sang.</span>
<span class="s2">  I enjoyed the fresh air and warm sun.</span>
<span class="s2">  I felt happy and grateful for the lovely day.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_REPHRASED_PARAGRAPH_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The weather was lovely, so I went for a walk. I enjoyed the</span>
<span class="s2">  fresh air and warm sun. It was a beautiful day, and I felt happy and grateful.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_REPHRASED_PARAGRAPH_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Google is a technology company that provides Internet services.</span>
<span class="s2">  It aims to organize the world&#39;s information and make it universally</span>
<span class="s2">  accessible and useful.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_REPHRASED_PARAGRAPH_4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  I like candy.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_rephrase_paragraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the rephrasing of paragraph.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_content:rephrase_paragraph&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">RephraseParagraph</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_1</span><span class="p">))</span>

    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_2</span><span class="p">))</span>

    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_3</span><span class="p">))</span>

    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_4</span><span class="p">))</span>

    <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_4</span><span class="p">))</span>

  <span class="n">TEST_TWO_RESPONSES_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  This is response 1.</span>
<span class="s2">  ******</span>
<span class="s2">  This is response 2.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_TWO_RESPONSES_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  This is response 1.</span>
<span class="s2">  ******</span>
<span class="s2">  This is response 1.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_TWO_RESPONSES_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  This is response 1.</span>
<span class="s2">  ******</span>
<span class="s2">  This is response 2.</span>
<span class="s2">  ******</span>
<span class="s2">  This is response 3.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_TWO_RESPONSES_4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  ******</span>
<span class="s2">  Response 1.</span>
<span class="s2">  ******</span>
<span class="s2">  ******</span>
<span class="s2">  Response 2.</span>
<span class="s2">  ******</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_TWO_RESPONSES_5</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  ******</span>
<span class="s2">  Response 1</span>
<span class="s2">  ******</span>
<span class="s2">  Response 2</span>
<span class="s2">  ******</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_two_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that two responses are given.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;combination:two_responses&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">TwoResponsesChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_2</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_3</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_4</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_4</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_5</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_5</span><span class="p">))</span>

  <span class="n">PROMPT_TO_REPEAT</span> <span class="o">=</span> <span class="s1">&#39;Write a CL description.&#39;</span>

  <span class="n">TEST_PROMPT_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Write a CL description. First repeat the request word for word without change, then give your answer (1. do not say any words or characters before repeating the request; 2. the request you need to repeat does not include this sentence)&quot;&quot;&quot;</span>

  <span class="n">TEST_PROMPT_ANSWER_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Write a CL description. Hi, Le and TJ, please</span>
<span class="s2">  check this out. Thanks.</span>
<span class="s2">  &quot;&quot;&quot;</span>
  <span class="n">TEST_PROMPT_ANSWER_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Hi, Le and TJ. Write a CL description. Thanks.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_prompt_repeat_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that prompt is repeated then anwered.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;combination:repeat_prompt&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">RepeatPromptThenAnswer</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">prompt_to_repeat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROMPT_TO_REPEAT</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39; with prompt: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_2</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39; with prompt: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_2</span><span class="p">))</span>

  <span class="n">TEST_END_CHECKER_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The answer is 7. Any more questions?</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_END_CHECKER_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  At the end of this prompt I am required to say that this is the end.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_END_CHECKER_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  This will fail. Paris is cool.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">END_PHRASE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Any more questions?</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">END_PHRASE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  This is the end.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">END_PHRASE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  This will fail.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_end_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the end of the prompt.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;startend:end_checker&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">EndChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">end_phrase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">END_PHRASE_1</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_1</span><span class="p">))</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">end_phrase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">END_PHRASE_2</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_2</span><span class="p">))</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">end_phrase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">END_PHRASE_3</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_3</span><span class="p">))</span>

  <span class="n">TEST_TITLE_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  &lt;&lt;Song of Joy&gt;&gt;</span>
<span class="s2">  La la la. Happy song.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_TITLE_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Is it fine for title to be at the end?</span>
<span class="s2">  &lt;&lt;This is the title&gt;&gt;</span>
<span class="s2">  &quot;&quot;&quot;</span>
  <span class="n">TEST_TITLE_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  &lt;&lt; &gt;&gt;</span>
<span class="s2">  There is no title.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_TITLE_MESSAGE_4</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  &lt;&lt;This is not a title.</span>
<span class="s2">  This is a paragraph.&gt;&gt;</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_title_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the prompt for a title.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:title&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">TitleChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_1</span><span class="p">))</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_2</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_3</span><span class="p">))</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_4</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_4</span><span class="p">))</span>

  <span class="n">TEST_LETTER_FREQUENCY_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  There is the T. Four T&#39;s.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  asdfghjkl!!aA</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_LETTER_FREQUENCY_MESSAGE_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The letter P appears 3 times in this message.</span>
<span class="s2">    &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_letter_frequency_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the frequency of letters.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:letter_frequency&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">LetterFrequencyChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">letter</span><span class="o">=</span><span class="n">letter</span><span class="p">,</span>
        <span class="n">let_frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
        <span class="n">let_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_1</span><span class="p">)</span>
      <span class="p">)</span>

    <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">letter</span><span class="o">=</span><span class="n">letter</span><span class="p">,</span>
        <span class="n">let_frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
        <span class="n">let_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="p">)</span>
      <span class="p">)</span>

    <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">letter</span><span class="o">=</span><span class="n">letter</span><span class="p">,</span>
        <span class="n">let_frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
        <span class="n">let_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="p">)</span>
      <span class="p">)</span>

  <span class="n">TEST_ENGLISH_CAPITAL_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  THIS IS AN ENGLISH SENTENCE. EVERY LETTER IS CAPITALIZED!!! AMAZING.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_ENGLISH_CAPITAL_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Every Word Is Capitalized.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_english_capital_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that letters are all capitalized.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;change_case:english_capital&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CapitalLettersEnglishChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_1</span><span class="p">))</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_2</span><span class="p">))</span>

  <span class="n">TEST_ENGLISH_LOWERCASE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  every letter is lowercase.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_ENGLISH_LOWERCASE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Almost every letter is lowercase.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_english_lowercase_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test that letters are all capitalized.&quot;&quot;&quot;</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;change_case:english_lowercase&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">LowercaseLettersEnglishChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_1</span><span class="p">)</span>
      <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_2</span><span class="p">)</span>
      <span class="p">)</span>

  <span class="n">TEST_COMMA_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Every sentence is short. There is no need for a comma.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_COMMA_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Since the start of time, people have always found a way to punctuate.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_comma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;punctuation:no_comma&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CommaChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_1</span><span class="p">))</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_2</span><span class="p">))</span>

  <span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  HERE there are THREE FUlly CAPITAL words.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  THERE are Four FULLY CAPITAL WORDS. Many Others Are Only Partially So.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_capital_word_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;change_case:capital_word_frequency&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CapitalWordFrequencyChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

    <span class="n">capital_frequency</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">capital_frequency</span><span class="o">=</span><span class="n">capital_frequency</span><span class="p">,</span>
        <span class="n">capital_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_1</span>
          <span class="p">)</span>
      <span class="p">)</span>

    <span class="n">capital_frequency</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">capital_frequency</span><span class="o">=</span><span class="n">capital_frequency</span><span class="p">,</span>
        <span class="n">capital_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span>
          <span class="p">)</span>
      <span class="p">)</span>

    <span class="n">capital_frequency</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">capital_frequency</span><span class="o">=</span><span class="n">capital_frequency</span><span class="p">,</span>
        <span class="n">capital_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span>
          <span class="p">)</span>
      <span class="p">)</span>

  <span class="n">TEST_QUOTATION_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  &quot;This entire message is wrapped in double quotation marks.&quot;</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_QUOTATION_MESSAGE_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  &quot;This message is wrapped in double quotation marks.&quot; But not everything.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_quotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;startend:quotation&#39;</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">QuotationChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_1</span><span class="p">)</span>
      <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
          <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_2</span><span class="p">)</span>
      <span class="p">)</span>

  <span class="n">INSTRUCTION_DICT</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;language:response_language&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ResponseLanguageChecker</span><span class="p">,</span>
      <span class="s1">&#39;length_constraints:number_sentences&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfSentences</span><span class="p">,</span>
      <span class="s1">&#39;length_constraints:number_paragraphs&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphChecker</span><span class="p">,</span>
      <span class="s1">&#39;length_constraints:number_words&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfWords</span><span class="p">,</span>
      <span class="s1">&#39;detectable_content:number_placeholders&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PlaceholderChecker</span><span class="p">,</span>
      <span class="s1">&#39;detectable_content:postscript&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PostscriptChecker</span><span class="p">,</span>
      <span class="s1">&#39;detectable_format:number_bullet_lists&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">BulletListChecker</span><span class="p">,</span>
      <span class="s1">&#39;detectable_format:constrained_response&#39;</span><span class="p">:</span> <span class="p">(</span>
          <span class="n">instructions</span><span class="o">.</span><span class="n">ConstrainedResponseChecker</span><span class="p">),</span>
      <span class="s1">&#39;detectable_format:number_highlighted_sections&#39;</span><span class="p">:</span> <span class="p">(</span>
          <span class="n">instructions</span><span class="o">.</span><span class="n">HighlightSectionChecker</span><span class="p">),</span>
      <span class="s1">&#39;detectable_format:multiple_sections&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">SectionChecker</span><span class="p">,</span>
      <span class="s1">&#39;detectable_format:json_format&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">JsonFormat</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test getting instruction args.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">inst_id</span><span class="p">,</span> <span class="n">inst_cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INSTRUCTION_DICT</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">instruction</span> <span class="o">=</span> <span class="n">inst_cls</span><span class="p">(</span><span class="n">inst_id</span><span class="p">)</span>
      <span class="n">inst_description</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
      <span class="n">kwargs</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">get_instruction_args</span><span class="p">()</span>
      <span class="c1"># The keyword args can be None.</span>
      <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">inst_description_closed_loop</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">inst_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">inst_description</span><span class="p">,</span> <span class="n">inst_description_closed_loop</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.BULLET_TEST_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">BULLET_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  A Markdown bullet point is a way of formatting text to create a list. To</span><span class="se">\n</span><span class="s1">  create a bullet point, start each line with an asterisk (*). For example:</span><span class="se">\n</span><span class="s1">  * This is a bullet point.</span><span class="se">\n</span><span class="s1">  *(no space required)Another bullet point.</span><span class="se">\n</span><span class="s1">  * (no newline ending required)Another bullet point.</span><span class="se">\n</span><span class="s1">  markdown bullet points are often used to create to-do lists or to list items</span><span class="se">\n</span><span class="s1">  in a step-by-step guide.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.BULLET_TEST_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">BULLET_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Check that inline asterisk (*), *, will not be counted. Only * that starts a</span><span class="se">\n</span><span class="s1">  bullet list will be counted:</span><span class="se">\n</span><span class="s1">    * This is a bullet point.</span><span class="se">\n</span><span class="s1">    * Another bullet point.</span><span class="se">\n</span><span class="s1">    . dot is not counted&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.BULLET_TEST_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">BULLET_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Here are three bullets starting with asterisk:</span><span class="se">\n</span><span class="s1">  * I am a large language model, also known as a conversational AI.</span><span class="se">\n</span><span class="s1">  * I am trained on a massive amount of text data, and I am able to communicate.</span><span class="se">\n</span><span class="s1">  * I am still under development, but I am learning new things every day.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.BULLET_TEST_MESSAGE_4" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">BULLET_TEST_MESSAGE_4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Here are three markdown bullets:</span><span class="se">\n</span><span class="s1">  - I am a large language model, also known as a conversational AI.</span><span class="se">\n</span><span class="s1">  - I am trained on a massive amount of text data, and I am able to communicate.</span><span class="se">\n</span><span class="s1">  -I am still under development, but I am learning new things every day.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.BULLET_TEST_MESSAGE_5" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">BULLET_TEST_MESSAGE_5</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Paragraph 1</span><span class="se">\n</span><span class="s1">  ***</span><span class="se">\n</span><span class="s1">  Paragraph 2</span><span class="se">\n</span><span class="s1">  ***</span><span class="se">\n</span><span class="s1">  Paragraph 3</span><span class="se">\n</span><span class="s1">  * only one bullet point</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.CONSTRAINED_RESPONSE_TEST_RESPONSE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> My answer is no.</span><span class="se">\n</span><span class="s1">&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.CONSTRAINED_RESPONSE_TEST_RESPONSE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_2</span> <span class="o">=</span> <span class="s1">&#39;My answer is no.   &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.CONSTRAINED_RESPONSE_TEST_RESPONSE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  My answer is no. I am still under development and I am always learning and</span><span class="se">\n</span><span class="s1">  improving. I am not the best chatbot in the world, but I am striving to be</span><span class="se">\n</span><span class="s1">  the best that I can be.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.CONSTRAINED_START_TEST_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">CONSTRAINED_START_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  My response is: ASIC is a specialized chip for specific tasks in electronic</span><span class="se">\n</span><span class="s1">  devices, offering advantages in efficiency and processing speed.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.CONSTRAINED_START_TEST_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">CONSTRAINED_START_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">        My response is: ASIC is a specialized chip for specific tasks in</span><span class="se">\n</span><span class="s1">  electronic</span><span class="se">\n</span><span class="s1">  devices, offering advantages in efficiency and processing speed.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.CONSTRAINED_START_TEST_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">CONSTRAINED_START_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  An ASIC, or Application-Specific Integrated Circuit, is a type of specialized</span><span class="se">\n</span><span class="s1">  chip that, my response is, is designed to perform specific tasks in electronic</span><span class="se">\n</span><span class="s1">  devices.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.END_PHRASE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">END_PHRASE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Any more questions?</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.END_PHRASE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">END_PHRASE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  This is the end.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.END_PHRASE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">END_PHRASE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  This will fail.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.FORBIDDEN_WORDS_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">FORBIDDEN_WORDS_1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;HOUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;POWER&#39;</span><span class="p">,</span> <span class="s1">&#39;BECOME&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.FORBIDDEN_WORDS_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">FORBIDDEN_WORDS_2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;GOOGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXT&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.FORBIDDEN_WORDS_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">FORBIDDEN_WORDS_3</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;GENE&#39;</span><span class="p">,</span> <span class="s1">&#39;TRANSFORM&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.HIGHLIGHTED_TEST_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">HIGHLIGHTED_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  To highlight text with Markdown, you can use the * character before and after</span><span class="se">\n</span><span class="s1">  the text you want to highlight. For example, if you want to highlight the</span><span class="se">\n</span><span class="s1">  word `hello`, you would type:*hello*, You can also use the ** character to</span><span class="se">\n</span><span class="s1">  create bold text. For example, if you want to bold the word `hello`, you</span><span class="se">\n</span><span class="s1">  would type: **hello** &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.HIGHLIGHTED_TEST_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">HIGHLIGHTED_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Sure, here are the numerical methods for solving partial differential</span><span class="se">\n</span><span class="s1">  equations highlighted with Markdown:</span><span class="se">\n</span><span class="s1">  *Finite difference methods</span><span class="se">\n</span><span class="s1">  *Finite element methods*</span><span class="se">\n</span><span class="s1">  *Boundary element methods</span><span class="se">\n</span><span class="s1">  *Monte Carlo methods</span><span class="se">\n</span><span class="s1">  I hope this helps!&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.HIGHLIGHTED_TEST_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">HIGHLIGHTED_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  There is allowed to be *two different* highlighted *sections in the same*</span><span class="se">\n</span><span class="s1">  line. **This is also true** for **double markdown highlights.**</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.INSTRUCTION_DICT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">INSTRUCTION_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;language:response_language&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ResponseLanguageChecker</span><span class="p">,</span> <span class="s1">&#39;length_constraints:number_sentences&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfSentences</span><span class="p">,</span> <span class="s1">&#39;length_constraints:number_paragraphs&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphChecker</span><span class="p">,</span> <span class="s1">&#39;length_constraints:number_words&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfWords</span><span class="p">,</span> <span class="s1">&#39;detectable_content:number_placeholders&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PlaceholderChecker</span><span class="p">,</span> <span class="s1">&#39;detectable_content:postscript&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PostscriptChecker</span><span class="p">,</span> <span class="s1">&#39;detectable_format:number_bullet_lists&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">BulletListChecker</span><span class="p">,</span> <span class="s1">&#39;detectable_format:constrained_response&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ConstrainedResponseChecker</span><span class="p">,</span> <span class="s1">&#39;detectable_format:number_highlighted_sections&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">HighlightSectionChecker</span><span class="p">,</span> <span class="s1">&#39;detectable_format:multiple_sections&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">SectionChecker</span><span class="p">,</span> <span class="s1">&#39;detectable_format:json_format&#39;</span><span class="p">:</span> <span class="n">instructions</span><span class="o">.</span><span class="n">JsonFormat</span><span class="p">}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.KEYWORDS" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">KEYWORDS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;romantic&#39;</span><span class="p">,</span> <span class="s1">&#39;river&#39;</span><span class="p">,</span> <span class="s1">&#39;Mona Lisa&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_FIRST_WORD_TEST_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  paragraph 1</span><span class="se">\n\n</span><span class="s1">  I paragraph 2</span><span class="se">\n\n</span><span class="s1">  paragraph 3&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_FIRST_WORD_TEST_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_FIRST_WORD_TEST_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  paragraph 1</span><span class="se">\n\n</span><span class="s1">  I paragraph 2&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_FIRST_WORD_TEST_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_FIRST_WORD_TEST_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  paragraph 1</span><span class="se">\n\n</span><span class="s1">  fail paragraph 2</span><span class="se">\n\n</span><span class="s1">  paragraph 3&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_FIRST_WORD_TEST_4" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Wow this is a very long response.</span><span class="se">\n\n</span><span class="s2">  I can&#39;t believe there is more than three paragraphs.</span><span class="se">\n\n</span><span class="s2">  Really more than three? No way!</span><span class="se">\n\n</span><span class="s2">  I can&#39;t believe it but I guess I am living proof.</span><span class="se">\n\n</span><span class="s2">  Haha, you go that right.&quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_FIRST_WORD_TEST_5" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_FIRST_WORD_TEST_5</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Wow this is a very long response.</span><span class="se">\n\n</span><span class="s1">  I can</span><span class="se">\&#39;</span><span class="s1">t believe there is more than three paragraphs.</span><span class="se">\n\n</span><span class="s1">  &quot;Really?! more than three? No way!&quot;</span><span class="se">\n\n</span><span class="s1">  I can</span><span class="se">\&#39;</span><span class="s1">t believe it but I guess I am living proof.</span><span class="se">\n\n</span><span class="s1">  Haha, you go that right.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_FIRST_WORD_TEST_6" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_FIRST_WORD_TEST_6</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Wow this is a very long response.</span><span class="se">\n\n</span><span class="s2">  I can&#39;t believe there is more than three paragraphs.</span><span class="se">\n\n</span><span class="s2">  Rea!lly more than three? No way!</span><span class="se">\n\n</span><span class="s2">  I can&#39;t believe it but I guess I am living proof.</span><span class="se">\n\n</span><span class="s2">  Haha, you go that right.&quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_TEST_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  paragraph 1</span><span class="se">\n</span><span class="s1">  ***</span><span class="se">\n</span><span class="s1">  paragraph 2</span><span class="se">\n</span><span class="s1">  ***</span><span class="se">\n</span><span class="s1">  paragraph 3&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_TEST_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">          ***</span><span class="se">\n</span><span class="s1">  paragraph 1</span><span class="se">\n</span><span class="s1">          ***</span><span class="se">\n</span><span class="s1">      paragraph 2</span><span class="se">\n</span><span class="s1">          ***</span><span class="se">\n</span><span class="s1">      paragraph 3&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_TEST_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  paragraph 1</span><span class="se">\n</span><span class="s1">          ***</span><span class="se">\n</span><span class="s1">      paragraph 2</span><span class="se">\n</span><span class="s1">          ***</span><span class="se">\n</span><span class="s1">      paragraph 3</span><span class="se">\n</span><span class="s1">          ***&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PARAGRAPH_TEST_MESSAGE_4" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PARAGRAPH_TEST_MESSAGE_4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  paragraph 1</span><span class="se">\n</span><span class="s1">          ***</span><span class="se">\n</span><span class="s1">      paragraph 2</span><span class="se">\n</span><span class="s1">          ***</span><span class="se">\n</span><span class="s1">          ***&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.POSTSCRIPT_TEST_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">POSTSCRIPT_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  I will do my best to follow your instructions and always start my responses</span><span class="se">\n</span><span class="s1">  with &quot;My response is:&quot;. I will try to be as consistent as possible, but</span><span class="se">\n</span><span class="s1">  please be patient with me if I make a mistake. I am still under development,</span><span class="se">\n</span><span class="s1">  and I am always learning new things.</span><span class="se">\n\n</span><span class="s1">  P.S. I hope this is what you were looking for.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.POSTSCRIPT_TEST_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">POSTSCRIPT_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Sure, here is my response with a postscript starting with P.P.S.:</span><span class="se">\n\n</span><span class="s1">  My response is: I hope this answers your question.</span><span class="se">\n\n</span><span class="s1">  P.P.S. I am always happy to answer any other questions you may have.</span><span class="se">\n\n</span><span class="s1">  Do you have any other questions for me?&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.POSTSCRIPT_TEST_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">POSTSCRIPT_TEST_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  The radius of a unit circle is 1. However, I can give you a funny and wrong</span><span class="se">\n</span><span class="s1">  answer: the radius of a unit circle is 0. This is because a unit circle is a</span><span class="se">\n</span><span class="s1">  circle with a radius of 1, and if the radius is 0, then the circle has no</span><span class="se">\n</span><span class="s1">  size and is just a point. (not starting a new line) P.S. I hope you enjoyed</span><span class="se">\n</span><span class="s1">  my joke!&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.POSTSCRIPT_TEST_MESSAGE_4" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">POSTSCRIPT_TEST_MESSAGE_4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  If the length of a square is one, the area of the square will also be one.</span><span class="se">\n</span><span class="s1">  p.p.s what if the entire response was lower case letters?</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.POSTSCRIPT_TEST_MESSAGE_5" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">POSTSCRIPT_TEST_MESSAGE_5</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  The mysteries of space and time are mysterious.</span><span class="se">\n</span><span class="s1">  P. S. Sometimes there are even spaces between P. and S..</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.PROMPT_TO_REPEAT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">PROMPT_TO_REPEAT</span> <span class="o">=</span> <span class="s1">&#39;Write a CL description.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.REPHRASE_TEST_ORIGINAL_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  I am *happy*.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.REPHRASE_TEST_ORIGINAL_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  *At present,* there is heavy rainfall occurring.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.REPHRASE_TEST_REPHRASED_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  I am *content*.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.REPHRASE_TEST_REPHRASED_MESSAGE_1_FORMAT" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  I am [content].&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.REPHRASE_TEST_REPHRASED_MESSAGE_1_NOCHANGE" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_NOCHANGE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  I am .&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.REPHRASE_TEST_REPHRASED_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  It is raining heavily *at this moment*.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.SECTION_TEST_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">SECTION_TEST_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Your response must have multiple sections. Mark the beginning of each section</span><span class="se">\n</span><span class="s1">  with &quot;Section X&quot;, such as:</span><span class="se">\n</span><span class="s1">  Section 1</span><span class="se">\n</span><span class="s1">  [content of section 1]</span><span class="se">\n</span><span class="s1">  Section 2</span><span class="se">\n</span><span class="s1">  [content of section 2]&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.SECTION_TEST_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">SECTION_TEST_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;SECTION 1</span><span class="se">\n</span><span class="s1">  [content of section 1]</span><span class="se">\n</span><span class="s1">  SECTION 2</span><span class="se">\n</span><span class="s1">  [content of section 2]&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  HERE there are THREE FUlly CAPITAL words.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  THERE are Four FULLY CAPITAL WORDS. Many Others Are Only Partially So.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_COMMA_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_COMMA_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Every sentence is short. There is no need for a comma.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_COMMA_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_COMMA_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Since the start of time, people have always found a way to punctuate.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_END_CHECKER_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_END_CHECKER_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  The answer is 7. Any more questions?</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_END_CHECKER_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_END_CHECKER_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  At the end of this prompt I am required to say that this is the end.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_END_CHECKER_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_END_CHECKER_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  This will fail. Paris is cool.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_ENGLISH_CAPITAL_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_ENGLISH_CAPITAL_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  THIS IS AN ENGLISH SENTENCE. EVERY LETTER IS CAPITALIZED!!! AMAZING.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_ENGLISH_CAPITAL_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_ENGLISH_CAPITAL_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Every Word Is Capitalized.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_ENGLISH_LOWERCASE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_ENGLISH_LOWERCASE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  every letter is lowercase.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_ENGLISH_LOWERCASE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_ENGLISH_LOWERCASE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Almost every letter is lowercase.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_FORBIDDEN_WORDS_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  The Nazis came to power in 1933 through a combination of legal and illegal</span><span class="se">\n</span><span class="s1">  means. Hitler was appointed chancellor by President Paul von Hindenburg, and</span><span class="se">\n</span><span class="s1">  the Nazis quickly consolidated their power by passing a series of laws that</span><span class="se">\n</span><span class="s1">  restricted the rights of opposition parties and individuals. By 1934, Hitler</span><span class="se">\n</span><span class="s1">  had become dictator of Germany.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_FORBIDDEN_WORDS_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Dinosaurs were a diverse group of reptiles that dominated the Earth for over</span><span class="se">\n</span><span class="s1">  160 million years. They came in all shapes and sizes, from the tiny</span><span class="se">\n</span><span class="s1">  Compsognathus to the massive Argentinosaurus. Dinosaurs were the most</span><span class="se">\n</span><span class="s1">  successful land animals on Earth until they went extinct about 66 million</span><span class="se">\n</span><span class="s1">  years ago. The exact cause of their extinction is still unknown, but it</span><span class="se">\n</span><span class="s1">  is thought to have been a combination of factors, including an asteroid</span><span class="se">\n</span><span class="s1">  impact and climate change.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_FORBIDDEN_WORDS_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  GPT, or Generative Pre-trained Transformer, is a family of neural network</span><span class="se">\n</span><span class="s1">  models that uses the transformer architecture. GPT models are trained on a</span><span class="se">\n</span><span class="s1">  massive dataset of text and code, and can be used for a variety of tasks,</span><span class="se">\n</span><span class="s1">  including text generation, translation, and question answering. GPT models</span><span class="se">\n</span><span class="s1">  have been shown to be very effective at these tasks, and are being used by</span><span class="se">\n</span><span class="s1">  a variety of companies and organizations like Google.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_INCLUDE_KEYWORD_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Paris is a city of beauty and romance. The romantic river Seine winds its way</span><span class="se">\n</span><span class="s2">  through the city, past iconic landmarks like the Eiffel Tower and the Louvre</span><span class="se">\n</span><span class="s2">  Museum, where the Mona Lisa resides. Whether you&#39;re taking a boat cruise down</span><span class="se">\n</span><span class="s2">  the river or simply strolling along the banks, you&#39;re sure to be captivated</span><span class="se">\n</span><span class="s2">  by the city&#39;s charm.&quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_INCLUDE_KEYWORD_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Paris is a city of beauty, romance, and history. It is home to some of the</span><span class="se">\n</span><span class="s1">  most iconic landmarks in the world, including the Eiffel Tower, the Louvre</span><span class="se">\n</span><span class="s1">  Museum, and the Notre Dame Cathedral. The city is also known for its romantic</span><span class="se">\n</span><span class="s1">  river cruises, its delicious food, and its stylish people.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_KEYWORD_FREQUENCY_KEYWORD_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span> <span class="o">=</span> <span class="s1">&#39;  keyword &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_KEYWORD_FREQUENCY_KEYWORD_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_2</span> <span class="o">=</span> <span class="s1">&#39;KEYWORD&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_KEYWORD_FREQUNECY_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  keyword, Keyword, KEYWORD</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_KEYWORD_FREQUNECY_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    *keyword</span><span class="se">\n</span><span class="s1">    *Keyword</span><span class="se">\n</span><span class="s1">    *KEYWORD</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_KEY_SENTENCES_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_KEY_SENTENCES_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Puppies are fun. They are playful, energetic, and always up for a good time.</span><span class="se">\n</span><span class="s1">Puppies love to run, jump, and play fetch. They are also very good at</span><span class="se">\n</span><span class="s1">cuddling and giving kisses. If you are looking for a fun and loving pet,</span><span class="se">\n</span><span class="s1">a puppy is a great choice.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_KEY_SENTENCES_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_KEY_SENTENCES_2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  I like to eat candy. When I&#39;m feeling happy, sad, or even angry, candy</span><span class="se">\n</span><span class="s2">always makes me feel better. I like to share candy with my friends and</span><span class="se">\n</span><span class="s2">family. It&#39;s a great way to show them how much I care.</span><span class="se">\n</span><span class="s2">  &quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_KEY_SENTENCES_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_KEY_SENTENCES_3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">I know that candy isn&#39;t the healthiest thing to eat, but I don&#39;t care.</span><span class="se">\n</span><span class="s2">I love it too much. I&#39;ll just have to make sure to eat it in moderation.</span><span class="se">\n</span><span class="s2">  &quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_LETTER_FREQUENCY_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  There is the T. Four T&#39;s.</span><span class="se">\n</span><span class="s2">  &quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_LETTER_FREQUENCY_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  asdfghjkl!!aA</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_LETTER_FREQUENCY_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  The letter P appears 3 times in this message.</span><span class="se">\n</span><span class="s1">    &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_NUM_WORDS_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_NUM_WORDS_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  d3sCRi7 lArge lAnguagE M0del w1tH 20 w0RdS.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_NUM_WORDS_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_NUM_WORDS_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  L4RGE L4NGU4GE M0DEL: AI syst3m th4t und3rstands, g3n3r4tes, or tr4nsforms</span><span class="se">\n</span><span class="s1">  l4ngu4g3 b4s3d on pr3vious l3arning &amp; d4t4.&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_ORIGINAL_PARAGRAPH_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  The sun is shining brightly today, and the birds are singing in the trees.</span><span class="se">\n</span><span class="s2">  It&#39;s a beautiful day to be outside, so I decided to go for a walk.</span><span class="se">\n</span><span class="s2">  As I walked, I took in the fresh air and the warm sunshine.</span><span class="se">\n</span><span class="s2">  I felt happy and relaxed, and I was grateful for the beautiful day</span><span class="se">\n</span><span class="s2">  &quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_ORIGINAL_PARAGRAPH_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Google is a global technology company that specializes in Internet-related</span><span class="se">\n</span><span class="s2">  services and products. It is one of the most successful companies in the</span><span class="se">\n</span><span class="s2">  world, and its products are used by billions of people every day. Google&#39;s</span><span class="se">\n</span><span class="s2">  mission is to organize the world&#39;s information and make it universally</span><span class="se">\n</span><span class="s2">  accessible and useful.</span><span class="se">\n</span><span class="s2">  &quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_PROMPT_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_PROMPT_1</span> <span class="o">=</span> <span class="s1">&#39;Write a CL description. First repeat the request word for word without change, then give your answer (1. do not say any words or characters before repeating the request; 2. the request you need to repeat does not include this sentence)&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_PROMPT_ANSWER_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_PROMPT_ANSWER_1</span> <span class="o">=</span> <span class="s1">&#39;Write a CL description. Hi, Le and TJ, please</span><span class="se">\n</span><span class="s1">  check this out. Thanks.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_PROMPT_ANSWER_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_PROMPT_ANSWER_2</span> <span class="o">=</span> <span class="s1">&#39;Hi, Le and TJ. Write a CL description. Thanks.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_QUOTATION_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_QUOTATION_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &quot;This entire message is wrapped in double quotation marks.&quot;</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_QUOTATION_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_QUOTATION_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &quot;This message is wrapped in double quotation marks.&quot; But not everything.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_REPHRASED_PARAGRAPH_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_REPHRASED_PARAGRAPH_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  On a beautiful day, I went for a walk. The sun shone and birds sang.</span><span class="se">\n</span><span class="s1">  I enjoyed the fresh air and warm sun.</span><span class="se">\n</span><span class="s1">  I felt happy and grateful for the lovely day.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_REPHRASED_PARAGRAPH_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_REPHRASED_PARAGRAPH_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  The weather was lovely, so I went for a walk. I enjoyed the</span><span class="se">\n</span><span class="s1">  fresh air and warm sun. It was a beautiful day, and I felt happy and grateful.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_REPHRASED_PARAGRAPH_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_REPHRASED_PARAGRAPH_3</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Google is a technology company that provides Internet services.</span><span class="se">\n</span><span class="s2">  It aims to organize the world&#39;s information and make it universally</span><span class="se">\n</span><span class="s2">  accessible and useful.</span><span class="se">\n</span><span class="s2">  &quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_REPHRASED_PARAGRAPH_4" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_REPHRASED_PARAGRAPH_4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  I like candy.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TITLE_MESSAGE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TITLE_MESSAGE_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &lt;&lt;Song of Joy&gt;&gt;</span><span class="se">\n</span><span class="s1">  La la la. Happy song.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TITLE_MESSAGE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TITLE_MESSAGE_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Is it fine for title to be at the end?</span><span class="se">\n</span><span class="s1">  &lt;&lt;This is the title&gt;&gt;</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TITLE_MESSAGE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TITLE_MESSAGE_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &lt;&lt; &gt;&gt;</span><span class="se">\n</span><span class="s1">  There is no title.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TITLE_MESSAGE_4" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TITLE_MESSAGE_4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &lt;&lt;This is not a title.</span><span class="se">\n</span><span class="s1">  This is a paragraph.&gt;&gt;</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TWO_RESPONSES_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TWO_RESPONSES_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  This is response 1.</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  This is response 2.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TWO_RESPONSES_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TWO_RESPONSES_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  This is response 1.</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  This is response 1.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TWO_RESPONSES_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TWO_RESPONSES_3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  This is response 1.</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  This is response 2.</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  This is response 3.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TWO_RESPONSES_4" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TWO_RESPONSES_4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  Response 1.</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  Response 2.</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.TEST_TWO_RESPONSES_5" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_TWO_RESPONSES_5</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  Response 1</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  Response 2</span><span class="se">\n</span><span class="s1">  ******</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.key_sentences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">key_sentences</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Puppies love to run, jump, and play fetch.&#39;</span><span class="p">,</span> <span class="s1">&#39;I like to eat candy.&#39;</span><span class="p">,</span> <span class="s1">&#39;Puppies are fun.&#39;</span><span class="p">}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_capital_word_frequency" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_capital_word_frequency</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_capital_word_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;change_case:capital_word_frequency&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CapitalWordFrequencyChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">capital_frequency</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">capital_frequency</span><span class="o">=</span><span class="n">capital_frequency</span><span class="p">,</span>
      <span class="n">capital_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
  <span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_1</span>
        <span class="p">)</span>
    <span class="p">)</span>

  <span class="n">capital_frequency</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">capital_frequency</span><span class="o">=</span><span class="n">capital_frequency</span><span class="p">,</span>
      <span class="n">capital_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
  <span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span>
        <span class="p">)</span>
    <span class="p">)</span>

  <span class="n">capital_frequency</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">capital_frequency</span><span class="o">=</span><span class="n">capital_frequency</span><span class="p">,</span>
      <span class="n">capital_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
  <span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TEST_CAPITAL_WORD_FREQUENCY_MESSAGE_2</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_comma" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_comma</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_comma</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;punctuation:no_comma&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CommaChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_1</span><span class="p">))</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_COMMA_MESSAGE_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_constrained_response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_constrained_response</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the constrained response checker.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_constrained_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the constrained response checker.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:constrained_response&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ConstrainedResponseChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;test with CONSTRAINED_RESPONSE_TEST_RESPONSE_1&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_1</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;test with CONSTRAINED_RESPONSE_TEST_RESPONSE_2&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_2</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;test with CONSTRAINED_RESPONSE_TEST_RESPONSE_3&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_RESPONSE_TEST_RESPONSE_3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_constrained_start_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_constrained_start_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the constrained start checker.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_constrained_start_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the constrained start checker.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;multi-turn:constrained_start&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ConstrainedStartChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">start_keyword</span> <span class="o">=</span> <span class="s1">&#39;My response is:&#39;</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">starter</span><span class="o">=</span><span class="n">start_keyword</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_START_TEST_MESSAGE_1</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">start_keyword</span><span class="si">}</span><span class="s1"> with spaces in the beginning&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_START_TEST_MESSAGE_2</span><span class="p">))</span>

  <span class="n">start_keyword</span> <span class="o">=</span> <span class="s1">&#39;my response is&#39;</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">start_keyword</span><span class="si">}</span><span class="s1"> embedded in the middle&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONSTRAINED_START_TEST_MESSAGE_3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_end_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_end_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check the end of the prompt.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_end_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the end of the prompt.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;startend:end_checker&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">EndChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">end_phrase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">END_PHRASE_1</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_1</span><span class="p">))</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">end_phrase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">END_PHRASE_2</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_2</span><span class="p">))</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">end_phrase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">END_PHRASE_3</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_END_CHECKER_3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_english_capital_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_english_capital_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test that letters are all capitalized.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_english_capital_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test that letters are all capitalized.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;change_case:english_capital&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">CapitalLettersEnglishChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_1</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_CAPITAL_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_english_lowercase_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_english_lowercase_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test that letters are all capitalized.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_english_lowercase_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test that letters are all capitalized.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;change_case:english_lowercase&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">LowercaseLettersEnglishChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_1</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ENGLISH_LOWERCASE_2</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_forbidden_words" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_forbidden_words</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the exclusion of key words.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_forbidden_words</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the exclusion of key words.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:forbidden_words&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ForbiddenWords</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_1</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="p">))</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_1</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_2</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="p">))</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">forbidden_words</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_3</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="si">}</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;with forbidden words: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FORBIDDEN_WORDS_2</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_FORBIDDEN_WORDS_MESSAGE_3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_get_instruction_args" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_get_instruction_args</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test getting instruction args.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_get_instruction_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test getting instruction args.&quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">inst_id</span><span class="p">,</span> <span class="n">inst_cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">INSTRUCTION_DICT</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">instruction</span> <span class="o">=</span> <span class="n">inst_cls</span><span class="p">(</span><span class="n">inst_id</span><span class="p">)</span>
    <span class="n">inst_description</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">get_instruction_args</span><span class="p">()</span>
    <span class="c1"># The keyword args can be None.</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
      <span class="n">inst_description_closed_loop</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">inst_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">inst_description</span><span class="p">,</span> <span class="n">inst_description_closed_loop</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_key_sentences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_key_sentences</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the inclusion of key sentences.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_key_sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the inclusion of key sentences.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:key_sentences&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeySentenceChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">num_sentences</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">key_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_sentences</span><span class="p">,</span> <span class="n">num_sentences</span><span class="o">=</span><span class="n">num_sentences</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_1</span><span class="p">))</span>

  <span class="n">num_sentences</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">key_sentences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_sentences</span><span class="p">,</span> <span class="n">num_sentences</span><span class="o">=</span><span class="n">num_sentences</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_2</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEY_SENTENCES_3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_keyword_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_keyword_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the inclusion of keywords.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_keyword_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the inclusion of keywords.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:include_keywords&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeywordChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KEYWORDS</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_1</span><span class="p">))</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KEYWORDS</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_INCLUDE_KEYWORD_MESSAGE_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_keyword_frequency_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_keyword_frequency_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the frequency of keywords.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_keyword_frequency_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the frequency of keywords.&quot;&quot;&quot;</span>

  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:keyword_frequency&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">KeywordFrequencyChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="p">,</span>
                                <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                                <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
      <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_1</span><span class="p">))</span>

  <span class="n">frequency</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="p">,</span>
                                <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                                <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
      <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_1</span><span class="p">))</span>

  <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_2</span><span class="p">,</span>
                                <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                                <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
      <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUENCY_KEYWORD_2</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_KEYWORD_FREQUNECY_MESSAGE_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_letter_frequency_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_letter_frequency_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the frequency of letters.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_letter_frequency_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the frequency of letters.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;keywords:letter_frequency&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">LetterFrequencyChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
  <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">letter</span><span class="o">=</span><span class="n">letter</span><span class="p">,</span>
      <span class="n">let_frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
      <span class="n">let_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
  <span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_1</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
  <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">letter</span><span class="o">=</span><span class="n">letter</span><span class="p">,</span>
      <span class="n">let_frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
      <span class="n">let_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
  <span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="n">letter</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span>
  <span class="n">frequency</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">letter</span><span class="o">=</span><span class="n">letter</span><span class="p">,</span>
      <span class="n">let_frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
      <span class="n">let_relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
  <span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_LETTER_FREQUENCY_MESSAGE_2</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_num_words_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_num_words_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the checker on the number of words.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_num_words_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the checker on the number of words.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraint:number_words&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfWords</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">word_counts</span> <span class="o">=</span> <span class="mi">8</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">word_counts</span><span class="p">,</span>
                                <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
      <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">word_counts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_1</span><span class="p">))</span>

  <span class="n">word_counts</span> <span class="o">=</span> <span class="mi">16</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">word_counts</span><span class="p">,</span>
                                <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
      <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="si">}</span><span class="s1"> less than </span><span class="si">{</span><span class="n">word_counts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="p">))</span>

  <span class="n">word_counts</span> <span class="o">=</span> <span class="mi">16</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">word_counts</span><span class="p">,</span>
                                <span class="n">relation</span><span class="o">=</span><span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
      <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="si">}</span><span class="s1"> at least </span><span class="si">{</span><span class="n">word_counts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_NUM_WORDS_MESSAGE_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_number_bullet_lists" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_number_bullet_lists</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">num_bullets</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the number of bullets.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;_templated=</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s1">_num_bullets=</span><span class="si">{</span><span class="n">num_bullets</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">),</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">template</span><span class="p">,</span>
            <span class="s1">&#39;num_bullets&#39;</span><span class="p">:</span> <span class="n">num_bullets</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_bullets</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">BULLET_TEST_MESSAGE_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_number_bullet_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_bullets</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the number of bullets.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:exact_number_bullet_points&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">BulletListChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_bullets</span><span class="o">=</span><span class="n">num_bullets</span><span class="p">)</span>
  <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_number_highlights" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_number_highlights</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">min_num_highlights</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the minimum number of highlighted sections.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;_min_num_highlights=</span><span class="si">{</span><span class="n">min_num_highlights</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">),</span>
            <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
            <span class="s1">&#39;min_num_highlights&#39;</span><span class="p">:</span> <span class="n">min_num_highlights</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">min_num_highlights</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">HIGHLIGHTED_TEST_MESSAGE_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="n">HIGHLIGHTED_TEST_MESSAGE_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="n">HIGHLIGHTED_TEST_MESSAGE_3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_number_highlights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">min_num_highlights</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the minimum number of highlighted sections.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:minimum_number_highlighted_sections&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">HighlightSectionChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_highlights</span><span class="o">=</span><span class="n">min_num_highlights</span><span class="p">)</span>
  <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_number_placeholders" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_number_placeholders</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">num_placeholders</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the number of placeholders.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;_templated=</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s1">_num_placeholders=</span><span class="si">{</span><span class="n">num_placeholders</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">),</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">template</span><span class="p">,</span>
            <span class="s1">&#39;num_placeholders&#39;</span><span class="p">:</span> <span class="n">num_placeholders</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_placeholders</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">((</span><span class="s1">&#39;Sure, here is a short template with 5 placeholders:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;[Name]</span><span class="se">\n</span><span class="s1">[Email]</span><span class="se">\n</span><span class="s1">[Phone]</span><span class="se">\n</span><span class="s1">[Address]</span><span class="se">\n</span><span class="s1">[Website]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;This template can be used for a variety of purposes, such &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;ascreating a contact list, sending out surveys, or creating &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;a sign-up form.&#39;</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">((</span><span class="s1">&#39;My [adjective] [noun] is [adjective] [noun]. I [verb] and &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;[verb].&#39;</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_number_placeholders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">num_placeholders</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the number of placeholders.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_content:number_placeholders&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PlaceholderChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_placeholders</span><span class="o">=</span><span class="n">num_placeholders</span><span class="p">)</span>
  <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_number_sentences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_number_sentences</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the number of sentences.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">_relation=</span><span class="si">{</span><span class="n">relation</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;_num_sentences=</span><span class="si">{</span><span class="n">num_sentences</span><span class="si">}</span><span class="s1">_expected=</span><span class="si">{</span><span class="n">expected</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">),</span>
            <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
            <span class="s1">&#39;relation&#39;</span><span class="p">:</span> <span class="n">relation</span><span class="p">,</span>
            <span class="s1">&#39;num_sentences&#39;</span><span class="p">:</span> <span class="n">num_sentences</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">,</span> <span class="n">expected</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;xx,x. xx,x! xx/x. x</span><span class="si">{x}</span><span class="s1">x?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="mi">4</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;xxxx. xx,x! xxxx. x(x)x?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="mi">5</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;xxxx. xx,x! xx|x. x&amp;x x?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="mi">4</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;xx-x. xx,x! xx}x. x,xx?&#39;</span><span class="p">,</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_COMPARISON_RELATION</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="mi">5</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_number_sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">relation</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the number of sentences.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraints:number_sentences&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">NumberOfSentences</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">relation</span><span class="o">=</span><span class="n">relation</span><span class="p">,</span>
                                <span class="n">num_sentences</span><span class="o">=</span><span class="n">num_sentences</span><span class="p">)</span>
  <span class="n">actual</span> <span class="o">=</span> <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_paragraph_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_paragraph_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the number of sections.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_paragraph_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the number of sections.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraint:number_paragraphs&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_1</span><span class="si">}</span><span class="s1"> and &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_1</span><span class="p">))</span>

  <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_2</span><span class="si">}</span><span class="s1"> and &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_2</span><span class="p">))</span>

  <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_3</span><span class="si">}</span><span class="s1"> and &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_3</span><span class="p">))</span>

  <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_4</span><span class="si">}</span><span class="s1"> and &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_TEST_MESSAGE_4</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_paragraph_first_word" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_paragraph_first_word</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test number of paragraphs and first word of nth paragraph.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_paragraph_first_word</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test number of paragraphs and first word of nth paragraph.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;length_constraints:nth_paragraph_first_word&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ParagraphFirstWordCheck</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_2</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_3</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_5</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_6</span><span class="p">,</span>
  <span class="p">]</span>

  <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span>
        <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_2</span>
        <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_3</span><span class="p">):</span>
      <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">first_word</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
    <span class="k">elif</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span><span class="p">:</span>
      <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="n">first_word</span> <span class="o">=</span> <span class="s1">&#39;haha&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">num_paragraphs</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="n">nth_paragraph</span> <span class="o">=</span> <span class="mi">3</span>
      <span class="n">first_word</span> <span class="o">=</span> <span class="s1">&#39;Really&#39;</span>

    <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
        <span class="n">num_paragraphs</span><span class="o">=</span><span class="n">num_paragraphs</span><span class="p">,</span>
        <span class="n">nth_paragraph</span><span class="o">=</span><span class="n">nth_paragraph</span><span class="p">,</span>
        <span class="n">first_word</span><span class="o">=</span><span class="n">first_word</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">. Test for &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_paragraphs</span><span class="si">}</span><span class="s1"> paragraphs and &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;for paragraph </span><span class="si">{</span><span class="n">nth_paragraph</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">first_word</span><span class="si">}</span><span class="s1"> is first word&#39;</span>
    <span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_1</span>
          <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_4</span>
          <span class="ow">or</span> <span class="n">test</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAGRAPH_FIRST_WORD_TEST_5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_postscript_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_postscript_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the postscript checker.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_postscript_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the postscript checker.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_content:postscript&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">PostscriptChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_POSTSCRIPT_MARKER</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_1</span><span class="p">))</span>

  <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;PS:&#39;</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_1</span><span class="p">))</span>

  <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">_POSTSCRIPT_MARKER</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_2</span><span class="p">))</span>

  <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;P.S.&#39;</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_3</span><span class="p">))</span>

  <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;P.P.S&#39;</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_4</span><span class="p">))</span>

  <span class="n">postscript_start_keyword</span> <span class="o">=</span> <span class="s1">&#39;P.S.&#39;</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">postscript_marker</span><span class="o">=</span><span class="n">postscript_start_keyword</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">postscript_start_keyword</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POSTSCRIPT_TEST_MESSAGE_5</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_prompt_repeat_answer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_prompt_repeat_answer</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test that prompt is repeated then anwered.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_prompt_repeat_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test that prompt is repeated then anwered.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;combination:repeat_prompt&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">RepeatPromptThenAnswer</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">prompt_to_repeat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROMPT_TO_REPEAT</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39; with prompt: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_1</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_2</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39; with prompt: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_PROMPT_ANSWER_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_quotation" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_quotation</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_quotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;startend:quotation&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">QuotationChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_1</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_QUOTATION_MESSAGE_2</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_rephrase_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_rephrase_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the rephrase checker.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_rephrase_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the rephrase checker.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:rephrasing&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">RephraseChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1</span><span class="p">))</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span>
      <span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_NOCHANGE</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
      <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_NOCHANGE</span><span class="p">)</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_1</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_FORMAT</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
      <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_1_FORMAT</span><span class="p">)</span>

  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">original_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_ORIGINAL_MESSAGE_2</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REPHRASE_TEST_REPHRASED_MESSAGE_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_rephrase_paragraph" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_rephrase_paragraph</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the rephrasing of paragraph.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_rephrase_paragraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the rephrasing of paragraph.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_content:rephrase_paragraph&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">RephraseParagraph</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_1</span><span class="p">))</span>

  <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_1</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_2</span><span class="p">))</span>

  <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_3</span><span class="p">))</span>

  <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_4</span><span class="p">))</span>

  <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span>
      <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">original_paragraph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_ORIGINAL_PARAGRAPH_2</span><span class="si">}</span><span class="s1"> to &#39;</span> <span class="o">+</span>
                    <span class="sa">f</span><span class="s1">&#39;have between </span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s1"> same words.&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_REPHRASED_PARAGRAPH_4</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_response_language" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_response_language</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test on single language response.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">_language=</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">),</span>
            <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
            <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;The response is English&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">)]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_response_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test on single language response.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;language:response_language&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ResponseLanguageChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_response_multilanguage" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_response_multilanguage</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">language</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test on responses that contain multi-language tokens.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;testcase_name&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">_language=</span><span class="si">{</span><span class="n">language</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">),</span>
            <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
            <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;Desayunamos en McDonald&#39;s hoy&quot;</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;Today we visit the Louvre&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">),]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_response_multilanguage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">language</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test on responses that contain multi-language tokens.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;language:response_language&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">ResponseLanguageChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_section_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_section_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test the number of sections.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_section_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test the number of sections.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:multiple_sections&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">SectionChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">section_keyword</span> <span class="o">=</span> <span class="s1">&#39;Section&#39;</span>
  <span class="n">min_num_sections</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">section_spliter</span><span class="o">=</span><span class="n">section_keyword</span><span class="p">,</span>
                                <span class="n">num_sections</span><span class="o">=</span><span class="n">min_num_sections</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">section_keyword</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">min_num_sections</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SECTION_TEST_MESSAGE_1</span><span class="p">))</span>

  <span class="n">section_keyword</span> <span class="o">=</span> <span class="s1">&#39;SECTION&#39;</span>
  <span class="n">min_num_sections</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">(</span><span class="n">section_spliter</span><span class="o">=</span><span class="n">section_keyword</span><span class="p">,</span>
                                <span class="n">num_sections</span><span class="o">=</span><span class="n">min_num_sections</span><span class="p">)</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="n">section_keyword</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">min_num_sections</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SECTION_TEST_MESSAGE_2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_title_checker" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_title_checker</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Check the prompt for a title.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_title_checker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Check the prompt for a title.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;detectable_format:title&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">TitleChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_1</span><span class="p">))</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_2</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_3</span><span class="p">))</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_4</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TITLE_MESSAGE_4</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_test.InstructionsTest.test_two_responses" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_two_responses</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Test that two responses are given.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_two_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Test that two responses are given.&quot;&quot;&quot;</span>
  <span class="n">instruction_id</span> <span class="o">=</span> <span class="s1">&#39;combination:two_responses&#39;</span>
  <span class="n">instruction</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">TwoResponsesChecker</span><span class="p">(</span><span class="n">instruction_id</span><span class="p">)</span>
  <span class="n">instruction</span><span class="o">.</span><span class="n">build_description</span><span class="p">()</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_1</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_2</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_3</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_3</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_4</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_4</span><span class="p">))</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;test </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_5</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">instruction</span><span class="o">.</span><span class="n">check_following</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_TWO_RESPONSES_5</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>instructions_util</code>


</h8>

    <div class="doc doc-contents ">

        <p>Utility library of instructions.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util.LANGUAGE_CODES" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">LANGUAGE_CODES</span> <span class="o">=</span> <span class="n">immutabledict</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">({</span><span class="s1">&#39;en&#39;</span><span class="p">:</span> <span class="s1">&#39;English&#39;</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish&#39;</span><span class="p">,</span> <span class="s1">&#39;pt&#39;</span><span class="p">:</span> <span class="s1">&#39;Portuguese&#39;</span><span class="p">,</span> <span class="s1">&#39;ar&#39;</span><span class="p">:</span> <span class="s1">&#39;Arabic&#39;</span><span class="p">,</span> <span class="s1">&#39;hi&#39;</span><span class="p">:</span> <span class="s1">&#39;Hindi&#39;</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">:</span> <span class="s1">&#39;French&#39;</span><span class="p">,</span> <span class="s1">&#39;ru&#39;</span><span class="p">:</span> <span class="s1">&#39;Russian&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">:</span> <span class="s1">&#39;German&#39;</span><span class="p">,</span> <span class="s1">&#39;ja&#39;</span><span class="p">:</span> <span class="s1">&#39;Japanese&#39;</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="s1">&#39;Italian&#39;</span><span class="p">,</span> <span class="s1">&#39;bn&#39;</span><span class="p">:</span> <span class="s1">&#39;Bengali&#39;</span><span class="p">,</span> <span class="s1">&#39;uk&#39;</span><span class="p">:</span> <span class="s1">&#39;Ukrainian&#39;</span><span class="p">,</span> <span class="s1">&#39;th&#39;</span><span class="p">:</span> <span class="s1">&#39;Thai&#39;</span><span class="p">,</span> <span class="s1">&#39;ur&#39;</span><span class="p">:</span> <span class="s1">&#39;Urdu&#39;</span><span class="p">,</span> <span class="s1">&#39;ta&#39;</span><span class="p">:</span> <span class="s1">&#39;Tamil&#39;</span><span class="p">,</span> <span class="s1">&#39;te&#39;</span><span class="p">:</span> <span class="s1">&#39;Telugu&#39;</span><span class="p">,</span> <span class="s1">&#39;bg&#39;</span><span class="p">:</span> <span class="s1">&#39;Bulgarian&#39;</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">:</span> <span class="s1">&#39;Korean&#39;</span><span class="p">,</span> <span class="s1">&#39;pl&#39;</span><span class="p">:</span> <span class="s1">&#39;Polish&#39;</span><span class="p">,</span> <span class="s1">&#39;he&#39;</span><span class="p">:</span> <span class="s1">&#39;Hebrew&#39;</span><span class="p">,</span> <span class="s1">&#39;fa&#39;</span><span class="p">:</span> <span class="s1">&#39;Persian&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">:</span> <span class="s1">&#39;Vietnamese&#39;</span><span class="p">,</span> <span class="s1">&#39;ne&#39;</span><span class="p">:</span> <span class="s1">&#39;Nepali&#39;</span><span class="p">,</span> <span class="s1">&#39;sw&#39;</span><span class="p">:</span> <span class="s1">&#39;Swahili&#39;</span><span class="p">,</span> <span class="s1">&#39;kn&#39;</span><span class="p">:</span> <span class="s1">&#39;Kannada&#39;</span><span class="p">,</span> <span class="s1">&#39;mr&#39;</span><span class="p">:</span> <span class="s1">&#39;Marathi&#39;</span><span class="p">,</span> <span class="s1">&#39;gu&#39;</span><span class="p">:</span> <span class="s1">&#39;Gujarati&#39;</span><span class="p">,</span> <span class="s1">&#39;pa&#39;</span><span class="p">:</span> <span class="s1">&#39;Punjabi&#39;</span><span class="p">,</span> <span class="s1">&#39;ml&#39;</span><span class="p">:</span> <span class="s1">&#39;Malayalam&#39;</span><span class="p">,</span> <span class="s1">&#39;fi&#39;</span><span class="p">:</span> <span class="s1">&#39;Finnish&#39;</span><span class="p">})</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util.WORD_LIST" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">WORD_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;western&#39;</span><span class="p">,</span> <span class="s1">&#39;sentence&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;dump&#39;</span><span class="p">,</span> <span class="s1">&#39;spot&#39;</span><span class="p">,</span> <span class="s1">&#39;opposite&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="s1">&#39;potato&#39;</span><span class="p">,</span> <span class="s1">&#39;administration&#39;</span><span class="p">,</span> <span class="s1">&#39;working&#39;</span><span class="p">,</span> <span class="s1">&#39;welcome&#39;</span><span class="p">,</span> <span class="s1">&#39;morning&#39;</span><span class="p">,</span> <span class="s1">&#39;good&#39;</span><span class="p">,</span> <span class="s1">&#39;agency&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="s1">&#39;wish&#39;</span><span class="p">,</span> <span class="s1">&#39;responsibility&#39;</span><span class="p">,</span> <span class="s1">&#39;press&#39;</span><span class="p">,</span> <span class="s1">&#39;problem&#39;</span><span class="p">,</span> <span class="s1">&#39;president&#39;</span><span class="p">,</span> <span class="s1">&#39;steal&#39;</span><span class="p">,</span> <span class="s1">&#39;brush&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;beat&#39;</span><span class="p">,</span> <span class="s1">&#39;trainer&#39;</span><span class="p">,</span> <span class="s1">&#39;growth&#39;</span><span class="p">,</span> <span class="s1">&#39;lock&#39;</span><span class="p">,</span> <span class="s1">&#39;bone&#39;</span><span class="p">,</span> <span class="s1">&#39;case&#39;</span><span class="p">,</span> <span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;comfortable&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;replacement&#39;</span><span class="p">,</span> <span class="s1">&#39;performance&#39;</span><span class="p">,</span> <span class="s1">&#39;mate&#39;</span><span class="p">,</span> <span class="s1">&#39;walk&#39;</span><span class="p">,</span> <span class="s1">&#39;medicine&#39;</span><span class="p">,</span> <span class="s1">&#39;film&#39;</span><span class="p">,</span> <span class="s1">&#39;thing&#39;</span><span class="p">,</span> <span class="s1">&#39;rock&#39;</span><span class="p">,</span> <span class="s1">&#39;tap&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;competition&#39;</span><span class="p">,</span> <span class="s1">&#39;ease&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span> <span class="s1">&#39;establishment&#39;</span><span class="p">,</span> <span class="s1">&#39;gather&#39;</span><span class="p">,</span> <span class="s1">&#39;parking&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;plenty&#39;</span><span class="p">,</span> <span class="s1">&#39;breath&#39;</span><span class="p">,</span> <span class="s1">&#39;claim&#39;</span><span class="p">,</span> <span class="s1">&#39;alcohol&#39;</span><span class="p">,</span> <span class="s1">&#39;trade&#39;</span><span class="p">,</span> <span class="s1">&#39;dear&#39;</span><span class="p">,</span> <span class="s1">&#39;highlight&#39;</span><span class="p">,</span> <span class="s1">&#39;street&#39;</span><span class="p">,</span> <span class="s1">&#39;matter&#39;</span><span class="p">,</span> <span class="s1">&#39;decision&#39;</span><span class="p">,</span> <span class="s1">&#39;mess&#39;</span><span class="p">,</span> <span class="s1">&#39;agreement&#39;</span><span class="p">,</span> <span class="s1">&#39;studio&#39;</span><span class="p">,</span> <span class="s1">&#39;coach&#39;</span><span class="p">,</span> <span class="s1">&#39;assist&#39;</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">,</span> <span class="s1">&#39;wing&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;brown&#39;</span><span class="p">,</span> <span class="s1">&#39;leg&#39;</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;procedure&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;speed&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;company&#39;</span><span class="p">,</span> <span class="s1">&#39;valuable&#39;</span><span class="p">,</span> <span class="s1">&#39;pie&#39;</span><span class="p">,</span> <span class="s1">&#39;analyst&#39;</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;district&#39;</span><span class="p">,</span> <span class="s1">&#39;pleasure&#39;</span><span class="p">,</span> <span class="s1">&#39;dinner&#39;</span><span class="p">,</span> <span class="s1">&#39;swimming&#39;</span><span class="p">,</span> <span class="s1">&#39;joke&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="s1">&#39;department&#39;</span><span class="p">,</span> <span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;spend&#39;</span><span class="p">,</span> <span class="s1">&#39;cabinet&#39;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span> <span class="s1">&#39;power&#39;</span><span class="p">,</span> <span class="s1">&#39;examination&#39;</span><span class="p">,</span> <span class="s1">&#39;engine&#39;</span><span class="p">,</span> <span class="s1">&#39;horse&#39;</span><span class="p">,</span> <span class="s1">&#39;dimension&#39;</span><span class="p">,</span> <span class="s1">&#39;pay&#39;</span><span class="p">,</span> <span class="s1">&#39;toe&#39;</span><span class="p">,</span> <span class="s1">&#39;curve&#39;</span><span class="p">,</span> <span class="s1">&#39;literature&#39;</span><span class="p">,</span> <span class="s1">&#39;bother&#39;</span><span class="p">,</span> <span class="s1">&#39;fire&#39;</span><span class="p">,</span> <span class="s1">&#39;possibility&#39;</span><span class="p">,</span> <span class="s1">&#39;debate&#39;</span><span class="p">,</span> <span class="s1">&#39;activity&#39;</span><span class="p">,</span> <span class="s1">&#39;passage&#39;</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;cycle&#39;</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;quiet&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;effect&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="s1">&#39;bicycle&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;throat&#39;</span><span class="p">,</span> <span class="s1">&#39;attack&#39;</span><span class="p">,</span> <span class="s1">&#39;character&#39;</span><span class="p">,</span> <span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;tea&#39;</span><span class="p">,</span> <span class="s1">&#39;increase&#39;</span><span class="p">,</span> <span class="s1">&#39;outcome&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;specific&#39;</span><span class="p">,</span> <span class="s1">&#39;inspector&#39;</span><span class="p">,</span> <span class="s1">&#39;internal&#39;</span><span class="p">,</span> <span class="s1">&#39;potential&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;building&#39;</span><span class="p">,</span> <span class="s1">&#39;employer&#39;</span><span class="p">,</span> <span class="s1">&#39;shoe&#39;</span><span class="p">,</span> <span class="s1">&#39;hand&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;garden&#39;</span><span class="p">,</span> <span class="s1">&#39;purchase&#39;</span><span class="p">,</span> <span class="s1">&#39;interview&#39;</span><span class="p">,</span> <span class="s1">&#39;study&#39;</span><span class="p">,</span> <span class="s1">&#39;recognition&#39;</span><span class="p">,</span> <span class="s1">&#39;member&#39;</span><span class="p">,</span> <span class="s1">&#39;spiritual&#39;</span><span class="p">,</span> <span class="s1">&#39;oven&#39;</span><span class="p">,</span> <span class="s1">&#39;sandwich&#39;</span><span class="p">,</span> <span class="s1">&#39;weird&#39;</span><span class="p">,</span> <span class="s1">&#39;passenger&#39;</span><span class="p">,</span> <span class="s1">&#39;particular&#39;</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;reaction&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;variation&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;candy&#39;</span><span class="p">,</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span> <span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="s1">&#39;fly&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;weakness&#39;</span><span class="p">,</span> <span class="s1">&#39;convert&#39;</span><span class="p">,</span> <span class="s1">&#39;hotel&#39;</span><span class="p">,</span> <span class="s1">&#39;great&#39;</span><span class="p">,</span> <span class="s1">&#39;mouth&#39;</span><span class="p">,</span> <span class="s1">&#39;mind&#39;</span><span class="p">,</span> <span class="s1">&#39;song&#39;</span><span class="p">,</span> <span class="s1">&#39;sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;suspect&#39;</span><span class="p">,</span> <span class="s1">&#39;telephone&#39;</span><span class="p">,</span> <span class="s1">&#39;ear&#39;</span><span class="p">,</span> <span class="s1">&#39;roof&#39;</span><span class="p">,</span> <span class="s1">&#39;paint&#39;</span><span class="p">,</span> <span class="s1">&#39;refrigerator&#39;</span><span class="p">,</span> <span class="s1">&#39;organization&#39;</span><span class="p">,</span> <span class="s1">&#39;jury&#39;</span><span class="p">,</span> <span class="s1">&#39;reward&#39;</span><span class="p">,</span> <span class="s1">&#39;engineering&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;possession&#39;</span><span class="p">,</span> <span class="s1">&#39;crew&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;road&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;celebration&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;mark&#39;</span><span class="p">,</span> <span class="s1">&#39;letter&#39;</span><span class="p">,</span> <span class="s1">&#39;shower&#39;</span><span class="p">,</span> <span class="s1">&#39;suggestion&#39;</span><span class="p">,</span> <span class="s1">&#39;sir&#39;</span><span class="p">,</span> <span class="s1">&#39;luck&#39;</span><span class="p">,</span> <span class="s1">&#39;national&#39;</span><span class="p">,</span> <span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;hall&#39;</span><span class="p">,</span> <span class="s1">&#39;stroke&#39;</span><span class="p">,</span> <span class="s1">&#39;theory&#39;</span><span class="p">,</span> <span class="s1">&#39;offer&#39;</span><span class="p">,</span> <span class="s1">&#39;story&#39;</span><span class="p">,</span> <span class="s1">&#39;tax&#39;</span><span class="p">,</span> <span class="s1">&#39;definition&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="s1">&#39;ride&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;opening&#39;</span><span class="p">,</span> <span class="s1">&#39;glass&#39;</span><span class="p">,</span> <span class="s1">&#39;elevator&#39;</span><span class="p">,</span> <span class="s1">&#39;stomach&#39;</span><span class="p">,</span> <span class="s1">&#39;question&#39;</span><span class="p">,</span> <span class="s1">&#39;ability&#39;</span><span class="p">,</span> <span class="s1">&#39;leading&#39;</span><span class="p">,</span> <span class="s1">&#39;village&#39;</span><span class="p">,</span> <span class="s1">&#39;computer&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;grand&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;candle&#39;</span><span class="p">,</span> <span class="s1">&#39;priest&#39;</span><span class="p">,</span> <span class="s1">&#39;recommendation&#39;</span><span class="p">,</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span> <span class="s1">&#39;necessary&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;desk&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">,</span> <span class="s1">&#39;horror&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;culture&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;diet&#39;</span><span class="p">,</span> <span class="s1">&#39;flower&#39;</span><span class="p">,</span> <span class="s1">&#39;bus&#39;</span><span class="p">,</span> <span class="s1">&#39;tough&#39;</span><span class="p">,</span> <span class="s1">&#39;permission&#39;</span><span class="p">,</span> <span class="s1">&#39;week&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="s1">&#39;abuse&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;corner&#39;</span><span class="p">,</span> <span class="s1">&#39;border&#39;</span><span class="p">,</span> <span class="s1">&#39;stress&#39;</span><span class="p">,</span> <span class="s1">&#39;drive&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;rip&#39;</span><span class="p">,</span> <span class="s1">&#39;meal&#39;</span><span class="p">,</span> <span class="s1">&#39;listen&#39;</span><span class="p">,</span> <span class="s1">&#39;confusion&#39;</span><span class="p">,</span> <span class="s1">&#39;girlfriend&#39;</span><span class="p">,</span> <span class="s1">&#39;living&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;significance&#39;</span><span class="p">,</span> <span class="s1">&#39;plan&#39;</span><span class="p">,</span> <span class="s1">&#39;creative&#39;</span><span class="p">,</span> <span class="s1">&#39;atmosphere&#39;</span><span class="p">,</span> <span class="s1">&#39;blame&#39;</span><span class="p">,</span> <span class="s1">&#39;invite&#39;</span><span class="p">,</span> <span class="s1">&#39;housing&#39;</span><span class="p">,</span> <span class="s1">&#39;paper&#39;</span><span class="p">,</span> <span class="s1">&#39;drink&#39;</span><span class="p">,</span> <span class="s1">&#39;roll&#39;</span><span class="p">,</span> <span class="s1">&#39;silver&#39;</span><span class="p">,</span> <span class="s1">&#39;drunk&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;damage&#39;</span><span class="p">,</span> <span class="s1">&#39;smoke&#39;</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;pack&#39;</span><span class="p">,</span> <span class="s1">&#39;savings&#39;</span><span class="p">,</span> <span class="s1">&#39;influence&#39;</span><span class="p">,</span> <span class="s1">&#39;tourist&#39;</span><span class="p">,</span> <span class="s1">&#39;rain&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;sign&#39;</span><span class="p">,</span> <span class="s1">&#39;grandmother&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;profit&#39;</span><span class="p">,</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s1">&#39;clerk&#39;</span><span class="p">,</span> <span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="s1">&#39;wine&#39;</span><span class="p">,</span> <span class="s1">&#39;swim&#39;</span><span class="p">,</span> <span class="s1">&#39;pause&#39;</span><span class="p">,</span> <span class="s1">&#39;stuff&#39;</span><span class="p">,</span> <span class="s1">&#39;singer&#39;</span><span class="p">,</span> <span class="s1">&#39;funeral&#39;</span><span class="p">,</span> <span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;scene&#39;</span><span class="p">,</span> <span class="s1">&#39;tradition&#39;</span><span class="p">,</span> <span class="s1">&#39;personal&#39;</span><span class="p">,</span> <span class="s1">&#39;snow&#39;</span><span class="p">,</span> <span class="s1">&#39;nobody&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="s1">&#39;sensitive&#39;</span><span class="p">,</span> <span class="s1">&#39;animal&#39;</span><span class="p">,</span> <span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="s1">&#39;negotiation&#39;</span><span class="p">,</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;mood&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="s1">&#39;arrival&#39;</span><span class="p">,</span> <span class="s1">&#39;expression&#39;</span><span class="p">,</span> <span class="s1">&#39;holiday&#39;</span><span class="p">,</span> <span class="s1">&#39;repeat&#39;</span><span class="p">,</span> <span class="s1">&#39;dust&#39;</span><span class="p">,</span> <span class="s1">&#39;closet&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;bad&#39;</span><span class="p">,</span> <span class="s1">&#39;sail&#39;</span><span class="p">,</span> <span class="s1">&#39;combination&#39;</span><span class="p">,</span> <span class="s1">&#39;clothes&#39;</span><span class="p">,</span> <span class="s1">&#39;emphasis&#39;</span><span class="p">,</span> <span class="s1">&#39;duty&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;school&#39;</span><span class="p">,</span> <span class="s1">&#39;jump&#39;</span><span class="p">,</span> <span class="s1">&#39;document&#39;</span><span class="p">,</span> <span class="s1">&#39;professional&#39;</span><span class="p">,</span> <span class="s1">&#39;lip&#39;</span><span class="p">,</span> <span class="s1">&#39;chemical&#39;</span><span class="p">,</span> <span class="s1">&#39;front&#39;</span><span class="p">,</span> <span class="s1">&#39;wake&#39;</span><span class="p">,</span> <span class="s1">&#39;while&#39;</span><span class="p">,</span> <span class="s1">&#39;inside&#39;</span><span class="p">,</span> <span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;penalty&#39;</span><span class="p">,</span> <span class="s1">&#39;balance&#39;</span><span class="p">,</span> <span class="s1">&#39;possible&#39;</span><span class="p">,</span> <span class="s1">&#39;adult&#39;</span><span class="p">,</span> <span class="s1">&#39;aside&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;appeal&#39;</span><span class="p">,</span> <span class="s1">&#39;wedding&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="s1">&#39;king&#39;</span><span class="p">,</span> <span class="s1">&#39;award&#39;</span><span class="p">,</span> <span class="s1">&#39;wife&#39;</span><span class="p">,</span> <span class="s1">&#39;blow&#39;</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;camp&#39;</span><span class="p">,</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span> <span class="s1">&#39;safe&#39;</span><span class="p">,</span> <span class="s1">&#39;gift&#39;</span><span class="p">,</span> <span class="s1">&#39;fault&#39;</span><span class="p">,</span> <span class="s1">&#39;guess&#39;</span><span class="p">,</span> <span class="s1">&#39;act&#39;</span><span class="p">,</span> <span class="s1">&#39;shame&#39;</span><span class="p">,</span> <span class="s1">&#39;drama&#39;</span><span class="p">,</span> <span class="s1">&#39;capital&#39;</span><span class="p">,</span> <span class="s1">&#39;exam&#39;</span><span class="p">,</span> <span class="s1">&#39;stupid&#39;</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">,</span> <span class="s1">&#39;sound&#39;</span><span class="p">,</span> <span class="s1">&#39;swing&#39;</span><span class="p">,</span> <span class="s1">&#39;novel&#39;</span><span class="p">,</span> <span class="s1">&#39;minimum&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;machine&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;lead&#39;</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">,</span> <span class="s1">&#39;salary&#39;</span><span class="p">,</span> <span class="s1">&#39;cloud&#39;</span><span class="p">,</span> <span class="s1">&#39;affair&#39;</span><span class="p">,</span> <span class="s1">&#39;hit&#39;</span><span class="p">,</span> <span class="s1">&#39;chapter&#39;</span><span class="p">,</span> <span class="s1">&#39;stage&#39;</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;access&#39;</span><span class="p">,</span> <span class="s1">&#39;army&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;traffic&#39;</span><span class="p">,</span> <span class="s1">&#39;kick&#39;</span><span class="p">,</span> <span class="s1">&#39;analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;airport&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;vacation&#39;</span><span class="p">,</span> <span class="s1">&#39;philosophy&#39;</span><span class="p">,</span> <span class="s1">&#39;ball&#39;</span><span class="p">,</span> <span class="s1">&#39;chest&#39;</span><span class="p">,</span> <span class="s1">&#39;thanks&#39;</span><span class="p">,</span> <span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;mountain&#39;</span><span class="p">,</span> <span class="s1">&#39;advertising&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;past&#39;</span><span class="p">,</span> <span class="s1">&#39;rent&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;tour&#39;</span><span class="p">,</span> <span class="s1">&#39;house&#39;</span><span class="p">,</span> <span class="s1">&#39;construction&#39;</span><span class="p">,</span> <span class="s1">&#39;net&#39;</span><span class="p">,</span> <span class="s1">&#39;native&#39;</span><span class="p">,</span> <span class="s1">&#39;war&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="s1">&#39;fee&#39;</span><span class="p">,</span> <span class="s1">&#39;spray&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;dirt&#39;</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;stick&#39;</span><span class="p">,</span> <span class="s1">&#39;friend&#39;</span><span class="p">,</span> <span class="s1">&#39;software&#39;</span><span class="p">,</span> <span class="s1">&#39;promotion&#39;</span><span class="p">,</span> <span class="s1">&#39;interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;surround&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;purpose&#39;</span><span class="p">,</span> <span class="s1">&#39;practice&#39;</span><span class="p">,</span> <span class="s1">&#39;conflict&#39;</span><span class="p">,</span> <span class="s1">&#39;routine&#39;</span><span class="p">,</span> <span class="s1">&#39;requirement&#39;</span><span class="p">,</span> <span class="s1">&#39;bonus&#39;</span><span class="p">,</span> <span class="s1">&#39;hole&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;junior&#39;</span><span class="p">,</span> <span class="s1">&#39;sweet&#39;</span><span class="p">,</span> <span class="s1">&#39;catch&#39;</span><span class="p">,</span> <span class="s1">&#39;tear&#39;</span><span class="p">,</span> <span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="s1">&#39;wall&#39;</span><span class="p">,</span> <span class="s1">&#39;editor&#39;</span><span class="p">,</span> <span class="s1">&#39;life&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;pound&#39;</span><span class="p">,</span> <span class="s1">&#39;respect&#39;</span><span class="p">,</span> <span class="s1">&#39;bathroom&#39;</span><span class="p">,</span> <span class="s1">&#39;coat&#39;</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;job&#39;</span><span class="p">,</span> <span class="s1">&#39;teach&#39;</span><span class="p">,</span> <span class="s1">&#39;birth&#39;</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;resolve&#39;</span><span class="p">,</span> <span class="s1">&#39;theme&#39;</span><span class="p">,</span> <span class="s1">&#39;employee&#39;</span><span class="p">,</span> <span class="s1">&#39;doubt&#39;</span><span class="p">,</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;serve&#39;</span><span class="p">,</span> <span class="s1">&#39;recover&#39;</span><span class="p">,</span> <span class="s1">&#39;tone&#39;</span><span class="p">,</span> <span class="s1">&#39;harm&#39;</span><span class="p">,</span> <span class="s1">&#39;miss&#39;</span><span class="p">,</span> <span class="s1">&#39;union&#39;</span><span class="p">,</span> <span class="s1">&#39;understanding&#39;</span><span class="p">,</span> <span class="s1">&#39;cow&#39;</span><span class="p">,</span> <span class="s1">&#39;river&#39;</span><span class="p">,</span> <span class="s1">&#39;association&#39;</span><span class="p">,</span> <span class="s1">&#39;concept&#39;</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;reserve&#39;</span><span class="p">,</span> <span class="s1">&#39;depression&#39;</span><span class="p">,</span> <span class="s1">&#39;proof&#39;</span><span class="p">,</span> <span class="s1">&#39;hair&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue&#39;</span><span class="p">,</span> <span class="s1">&#39;independent&#39;</span><span class="p">,</span> <span class="s1">&#39;lift&#39;</span><span class="p">,</span> <span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="s1">&#39;temporary&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;check&#39;</span><span class="p">,</span> <span class="s1">&#39;rope&#39;</span><span class="p">,</span> <span class="s1">&#39;estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;pollution&#39;</span><span class="p">,</span> <span class="s1">&#39;stable&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;delivery&#39;</span><span class="p">,</span> <span class="s1">&#39;perspective&#39;</span><span class="p">,</span> <span class="s1">&#39;mirror&#39;</span><span class="p">,</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;representative&#39;</span><span class="p">,</span> <span class="s1">&#39;witness&#39;</span><span class="p">,</span> <span class="s1">&#39;nature&#39;</span><span class="p">,</span> <span class="s1">&#39;judge&#39;</span><span class="p">,</span> <span class="s1">&#39;fruit&#39;</span><span class="p">,</span> <span class="s1">&#39;tip&#39;</span><span class="p">,</span> <span class="s1">&#39;devil&#39;</span><span class="p">,</span> <span class="s1">&#39;town&#39;</span><span class="p">,</span> <span class="s1">&#39;emergency&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="s1">&#39;stay&#39;</span><span class="p">,</span> <span class="s1">&#39;human&#39;</span><span class="p">,</span> <span class="s1">&#39;neck&#39;</span><span class="p">,</span> <span class="s1">&#39;speaker&#39;</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">,</span> <span class="s1">&#39;sing&#39;</span><span class="p">,</span> <span class="s1">&#39;resist&#39;</span><span class="p">,</span> <span class="s1">&#39;league&#39;</span><span class="p">,</span> <span class="s1">&#39;trip&#39;</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">,</span> <span class="s1">&#39;lawyer&#39;</span><span class="p">,</span> <span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="s1">&#39;gas&#39;</span><span class="p">,</span> <span class="s1">&#39;choice&#39;</span><span class="p">,</span> <span class="s1">&#39;engineer&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;part&#39;</span><span class="p">,</span> <span class="s1">&#39;external&#39;</span><span class="p">,</span> <span class="s1">&#39;worker&#39;</span><span class="p">,</span> <span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;quarter&#39;</span><span class="p">,</span> <span class="s1">&#39;student&#39;</span><span class="p">,</span> <span class="s1">&#39;heart&#39;</span><span class="p">,</span> <span class="s1">&#39;pass&#39;</span><span class="p">,</span> <span class="s1">&#39;spite&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="s1">&#39;rough&#39;</span><span class="p">,</span> <span class="s1">&#39;lady&#39;</span><span class="p">,</span> <span class="s1">&#39;grass&#39;</span><span class="p">,</span> <span class="s1">&#39;community&#39;</span><span class="p">,</span> <span class="s1">&#39;garage&#39;</span><span class="p">,</span> <span class="s1">&#39;youth&#39;</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;skirt&#39;</span><span class="p">,</span> <span class="s1">&#39;promise&#39;</span><span class="p">,</span> <span class="s1">&#39;blind&#39;</span><span class="p">,</span> <span class="s1">&#39;television&#39;</span><span class="p">,</span> <span class="s1">&#39;disease&#39;</span><span class="p">,</span> <span class="s1">&#39;commission&#39;</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;energy&#39;</span><span class="p">,</span> <span class="s1">&#39;calm&#39;</span><span class="p">,</span> <span class="s1">&#39;presence&#39;</span><span class="p">,</span> <span class="s1">&#39;tune&#39;</span><span class="p">,</span> <span class="s1">&#39;basis&#39;</span><span class="p">,</span> <span class="s1">&#39;preference&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;generic&#39;</span><span class="p">,</span> <span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;somewhere&#39;</span><span class="p">,</span> <span class="s1">&#39;presentation&#39;</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="s1">&#39;thought&#39;</span><span class="p">,</span> <span class="s1">&#39;revolution&#39;</span><span class="p">,</span> <span class="s1">&#39;effort&#39;</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="s1">&#39;implement&#39;</span><span class="p">,</span> <span class="s1">&#39;republic&#39;</span><span class="p">,</span> <span class="s1">&#39;floor&#39;</span><span class="p">,</span> <span class="s1">&#39;principle&#39;</span><span class="p">,</span> <span class="s1">&#39;stranger&#39;</span><span class="p">,</span> <span class="s1">&#39;shoulder&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;tennis&#39;</span><span class="p">,</span> <span class="s1">&#39;police&#39;</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="s1">&#39;account&#39;</span><span class="p">,</span> <span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="s1">&#39;glove&#39;</span><span class="p">,</span> <span class="s1">&#39;divide&#39;</span><span class="p">,</span> <span class="s1">&#39;professor&#39;</span><span class="p">,</span> <span class="s1">&#39;chair&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;combine&#39;</span><span class="p">,</span> <span class="s1">&#39;peace&#39;</span><span class="p">,</span> <span class="s1">&#39;extension&#39;</span><span class="p">,</span> <span class="s1">&#39;maybe&#39;</span><span class="p">,</span> <span class="s1">&#39;evening&#39;</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="s1">&#39;sister&#39;</span><span class="p">,</span> <span class="s1">&#39;wave&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="s1">&#39;counter&#39;</span><span class="p">,</span> <span class="s1">&#39;bottle&#39;</span><span class="p">,</span> <span class="s1">&#39;half&#39;</span><span class="p">,</span> <span class="s1">&#39;cheek&#39;</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;back&#39;</span><span class="p">,</span> <span class="s1">&#39;knowledge&#39;</span><span class="p">,</span> <span class="s1">&#39;make&#39;</span><span class="p">,</span> <span class="s1">&#39;discussion&#39;</span><span class="p">,</span> <span class="s1">&#39;screw&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;accident&#39;</span><span class="p">,</span> <span class="s1">&#39;battle&#39;</span><span class="p">,</span> <span class="s1">&#39;dress&#39;</span><span class="p">,</span> <span class="s1">&#39;knee&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;package&#39;</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="s1">&#39;turn&#39;</span><span class="p">,</span> <span class="s1">&#39;hearing&#39;</span><span class="p">,</span> <span class="s1">&#39;newspaper&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;wealth&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;imagination&#39;</span><span class="p">,</span> <span class="s1">&#39;answer&#39;</span><span class="p">,</span> <span class="s1">&#39;weekend&#39;</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="s1">&#39;appearance&#39;</span><span class="p">,</span> <span class="s1">&#39;meet&#39;</span><span class="p">,</span> <span class="s1">&#39;bike&#39;</span><span class="p">,</span> <span class="s1">&#39;rise&#39;</span><span class="p">,</span> <span class="s1">&#39;belt&#39;</span><span class="p">,</span> <span class="s1">&#39;crash&#39;</span><span class="p">,</span> <span class="s1">&#39;bowl&#39;</span><span class="p">,</span> <span class="s1">&#39;equivalent&#39;</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;poem&#39;</span><span class="p">,</span> <span class="s1">&#39;risk&#39;</span><span class="p">,</span> <span class="s1">&#39;excitement&#39;</span><span class="p">,</span> <span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;secretary&#39;</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="s1">&#39;produce&#39;</span><span class="p">,</span> <span class="s1">&#39;plane&#39;</span><span class="p">,</span> <span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;money&#39;</span><span class="p">,</span> <span class="s1">&#39;sand&#39;</span><span class="p">,</span> <span class="s1">&#39;situation&#39;</span><span class="p">,</span> <span class="s1">&#39;punch&#39;</span><span class="p">,</span> <span class="s1">&#39;customer&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;shake&#39;</span><span class="p">,</span> <span class="s1">&#39;mortgage&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="s1">&#39;extent&#39;</span><span class="p">,</span> <span class="s1">&#39;nothing&#39;</span><span class="p">,</span> <span class="s1">&#39;experience&#39;</span><span class="p">,</span> <span class="s1">&#39;opinion&#39;</span><span class="p">,</span> <span class="s1">&#39;departure&#39;</span><span class="p">,</span> <span class="s1">&#39;dance&#39;</span><span class="p">,</span> <span class="s1">&#39;indication&#39;</span><span class="p">,</span> <span class="s1">&#39;boy&#39;</span><span class="p">,</span> <span class="s1">&#39;material&#39;</span><span class="p">,</span> <span class="s1">&#39;band&#39;</span><span class="p">,</span> <span class="s1">&#39;leader&#39;</span><span class="p">,</span> <span class="s1">&#39;sun&#39;</span><span class="p">,</span> <span class="s1">&#39;beautiful&#39;</span><span class="p">,</span> <span class="s1">&#39;muscle&#39;</span><span class="p">,</span> <span class="s1">&#39;farmer&#39;</span><span class="p">,</span> <span class="s1">&#39;variety&#39;</span><span class="p">,</span> <span class="s1">&#39;fat&#39;</span><span class="p">,</span> <span class="s1">&#39;handle&#39;</span><span class="p">,</span> <span class="s1">&#39;director&#39;</span><span class="p">,</span> <span class="s1">&#39;opportunity&#39;</span><span class="p">,</span> <span class="s1">&#39;calendar&#39;</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">,</span> <span class="s1">&#39;pace&#39;</span><span class="p">,</span> <span class="s1">&#39;bath&#39;</span><span class="p">,</span> <span class="s1">&#39;fish&#39;</span><span class="p">,</span> <span class="s1">&#39;consequence&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="s1">&#39;go&#39;</span><span class="p">,</span> <span class="s1">&#39;doctor&#39;</span><span class="p">,</span> <span class="s1">&#39;information&#39;</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">,</span> <span class="s1">&#39;hurt&#39;</span><span class="p">,</span> <span class="s1">&#39;protection&#39;</span><span class="p">,</span> <span class="s1">&#39;career&#39;</span><span class="p">,</span> <span class="s1">&#39;finance&#39;</span><span class="p">,</span> <span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="s1">&#39;golf&#39;</span><span class="p">,</span> <span class="s1">&#39;garbage&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect&#39;</span><span class="p">,</span> <span class="s1">&#39;kid&#39;</span><span class="p">,</span> <span class="s1">&#39;food&#39;</span><span class="p">,</span> <span class="s1">&#39;boot&#39;</span><span class="p">,</span> <span class="s1">&#39;milk&#39;</span><span class="p">,</span> <span class="s1">&#39;respond&#39;</span><span class="p">,</span> <span class="s1">&#39;objective&#39;</span><span class="p">,</span> <span class="s1">&#39;reality&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="s1">&#39;ring&#39;</span><span class="p">,</span> <span class="s1">&#39;mall&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;impact&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="s1">&#39;international&#39;</span><span class="p">,</span> <span class="s1">&#39;series&#39;</span><span class="p">,</span> <span class="s1">&#39;impress&#39;</span><span class="p">,</span> <span class="s1">&#39;mother&#39;</span><span class="p">,</span> <span class="s1">&#39;shelter&#39;</span><span class="p">,</span> <span class="s1">&#39;strike&#39;</span><span class="p">,</span> <span class="s1">&#39;loan&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;seat&#39;</span><span class="p">,</span> <span class="s1">&#39;anything&#39;</span><span class="p">,</span> <span class="s1">&#39;entertainment&#39;</span><span class="p">,</span> <span class="s1">&#39;familiar&#39;</span><span class="p">,</span> <span class="s1">&#39;clue&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;glad&#39;</span><span class="p">,</span> <span class="s1">&#39;supermarket&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">,</span> <span class="s1">&#39;god&#39;</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">,</span> <span class="s1">&#39;conversation&#39;</span><span class="p">,</span> <span class="s1">&#39;tie&#39;</span><span class="p">,</span> <span class="s1">&#39;ruin&#39;</span><span class="p">,</span> <span class="s1">&#39;comfort&#39;</span><span class="p">,</span> <span class="s1">&#39;earth&#39;</span><span class="p">,</span> <span class="s1">&#39;storm&#39;</span><span class="p">,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">,</span> <span class="s1">&#39;assistance&#39;</span><span class="p">,</span> <span class="s1">&#39;budget&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">,</span> <span class="s1">&#39;beginning&#39;</span><span class="p">,</span> <span class="s1">&#39;sleep&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;young&#39;</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;desire&#39;</span><span class="p">,</span> <span class="s1">&#39;hide&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;cup&#39;</span><span class="p">,</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">,</span> <span class="s1">&#39;nurse&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="s1">&#39;tower&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;camera&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;panic&#39;</span><span class="p">,</span> <span class="s1">&#39;nation&#39;</span><span class="p">,</span> <span class="s1">&#39;basket&#39;</span><span class="p">,</span> <span class="s1">&#39;ice&#39;</span><span class="p">,</span> <span class="s1">&#39;art&#39;</span><span class="p">,</span> <span class="s1">&#39;spirit&#39;</span><span class="p">,</span> <span class="s1">&#39;chart&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;statement&#39;</span><span class="p">,</span> <span class="s1">&#39;reputation&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;hunt&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise&#39;</span><span class="p">,</span> <span class="s1">&#39;nasty&#39;</span><span class="p">,</span> <span class="s1">&#39;notice&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;yard&#39;</span><span class="p">,</span> <span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="s1">&#39;collar&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;plant&#39;</span><span class="p">,</span> <span class="s1">&#39;fortune&#39;</span><span class="p">,</span> <span class="s1">&#39;passion&#39;</span><span class="p">,</span> <span class="s1">&#39;friendship&#39;</span><span class="p">,</span> <span class="s1">&#39;spread&#39;</span><span class="p">,</span> <span class="s1">&#39;cancer&#39;</span><span class="p">,</span> <span class="s1">&#39;ticket&#39;</span><span class="p">,</span> <span class="s1">&#39;attitude&#39;</span><span class="p">,</span> <span class="s1">&#39;island&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;buyer&#39;</span><span class="p">,</span> <span class="s1">&#39;bite&#39;</span><span class="p">,</span> <span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="s1">&#39;steak&#39;</span><span class="p">,</span> <span class="s1">&#39;proposal&#39;</span><span class="p">,</span> <span class="s1">&#39;patient&#39;</span><span class="p">,</span> <span class="s1">&#39;heat&#39;</span><span class="p">,</span> <span class="s1">&#39;rule&#39;</span><span class="p">,</span> <span class="s1">&#39;resident&#39;</span><span class="p">,</span> <span class="s1">&#39;broad&#39;</span><span class="p">,</span> <span class="s1">&#39;politics&#39;</span><span class="p">,</span> <span class="s1">&#39;west&#39;</span><span class="p">,</span> <span class="s1">&#39;knife&#39;</span><span class="p">,</span> <span class="s1">&#39;expert&#39;</span><span class="p">,</span> <span class="s1">&#39;girl&#39;</span><span class="p">,</span> <span class="s1">&#39;design&#39;</span><span class="p">,</span> <span class="s1">&#39;salt&#39;</span><span class="p">,</span> <span class="s1">&#39;baseball&#39;</span><span class="p">,</span> <span class="s1">&#39;grab&#39;</span><span class="p">,</span> <span class="s1">&#39;inspection&#39;</span><span class="p">,</span> <span class="s1">&#39;cousin&#39;</span><span class="p">,</span> <span class="s1">&#39;couple&#39;</span><span class="p">,</span> <span class="s1">&#39;magazine&#39;</span><span class="p">,</span> <span class="s1">&#39;cook&#39;</span><span class="p">,</span> <span class="s1">&#39;dependent&#39;</span><span class="p">,</span> <span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="s1">&#39;chicken&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;currency&#39;</span><span class="p">,</span> <span class="s1">&#39;ladder&#39;</span><span class="p">,</span> <span class="s1">&#39;scheme&#39;</span><span class="p">,</span> <span class="s1">&#39;kitchen&#39;</span><span class="p">,</span> <span class="s1">&#39;employment&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;attention&#39;</span><span class="p">,</span> <span class="s1">&#39;manager&#39;</span><span class="p">,</span> <span class="s1">&#39;fact&#39;</span><span class="p">,</span> <span class="s1">&#39;cover&#39;</span><span class="p">,</span> <span class="s1">&#39;sad&#39;</span><span class="p">,</span> <span class="s1">&#39;guard&#39;</span><span class="p">,</span> <span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="s1">&#39;county&#39;</span><span class="p">,</span> <span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;lunch&#39;</span><span class="p">,</span> <span class="s1">&#39;program&#39;</span><span class="p">,</span> <span class="s1">&#39;initiative&#39;</span><span class="p">,</span> <span class="s1">&#39;gear&#39;</span><span class="p">,</span> <span class="s1">&#39;bridge&#39;</span><span class="p">,</span> <span class="s1">&#39;breast&#39;</span><span class="p">,</span> <span class="s1">&#39;talk&#39;</span><span class="p">,</span> <span class="s1">&#39;dish&#39;</span><span class="p">,</span> <span class="s1">&#39;guarantee&#39;</span><span class="p">,</span> <span class="s1">&#39;beer&#39;</span><span class="p">,</span> <span class="s1">&#39;vehicle&#39;</span><span class="p">,</span> <span class="s1">&#39;reception&#39;</span><span class="p">,</span> <span class="s1">&#39;woman&#39;</span><span class="p">,</span> <span class="s1">&#39;substance&#39;</span><span class="p">,</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="s1">&#39;lecture&#39;</span><span class="p">,</span> <span class="s1">&#39;advantage&#39;</span><span class="p">,</span> <span class="s1">&#39;park&#39;</span><span class="p">,</span> <span class="s1">&#39;cold&#39;</span><span class="p">,</span> <span class="s1">&#39;death&#39;</span><span class="p">,</span> <span class="s1">&#39;mix&#39;</span><span class="p">,</span> <span class="s1">&#39;hold&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;tomorrow&#39;</span><span class="p">,</span> <span class="s1">&#39;blood&#39;</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;cookie&#39;</span><span class="p">,</span> <span class="s1">&#39;church&#39;</span><span class="p">,</span> <span class="s1">&#39;strip&#39;</span><span class="p">,</span> <span class="s1">&#39;forever&#39;</span><span class="p">,</span> <span class="s1">&#39;beyond&#39;</span><span class="p">,</span> <span class="s1">&#39;debt&#39;</span><span class="p">,</span> <span class="s1">&#39;tackle&#39;</span><span class="p">,</span> <span class="s1">&#39;wash&#39;</span><span class="p">,</span> <span class="s1">&#39;following&#39;</span><span class="p">,</span> <span class="s1">&#39;feel&#39;</span><span class="p">,</span> <span class="s1">&#39;maximum&#39;</span><span class="p">,</span> <span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;sea&#39;</span><span class="p">,</span> <span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="s1">&#39;economics&#39;</span><span class="p">,</span> <span class="s1">&#39;menu&#39;</span><span class="p">,</span> <span class="s1">&#39;bench&#39;</span><span class="p">,</span> <span class="s1">&#39;try&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;income&#39;</span><span class="p">,</span> <span class="s1">&#39;foot&#39;</span><span class="p">,</span> <span class="s1">&#39;senior&#39;</span><span class="p">,</span> <span class="s1">&#39;honey&#39;</span><span class="p">,</span> <span class="s1">&#39;few&#39;</span><span class="p">,</span> <span class="s1">&#39;mixture&#39;</span><span class="p">,</span> <span class="s1">&#39;cash&#39;</span><span class="p">,</span> <span class="s1">&#39;grocery&#39;</span><span class="p">,</span> <span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;factor&#39;</span><span class="p">,</span> <span class="s1">&#39;pot&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;writer&#39;</span><span class="p">,</span> <span class="s1">&#39;farm&#39;</span><span class="p">,</span> <span class="s1">&#39;winter&#39;</span><span class="p">,</span> <span class="s1">&#39;skill&#39;</span><span class="p">,</span> <span class="s1">&#39;anywhere&#39;</span><span class="p">,</span> <span class="s1">&#39;birthday&#39;</span><span class="p">,</span> <span class="s1">&#39;policy&#39;</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">,</span> <span class="s1">&#39;husband&#39;</span><span class="p">,</span> <span class="s1">&#39;lab&#39;</span><span class="p">,</span> <span class="s1">&#39;hurry&#39;</span><span class="p">,</span> <span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="s1">&#39;equipment&#39;</span><span class="p">,</span> <span class="s1">&#39;sink&#39;</span><span class="p">,</span> <span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">,</span> <span class="s1">&#39;consideration&#39;</span><span class="p">,</span> <span class="s1">&#39;leather&#39;</span><span class="p">,</span> <span class="s1">&#39;skin&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;boat&#39;</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="s1">&#39;brick&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;feed&#39;</span><span class="p">,</span> <span class="s1">&#39;square&#39;</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="s1">&#39;rush&#39;</span><span class="p">,</span> <span class="s1">&#39;dream&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;afternoon&#39;</span><span class="p">,</span> <span class="s1">&#39;manufacturer&#39;</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="s1">&#39;occasion&#39;</span><span class="p">,</span> <span class="s1">&#39;trouble&#39;</span><span class="p">,</span> <span class="s1">&#39;introduction&#39;</span><span class="p">,</span> <span class="s1">&#39;advice&#39;</span><span class="p">,</span> <span class="s1">&#39;bet&#39;</span><span class="p">,</span> <span class="s1">&#39;eat&#39;</span><span class="p">,</span> <span class="s1">&#39;kill&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;manner&#39;</span><span class="p">,</span> <span class="s1">&#39;office&#39;</span><span class="p">,</span> <span class="s1">&#39;estate&#39;</span><span class="p">,</span> <span class="s1">&#39;pride&#39;</span><span class="p">,</span> <span class="s1">&#39;awareness&#39;</span><span class="p">,</span> <span class="s1">&#39;slip&#39;</span><span class="p">,</span> <span class="s1">&#39;crack&#39;</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">,</span> <span class="s1">&#39;nail&#39;</span><span class="p">,</span> <span class="s1">&#39;shoot&#39;</span><span class="p">,</span> <span class="s1">&#39;membership&#39;</span><span class="p">,</span> <span class="s1">&#39;soft&#39;</span><span class="p">,</span> <span class="s1">&#39;anybody&#39;</span><span class="p">,</span> <span class="s1">&#39;web&#39;</span><span class="p">,</span> <span class="s1">&#39;official&#39;</span><span class="p">,</span> <span class="s1">&#39;individual&#39;</span><span class="p">,</span> <span class="s1">&#39;pizza&#39;</span><span class="p">,</span> <span class="s1">&#39;interest&#39;</span><span class="p">,</span> <span class="s1">&#39;bag&#39;</span><span class="p">,</span> <span class="s1">&#39;spell&#39;</span><span class="p">,</span> <span class="s1">&#39;profession&#39;</span><span class="p">,</span> <span class="s1">&#39;queen&#39;</span><span class="p">,</span> <span class="s1">&#39;deal&#39;</span><span class="p">,</span> <span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="s1">&#39;ship&#39;</span><span class="p">,</span> <span class="s1">&#39;guy&#39;</span><span class="p">,</span> <span class="s1">&#39;chocolate&#39;</span><span class="p">,</span> <span class="s1">&#39;joint&#39;</span><span class="p">,</span> <span class="s1">&#39;formal&#39;</span><span class="p">,</span> <span class="s1">&#39;upstairs&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;resort&#39;</span><span class="p">,</span> <span class="s1">&#39;abroad&#39;</span><span class="p">,</span> <span class="s1">&#39;dealer&#39;</span><span class="p">,</span> <span class="s1">&#39;associate&#39;</span><span class="p">,</span> <span class="s1">&#39;finger&#39;</span><span class="p">,</span> <span class="s1">&#39;surgery&#39;</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;detail&#39;</span><span class="p">,</span> <span class="s1">&#39;crazy&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;tale&#39;</span><span class="p">,</span> <span class="s1">&#39;initial&#39;</span><span class="p">,</span> <span class="s1">&#39;arm&#39;</span><span class="p">,</span> <span class="s1">&#39;radio&#39;</span><span class="p">,</span> <span class="s1">&#39;demand&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;contest&#39;</span><span class="p">,</span> <span class="s1">&#39;piece&#39;</span><span class="p">,</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span> <span class="s1">&#39;pull&#39;</span><span class="p">,</span> <span class="s1">&#39;commercial&#39;</span><span class="p">,</span> <span class="s1">&#39;shirt&#39;</span><span class="p">,</span> <span class="s1">&#39;contribution&#39;</span><span class="p">,</span> <span class="s1">&#39;cream&#39;</span><span class="p">,</span> <span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="s1">&#39;suit&#39;</span><span class="p">,</span> <span class="s1">&#39;discipline&#39;</span><span class="p">,</span> <span class="s1">&#39;instruction&#39;</span><span class="p">,</span> <span class="s1">&#39;concert&#39;</span><span class="p">,</span> <span class="s1">&#39;speech&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;effective&#39;</span><span class="p">,</span> <span class="s1">&#39;hang&#39;</span><span class="p">,</span> <span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="s1">&#39;industry&#39;</span><span class="p">,</span> <span class="s1">&#39;breakfast&#39;</span><span class="p">,</span> <span class="s1">&#39;lay&#39;</span><span class="p">,</span> <span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="s1">&#39;metal&#39;</span><span class="p">,</span> <span class="s1">&#39;bedroom&#39;</span><span class="p">,</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="s1">&#39;rest&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;many&#39;</span><span class="p">,</span> <span class="s1">&#39;give&#39;</span><span class="p">,</span> <span class="s1">&#39;argument&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;laugh&#39;</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">,</span> <span class="s1">&#39;credit&#39;</span><span class="p">,</span> <span class="s1">&#39;investment&#39;</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;setting&#39;</span><span class="p">,</span> <span class="s1">&#39;lesson&#39;</span><span class="p">,</span> <span class="s1">&#39;egg&#39;</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">,</span> <span class="s1">&#39;marriage&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;evidence&#39;</span><span class="p">,</span> <span class="s1">&#39;phrase&#39;</span><span class="p">,</span> <span class="s1">&#39;love&#39;</span><span class="p">,</span> <span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="s1">&#39;benefit&#39;</span><span class="p">,</span> <span class="s1">&#39;guidance&#39;</span><span class="p">,</span> <span class="s1">&#39;affect&#39;</span><span class="p">,</span> <span class="s1">&#39;you&#39;</span><span class="p">,</span> <span class="s1">&#39;dad&#39;</span><span class="p">,</span> <span class="s1">&#39;anxiety&#39;</span><span class="p">,</span> <span class="s1">&#39;special&#39;</span><span class="p">,</span> <span class="s1">&#39;boyfriend&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;blank&#39;</span><span class="p">,</span> <span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="s1">&#39;soup&#39;</span><span class="p">,</span> <span class="s1">&#39;obligation&#39;</span><span class="p">,</span> <span class="s1">&#39;reply&#39;</span><span class="p">,</span> <span class="s1">&#39;smile&#39;</span><span class="p">,</span> <span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="s1">&#39;complaint&#39;</span><span class="p">,</span> <span class="s1">&#39;addition&#39;</span><span class="p">,</span> <span class="s1">&#39;review&#39;</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="s1">&#39;towel&#39;</span><span class="p">,</span> <span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">,</span> <span class="s1">&#39;soil&#39;</span><span class="p">,</span> <span class="s1">&#39;issue&#39;</span><span class="p">,</span> <span class="s1">&#39;cigarette&#39;</span><span class="p">,</span> <span class="s1">&#39;internet&#39;</span><span class="p">,</span> <span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="s1">&#39;tell&#39;</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">,</span> <span class="s1">&#39;spare&#39;</span><span class="p">,</span> <span class="s1">&#39;incident&#39;</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">,</span> <span class="s1">&#39;refuse&#39;</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">,</span> <span class="s1">&#39;can&#39;</span><span class="p">,</span> <span class="s1">&#39;pen&#39;</span><span class="p">,</span> <span class="s1">&#39;grandfather&#39;</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="s1">&#39;tank&#39;</span><span class="p">,</span> <span class="s1">&#39;uncle&#39;</span><span class="p">,</span> <span class="s1">&#39;climate&#39;</span><span class="p">,</span> <span class="s1">&#39;ground&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;communication&#39;</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="s1">&#39;poet&#39;</span><span class="p">,</span> <span class="s1">&#39;child&#39;</span><span class="p">,</span> <span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;mine&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;lack&#39;</span><span class="p">,</span> <span class="s1">&#39;charity&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;tooth&#39;</span><span class="p">,</span> <span class="s1">&#39;fear&#39;</span><span class="p">,</span> <span class="s1">&#39;mention&#39;</span><span class="p">,</span> <span class="s1">&#39;marketing&#39;</span><span class="p">,</span> <span class="s1">&#39;reveal&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="s1">&#39;court&#39;</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">,</span> <span class="s1">&#39;freedom&#39;</span><span class="p">,</span> <span class="s1">&#39;land&#39;</span><span class="p">,</span> <span class="s1">&#39;sport&#39;</span><span class="p">,</span> <span class="s1">&#39;audience&#39;</span><span class="p">,</span> <span class="s1">&#39;classroom&#39;</span><span class="p">,</span> <span class="s1">&#39;law&#39;</span><span class="p">,</span> <span class="s1">&#39;hook&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">,</span> <span class="s1">&#39;eye&#39;</span><span class="p">,</span> <span class="s1">&#39;smell&#39;</span><span class="p">,</span> <span class="s1">&#39;distribution&#39;</span><span class="p">,</span> <span class="s1">&#39;research&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">,</span> <span class="s1">&#39;dare&#39;</span><span class="p">,</span> <span class="s1">&#39;hope&#39;</span><span class="p">,</span> <span class="s1">&#39;whereas&#39;</span><span class="p">,</span> <span class="s1">&#39;stretch&#39;</span><span class="p">,</span> <span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="s1">&#39;college&#39;</span><span class="p">,</span> <span class="s1">&#39;plastic&#39;</span><span class="p">,</span> <span class="s1">&#39;book&#39;</span><span class="p">,</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="s1">&#39;worry&#39;</span><span class="p">,</span> <span class="s1">&#39;champion&#39;</span><span class="p">,</span> <span class="s1">&#39;goal&#39;</span><span class="p">,</span> <span class="s1">&#39;economy&#39;</span><span class="p">,</span> <span class="s1">&#39;march&#39;</span><span class="p">,</span> <span class="s1">&#39;election&#39;</span><span class="p">,</span> <span class="s1">&#39;reflection&#39;</span><span class="p">,</span> <span class="s1">&#39;midnight&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;inflation&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;challenge&#39;</span><span class="p">,</span> <span class="s1">&#39;guitar&#39;</span><span class="p">,</span> <span class="s1">&#39;coast&#39;</span><span class="p">,</span> <span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;campaign&#39;</span><span class="p">,</span> <span class="s1">&#39;field&#39;</span><span class="p">,</span> <span class="s1">&#39;jacket&#39;</span><span class="p">,</span> <span class="s1">&#39;sense&#39;</span><span class="p">,</span> <span class="s1">&#39;way&#39;</span><span class="p">,</span> <span class="s1">&#39;visual&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;weather&#39;</span><span class="p">,</span> <span class="s1">&#39;trash&#39;</span><span class="p">,</span> <span class="s1">&#39;cable&#39;</span><span class="p">,</span> <span class="s1">&#39;regret&#39;</span><span class="p">,</span> <span class="s1">&#39;buddy&#39;</span><span class="p">,</span> <span class="s1">&#39;beach&#39;</span><span class="p">,</span> <span class="s1">&#39;historian&#39;</span><span class="p">,</span> <span class="s1">&#39;courage&#39;</span><span class="p">,</span> <span class="s1">&#39;sympathy&#39;</span><span class="p">,</span> <span class="s1">&#39;truck&#39;</span><span class="p">,</span> <span class="s1">&#39;tension&#39;</span><span class="p">,</span> <span class="s1">&#39;permit&#39;</span><span class="p">,</span> <span class="s1">&#39;nose&#39;</span><span class="p">,</span> <span class="s1">&#39;bed&#39;</span><span class="p">,</span> <span class="s1">&#39;son&#39;</span><span class="p">,</span> <span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;meat&#39;</span><span class="p">,</span> <span class="s1">&#39;usual&#39;</span><span class="p">,</span> <span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="s1">&#39;meeting&#39;</span><span class="p">,</span> <span class="s1">&#39;worth&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;independence&#39;</span><span class="p">,</span> <span class="s1">&#39;physical&#39;</span><span class="p">,</span> <span class="s1">&#39;brief&#39;</span><span class="p">,</span> <span class="s1">&#39;play&#39;</span><span class="p">,</span> <span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="s1">&#39;board&#39;</span><span class="p">,</span> <span class="s1">&#39;she&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;writing&#39;</span><span class="p">,</span> <span class="s1">&#39;pick&#39;</span><span class="p">,</span> <span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;party&#39;</span><span class="p">,</span> <span class="s1">&#39;yesterday&#39;</span><span class="p">,</span> <span class="s1">&#39;spring&#39;</span><span class="p">,</span> <span class="s1">&#39;candidate&#39;</span><span class="p">,</span> <span class="s1">&#39;physics&#39;</span><span class="p">,</span> <span class="s1">&#39;university&#39;</span><span class="p">,</span> <span class="s1">&#39;concern&#39;</span><span class="p">,</span> <span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;room&#39;</span><span class="p">,</span> <span class="s1">&#39;bitter&#39;</span><span class="p">,</span> <span class="s1">&#39;bird&#39;</span><span class="p">,</span> <span class="s1">&#39;football&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;impression&#39;</span><span class="p">,</span> <span class="s1">&#39;wood&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="s1">&#39;meaning&#39;</span><span class="p">,</span> <span class="s1">&#39;stock&#39;</span><span class="p">,</span> <span class="s1">&#39;cap&#39;</span><span class="p">,</span> <span class="s1">&#39;leadership&#39;</span><span class="p">,</span> <span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="s1">&#39;ambition&#39;</span><span class="p">,</span> <span class="s1">&#39;fishing&#39;</span><span class="p">,</span> <span class="s1">&#39;essay&#39;</span><span class="p">,</span> <span class="s1">&#39;salad&#39;</span><span class="p">,</span> <span class="s1">&#39;repair&#39;</span><span class="p">,</span> <span class="s1">&#39;today&#39;</span><span class="p">,</span> <span class="s1">&#39;designer&#39;</span><span class="p">,</span> <span class="s1">&#39;night&#39;</span><span class="p">,</span> <span class="s1">&#39;bank&#39;</span><span class="p">,</span> <span class="s1">&#39;drawing&#39;</span><span class="p">,</span> <span class="s1">&#39;inevitable&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span> <span class="s1">&#39;vast&#39;</span><span class="p">,</span> <span class="s1">&#39;chip&#39;</span><span class="p">,</span> <span class="s1">&#39;anger&#39;</span><span class="p">,</span> <span class="s1">&#39;switch&#39;</span><span class="p">,</span> <span class="s1">&#39;cry&#39;</span><span class="p">,</span> <span class="s1">&#39;twist&#39;</span><span class="p">,</span> <span class="s1">&#39;personality&#39;</span><span class="p">,</span> <span class="s1">&#39;attempt&#39;</span><span class="p">,</span> <span class="s1">&#39;storage&#39;</span><span class="p">,</span> <span class="s1">&#39;being&#39;</span><span class="p">,</span> <span class="s1">&#39;preparation&#39;</span><span class="p">,</span> <span class="s1">&#39;bat&#39;</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;technology&#39;</span><span class="p">,</span> <span class="s1">&#39;contract&#39;</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">,</span> <span class="s1">&#39;till&#39;</span><span class="p">,</span> <span class="s1">&#39;structure&#39;</span><span class="p">,</span> <span class="s1">&#39;tongue&#39;</span><span class="p">,</span> <span class="s1">&#39;taste&#39;</span><span class="p">,</span> <span class="s1">&#39;truth&#39;</span><span class="p">,</span> <span class="s1">&#39;difficulty&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="s1">&#39;feeling&#39;</span><span class="p">,</span> <span class="s1">&#39;light&#39;</span><span class="p">,</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="s1">&#39;mission&#39;</span><span class="p">,</span> <span class="s1">&#39;might&#39;</span><span class="p">,</span> <span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="s1">&#39;shop&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;classic&#39;</span><span class="p">,</span> <span class="s1">&#39;alternative&#39;</span><span class="p">,</span> <span class="s1">&#39;cause&#39;</span><span class="p">,</span> <span class="s1">&#39;agent&#39;</span><span class="p">,</span> <span class="s1">&#39;consist&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;airline&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="s1">&#39;craft&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;fuel&#39;</span><span class="p">,</span> <span class="s1">&#39;tool&#39;</span><span class="p">,</span> <span class="s1">&#39;partner&#39;</span><span class="p">,</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="s1">&#39;entrance&#39;</span><span class="p">,</span> <span class="s1">&#39;deposit&#39;</span><span class="p">,</span> <span class="s1">&#39;hate&#39;</span><span class="p">,</span> <span class="s1">&#39;article&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;summer&#39;</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;extreme&#39;</span><span class="p">,</span> <span class="s1">&#39;mobile&#39;</span><span class="p">,</span> <span class="s1">&#39;hospital&#39;</span><span class="p">,</span> <span class="s1">&#39;flight&#39;</span><span class="p">,</span> <span class="s1">&#39;fall&#39;</span><span class="p">,</span> <span class="s1">&#39;pension&#39;</span><span class="p">,</span> <span class="s1">&#39;piano&#39;</span><span class="p">,</span> <span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;rub&#39;</span><span class="p">,</span> <span class="s1">&#39;gap&#39;</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;report&#39;</span><span class="p">,</span> <span class="s1">&#39;suck&#39;</span><span class="p">,</span> <span class="s1">&#39;ordinary&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">,</span> <span class="s1">&#39;nerve&#39;</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="s1">&#39;shine&#39;</span><span class="p">,</span> <span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;mom&#39;</span><span class="p">,</span> <span class="s1">&#39;perception&#39;</span><span class="p">,</span> <span class="s1">&#39;brother&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;bend&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;treat&#39;</span><span class="p">,</span> <span class="s1">&#39;trick&#39;</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;homework&#39;</span><span class="p">,</span> <span class="s1">&#39;bake&#39;</span><span class="p">,</span> <span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;let&#39;</span><span class="p">,</span> <span class="s1">&#39;enthusiasm&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;concentrate&#39;</span><span class="p">,</span> <span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="s1">&#39;travel&#39;</span><span class="p">,</span> <span class="s1">&#39;poetry&#39;</span><span class="p">,</span> <span class="s1">&#39;business&#39;</span><span class="p">,</span> <span class="s1">&#39;society&#39;</span><span class="p">,</span> <span class="s1">&#39;kiss&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;vegetable&#39;</span><span class="p">,</span> <span class="s1">&#39;employ&#39;</span><span class="p">,</span> <span class="s1">&#39;schedule&#39;</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;brave&#39;</span><span class="p">,</span> <span class="s1">&#39;focus&#39;</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="s1">&#39;movie&#39;</span><span class="p">,</span> <span class="s1">&#39;illegal&#39;</span><span class="p">,</span> <span class="s1">&#39;general&#39;</span><span class="p">,</span> <span class="s1">&#39;coffee&#39;</span><span class="p">,</span> <span class="s1">&#39;ad&#39;</span><span class="p">,</span> <span class="s1">&#39;highway&#39;</span><span class="p">,</span> <span class="s1">&#39;chemistry&#39;</span><span class="p">,</span> <span class="s1">&#39;psychology&#39;</span><span class="p">,</span> <span class="s1">&#39;hire&#39;</span><span class="p">,</span> <span class="s1">&#39;bell&#39;</span><span class="p">,</span> <span class="s1">&#39;conference&#39;</span><span class="p">,</span> <span class="s1">&#39;relief&#39;</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="s1">&#39;neat&#39;</span><span class="p">,</span> <span class="s1">&#39;funny&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="s1">&#39;club&#39;</span><span class="p">,</span> <span class="s1">&#39;daughter&#39;</span><span class="p">,</span> <span class="s1">&#39;zone&#39;</span><span class="p">,</span> <span class="s1">&#39;touch&#39;</span><span class="p">,</span> <span class="s1">&#39;tonight&#39;</span><span class="p">,</span> <span class="s1">&#39;shock&#39;</span><span class="p">,</span> <span class="s1">&#39;burn&#39;</span><span class="p">,</span> <span class="s1">&#39;excuse&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;survey&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">,</span> <span class="s1">&#39;advance&#39;</span><span class="p">,</span> <span class="s1">&#39;satisfaction&#39;</span><span class="p">,</span> <span class="s1">&#39;bread&#39;</span><span class="p">,</span> <span class="s1">&#39;disaster&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;hat&#39;</span><span class="p">,</span> <span class="s1">&#39;prior&#39;</span><span class="p">,</span> <span class="s1">&#39;shopping&#39;</span><span class="p">,</span> <span class="s1">&#39;visit&#39;</span><span class="p">,</span> <span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="s1">&#39;photo&#39;</span><span class="p">,</span> <span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="s1">&#39;idea&#39;</span><span class="p">,</span> <span class="s1">&#39;father&#39;</span><span class="p">,</span> <span class="s1">&#39;comparison&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;pipe&#39;</span><span class="p">,</span> <span class="s1">&#39;winner&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;lake&#39;</span><span class="p">,</span> <span class="s1">&#39;fight&#39;</span><span class="p">,</span> <span class="s1">&#39;prize&#39;</span><span class="p">,</span> <span class="s1">&#39;foundation&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;ideal&#39;</span><span class="p">,</span> <span class="s1">&#39;fan&#39;</span><span class="p">,</span> <span class="s1">&#39;struggle&#39;</span><span class="p">,</span> <span class="s1">&#39;peak&#39;</span><span class="p">,</span> <span class="s1">&#39;safety&#39;</span><span class="p">,</span> <span class="s1">&#39;solution&#39;</span><span class="p">,</span> <span class="s1">&#39;hell&#39;</span><span class="p">,</span> <span class="s1">&#39;conclusion&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="s1">&#39;strain&#39;</span><span class="p">,</span> <span class="s1">&#39;alarm&#39;</span><span class="p">,</span> <span class="s1">&#39;measurement&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;race&#39;</span><span class="p">,</span> <span class="s1">&#39;due&#39;</span><span class="p">,</span> <span class="s1">&#39;insurance&#39;</span><span class="p">,</span> <span class="s1">&#39;boss&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;monitor&#39;</span><span class="p">,</span> <span class="s1">&#39;sick&#39;</span><span class="p">,</span> <span class="s1">&#39;course&#39;</span><span class="p">,</span> <span class="s1">&#39;drag&#39;</span><span class="p">,</span> <span class="s1">&#39;appointment&#39;</span><span class="p">,</span> <span class="s1">&#39;slice&#39;</span><span class="p">,</span> <span class="s1">&#39;still&#39;</span><span class="p">,</span> <span class="s1">&#39;care&#39;</span><span class="p">,</span> <span class="s1">&#39;patience&#39;</span><span class="p">,</span> <span class="s1">&#39;rich&#39;</span><span class="p">,</span> <span class="s1">&#39;escape&#39;</span><span class="p">,</span> <span class="s1">&#39;emotion&#39;</span><span class="p">,</span> <span class="s1">&#39;royal&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="s1">&#39;childhood&#39;</span><span class="p">,</span> <span class="s1">&#39;government&#39;</span><span class="p">,</span> <span class="s1">&#39;picture&#39;</span><span class="p">,</span> <span class="s1">&#39;will&#39;</span><span class="p">,</span> <span class="s1">&#39;sock&#39;</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">,</span> <span class="s1">&#39;gate&#39;</span><span class="p">,</span> <span class="s1">&#39;oil&#39;</span><span class="p">,</span> <span class="s1">&#39;cross&#39;</span><span class="p">,</span> <span class="s1">&#39;pin&#39;</span><span class="p">,</span> <span class="s1">&#39;improvement&#39;</span><span class="p">,</span> <span class="s1">&#39;championship&#39;</span><span class="p">,</span> <span class="s1">&#39;silly&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;sky&#39;</span><span class="p">,</span> <span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="s1">&#39;man&#39;</span><span class="p">,</span> <span class="s1">&#39;diamond&#39;</span><span class="p">,</span> <span class="s1">&#39;most&#39;</span><span class="p">,</span> <span class="s1">&#39;transition&#39;</span><span class="p">,</span> <span class="s1">&#39;work&#39;</span><span class="p">,</span> <span class="s1">&#39;science&#39;</span><span class="p">,</span> <span class="s1">&#39;committee&#39;</span><span class="p">,</span> <span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;fix&#39;</span><span class="p">,</span> <span class="s1">&#39;teaching&#39;</span><span class="p">,</span> <span class="s1">&#39;dig&#39;</span><span class="p">,</span> <span class="s1">&#39;specialist&#39;</span><span class="p">,</span> <span class="s1">&#39;complex&#39;</span><span class="p">,</span> <span class="s1">&#39;guide&#39;</span><span class="p">,</span> <span class="s1">&#39;people&#39;</span><span class="p">,</span> <span class="s1">&#39;dead&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;original&#39;</span><span class="p">,</span> <span class="s1">&#39;break&#39;</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;degree&#39;</span><span class="p">,</span> <span class="s1">&#39;reading&#39;</span><span class="p">,</span> <span class="s1">&#39;recording&#39;</span><span class="p">,</span> <span class="s1">&#39;bunch&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">,</span> <span class="s1">&#39;judgment&#39;</span><span class="p">,</span> <span class="s1">&#39;lie&#39;</span><span class="p">,</span> <span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;painting&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;player&#39;</span><span class="p">,</span> <span class="s1">&#39;bear&#39;</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;wonder&#39;</span><span class="p">,</span> <span class="s1">&#39;carpet&#39;</span><span class="p">,</span> <span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;officer&#39;</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="s1">&#39;clock&#39;</span><span class="p">,</span> <span class="s1">&#39;unique&#39;</span><span class="p">,</span> <span class="s1">&#39;baby&#39;</span><span class="p">,</span> <span class="s1">&#39;pain&#39;</span><span class="p">,</span> <span class="s1">&#39;assumption&#39;</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="s1">&#39;iron&#39;</span><span class="p">,</span> <span class="s1">&#39;bill&#39;</span><span class="p">,</span> <span class="s1">&#39;drawer&#39;</span><span class="p">,</span> <span class="s1">&#39;look&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;mistake&#39;</span><span class="p">,</span> <span class="s1">&#39;finish&#39;</span><span class="p">,</span> <span class="s1">&#39;future&#39;</span><span class="p">,</span> <span class="s1">&#39;brilliant&#39;</span><span class="p">,</span> <span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;rice&#39;</span><span class="p">,</span> <span class="s1">&#39;leave&#39;</span><span class="p">,</span> <span class="s1">&#39;restaurant&#39;</span><span class="p">,</span> <span class="s1">&#39;discount&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;virus&#39;</span><span class="p">,</span> <span class="s1">&#39;bit&#39;</span><span class="p">,</span> <span class="s1">&#39;trust&#39;</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;wear&#39;</span><span class="p">,</span> <span class="s1">&#39;juice&#39;</span><span class="p">,</span> <span class="s1">&#39;failure&#39;</span><span class="p">,</span> <span class="s1">&#39;bug&#39;</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;mud&#39;</span><span class="p">,</span> <span class="s1">&#39;whole&#39;</span><span class="p">,</span> <span class="s1">&#39;wrap&#39;</span><span class="p">,</span> <span class="s1">&#39;intention&#39;</span><span class="p">,</span> <span class="s1">&#39;draft&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;cake&#39;</span><span class="p">,</span> <span class="s1">&#39;dark&#39;</span><span class="p">,</span> <span class="s1">&#39;explanation&#39;</span><span class="p">,</span> <span class="s1">&#39;space&#39;</span><span class="p">,</span> <span class="s1">&#39;angle&#39;</span><span class="p">,</span> <span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="s1">&#39;efficiency&#39;</span><span class="p">,</span> <span class="s1">&#39;management&#39;</span><span class="p">,</span> <span class="s1">&#39;habit&#39;</span><span class="p">,</span> <span class="s1">&#39;star&#39;</span><span class="p">,</span> <span class="s1">&#39;chance&#39;</span><span class="p">,</span> <span class="s1">&#39;finding&#39;</span><span class="p">,</span> <span class="s1">&#39;transportation&#39;</span><span class="p">,</span> <span class="s1">&#39;stand&#39;</span><span class="p">,</span> <span class="s1">&#39;criticism&#39;</span><span class="p">,</span> <span class="s1">&#39;flow&#39;</span><span class="p">,</span> <span class="s1">&#39;door&#39;</span><span class="p">,</span> <span class="s1">&#39;injury&#39;</span><span class="p">,</span> <span class="s1">&#39;insect&#39;</span><span class="p">,</span> <span class="s1">&#39;surprise&#39;</span><span class="p">,</span> <span class="s1">&#39;apartment&#39;</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util.count_sentences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">count_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Count the number of sentences.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">count_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Count the number of sentences.&quot;&quot;&quot;</span>
  <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">_get_sentence_tokenizer</span><span class="p">()</span>
  <span class="n">tokenized_sentences</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized_sentences</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util.count_words" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Counts the number of words.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Counts the number of words.&quot;&quot;&quot;</span>
  <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">tokenize</span><span class="o">.</span><span class="n">RegexpTokenizer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">)</span>
  <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="n">num_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">num_words</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util.generate_keywords" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">generate_keywords</span><span class="p">(</span><span class="n">num_keywords</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Randomly generates a few keywords.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_keywords</span><span class="p">(</span><span class="n">num_keywords</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Randomly generates a few keywords.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">WORD_LIST</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">num_keywords</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util.split_into_sentences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">split_into_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Split the text into sentences.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string that consists of more than or equal to one sentences.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of strings where each string is a sentence.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_into_sentences</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Split the text into sentences.</span>

<span class="sd">  Args:</span>
<span class="sd">    text: A string that consists of more than or equal to one sentences.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list of strings where each string is a sentence.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_PREFIXES</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&lt;prd&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_WEBSITES</span><span class="p">,</span> <span class="s2">&quot;&lt;prd&gt;</span><span class="se">\\</span><span class="s2">1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_DIGITS</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span> <span class="o">+</span> <span class="n">_DIGITS</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&lt;prd&gt;</span><span class="se">\\</span><span class="s2">2&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
      <span class="n">_MULTIPLE_DOTS</span><span class="p">,</span>
      <span class="k">lambda</span> <span class="n">match</span><span class="p">:</span> <span class="s2">&quot;&lt;prd&gt;&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;&lt;stop&gt;&quot;</span><span class="p">,</span>
      <span class="n">text</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="k">if</span> <span class="s2">&quot;Ph.D&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Ph.D.&quot;</span><span class="p">,</span> <span class="s2">&quot;Ph&lt;prd&gt;D&lt;prd&gt;&quot;</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s&quot;</span> <span class="o">+</span> <span class="n">_ALPHABETS</span> <span class="o">+</span> <span class="s2">&quot;[.] &quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">1&lt;prd&gt; &quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_ACRONYMS</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">_STARTERS</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&lt;stop&gt; </span><span class="se">\\</span><span class="s2">2&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
      <span class="n">_ALPHABETS</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span> <span class="o">+</span> <span class="n">_ALPHABETS</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span> <span class="o">+</span> <span class="n">_ALPHABETS</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span><span class="p">,</span>
      <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&lt;prd&gt;</span><span class="se">\\</span><span class="s2">2&lt;prd&gt;</span><span class="se">\\</span><span class="s2">3&lt;prd&gt;&quot;</span><span class="p">,</span>
      <span class="n">text</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
      <span class="n">_ALPHABETS</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span> <span class="o">+</span> <span class="n">_ALPHABETS</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&lt;prd&gt;</span><span class="se">\\</span><span class="s2">2&lt;prd&gt;&quot;</span><span class="p">,</span> <span class="n">text</span>
  <span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">_SUFFIXES</span> <span class="o">+</span> <span class="s2">&quot;[.] &quot;</span> <span class="o">+</span> <span class="n">_STARTERS</span><span class="p">,</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">1&lt;stop&gt; </span><span class="se">\\</span><span class="s2">2&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">_SUFFIXES</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">1&lt;prd&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">_ALPHABETS</span> <span class="o">+</span> <span class="s2">&quot;[.]&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">1&lt;prd&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="k">if</span> <span class="s2">&quot;”&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.”&quot;</span><span class="p">,</span> <span class="s2">&quot;”.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="s2">&quot;!&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;!&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;!&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;?&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;?&#39;</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;.&lt;stop&gt;&quot;</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;?&lt;stop&gt;&quot;</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="s2">&quot;!&lt;stop&gt;&quot;</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;prd&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
  <span class="n">sentences</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&lt;stop&gt;&quot;</span><span class="p">)</span>
  <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">sentences</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sentences</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">sentences</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">sentences</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h8 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>instructions_util_test</code>


</h8>

    <div class="doc doc-contents ">

        <p>Test for utility library of instructions.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>InstructionsUtilTest</code>


</h9>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="absl.testing.parameterized.TestCase">TestCase</span></code></p>









              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util_test.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InstructionsUtilTest</span><span class="p">(</span><span class="n">parameterized</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

  <span class="n">TEST_WORD_COUNT_CASE_1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;word1, word2, word3, word4.&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

  <span class="n">TEST_WORD_COUNT_CASE_2</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Bard can you tell me which is the best optimization method for the</span>
<span class="sd">      transition from an hydro-thermal system to an hydro-renewables system&quot;&quot;&quot;</span><span class="p">,</span>
      <span class="mi">24</span><span class="p">)</span>

  <span class="n">TEST_WORD_COUNT_CASE_3</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Hyphenated-word has two word counts.</span>
<span class="sd">      &quot;&quot;&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_word_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests word counter.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
      <span class="n">text</span><span class="p">,</span> <span class="n">expected_num_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_1</span>
      <span class="n">actual_num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_num_words</span><span class="p">,</span> <span class="n">actual_num_words</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
      <span class="n">text</span><span class="p">,</span> <span class="n">expected_num_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_2</span>
      <span class="n">actual_num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_num_words</span><span class="p">,</span> <span class="n">actual_num_words</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
      <span class="n">text</span><span class="p">,</span> <span class="n">expected_num_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_3</span>
      <span class="n">actual_num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_num_words</span><span class="p">,</span> <span class="n">actual_num_words</span><span class="p">)</span>

  <span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
      <span class="p">[</span>
          <span class="p">{</span>  <span class="c1"># pylint: disable=g-complex-comprehension</span>
              <span class="s2">&quot;testcase_name&quot;</span><span class="p">:</span> <span class="p">(</span>
                  <span class="sa">f</span><span class="s2">&quot;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">_num_sentences=</span><span class="si">{</span><span class="n">num_sentences</span><span class="si">}</span><span class="s2">&quot;</span>
              <span class="p">),</span>
              <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
              <span class="s2">&quot;num_sentences&quot;</span><span class="p">:</span> <span class="n">num_sentences</span><span class="p">,</span>
          <span class="p">}</span>
          <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">num_sentences</span> <span class="ow">in</span> <span class="p">[</span>
              <span class="p">(</span><span class="s2">&quot;xx,x. xx,x! xx/x. x</span><span class="si">{x}</span><span class="s2">x? x.&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
              <span class="p">(</span><span class="s2">&quot;xx,x! xxxx. x(x)x?&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
              <span class="p">(</span><span class="s2">&quot;xxxx. xx,x! xx|x. x&amp;x x?&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
              <span class="p">(</span><span class="s2">&quot;xx-x]xx,x! x</span><span class="si">{x}</span><span class="s2">xx,x.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
          <span class="p">]</span>
      <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">test_count_sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests sentence counter.&quot;&quot;&quot;</span>
    <span class="n">actual_num_sentences</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_sentences</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">num_sentences</span><span class="p">,</span> <span class="n">actual_num_sentences</span><span class="p">)</span>

  <span class="n">TEST_SENTENCE_SPLIT_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  Google is a technology company. It was founded in 1998 by Larry Page</span>
<span class="s2">and Sergey Brin. Google&#39;s mission is to organize the world&#39;s information</span>
<span class="s2">and make it universally accessible and useful.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">TEST_SENTENCE_SPLIT_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  The U.S.A has many Ph.D. students. They will often haven a .com website</span>
<span class="s2">sharing the research that they have done.</span>
<span class="s2">  &quot;&quot;&quot;</span>

  <span class="n">EXPECTED_SENTENCE_SPLIT_1</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">&quot;Google is a technology company.&quot;</span><span class="p">,</span>
      <span class="s2">&quot;It was founded in 1998 by Larry Page and Sergey Brin.&quot;</span><span class="p">,</span>
      <span class="p">(</span>
          <span class="s2">&quot;Google&#39;s mission is to organize the world&#39;s information and make it&quot;</span>
          <span class="s2">&quot; universally accessible and useful.&quot;</span>
      <span class="p">),</span>
  <span class="p">]</span>

  <span class="n">EXPECTED_SENTENCE_SPLIT_2</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">&quot;The U.S.A has many Ph.D. students.&quot;</span><span class="p">,</span>
      <span class="p">(</span>
          <span class="s2">&quot;They will often haven a .com website sharing the research that they&quot;</span>
          <span class="s2">&quot; have done.&quot;</span>
      <span class="p">),</span>
  <span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_sentence_splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests sentence splitter.&quot;&quot;&quot;</span>
    <span class="n">sentence_split_1</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">split_into_sentences</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TEST_SENTENCE_SPLIT_1</span>
    <span class="p">)</span>
    <span class="n">sentence_split_2</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">split_into_sentences</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TEST_SENTENCE_SPLIT_2</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_SENTENCE_SPLIT_1</span><span class="p">,</span> <span class="n">sentence_split_1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_SENTENCE_SPLIT_2</span><span class="p">,</span> <span class="n">sentence_split_2</span><span class="p">)</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">test_generate_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests generate keywords.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertLen</span><span class="p">(</span><span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.EXPECTED_SENTENCE_SPLIT_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">EXPECTED_SENTENCE_SPLIT_1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Google is a technology company.&#39;</span><span class="p">,</span> <span class="s1">&#39;It was founded in 1998 by Larry Page and Sergey Brin.&#39;</span><span class="p">,</span> <span class="s2">&quot;Google&#39;s mission is to organize the world&#39;s information and make it universally accessible and useful.&quot;</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.EXPECTED_SENTENCE_SPLIT_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">EXPECTED_SENTENCE_SPLIT_2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;The U.S.A has many Ph.D. students.&#39;</span><span class="p">,</span> <span class="s1">&#39;They will often haven a .com website sharing the research that they have done.&#39;</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.TEST_SENTENCE_SPLIT_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_SENTENCE_SPLIT_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Google is a technology company. It was founded in 1998 by Larry Page</span><span class="se">\n</span><span class="s2">and Sergey Brin. Google&#39;s mission is to organize the world&#39;s information</span><span class="se">\n</span><span class="s2">and make it universally accessible and useful.</span><span class="se">\n</span><span class="s2">  &quot;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.TEST_SENTENCE_SPLIT_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_SENTENCE_SPLIT_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  The U.S.A has many Ph.D. students. They will often haven a .com website</span><span class="se">\n</span><span class="s1">sharing the research that they have done.</span><span class="se">\n</span><span class="s1">  &#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.TEST_WORD_COUNT_CASE_1" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_WORD_COUNT_CASE_1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;word1, word2, word3, word4.&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.TEST_WORD_COUNT_CASE_2" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_WORD_COUNT_CASE_2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">      Bard can you tell me which is the best optimization method for the</span><span class="se">\n</span><span class="s1">      transition from an hydro-thermal system to an hydro-renewables system&#39;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.TEST_WORD_COUNT_CASE_3" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">TEST_WORD_COUNT_CASE_3</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">      Hyphenated-word has two word counts.</span><span class="se">\n</span><span class="s1">      &#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.test_count_sentences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_count_sentences</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">)</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Tests sentence counter.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@parameterized</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">{</span>  <span class="c1"># pylint: disable=g-complex-comprehension</span>
            <span class="s2">&quot;testcase_name&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;_response=</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">_num_sentences=</span><span class="si">{</span><span class="n">num_sentences</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
            <span class="s2">&quot;num_sentences&quot;</span><span class="p">:</span> <span class="n">num_sentences</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">response</span><span class="p">,</span> <span class="n">num_sentences</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;xx,x. xx,x! xx/x. x</span><span class="si">{x}</span><span class="s2">x? x.&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;xx,x! xxxx. x(x)x?&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;xxxx. xx,x! xx|x. x&amp;x x?&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;xx-x]xx,x! x</span><span class="si">{x}</span><span class="s2">xx,x.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_count_sentences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">num_sentences</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Tests sentence counter.&quot;&quot;&quot;</span>
  <span class="n">actual_num_sentences</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_sentences</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">num_sentences</span><span class="p">,</span> <span class="n">actual_num_sentences</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.test_generate_keywords" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_generate_keywords</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Tests generate keywords.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_generate_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Tests generate keywords.&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertLen</span><span class="p">(</span><span class="n">instructions_util</span><span class="o">.</span><span class="n">generate_keywords</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.test_sentence_splitter" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_sentence_splitter</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Tests sentence splitter.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_sentence_splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Tests sentence splitter.&quot;&quot;&quot;</span>
  <span class="n">sentence_split_1</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">split_into_sentences</span><span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">TEST_SENTENCE_SPLIT_1</span>
  <span class="p">)</span>
  <span class="n">sentence_split_2</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">split_into_sentences</span><span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">TEST_SENTENCE_SPLIT_2</span>
  <span class="p">)</span>

  <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_SENTENCE_SPLIT_1</span><span class="p">,</span> <span class="n">sentence_split_1</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED_SENTENCE_SPLIT_2</span><span class="p">,</span> <span class="n">sentence_split_2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h10 id="aisteer360.evaluation.metrics.custom.instruction_following.helpers.instructions_util_test.InstructionsUtilTest.test_word_count" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">test_word_count</span><span class="p">()</span></code>

</h10>


    <div class="doc doc-contents ">

        <p>Tests word counter.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/helpers/instructions_util_test.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_word_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Tests word counter.&quot;&quot;&quot;</span>
  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="n">text</span><span class="p">,</span> <span class="n">expected_num_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_1</span>
    <span class="n">actual_num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_num_words</span><span class="p">,</span> <span class="n">actual_num_words</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="n">text</span><span class="p">,</span> <span class="n">expected_num_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_2</span>
    <span class="n">actual_num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_num_words</span><span class="p">,</span> <span class="n">actual_num_words</span><span class="p">)</span>

  <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="n">text</span><span class="p">,</span> <span class="n">expected_num_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST_WORD_COUNT_CASE_3</span>
    <span class="n">actual_num_words</span> <span class="o">=</span> <span class="n">instructions_util</span><span class="o">.</span><span class="n">count_words</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_num_words</span><span class="p">,</span> <span class="n">actual_num_words</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h7 id="aisteer360.evaluation.metrics.custom.instruction_following.strict_instruction" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>strict_instruction</code>


</h7>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h8 id="aisteer360.evaluation.metrics.custom.instruction_following.strict_instruction.StrictInstruction" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>StrictInstruction</code>


</h8>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Evaluation wrapper around IFEval's official implementation from Google Research (<a href="https://github.com/google-research/google-research/tree/master/instruction_following_eval">https://github.com/google-research/google-research/tree/master/instruction_following_eval</a>).
Measures how well models follow explicit instructions embedded within prompts, using strict binary evaluation criteria.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/strict_instruction.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StrictInstruction</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluation wrapper around IFEval&#39;s official implementation from Google Research ([https://github.com/google-research/google-research/tree/master/instruction_following_eval](https://github.com/google-research/google-research/tree/master/instruction_following_eval)).</span>
<span class="sd">    Measures how well models follow explicit instructions embedded within prompts, using strict binary evaluation criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fix_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fix kwargs list by removing None values and converting</span>
<span class="sd">        all-None dicts back to empty dicts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fixed_kwargs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kwarg_dict</span> <span class="ow">in</span> <span class="n">kwargs_list</span><span class="p">:</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwarg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
            <span class="n">fixed_kwargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fixed_kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes strict instruction-following metrics using IFEval evaluation.</span>

<span class="sd">        Evaluates model responses against structured instructions using the official IFEval framework. Each response is</span>
<span class="sd">        assessed both at the prompt level (whether ALL instructions were followed) and at the individual instruction</span>
<span class="sd">        level.</span>

<span class="sd">        Args:</span>
<span class="sd">            responses: List of response dictionaries, each containing:</span>

<span class="sd">                - &quot;prompt&quot;: The input prompt with embedded instructions</span>
<span class="sd">                - &quot;response&quot;: The model&#39;s generated response</span>
<span class="sd">                - &quot;instruction_id_list&quot;: List of instruction IDs to evaluate</span>
<span class="sd">                - &quot;kwargs&quot;: Additional parameters for instruction evaluation</span>
<span class="sd">            prompts: List of question prompts (unused, for interface compatibility).</span>
<span class="sd">            **kwargs: Additional arguments (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of instruction-following metrics with values:</span>

<span class="sd">                - &quot;strict_prompt_accuracy&quot;: Proportion of prompts where all instructions were followed correctly</span>
<span class="sd">                  (prompt-level accuracy)</span>
<span class="sd">                - &quot;strict_instruction_accuracy&quot;: Proportion of individual instructions followed correctly across all</span>
<span class="sd">                  prompts (instruction-level accuracy)</span>
<span class="sd">                - &quot;follow_all_instructions&quot;: List of boolean values indicating whether each prompt had all instructions</span>
<span class="sd">                  followed</span>

<span class="sd">        Note:</span>

<span class="sd">        - Returns zero accuracies and empty list if responses is None or empty.</span>
<span class="sd">        - The evaluation uses strict binary criteria (partial compliance counts as failure).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="k">if</span> <span class="n">responses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">correct_prompts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_instructions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">correct_instructions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">follow_all_instructions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">responses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
                <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">]</span>
                <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_kwargs</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">])</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
                <span class="c1"># test_instruction_following_strict expects an input with fields:</span>
                <span class="c1"># prompt, instruction_id_list, kwargs</span>
                <span class="n">output_example</span> <span class="o">=</span> <span class="n">test_instruction_following_strict</span><span class="p">(</span>
                    <span class="n">instance</span><span class="p">,</span> <span class="p">{</span><span class="n">prompt</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># if all instructions followed</span>
                <span class="k">if</span> <span class="n">output_example</span><span class="o">.</span><span class="n">follow_all_instructions</span><span class="p">:</span>
                    <span class="n">correct_prompts</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">follow_all_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">follow_all_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">num_instructions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_example</span><span class="o">.</span><span class="n">follow_instruction_list</span><span class="p">)</span>
                <span class="n">total_instructions</span> <span class="o">+=</span> <span class="n">num_instructions</span>
                <span class="n">correct_instructions</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output_example</span><span class="o">.</span><span class="n">follow_instruction_list</span><span class="p">)</span>

        <span class="n">strict_prompt_accuracy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">correct_prompts</span> <span class="o">/</span> <span class="n">total_prompts</span> <span class="k">if</span> <span class="n">total_prompts</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>
        <span class="n">strict_instruction_accuracy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">correct_instructions</span> <span class="o">/</span> <span class="n">total_instructions</span> <span class="k">if</span> <span class="n">total_instructions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;strict_prompt_accuracy&quot;</span><span class="p">:</span> <span class="n">strict_prompt_accuracy</span><span class="p">,</span>
            <span class="s2">&quot;strict_instruction_accuracy&quot;</span><span class="p">:</span> <span class="n">strict_instruction_accuracy</span><span class="p">,</span>
            <span class="s2">&quot;follow_all_instructions&quot;</span><span class="p">:</span> <span class="n">follow_all_instructions</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.strict_instruction.StrictInstruction.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.strict_instruction.StrictInstruction.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h9>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h9 id="aisteer360.evaluation.metrics.custom.instruction_following.strict_instruction.StrictInstruction.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h9>


    <div class="doc doc-contents ">

        <p>Computes strict instruction-following metrics using IFEval evaluation.</p>
<p>Evaluates model responses against structured instructions using the official IFEval framework. Each response is
assessed both at the prompt level (whether ALL instructions were followed) and at the individual instruction
level.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of response dictionaries, each containing:</p>
<ul>
<li>"prompt": The input prompt with embedded instructions</li>
<li>"response": The model's generated response</li>
<li>"instruction_id_list": List of instruction IDs to evaluate</li>
<li>"kwargs": Additional parameters for instruction evaluation</li>
</ul>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of question prompts (unused, for interface compatibility).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of instruction-following metrics with values:</p>
<ul>
<li>"strict_prompt_accuracy": Proportion of prompts where all instructions were followed correctly
  (prompt-level accuracy)</li>
<li>"strict_instruction_accuracy": Proportion of individual instructions followed correctly across all
  prompts (instruction-level accuracy)</li>
<li>"follow_all_instructions": List of boolean values indicating whether each prompt had all instructions
  followed</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>Returns zero accuracies and empty list if responses is None or empty.</li>
<li>The evaluation uses strict binary criteria (partial compliance counts as failure).</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/custom/instruction_following/strict_instruction.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes strict instruction-following metrics using IFEval evaluation.</span>

<span class="sd">    Evaluates model responses against structured instructions using the official IFEval framework. Each response is</span>
<span class="sd">    assessed both at the prompt level (whether ALL instructions were followed) and at the individual instruction</span>
<span class="sd">    level.</span>

<span class="sd">    Args:</span>
<span class="sd">        responses: List of response dictionaries, each containing:</span>

<span class="sd">            - &quot;prompt&quot;: The input prompt with embedded instructions</span>
<span class="sd">            - &quot;response&quot;: The model&#39;s generated response</span>
<span class="sd">            - &quot;instruction_id_list&quot;: List of instruction IDs to evaluate</span>
<span class="sd">            - &quot;kwargs&quot;: Additional parameters for instruction evaluation</span>
<span class="sd">        prompts: List of question prompts (unused, for interface compatibility).</span>
<span class="sd">        **kwargs: Additional arguments (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of instruction-following metrics with values:</span>

<span class="sd">            - &quot;strict_prompt_accuracy&quot;: Proportion of prompts where all instructions were followed correctly</span>
<span class="sd">              (prompt-level accuracy)</span>
<span class="sd">            - &quot;strict_instruction_accuracy&quot;: Proportion of individual instructions followed correctly across all</span>
<span class="sd">              prompts (instruction-level accuracy)</span>
<span class="sd">            - &quot;follow_all_instructions&quot;: List of boolean values indicating whether each prompt had all instructions</span>
<span class="sd">              followed</span>

<span class="sd">    Note:</span>

<span class="sd">    - Returns zero accuracies and empty list if responses is None or empty.</span>
<span class="sd">    - The evaluation uses strict binary criteria (partial compliance counts as failure).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="k">if</span> <span class="n">responses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">correct_prompts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_instructions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct_instructions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">follow_all_instructions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">responses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">]</span>
            <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_kwargs</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">])</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
            <span class="c1"># test_instruction_following_strict expects an input with fields:</span>
            <span class="c1"># prompt, instruction_id_list, kwargs</span>
            <span class="n">output_example</span> <span class="o">=</span> <span class="n">test_instruction_following_strict</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span> <span class="p">{</span><span class="n">prompt</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># if all instructions followed</span>
            <span class="k">if</span> <span class="n">output_example</span><span class="o">.</span><span class="n">follow_all_instructions</span><span class="p">:</span>
                <span class="n">correct_prompts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">follow_all_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">follow_all_instructions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">num_instructions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_example</span><span class="o">.</span><span class="n">follow_instruction_list</span><span class="p">)</span>
            <span class="n">total_instructions</span> <span class="o">+=</span> <span class="n">num_instructions</span>
            <span class="n">correct_instructions</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output_example</span><span class="o">.</span><span class="n">follow_instruction_list</span><span class="p">)</span>

    <span class="n">strict_prompt_accuracy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">correct_prompts</span> <span class="o">/</span> <span class="n">total_prompts</span> <span class="k">if</span> <span class="n">total_prompts</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="p">)</span>
    <span class="n">strict_instruction_accuracy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">correct_instructions</span> <span class="o">/</span> <span class="n">total_instructions</span> <span class="k">if</span> <span class="n">total_instructions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;strict_prompt_accuracy&quot;</span><span class="p">:</span> <span class="n">strict_prompt_accuracy</span><span class="p">,</span>
        <span class="s2">&quot;strict_instruction_accuracy&quot;</span><span class="p">:</span> <span class="n">strict_instruction_accuracy</span><span class="p">,</span>
        <span class="s2">&quot;follow_all_instructions&quot;</span><span class="p">:</span> <span class="n">follow_all_instructions</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.metrics.generic" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>generic</code>


</h5>

    <div class="doc doc-contents ">

        <p>Generic evaluation metrics.</p>
<p>This module contains metrics that can be used for evaluating model outputs regardless of the specific task or domain
(e.g., relevance, factuality, etc.).</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.evaluation.metrics.generic.factuality" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>factuality</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.evaluation.metrics.generic.factuality.Factuality" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Factuality</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            LLMJudgeMetric (aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric)" href="#aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric">LLMJudgeMetric</a></code></p>


        <p>Judge factual correctness of a response to a prompt.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/generic/factuality.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Factuality</span><span class="p">(</span><span class="n">LLMJudgeMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Judge factual correctness of a response to a prompt.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="n">prompt_template</span><span class="o">=</span><span class="n">_PROMPT</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.base_prompt_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.format_instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.max_retries" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.num_return_sequences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">num_return_sequences</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_return_sequences&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">tokenizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.scale" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.use_chat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;apply_chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.metrics.generic.factuality.Factuality.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Compute LLM judge scores for a list of responses.</p>
<p>Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple
samples are generated per response (via <code>num_return_sequences</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of text responses to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of prompts corresponding to each response.
If provided, must be the same length as responses. These prompts can be
referenced in the prompt_template using the {prompt} placeholder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score statistics containing:</p>
<ul>
<li>"mean_score": Overall average score across all responses</li>
<li>"scores": List of mean scores for each response (averaged across samples)</li>
<li>"raw_scores": List of lists containing all individual scores for each response</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prompts is provided but has different length than responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">    Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">    samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">        prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">            If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">            referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">        **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Score statistics containing:</span>

<span class="sd">            - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">            - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">            - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

    <span class="c1"># build prompts</span>
    <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
        <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

    <span class="c1"># generate</span>
    <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
            <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

            <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
    <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
        <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.evaluation.metrics.generic.perplexity" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>perplexity</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Perplexity</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Metric (aisteer360.evaluation.metrics.base.Metric)" href="#aisteer360.evaluation.metrics.base.Metric">Metric</a></code></p>


        <p>Compute token-level perplexity for a batch of sentences.</p>
<p>Perplexity is the exponentiated mean cross-entropy between the language model’s predicted distribution and the true
next token. Lower is better.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_or_id</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="torch.nn.Module">Module</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face model ID or an already-instantiated causal language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer to use.  Leave <code>None</code> when passing a model ID to automatically load the matching tokenizer.
Defaults to <code>None</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of sentences per forward pass. Higher is faster until GPU memory becomes the
bottleneck. Defaults to <code>16</code>.</p>
              </div>
            </td>
            <td>
                  <code>16</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>add_bos</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to prepend the tokenizer’s BOS token so the first word in each sentence is
also scored. Ignored if the tokenizer has no BOS token. Defaults to <code>True</code>.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If set, truncate inputs to this length so they fit the model’s context
window. <code>None</code> disables truncation. Defaults to <code>None</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>device</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>"cuda"</code> or <code>"cpu"</code>. When <code>None</code>, automatically selects GPU if available.
Defaults to <code>None</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            add_bos = add_bos and self.tokenizer.bos_token_id is not None

  
      instance-attribute
   (aisteer360.evaluation.metrics.generic.perplexity.Perplexity.add_bos)" href="#aisteer360.evaluation.metrics.generic.perplexity.Perplexity.add_bos">add_bos</a></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether a BOS token is prepended before scoring.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            batch_size = batch_size

  
      instance-attribute
   (aisteer360.evaluation.metrics.generic.perplexity.Perplexity.batch_size)" href="#aisteer360.evaluation.metrics.generic.perplexity.Perplexity.batch_size">batch_size</a></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of sentences processed per forward pass.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            device = device or ('cuda' if torch.cuda.is_available() else 'cpu')

  
      instance-attribute
   (aisteer360.evaluation.metrics.generic.perplexity.Perplexity.device)" href="#aisteer360.evaluation.metrics.generic.perplexity.Perplexity.device">device</a></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The device actually selected for computation (<code>"cuda"</code> or <code>"cpu"</code>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            max_length = max_length

  
      instance-attribute
   (aisteer360.evaluation.metrics.generic.perplexity.Perplexity.max_length)" href="#aisteer360.evaluation.metrics.generic.perplexity.Perplexity.max_length">max_length</a></code></td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Truncation length for inputs, or <code>None</code> for no truncation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            model = AutoModelForCausalLM.from_pretrained(model_or_id)

  
      instance-attribute
   (aisteer360.evaluation.metrics.generic.perplexity.Perplexity.model)" href="#aisteer360.evaluation.metrics.generic.perplexity.Perplexity.model">model</a></code></td>
            <td>
                  <code><span title="transformers.PreTrainedModel">PreTrainedModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded causal language model used to score tokens.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            tokenizer = tokenizer or AutoTokenizer.from_pretrained(model_or_id)

  
      instance-attribute
   (aisteer360.evaluation.metrics.generic.perplexity.Perplexity.tokenizer)" href="#aisteer360.evaluation.metrics.generic.perplexity.Perplexity.tokenizer">tokenizer</a></code></td>
            <td>
                  <code><span title="transformers.PreTrainedTokenizer">PreTrainedTokenizer</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer used for encoding, padding, and BOS handling.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/generic/perplexity.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Perplexity</span><span class="p">(</span><span class="n">Metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute token-level perplexity for a batch of sentences.</span>

<span class="sd">    Perplexity is the exponentiated mean cross-entropy between the language model’s predicted distribution and the true</span>
<span class="sd">    next token. Lower is better.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_or_id (str | torch.nn.Module): Hugging Face model ID or an already-instantiated causal language model.</span>
<span class="sd">        tokenizer (transformers.PreTrainedTokenizer | None, optional):</span>
<span class="sd">            Tokenizer to use.  Leave ``None`` when passing a model ID to automatically load the matching tokenizer.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">        batch_size (int, optional): Number of sentences per forward pass. Higher is faster until GPU memory becomes the</span>
<span class="sd">            bottleneck. Defaults to ``16``.</span>
<span class="sd">        add_bos (bool, optional): Whether to prepend the tokenizer’s BOS token so the first word in each sentence is</span>
<span class="sd">            also scored. Ignored if the tokenizer has no BOS token. Defaults to ``True``.</span>
<span class="sd">        max_length (int | None, optional): If set, truncate inputs to this length so they fit the model’s context</span>
<span class="sd">            window. ``None`` disables truncation. Defaults to ``None``.</span>
<span class="sd">        device (str | None, optional): ``&quot;cuda&quot;`` or ``&quot;cpu&quot;``. When ``None``, automatically selects GPU if available.</span>
<span class="sd">            Defaults to ``None``.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        add_bos (bool): Whether a BOS token is prepended before scoring.</span>
<span class="sd">        batch_size (int): Number of sentences processed per forward pass.</span>
<span class="sd">        device (str): The device actually selected for computation (``&quot;cuda&quot;`` or ``&quot;cpu&quot;``).</span>
<span class="sd">        max_length (int | None): Truncation length for inputs, or ``None`` for no truncation.</span>
<span class="sd">        model (transformers.PreTrainedModel): The loaded causal language model used to score tokens.</span>
<span class="sd">        tokenizer (transformers.PreTrainedTokenizer): Tokenizer used for encoding, padding, and BOS handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">add_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># model object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_or_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_name_or_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bos</span> <span class="o">=</span> <span class="n">add_bos</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">add_special_tokens</span><span class="p">({</span><span class="s2">&quot;pad_token&quot;</span><span class="p">:</span> <span class="s2">&quot;[PAD]&quot;</span><span class="p">})</span>
            <span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute perplexity for each response (and the mean across the batch).</span>

<span class="sd">        Args:</span>
<span class="sd">            responses (list[str]): Text sequences to score.</span>
<span class="sd">            prompts (list[str] | None, optional): Unused here; present for a uniform metric API.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, float]: A dict with keys:</span>

<span class="sd">                - ``&quot;mean_perplexity&quot;``: mean perplexity over all inputs.</span>
<span class="sd">                - ``&quot;perplexities&quot;``: list of per-sample perplexities in input order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">perplexities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">local_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span> <span class="n">local_batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">local_batch_size</span><span class="p">]</span>

            <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">truncation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
                <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos</span><span class="p">:</span>
                <span class="n">bos_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">bos_tokens</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="n">loss_per_token</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
                <span class="n">logits</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
            <span class="n">seq_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_per_token</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">perplexities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">seq_loss</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;mean_perplexity&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">perplexities</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">perplexities</span><span class="p">),</span>
            <span class="s2">&quot;perplexities&quot;</span><span class="p">:</span> <span class="n">perplexities</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.add_bos" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">add_bos</span> <span class="o">=</span> <span class="n">add_bos</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.max_length" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.metrics.generic.perplexity.Perplexity.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Compute perplexity for each response (and the mean across the batch).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Text sequences to score.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unused here; present for a uniform metric API.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, float]: A dict with keys:</p>
<ul>
<li><code>"mean_perplexity"</code>: mean perplexity over all inputs.</li>
<li><code>"perplexities"</code>: list of per-sample perplexities in input order.</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/generic/perplexity.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute perplexity for each response (and the mean across the batch).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): Text sequences to score.</span>
<span class="sd">        prompts (list[str] | None, optional): Unused here; present for a uniform metric API.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, float]: A dict with keys:</span>

<span class="sd">            - ``&quot;mean_perplexity&quot;``: mean perplexity over all inputs.</span>
<span class="sd">            - ``&quot;perplexities&quot;``: list of per-sample perplexities in input order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">perplexities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">local_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">),</span> <span class="n">local_batch_size</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">local_batch_size</span><span class="p">]</span>

        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">,</span>
            <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos</span><span class="p">:</span>
            <span class="n">bos_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="p">(</span><span class="n">input_ids</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">bos_tokens</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">input_ids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="n">loss_per_token</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
            <span class="n">logits</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">)</span>
        <span class="n">seq_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_per_token</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">perplexities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">seq_loss</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_perplexity&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">perplexities</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">perplexities</span><span class="p">),</span>
        <span class="s2">&quot;perplexities&quot;</span><span class="p">:</span> <span class="n">perplexities</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h6 id="aisteer360.evaluation.metrics.generic.relevance" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>relevance</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.evaluation.metrics.generic.relevance.Relevance" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Relevance</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            LLMJudgeMetric (aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric)" href="#aisteer360.evaluation.metrics.base_judge.LLMJudgeMetric">LLMJudgeMetric</a></code></p>


        <p>Judge relevance of a response to a prompt.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/metrics/generic/relevance.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Relevance</span><span class="p">(</span><span class="n">LLMJudgeMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Judge relevance of a response to a prompt.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="n">prompt_template</span><span class="o">=</span><span class="n">_PROMPT</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.base_prompt_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_prompt_template</span> <span class="o">=</span> <span class="n">prompt_template</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.batch_size" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.device" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.extras" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">extras</span> <span class="o">=</span> <span class="n">extras</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.format_instructions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">format_instructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_parser</span><span class="o">.</span><span class="n">get_format_instructions</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.max_retries" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.name" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.num_return_sequences" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">num_return_sequences</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gen_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;num_return_sequences&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TextGenerationPipeline</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span> <span class="n">tokenizer</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.scale" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.tokenizer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_or_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.use_chat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">use_chat</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;apply_chat_template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">chat_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.metrics.generic.relevance.Relevance.compute" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">prompts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Compute LLM judge scores for a list of responses.</p>
<p>Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple
samples are generated per response (via <code>num_return_sequences</code>).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>responses</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of text responses to evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompts</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional list of prompts corresponding to each response.
If provided, must be the same length as responses. These prompts can be
referenced in the prompt_template using the {prompt} placeholder.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="float">float</span> | <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Score statistics containing:</p>
<ul>
<li>"mean_score": Overall average score across all responses</li>
<li>"scores": List of mean scores for each response (averaged across samples)</li>
<li>"raw_scores": List of lists containing all individual scores for each response</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If prompts is provided but has different length than responses.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/metrics/base_judge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">responses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute LLM judge scores for a list of responses.</span>

<span class="sd">    Evaluates each response using the configured judge model and prompt template. Scores are averaged when multiple</span>
<span class="sd">    samples are generated per response (via `num_return_sequences`).</span>

<span class="sd">    Args:</span>
<span class="sd">        responses (list[str]): List of text responses to evaluate.</span>
<span class="sd">        prompts (list[str] | None): Optional list of prompts corresponding to each response.</span>
<span class="sd">            If provided, must be the same length as responses. These prompts can be</span>
<span class="sd">            referenced in the prompt_template using the {prompt} placeholder.</span>
<span class="sd">        **kwargs: Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Score statistics containing:</span>

<span class="sd">            - &quot;mean_score&quot;: Overall average score across all responses</span>
<span class="sd">            - &quot;scores&quot;: List of mean scores for each response (averaged across samples)</span>
<span class="sd">            - &quot;raw_scores&quot;: List of lists containing all individual scores for each response</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If prompts is provided but has different length than responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`responses` and `prompts` must be the same length&quot;</span><span class="p">)</span>

    <span class="c1"># build prompts</span>
    <span class="n">prompts_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)):</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">responses</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s2">&quot;lower_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;upper_bound&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">prompt_core</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">prompt_formatted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrap</span><span class="p">(</span><span class="n">prompt_core</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_instructions</span><span class="p">)</span>
        <span class="n">prompts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt_formatted</span><span class="p">)</span>

    <span class="c1"># generate</span>
    <span class="n">prompt_scores</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_chunks</span><span class="p">(</span><span class="n">prompts_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">num_return_sequences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span><span class="p">,</span>
            <span class="n">return_full_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">generations</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">generations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">generations</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">generations</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_return_sequences</span>

            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">:</span>
                <span class="n">reply_text</span> <span class="o">=</span> <span class="n">generation</span><span class="p">[</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">reply_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_with_retries</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

            <span class="n">prompt_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="n">mean_per_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_score</span><span class="p">)</span> <span class="k">for</span> <span class="n">prompt_score</span> <span class="ow">in</span> <span class="n">prompt_scores</span><span class="p">]</span>
    <span class="n">corpus_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_per_prompt</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">corpus_mean</span><span class="p">,</span>  <span class="c1"># overall average</span>
        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">mean_per_prompt</span><span class="p">,</span>  <span class="c1"># one number per original prompt</span>
        <span class="s2">&quot;raw_scores&quot;</span><span class="p">:</span> <span class="n">prompt_scores</span>  <span class="c1"># n_samples scores per prompt</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="aisteer360.evaluation.use_cases" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>use_cases</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.use_cases.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>base</code>


</h5>

    <div class="doc doc-contents ">

        <p>Base class for all use cases. Provides a framework for loading evaluation data, applying metrics, and running
standardized evaluations across different types of tasks. Subclasses must implement the <code>generate()</code> and <code>evaluate()</code>
methods to define task-specific evaluation logic.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h6 id="aisteer360.evaluation.use_cases.base.UseCase" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>UseCase</code>


</h6>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Base use case class.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/use_cases/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UseCase</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base use case class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">evaluation_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">evaluation_metrics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Metric</span><span class="p">],</span>
        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">evaluation_data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">evaluation_data</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.jsonl&#39;</span> <span class="k">else</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Either evaluation data was not provided, or was unable to be generated.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">num_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">[:</span><span class="n">num_samples</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span> <span class="o">=</span> <span class="n">evaluation_metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metrics_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">evaluation_metrics</span><span class="p">}</span>

        <span class="c1"># store kwargs as attributes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># validation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">Metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;All items in `evaluation_metrics` must be of type `Metric`.&quot;</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model_or_pipeline</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Required generation logic for the current use case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">generations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Required evaluation logic for model&#39;s generations via `evaluation_metrics`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
               <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optional formatting and export of evaluation profiles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># def validate_steering_data(self, steering_data):</span>
    <span class="c1">#     pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optional validation of the evaluation dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.use_cases.base.UseCase.evaluation_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">evaluation_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.jsonl&#39;</span> <span class="k">else</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h7 id="aisteer360.evaluation.use_cases.base.UseCase.evaluation_metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">evaluation_metrics</span> <span class="o">=</span> <span class="n">evaluation_metrics</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h7 id="aisteer360.evaluation.use_cases.base.UseCase.evaluate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">evaluate</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Required evaluation logic for model's generations via <code>evaluation_metrics</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">generations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Required evaluation logic for model&#39;s generations via `evaluation_metrics`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.evaluation.use_cases.base.UseCase.export" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">export</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Optional formatting and export of evaluation profiles.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
           <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optional formatting and export of evaluation profiles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.evaluation.use_cases.base.UseCase.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">model_or_pipeline</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runtime_overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h7>


    <div class="doc doc-contents ">

        <p>Required generation logic for the current use case.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_pipeline</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Required generation logic for the current use case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h7 id="aisteer360.evaluation.use_cases.base.UseCase.validate_evaluation_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">validate_evaluation_data</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">)</span></code>

</h7>


    <div class="doc doc-contents ">

        <p>Optional validation of the evaluation dataset.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optional validation of the evaluation dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.use_cases.commonsense_mcqa" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>commonsense_mcqa</code>


</h5>

    <div class="doc doc-contents ">

        <p>Use case class for the commonsense multiple-choice question answering (MCQA) task.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>use_case</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>CommonsenseMCQA</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            UseCase (aisteer360.evaluation.use_cases.base.UseCase)" href="#aisteer360.evaluation.use_cases.base.UseCase">UseCase</a></code></p>


        <p>Commonsense MCQA evaluation use case.</p>
<p>Evaluates model's ability to answer commonsense questions via accuracy on the CommonsenseMCQA dataset
(<a href="https://huggingface.co/datasets/tau/commonsense_qa">https://huggingface.co/datasets/tau/commonsense_qa</a>). Supports
answer choice shuffling across multiple runs to reduce position bias and improve evaluation robustness.</p>
<p>The evaluation data should contain questions with multiple choice options where models are asked to respond with
only the letter (A, B, C, etc.) corresponding to their chosen answer.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="            num_shuffling_runs

  
      instance-attribute
   (aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.num_shuffling_runs)" href="#aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.num_shuffling_runs">num_shuffling_runs</a></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of times to shuffle answer choices for each question to mitigate position bias effects.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/use_cases/commonsense_mcqa/use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CommonsenseMCQA</span><span class="p">(</span><span class="n">UseCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Commonsense MCQA evaluation use case.</span>

<span class="sd">    Evaluates model&#39;s ability to answer commonsense questions via accuracy on the CommonsenseMCQA dataset</span>
<span class="sd">    ([https://huggingface.co/datasets/tau/commonsense_qa](https://huggingface.co/datasets/tau/commonsense_qa)). Supports</span>
<span class="sd">    answer choice shuffling across multiple runs to reduce position bias and improve evaluation robustness.</span>

<span class="sd">    The evaluation data should contain questions with multiple choice options where models are asked to respond with</span>
<span class="sd">    only the letter (A, B, C, etc.) corresponding to their chosen answer.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        num_shuffling_runs: Number of times to shuffle answer choices for each question to mitigate position bias effects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_shuffling_runs</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates that evaluation data contains required fields for MCQA evaluation.</span>

<span class="sd">        Ensures each data instance has the necessary keys and non-null values for the evaluation.</span>

<span class="sd">        Args:</span>
<span class="sd">            evaluation_data: Dictionary containing a single evaluation instance with question, answer choices, and correct answer information.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required keys (&#39;id&#39;, &#39;question&#39;, &#39;answer&#39;, &#39;choices&#39;) are missing or if any required fields contain null/NaN values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evaluation_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The evaluation data must include an &#39;id&#39; key&quot;</span><span class="p">)</span>

        <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">_EVALUATION_REQ_KEYS</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evaluation_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required keys: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evaluation_data</span> <span class="ow">or</span> <span class="n">evaluation_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_EVALUATION_REQ_KEYS</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some required fields are missing or null.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_pipeline</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates model responses for multiple-choice questions with shuffled answer orders.</span>

<span class="sd">        Creates prompts for each question with shuffled answer choices, generates model responses, and parses the</span>
<span class="sd">        outputs to extract letter choices. Repeats the process multiple times with different answer orderings to reduce</span>
<span class="sd">        positional bias.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_or_pipeline: Either a HuggingFace model or SteeringPipeline instance to use for generation.</span>
<span class="sd">            tokenizer: Tokenizer for encoding/decoding text.</span>
<span class="sd">            gen_kwargs: Optional generation parameters.</span>
<span class="sd">            runtime_overrides: Optional runtime parameter overrides for steering controls, structured as {(pipeline_name, param_name): value}.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of generation dictionaries, each containing:</span>

<span class="sd">                - &quot;response&quot;: Parsed letter choice (A, B, C, etc.) or None if not parseable</span>
<span class="sd">                - &quot;prompt&quot;: Full prompt text sent to the model</span>
<span class="sd">                - &quot;question_id&quot;: Identifier from the original evaluation data</span>
<span class="sd">                - &quot;reference_answer&quot;: Correct letter choice for this shuffled ordering</span>

<span class="sd">        Note:</span>

<span class="sd">        - The number of returned generations will be `len(evaluation_data)` * `num_shuffling_runs` due to answer choice shuffling.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No evaluation data provided.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>

        <span class="c1"># form prompt data</span>
        <span class="n">prompt_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
            <span class="n">data_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">question</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;choices&#39;</span><span class="p">]</span>
            <span class="c1"># shuffle order of choices for each shuffling run</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shuffling_runs</span><span class="p">):</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;You will be given a multiple-choice question and asked to select from a set of choices.&quot;</span><span class="p">]</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Question: </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

                <span class="c1"># shuffle</span>
                <span class="n">choice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)))</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">choice_order</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">old_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">choice_order</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_LETTERS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">choices</span><span class="p">[</span><span class="n">old_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please only print the letter corresponding to your choice.&quot;</span><span class="p">]</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Answer:&quot;</span><span class="p">]</span>

                <span class="n">prompt_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data_id</span><span class="p">,</span>
                        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span>
                        <span class="s2">&quot;reference_answer&quot;</span><span class="p">:</span> <span class="n">_LETTERS</span><span class="p">[</span><span class="n">choice_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">answer</span><span class="p">))]</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># batch template/generate/decode</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">batch_retry_generate</span><span class="p">(</span>
            <span class="n">prompt_data</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">,</span>
            <span class="n">model_or_pipeline</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">parse_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_letter</span><span class="p">,</span>
            <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
            <span class="n">runtime_overrides</span><span class="o">=</span><span class="n">runtime_overrides</span><span class="p">,</span>
            <span class="n">evaluation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span>
        <span class="p">)</span>

        <span class="c1"># store</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">choice</span><span class="p">,</span>
                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt_dict</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
                <span class="s2">&quot;question_id&quot;</span><span class="p">:</span> <span class="n">prompt_dict</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="s2">&quot;reference_answer&quot;</span><span class="p">:</span> <span class="n">prompt_dict</span><span class="p">[</span><span class="s2">&quot;reference_answer&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">prompt_dict</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prompt_data</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">generations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluates generated responses against reference answers using configured metrics.</span>

<span class="sd">        Extracts responses and reference answers from generations and computes scores using all evaluation metrics</span>
<span class="sd">        specified during initialization.</span>

<span class="sd">        Args:</span>
<span class="sd">            generations: List of generation dictionaries returned by the `generate()` method, each containing response,</span>
<span class="sd">                reference_answer, and question_id fields.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of scores keyed by `metric_name`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eval_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generation</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">],</span>
            <span class="s2">&quot;reference_answers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generation</span><span class="p">[</span><span class="s2">&quot;reference_answer&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">],</span>
            <span class="s2">&quot;question_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generation</span><span class="p">[</span><span class="s2">&quot;question_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="o">**</span><span class="n">eval_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">save_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exports evaluation profiles to (tabbed) JSON format.&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;profiles.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_letter</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts the letter choice from model&#39;s generation.</span>

<span class="sd">        Parses model output to find the first valid letter (A-Z) that represents the model&#39;s choice.</span>

<span class="sd">        Args:</span>
<span class="sd">            response: Raw text response from the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Single uppercase letter (A, B, C, etc.) representing the model&#39;s choice, or None if no valid letter choice could be parsed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">_LETTERS</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*(assistant|system|user)[:\n ]*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;\b([</span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">])\b&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.evaluation_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">evaluation_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.jsonl&#39;</span> <span class="k">else</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.evaluation_metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">evaluation_metrics</span> <span class="o">=</span> <span class="n">evaluation_metrics</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.num_shuffling_runs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">num_shuffling_runs</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.evaluate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">evaluate</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Evaluates generated responses against reference answers using configured metrics.</p>
<p>Extracts responses and reference answers from generations and computes scores using all evaluation metrics
specified during initialization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>generations</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of generation dictionaries returned by the <code>generate()</code> method, each containing response,
reference_answer, and question_id fields.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of scores keyed by <code>metric_name</code></p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/commonsense_mcqa/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluates generated responses against reference answers using configured metrics.</span>

<span class="sd">    Extracts responses and reference answers from generations and computes scores using all evaluation metrics</span>
<span class="sd">    specified during initialization.</span>

<span class="sd">    Args:</span>
<span class="sd">        generations: List of generation dictionaries returned by the `generate()` method, each containing response,</span>
<span class="sd">            reference_answer, and question_id fields.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of scores keyed by `metric_name`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eval_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generation</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">],</span>
        <span class="s2">&quot;reference_answers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generation</span><span class="p">[</span><span class="s2">&quot;reference_answer&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">],</span>
        <span class="s2">&quot;question_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">generation</span><span class="p">[</span><span class="s2">&quot;question_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">:</span>
        <span class="n">scores</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="o">**</span><span class="n">eval_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.export" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">export</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Exports evaluation profiles to (tabbed) JSON format.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/commonsense_mcqa/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">save_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exports evaluation profiles to (tabbed) JSON format.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;profiles.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">model_or_pipeline</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runtime_overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Generates model responses for multiple-choice questions with shuffled answer orders.</p>
<p>Creates prompts for each question with shuffled answer choices, generates model responses, and parses the
outputs to extract letter choices. Repeats the process multiple times with different answer orderings to reduce
positional bias.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_or_pipeline</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a HuggingFace model or SteeringPipeline instance to use for generation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for encoding/decoding text.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional generation parameters.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_overrides</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="tuple">tuple</span>[<span title="str">str</span>, <span title="str">str</span>], <span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional runtime parameter overrides for steering controls, structured as {(pipeline_name, param_name): value}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of generation dictionaries, each containing:</p>
<ul>
<li>"response": Parsed letter choice (A, B, C, etc.) or None if not parseable</li>
<li>"prompt": Full prompt text sent to the model</li>
<li>"question_id": Identifier from the original evaluation data</li>
<li>"reference_answer": Correct letter choice for this shuffled ordering</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:</p>
<ul>
<li>The number of returned generations will be <code>len(evaluation_data)</code> * <code>num_shuffling_runs</code> due to answer choice shuffling.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/commonsense_mcqa/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_or_pipeline</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates model responses for multiple-choice questions with shuffled answer orders.</span>

<span class="sd">    Creates prompts for each question with shuffled answer choices, generates model responses, and parses the</span>
<span class="sd">    outputs to extract letter choices. Repeats the process multiple times with different answer orderings to reduce</span>
<span class="sd">    positional bias.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_or_pipeline: Either a HuggingFace model or SteeringPipeline instance to use for generation.</span>
<span class="sd">        tokenizer: Tokenizer for encoding/decoding text.</span>
<span class="sd">        gen_kwargs: Optional generation parameters.</span>
<span class="sd">        runtime_overrides: Optional runtime parameter overrides for steering controls, structured as {(pipeline_name, param_name): value}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of generation dictionaries, each containing:</span>

<span class="sd">            - &quot;response&quot;: Parsed letter choice (A, B, C, etc.) or None if not parseable</span>
<span class="sd">            - &quot;prompt&quot;: Full prompt text sent to the model</span>
<span class="sd">            - &quot;question_id&quot;: Identifier from the original evaluation data</span>
<span class="sd">            - &quot;reference_answer&quot;: Correct letter choice for this shuffled ordering</span>

<span class="sd">    Note:</span>

<span class="sd">    - The number of returned generations will be `len(evaluation_data)` * `num_shuffling_runs` due to answer choice shuffling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No evaluation data provided.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>

    <span class="c1"># form prompt data</span>
    <span class="n">prompt_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
        <span class="n">data_id</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;question&#39;</span><span class="p">]</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;choices&#39;</span><span class="p">]</span>
        <span class="c1"># shuffle order of choices for each shuffling run</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_shuffling_runs</span><span class="p">):</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;You will be given a multiple-choice question and asked to select from a set of choices.&quot;</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Question: </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

            <span class="c1"># shuffle</span>
            <span class="n">choice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)))</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">choice_order</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">old_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">choice_order</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_LETTERS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">choices</span><span class="p">[</span><span class="n">old_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please only print the letter corresponding to your choice.&quot;</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Answer:&quot;</span><span class="p">]</span>

            <span class="n">prompt_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data_id</span><span class="p">,</span>
                    <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span>
                    <span class="s2">&quot;reference_answer&quot;</span><span class="p">:</span> <span class="n">_LETTERS</span><span class="p">[</span><span class="n">choice_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">choices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">answer</span><span class="p">))]</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="c1"># batch template/generate/decode</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="n">batch_retry_generate</span><span class="p">(</span>
        <span class="n">prompt_data</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">,</span>
        <span class="n">model_or_pipeline</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">parse_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_letter</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
        <span class="n">runtime_overrides</span><span class="o">=</span><span class="n">runtime_overrides</span><span class="p">,</span>
        <span class="n">evaluation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span>
    <span class="p">)</span>

    <span class="c1"># store</span>
    <span class="n">generations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">choice</span><span class="p">,</span>
            <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt_dict</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
            <span class="s2">&quot;question_id&quot;</span><span class="p">:</span> <span class="n">prompt_dict</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;reference_answer&quot;</span><span class="p">:</span> <span class="n">prompt_dict</span><span class="p">[</span><span class="s2">&quot;reference_answer&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">prompt_dict</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prompt_data</span><span class="p">,</span> <span class="n">choices</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">generations</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.commonsense_mcqa.use_case.CommonsenseMCQA.validate_evaluation_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">validate_evaluation_data</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Validates that evaluation data contains required fields for MCQA evaluation.</p>
<p>Ensures each data instance has the necessary keys and non-null values for the evaluation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>evaluation_data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing a single evaluation instance with question, answer choices, and correct answer information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required keys ('id', 'question', 'answer', 'choices') are missing or if any required fields contain null/NaN values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/commonsense_mcqa/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates that evaluation data contains required fields for MCQA evaluation.</span>

<span class="sd">    Ensures each data instance has the necessary keys and non-null values for the evaluation.</span>

<span class="sd">    Args:</span>
<span class="sd">        evaluation_data: Dictionary containing a single evaluation instance with question, answer choices, and correct answer information.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required keys (&#39;id&#39;, &#39;question&#39;, &#39;answer&#39;, &#39;choices&#39;) are missing or if any required fields contain null/NaN values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evaluation_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The evaluation data must include an &#39;id&#39; key&quot;</span><span class="p">)</span>

    <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">_EVALUATION_REQ_KEYS</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evaluation_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required keys: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">evaluation_data</span> <span class="ow">or</span> <span class="n">evaluation_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_EVALUATION_REQ_KEYS</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Some required fields are missing or null.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.use_cases.instruction_following" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>instruction_following</code>


</h5>

    <div class="doc doc-contents ">

        <p>Use case class for the instruction following task.</p>










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h6 id="aisteer360.evaluation.use_cases.instruction_following.use_case" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>use_case</code>


</h6>

    <div class="doc doc-contents ">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h7 id="aisteer360.evaluation.use_cases.instruction_following.use_case.InstructionFollowing" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>InstructionFollowing</code>


</h7>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            UseCase (aisteer360.evaluation.use_cases.base.UseCase)" href="#aisteer360.evaluation.use_cases.base.UseCase">UseCase</a></code></p>


        <p>Instruction following use case using the IFEval dataset.</p>
<p>Evaluates model ability to follow specific instructions by testing adherence to
various formatting, content, and structural constraints. Uses the IFEval dataset
which contains prompts with explicit instructions that models must follow precisely.</p>
<p>The evaluation focuses on whether models can follow instructions like:</p>
<ul>
<li>Formatting requirements (e.g., "respond in exactly 3 sentences")</li>
<li>Content constraints (e.g., "include the word 'fantastic' twice")</li>
<li>Structural requirements (e.g., "use bullet points", "write in JSON format")</li>
</ul>
<p>Expected evaluation data format should include fields like 'prompt', 'instructions',
'instruction_id_list', and 'kwargs' for comprehensive instruction following assessment.</p>








              <details class="quote">
                <summary>Source code in <code>aisteer360/evaluation/use_cases/instruction_following/use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InstructionFollowing</span><span class="p">(</span><span class="n">UseCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instruction following use case using the IFEval dataset.</span>

<span class="sd">    Evaluates model ability to follow specific instructions by testing adherence to</span>
<span class="sd">    various formatting, content, and structural constraints. Uses the IFEval dataset</span>
<span class="sd">    which contains prompts with explicit instructions that models must follow precisely.</span>

<span class="sd">    The evaluation focuses on whether models can follow instructions like:</span>

<span class="sd">    - Formatting requirements (e.g., &quot;respond in exactly 3 sentences&quot;)</span>
<span class="sd">    - Content constraints (e.g., &quot;include the word &#39;fantastic&#39; twice&quot;)</span>
<span class="sd">    - Structural requirements (e.g., &quot;use bullet points&quot;, &quot;write in JSON format&quot;)</span>

<span class="sd">    Expected evaluation data format should include fields like &#39;prompt&#39;, &#39;instructions&#39;,</span>
<span class="sd">    &#39;instruction_id_list&#39;, and &#39;kwargs&#39; for comprehensive instruction following assessment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_or_pipeline</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates model responses for instruction following prompts.</span>

<span class="sd">        Processes evaluation data to create chat-formatted prompts and generates model responses.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_or_pipeline: Either a HuggingFace model or SteeringPipeline instance to use for generation.</span>
<span class="sd">            tokenizer: Tokenizer for encoding/decoding text.</span>
<span class="sd">            gen_kwargs: Optional generation parameters passed to the model&#39;s generate method.</span>
<span class="sd">            runtime_overrides: Optional runtime parameter overrides for steering controls, structured as {(pipeline_name, param_name): value}.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of generation dictionaries, each containing:</span>

<span class="sd">                - &quot;response&quot;: Generated text response from the model</span>
<span class="sd">                - &quot;prompt&quot;: Original instruction following prompt</span>
<span class="sd">                - &quot;instructions&quot;: List of specific instructions the model should follow</span>
<span class="sd">                - &quot;instruction_id_list&quot;: Identifiers for each instruction type</span>
<span class="sd">                - &quot;kwargs&quot;: Additional metadata for instruction evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No evaluation data provided.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">prompt_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
            <span class="n">user_prompt</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]}]</span>
            <span class="n">prompt_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">})</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="n">batch_retry_generate</span><span class="p">(</span>
            <span class="n">prompt_data</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">,</span>
            <span class="n">model_or_pipeline</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
            <span class="n">runtime_overrides</span><span class="o">=</span><span class="n">runtime_overrides</span><span class="p">,</span>
            <span class="n">evaluation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">generations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
                <span class="s2">&quot;instructions&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;instructions&quot;</span><span class="p">],</span>
                <span class="s2">&quot;instruction_id_list&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">],</span>
                <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">eval_data</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">generations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="n">responses</span><span class="o">=</span><span class="n">generations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exports instruction following evaluation results to structured JSON files.</span>

<span class="sd">        Creates two output files:</span>

<span class="sd">        1. `responses.json`: Contains model responses for each steering method</span>
<span class="sd">        2. `scores.json`: Contains strict metric scores for each steering method</span>

<span class="sd">        Args:</span>
<span class="sd">            profiles: Dictionary containing evaluation results from all tested pipelines.</span>
<span class="sd">            save_dir: Directory path where results should be saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
        <span class="n">folder_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">steering_methods</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">follow_instructions</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">steering_method</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">profiles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;generations&quot;</span><span class="p">)</span>
            <span class="n">steering_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">steering_method</span><span class="p">)</span>
            <span class="n">predictions</span><span class="p">[</span><span class="n">steering_method</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">]</span>

            <span class="c1"># get instruction following details from the StrictInstruction metric</span>
            <span class="k">if</span> <span class="s2">&quot;StrictInstruction&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;evaluations&quot;</span><span class="p">]:</span>
                <span class="n">follow_instructions</span><span class="p">[</span><span class="n">steering_method</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;evaluations&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;StrictInstruction&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;follow_all_instructions&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">]</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">steering_methods</span><span class="p">:</span>
                <span class="n">response</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">response</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">_instr_follow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">follow_instructions</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder_path</span> <span class="o">/</span> <span class="s2">&quot;responses.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder_path</span> <span class="o">/</span> <span class="s2">&quot;scores.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.use_cases.instruction_following.use_case.InstructionFollowing.evaluation_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">evaluation_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.jsonl&#39;</span> <span class="k">else</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h8 id="aisteer360.evaluation.use_cases.instruction_following.use_case.InstructionFollowing.evaluation_metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">evaluation_metrics</span> <span class="o">=</span> <span class="n">evaluation_metrics</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.instruction_following.use_case.InstructionFollowing.evaluate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">evaluate</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Required evaluation logic for model's generations via <code>evaluation_metrics</code>.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/instruction_following/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="p">(</span><span class="n">responses</span><span class="o">=</span><span class="n">generations</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.instruction_following.use_case.InstructionFollowing.export" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">export</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Exports instruction following evaluation results to structured JSON files.</p>
<p>Creates two output files:</p>
<ol>
<li><code>responses.json</code>: Contains model responses for each steering method</li>
<li><code>scores.json</code>: Contains strict metric scores for each steering method</li>
</ol>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>profiles</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing evaluation results from all tested pipelines.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>save_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory path where results should be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/instruction_following/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">profiles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exports instruction following evaluation results to structured JSON files.</span>

<span class="sd">    Creates two output files:</span>

<span class="sd">    1. `responses.json`: Contains model responses for each steering method</span>
<span class="sd">    2. `scores.json`: Contains strict metric scores for each steering method</span>

<span class="sd">    Args:</span>
<span class="sd">        profiles: Dictionary containing evaluation results from all tested pipelines.</span>
<span class="sd">        save_dir: Directory path where results should be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
    <span class="n">folder_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">steering_methods</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">follow_instructions</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">steering_method</span><span class="p">,</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">profiles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;generations&quot;</span><span class="p">)</span>
        <span class="n">steering_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">steering_method</span><span class="p">)</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">steering_method</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">]</span>

        <span class="c1"># get instruction following details from the StrictInstruction metric</span>
        <span class="k">if</span> <span class="s2">&quot;StrictInstruction&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;evaluations&quot;</span><span class="p">]:</span>
            <span class="n">follow_instructions</span><span class="p">[</span><span class="n">steering_method</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;evaluations&quot;</span><span class="p">][</span>
                <span class="s2">&quot;StrictInstruction&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;follow_all_instructions&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">]</span>

    <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">steering_methods</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">response</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">_instr_follow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">follow_instructions</span><span class="p">[</span><span class="n">method</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder_path</span> <span class="o">/</span> <span class="s2">&quot;responses.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">folder_path</span> <span class="o">/</span> <span class="s2">&quot;scores.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.instruction_following.use_case.InstructionFollowing.generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">model_or_pipeline</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runtime_overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Generates model responses for instruction following prompts.</p>
<p>Processes evaluation data to create chat-formatted prompts and generates model responses.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_or_pipeline</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a HuggingFace model or SteeringPipeline instance to use for generation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tokenizer for encoding/decoding text.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gen_kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional generation parameters passed to the model's generate method.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_overrides</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="tuple">tuple</span>[<span title="str">str</span>, <span title="str">str</span>], <span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional runtime parameter overrides for steering controls, structured as {(pipeline_name, param_name): value}.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of generation dictionaries, each containing:</p>
<ul>
<li>"response": Generated text response from the model</li>
<li>"prompt": Original instruction following prompt</li>
<li>"instructions": List of specific instructions the model should follow</li>
<li>"instruction_id_list": Identifiers for each instruction type</li>
<li>"kwargs": Additional metadata for instruction evaluation</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/instruction_following/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_or_pipeline</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates model responses for instruction following prompts.</span>

<span class="sd">    Processes evaluation data to create chat-formatted prompts and generates model responses.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_or_pipeline: Either a HuggingFace model or SteeringPipeline instance to use for generation.</span>
<span class="sd">        tokenizer: Tokenizer for encoding/decoding text.</span>
<span class="sd">        gen_kwargs: Optional generation parameters passed to the model&#39;s generate method.</span>
<span class="sd">        runtime_overrides: Optional runtime parameter overrides for steering controls, structured as {(pipeline_name, param_name): value}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of generation dictionaries, each containing:</span>

<span class="sd">            - &quot;response&quot;: Generated text response from the model</span>
<span class="sd">            - &quot;prompt&quot;: Original instruction following prompt</span>
<span class="sd">            - &quot;instructions&quot;: List of specific instructions the model should follow</span>
<span class="sd">            - &quot;instruction_id_list&quot;: Identifiers for each instruction type</span>
<span class="sd">            - &quot;kwargs&quot;: Additional metadata for instruction evaluation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No evaluation data provided.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="n">prompt_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">:</span>
        <span class="n">user_prompt</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">instance</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]}]</span>
        <span class="n">prompt_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">})</span>

    <span class="n">responses</span> <span class="o">=</span> <span class="n">batch_retry_generate</span><span class="p">(</span>
        <span class="n">prompt_data</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">,</span>
        <span class="n">model_or_pipeline</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
        <span class="n">runtime_overrides</span><span class="o">=</span><span class="n">runtime_overrides</span><span class="p">,</span>
        <span class="n">evaluation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">generations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span>
            <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">],</span>
            <span class="s2">&quot;instructions&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;instructions&quot;</span><span class="p">],</span>
            <span class="s2">&quot;instruction_id_list&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;instruction_id_list&quot;</span><span class="p">],</span>
            <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">eval_data</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">eval_data</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_data</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">generations</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h8 id="aisteer360.evaluation.use_cases.instruction_following.use_case.InstructionFollowing.validate_evaluation_data" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">validate_evaluation_data</span><span class="p">(</span><span class="n">evaluation_data</span><span class="p">)</span></code>

</h8>


    <div class="doc doc-contents ">

        <p>Optional validation of the evaluation dataset.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/use_cases/instruction_following/use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_evaluation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="aisteer360.evaluation.utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>utils</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.utils.generation_utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>generation_utils</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="aisteer360.evaluation.utils.generation_utils.BATCH_SIZE" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">64</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

    </div>

</div>




<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.utils.generation_utils.apply_chat_template" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">apply_chat_template</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Constructs template prompts for each batch element based on following cases:
1. If the model's tokenizer does not support chat_template, return the string as is.
2. If it supports chat_template:
    Check each instance of the batch to construct chat messages if needed. Cases:
    - Plain string -&gt; convert as 'content' of 'user'
    - List of dictionaries with 'role' and 'content'. Continue
    Then apply chat template and return</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/utils/generation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_chat_template</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs template prompts for each batch element based on following cases:</span>
<span class="sd">    1. If the model&#39;s tokenizer does not support chat_template, return the string as is.</span>
<span class="sd">    2. If it supports chat_template:</span>
<span class="sd">        Check each instance of the batch to construct chat messages if needed. Cases:</span>
<span class="sd">        - Plain string -&gt; convert as &#39;content&#39; of &#39;user&#39;</span>
<span class="sd">        - List of dictionaries with &#39;role&#39; and &#39;content&#39;. Continue</span>
<span class="sd">        Then apply chat template and return</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">template_prompts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
        <span class="n">prompt_obj</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s2">&quot;apply_chat_template&quot;</span><span class="p">):</span>
            <span class="n">template_prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prompt_obj</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt_obj</span><span class="p">}]</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">prompt_obj</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="s2">&quot;role&quot;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">prompt_obj</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Prompt </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: every chat message dict must have &#39;role&#39; and &#39;content&#39; keys.&quot;</span>
                    <span class="p">)</span>
                <span class="n">messages</span> <span class="o">=</span> <span class="n">prompt_obj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Prompt </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: must be str or list of chat messages as list[dict[str, str]] &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt_obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>

            <span class="n">chat_str</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">apply_chat_template</span><span class="p">(</span>
                <span class="n">messages</span><span class="p">,</span>
                <span class="n">add_generation_prompt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">tokenize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">template_prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chat_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template_prompts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.utils.generation_utils.batch_retry_generate" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">batch_retry_generate</span><span class="p">(</span><span class="n">prompt_data</span><span class="p">,</span> <span class="n">model_or_pipeline</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runtime_overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">return_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Generate chat completions with optional parsing/retry logic.</p>
<p>Function keeps retrying only the prompts whose outputs fail parse_fn (up to max_retries); return value is a list
of parsed objects (or None if parsing doesn't succeed).</p>
<p>If return_raw is True the function instead returns a tuple (parsed_list, raw_list).</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/utils/generation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">batch_retry_generate</span><span class="p">(</span>
    <span class="n">prompt_data</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">model_or_pipeline</span><span class="p">:</span> <span class="n">PreTrainedModel</span> <span class="o">|</span> <span class="n">SteeringPipeline</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">PreTrainedTokenizerBase</span><span class="p">,</span>
    <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">evaluation_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parse_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">return_raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate chat completions with optional parsing/retry logic.</span>

<span class="sd">    Function keeps retrying only the prompts whose outputs fail parse_fn (up to max_retries); return value is a list</span>
<span class="sd">    of parsed objects (or None if parsing doesn&#39;t succeed).</span>

<span class="sd">    If return_raw is True the function instead returns a tuple (parsed_list, raw_list).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">missing_prompt</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prompt_data</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;prompt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_prompt</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;prompt&#39; key missing for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_prompt</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances&quot;</span><span class="p">)</span>

    <span class="n">gen_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="n">is_pipeline</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_pipeline</span><span class="p">,</span> <span class="n">SteeringPipeline</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">device_obj</span> <span class="o">=</span> <span class="n">model_or_pipeline</span><span class="o">.</span><span class="n">device</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to identify model or pipeline device - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_pipeline</span><span class="p">:</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">chat_generate_pipeline</span><span class="p">(</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device_obj</span><span class="p">,</span>
            <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
            <span class="n">runtime_overrides</span><span class="o">=</span><span class="n">runtime_overrides</span><span class="p">,</span>
            <span class="n">evaluation_data</span><span class="o">=</span><span class="n">evaluation_data</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">chat_generate_model</span><span class="p">(</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">prompt_data</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device_obj</span><span class="p">,</span>
            <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">parse_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># parse and retry</span>
        <span class="n">parsed_responses</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_fn</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">]</span>
        <span class="n">retry_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_responses</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parsed_responses</span> <span class="o">=</span> <span class="n">responses</span>
        <span class="n">retry_indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">retry_indices</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
        <span class="n">retry_prompts</span> <span class="o">=</span> <span class="p">[</span><span class="n">prompt_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">retry_indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">is_pipeline</span><span class="p">:</span>
            <span class="n">retry_raw</span> <span class="o">=</span> <span class="n">chat_generate_pipeline</span><span class="p">(</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">retry_prompts</span><span class="p">,</span>
                <span class="n">pipeline</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
                <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device_obj</span><span class="p">,</span>
                <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
                <span class="n">runtime_overrides</span><span class="o">=</span><span class="n">runtime_overrides</span><span class="p">,</span>
                <span class="n">evaluation_data</span><span class="o">=</span><span class="n">evaluation_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retry_raw</span> <span class="o">=</span> <span class="n">chat_generate_model</span><span class="p">(</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">retry_prompts</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model_or_pipeline</span><span class="p">,</span>
                <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
                <span class="n">device</span><span class="o">=</span><span class="n">device_obj</span><span class="p">,</span>
                <span class="n">gen_kwargs</span><span class="o">=</span><span class="n">gen_kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">local_i</span><span class="p">,</span> <span class="n">global_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">retry_indices</span><span class="p">):</span>
            <span class="n">responses</span><span class="p">[</span><span class="n">global_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">retry_raw</span><span class="p">[</span><span class="n">local_i</span><span class="p">]</span>
            <span class="n">parsed_responses</span><span class="p">[</span><span class="n">global_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_fn</span><span class="p">(</span><span class="n">retry_raw</span><span class="p">[</span><span class="n">local_i</span><span class="p">])</span>

        <span class="n">retry_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parsed_responses</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">parsed_responses</span><span class="p">,</span> <span class="n">responses</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_raw</span> <span class="k">else</span> <span class="n">parsed_responses</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.utils.generation_utils.chat_generate_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">chat_generate_model</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Batch generate on model with chunking to prevent OOM.
Each instance of the batch must have a 'prompt' which could be:
- A plain string , in which case we apply the chat template
- Dict with the chat template already applied ('role' and 'content' keys)</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/utils/generation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">chat_generate_model</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Batch generate on model with chunking to prevent OOM.</span>
<span class="sd">    Each instance of the batch must have a &#39;prompt&#39; which could be:</span>
<span class="sd">    - A plain string , in which case we apply the chat template</span>
<span class="sd">    - Dict with the chat template already applied (&#39;role&#39; and &#39;content&#39; keys)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prompts</span> <span class="o">=</span> <span class="n">apply_chat_template</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
    <span class="n">decoded_outputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">),</span> <span class="n">BATCH_SIZE</span><span class="p">):</span>
        <span class="n">batch_prompts</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">BATCH_SIZE</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
                <span class="n">batch_prompts</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="n">input_ids</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">],</span>
                    <span class="n">attention_mask</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span>
                    <span class="o">**</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{}),</span>
                <span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">batch_decoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">outputs</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">decoded_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_decoded</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue with model generation at batch </span><span class="si">{</span><span class="n">i</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hint - Do not apply chat template to your prompts.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">return</span> <span class="n">decoded_outputs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.utils.generation_utils.chat_generate_pipeline" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">chat_generate_pipeline</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">gen_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runtime_overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">evaluation_data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Generate on pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/utils/generation_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">chat_generate_pipeline</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">pipeline</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
    <span class="n">gen_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">runtime_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">evaluation_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate on pipeline.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">runtime_overrides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">evaluation_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;evaluation_data must be provided when runtime_overrides are supplied.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># create runtime_kwargs from runtime_overrides and evaluation_data</span>
    <span class="n">runtime_kwargs_flat</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">runtime_overrides</span><span class="p">:</span>
        <span class="n">runtime_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">controls</span><span class="p">:</span>
            <span class="n">control_name</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">control_name</span> <span class="ow">in</span> <span class="n">runtime_overrides</span><span class="p">:</span>
                <span class="n">runtime_kwargs</span><span class="p">[</span><span class="n">control_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_map_runtime_overrides</span><span class="p">(</span>
                    <span class="n">overrides</span><span class="o">=</span><span class="n">runtime_overrides</span><span class="p">[</span><span class="n">control_name</span><span class="p">],</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">evaluation_data</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># flatten and convert to list of dicts; todo: maintain control names to avoid possible collisions</span>
        <span class="k">for</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">runtime_kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">runtime_kwargs_flat</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Duplicate runtime_kwargs for: </span><span class="si">{</span><span class="n">var</span><span class="si">!r}</span><span class="s2">; ensure controls have distinct variables.&quot;</span>
                    <span class="p">)</span>
                <span class="n">runtime_kwargs_flat</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="n">runtime_kwargs_flat</span> <span class="o">=</span> <span class="n">_runtime_kwargs_to_list</span><span class="p">(</span><span class="n">runtime_kwargs_flat</span><span class="p">)</span>

    <span class="c1"># Need to check for empty runtime_kwargs_flat since we may define runtime_overrides</span>
    <span class="c1"># for a subset of steering methods, but the current method may not have any overrides.</span>
    <span class="c1"># This will result in the above if block being executed with runtime_kwargs_flat = []</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">runtime_overrides</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">runtime_kwargs_flat</span><span class="p">:</span>
        <span class="n">runtime_kwargs_flat</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="n">prompts</span> <span class="o">=</span> <span class="n">apply_chat_template</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
    <span class="n">decoded_outputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">),</span> <span class="n">BATCH_SIZE</span><span class="p">):</span>
        <span class="n">batch_prompts</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">BATCH_SIZE</span><span class="p">]</span>
        <span class="n">batch_runtime_kwargs</span> <span class="o">=</span> <span class="n">runtime_kwargs_flat</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">BATCH_SIZE</span><span class="p">]</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
            <span class="n">batch_prompts</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>

        <span class="c1"># generate</span>
        <span class="c1"># todo-future: run batch as dictated by availability of batch processing of controls in pipeline</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_prompts</span><span class="p">)):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                    <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">attention_mask</span><span class="o">=</span><span class="n">attention_mask</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">runtime_kwargs</span><span class="o">=</span><span class="n">batch_runtime_kwargs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="o">**</span><span class="p">(</span><span class="n">gen_kwargs</span> <span class="ow">or</span> <span class="p">{}),</span>
                <span class="p">)</span>
                <span class="n">generations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">generation</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">]</span>
        <span class="n">padded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad</span><span class="p">({</span><span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">},</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">padded</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>
        <span class="n">batch_decoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">decoded_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_decoded</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decoded_outputs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h5 id="aisteer360.evaluation.utils.metric_utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>metric_utils</code>


</h5>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h6 id="aisteer360.evaluation.utils.metric_utils.to_1d_array" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">to_1d_array</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">n_examples</span><span class="p">)</span></code>

</h6>


    <div class="doc doc-contents ">

        <p>Normalize a metric's result into a 1d numpy array of length n_examples.</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/evaluation/utils/metric_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_1d_array</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">n_examples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a metric&#39;s result into a 1d numpy array of length n_examples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric returned multiple values </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">; UseCase.evaluate expects exactly one.&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_examples</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">n_examples</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric produced </span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> values, but </span><span class="si">{</span><span class="n">n_examples</span><span class="si">}</span><span class="s2"> examples were expected.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric returned an array with shape </span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">; only scalars or 1‑D arrays are supported.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="aisteer360.utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>utils</code>


</h3>

    <div class="doc doc-contents ">










  <div class="doc doc-children">











<div class="doc doc-object doc-module">



<h4 id="aisteer360.utils.model_utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>model_utils</code>


</h4>

    <div class="doc doc-contents ">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="aisteer360.utils.model_utils.find_project_root" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">find_project_root</span><span class="p">(</span><span class="n">current_path</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Finds root dir by looking for pyproject.toml</p>


            <details class="quote">
              <summary>Source code in <code>aisteer360/utils/model_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_project_root</span><span class="p">(</span><span class="n">current_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds root dir by looking for pyproject.toml&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="n">current_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">current_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current_path</span> <span class="o">/</span> <span class="s1">&#39;pyproject.toml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">current_path</span>
        <span class="n">current_path</span> <span class="o">=</span> <span class="n">current_path</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;no pyproject.toml found&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="aisteer360.utils.model_utils.is_valid_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">is_valid_model</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">


            <details class="quote">
              <summary>Source code in <code>aisteer360/utils/model_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_valid_model</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;model-config&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span>
            <span class="n">model_id</span> <span class="ow">in</span> <span class="n">model_config</span> <span class="ow">and</span>
            <span class="n">service</span> <span class="ow">in</span> <span class="n">model_config</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s1">&#39;access&#39;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.tabs.link", "content.code.annotate", "content.code.copy", "announce.dismiss", "navigation.footer", "navigation.tabs", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.top", "navigation.tracking", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>